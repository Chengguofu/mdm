<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸»æ•°æ®ç¼–ç è§„åˆ™</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f7faff; margin:0; font-size: 14px; }
    .container { max-width: 1200px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(33,118,199,0.10); padding: 32px 36px 28px 36px; }
    .section-title { color: #2176c7; font-size: 18px; font-weight: 600; margin-bottom: 18px; }
    .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 20px; }
    .btn-main { background: #4db6ac; color: #fff; border: none; border-radius: 4px; padding: 0 18px; height: 36px; font-size: 14px; display: flex; align-items: center; font-weight: 500; transition: background 0.18s; }
    .btn-main:hover { background: #399488; }
    .btn-line { background: #fff; color: #444; border: 1px solid #d0d7de; border-radius: 4px; padding: 0 14px; height: 36px; font-size: 14px; display: flex; align-items: center; transition: background 0.18s, border 0.18s; }
    .btn-line:hover { background: #f5f7fa; border-color: #b0b8c1; }
    .table-wrap { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(33, 118, 199, 0.06); padding: 18px 0 0 0; overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 14px; background: #fff; min-width: 900px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left; white-space: nowrap; }
    th { background: #f4f8fb; color: #2176c7; font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f0f6fd; }
    td.center { text-align: center; }
    
    /* æŠ½å±‰æ ·å¼ */
    .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; display: none; }
    .modal-content { position: fixed; top: 0; right: -800px; width: 800px; height: 100%; background: #fff; box-shadow: -2px 0 10px rgba(0,0,0,0.1); transition: right 0.3s ease; z-index: 1001; display: flex; flex-direction: column; }
    .modal-content.show { right: 0; }
    .modal-header { padding: 16px 24px; border-bottom: 1px solid #e0e6ed; background: #f8fafc; display: flex; align-items: center; justify-content: space-between; flex-shrink: 0; }
    .modal-header span { font-size: 16px; font-weight: 600; color: #2176c7; }
    .modal-close { font-size: 24px; color: #999; cursor: pointer; padding: 4px; }
    .modal-close:hover { color: #666; }
    
    .modal-body { flex: 1 1 auto; overflow-y: auto; padding: 24px; min-height:0; max-height:calc(100vh - 120px); box-sizing: border-box; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #e0e6ed; background: #f8fafc; display: flex; gap: 12px; justify-content: flex-end; flex-shrink: 0; position: sticky; bottom: 0; z-index:2; }
    
    /* è¡¨å•æ ·å¼ */
    .form-row { display: flex; gap: 24px; margin-bottom: 20px; }
    .form-group { flex: 1; display: flex; align-items: center; }
    .form-label { width: 80px; color: #185a99; font-size: 14px; text-align: right; margin-right: 8px; flex-shrink: 0; }
    .form-value { flex: 1; }
    .form-value input, .form-value select { width: 50%; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 4px; font-size: 14px; background: #f9fbfd; }
    .form-value input[type="text"], .form-value input[type="number"] { width: 50%; }
    .form-value select { width: 50%; }
    .required { color: #e53935; margin-left: 2px; font-size: 14px; }
    
    /* å¼€å…³æŒ‰é’®æ ·å¼ */
    .switch-container { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
    .switch { position: relative; display: inline-block; width: 44px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 22px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #4db6ac; }
    input:focus + .slider { box-shadow: 0 0 1px #4db6ac; }
    input:checked + .slider:before { transform: translateX(22px); }
    .switch-label { font-size: 13px; color: #666; }
    
    /* ç¼–ç è§„åˆ™é…ç½®æ ·å¼ */
    .code-segments { margin-top: 20px; }
    .segment-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8fafc; border: 1px solid #e0e6ed; border-radius: 6px; margin-bottom: 12px; }
    .segment-type { width: 120px; flex-shrink: 0; }
    .segment-type select {
      width: 100%;
      padding: 0 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #c0d3eb;
      vertical-align: middle;
      box-sizing: border-box;
    }
    .segment-config input,
    .segment-config select {
      height: 30px;
      padding: 4px 8px;
      font-size: 13px;
      border-radius: 4px;
      border: 1px solid #c0d3eb;
      box-sizing: border-box;
    }
    .segment-config { flex: 1; display: flex; gap: 8px; align-items: center; min-height: 32px; }
    .segment-config input, .segment-config select { padding: 4px 8px; border: 1px solid #c0d3eb; border-radius: 3px; font-size: 12px; height: 30px; }
    .segment-config label { display: flex; align-items: center; gap: 4px; font-size: 12px; }
    .segment-separator { display:none; }
    .separator-input { padding: 4px 8px; border: 1px solid #c0d3eb; border-radius: 3px; font-size: 12px; text-align: center; width:90px; margin-left:8px; }
    .segment-actions { width: 60px; flex-shrink: 0; }
    .btn-small { padding: 4px 10px; font-size: 13px; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s; }
    .btn-add { background: #4db6ac; color: #fff; }
    .btn-add:hover { background: #399488; }
    .btn-remove { background: #e74c3c; color: #fff; }
    .btn-remove:hover { background: #c62828; }
    .code-preview { background: #f0f6fd; border: 1px solid #c0d3eb; border-radius: 4px; padding: 12px 16px; margin-bottom: 16px; font-family: monospace; color: #2176c7; font-size: 13px; }
    .hidden { display: none; }
    
    /* çŠ¶æ€æ ‡ç­¾ */
    .status-active { background: #e8f5e8; color: #2e7d32; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .status-inactive { background: #ffebee; color: #c62828; padding: 4px 12px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    
    /* ç©ºçŠ¶æ€ */
    .empty-state { text-align: center; padding: 60px 20px; color: #666; }
    .empty-state .icon { font-size: 48px; margin-bottom: 16px; opacity: 0.3; }
    .empty-state .text { font-size: 15px; margin-bottom: 8px; }
    .empty-state .sub-text { font-size: 13px; opacity: 0.7; }
    
    /* æ–°å¢çš„CSS */
    .serial-group { display: flex; flex-direction: column; align-items: flex-start; margin-right: 8px; min-width: 50px; }
    .serial-group label { font-size: 12px; color: #185a99; margin-bottom: 2px; }
    .serial-group input { width: 70px; }
    .serial-group input.serial-length { width: 42px; }
    .serial-group input.serial-step { width: 35px; }
    .serial-group input.serial-start, .serial-group input.serial-end { width: 70px; }
    .serial-group .serial-pad-label { margin:0;font-size:13px;display:flex;align-items:center;gap:2px; }
    /* ç¼©å°æµæ°´ç è¾“å…¥åŒºåŸŸgap */
    .serial-group-row {
      display: flex;
      align-items: flex-end;
      gap: 0 !important;
      flex-wrap: nowrap;
      margin-bottom: 5px;
    }
    /* æµæ°´ç ä¸“ç”¨è¾“å…¥æ¡†æ ·å¼ */
    .serial-group input[type="number"],
    .serial-group input[type="text"] {
      height: 29px;
      width: calc(100% + 2px) !important;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
    /* é‡ç½®å‘¨æœŸå•é€‰å¹³é“º */
    .serial-reset-date-group {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-left: 8px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section-title">ä¸»æ•°æ®ç¼–ç è§„åˆ™</div>
    <div class="action-bar">
      <button class="btn-main" id="addBtn">æ–°å¢ç¼–ç è§„åˆ™</button>
      <button class="btn-line" id="deleteBtn">åˆ é™¤</button>
    </div>
    <div class="table-wrap">
      <table id="codeRuleTable">
        <thead>
          <tr>
            <th class="checkbox-cell" style="width:36px;"><input type="checkbox" id="checkAll"></th>
            <th>è§„åˆ™ç¼–ç </th>
            <th>è§„åˆ™åç§°</th>
            <th>ç¼–ç ç±»å‹</th>
            <th>ç¼–ç å­—æ®µ</th>
            <th>çŠ¶æ€</th>
            <th style="text-align:center;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody">
        </tbody>
      </table>
    </div>
  </div>

  <!-- æŠ½å±‰ -->
  <div class="modal-mask" id="modalMask">
    <div class="modal-content" id="modal-content">
      <div class="modal-header" style="display:flex;align-items:center;justify-content:space-between;">
        <span id="drawerTitle">æ–°å¢ç¼–ç è§„åˆ™</span>
        <span class="modal-close" id="drawerClose">Ã—</span>
      </div>
      <div style="display:flex;justify-content:flex-end;align-items:center;padding:10px 24px 0 24px;">
        <div class="switch-container" style="margin-bottom:0;">
          <span class="switch-label">çŠ¶æ€</span>
          <label class="switch">
            <input type="checkbox" id="statusSwitch" checked>
            <span class="slider"></span>
          </label>
        </div>
      </div>
      <form id="editForm">
        <div class="modal-body">
          <div class="form-row">
            <div class="form-group">
              <div class="form-label">è§„åˆ™ç¼–ç <span class="required">*</span>ï¼š</div>
              <div class="form-value"><input type="text" id="editCode" required placeholder="è¯·è¾“å…¥è§„åˆ™ç¼–ç "></div>
            </div>
            <div class="form-group">
              <div class="form-label">è§„åˆ™åç§°<span class="required">*</span>ï¼š</div>
              <div class="form-value"><input type="text" id="editName" required placeholder="è¯·è¾“å…¥è§„åˆ™åç§°"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <div class="form-label">ç¼–ç ç±»å‹<span class="required">*</span>ï¼š</div>
              <div class="form-value"><select id="editType" required onchange="toggleCodeConfig()"><option value="è‡ªåŠ¨ç¼–ç ">è‡ªåŠ¨ç¼–ç </option><option value="æ‰‹åŠ¨ç¼–ç ">æ‰‹åŠ¨ç¼–ç </option></select></div>
            </div>
            <div class="form-group">
              <div class="form-label">ç¼–ç å­—æ®µ<span class="required">*</span>ï¼š</div>
              <div class="form-value"><input type="text" id="editField" required placeholder="è¯·è¾“å…¥ç¼–ç å­—æ®µ"></div>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <div class="form-label">é€‚ç”¨æ¡ä»¶ï¼š</div>
              <div class="form-value" style="position:relative;width:300px;min-width:0;display:flex;align-items:center;background:#f9fbfd;border:1.2px solid #c0d3eb;border-radius:4px;">
                <input id="conditionInput" class="form-control" style="flex:1;border:none;background:transparent;padding:6px 10px 6px 10px;height:32px;font-size:14px;outline:none;" readonly placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘">
                <button type="button" id="conditionSearchBtn" style="border:none;background:transparent;cursor:pointer;padding:0 8px 0 0;height:32px;width:32px;display:flex;align-items:center;justify-content:center;">
                  <svg width="18" height="18" viewBox="0 0 20 20"><circle cx="9" cy="9" r="7" stroke="#2176c7" stroke-width="2" fill="none"/><line x1="15" y1="15" x2="11.5" y2="11.5" stroke="#2176c7" stroke-width="2" stroke-linecap="round"/></svg>
                </button>
              </div>
            </div>
          </div>

          <!-- è‡ªåŠ¨ç¼–ç é…ç½® -->
          <div id="autoCodeConfig">
            <div class="code-segments">
              <div style="display:flex;justify-content:space-between;align-items:center;margin:16px 0;">
                <h4 style="margin:0;color:#2176c7;font-size:15px;">ç¼–ç è§„åˆ™é…ç½®</h4>
                <button type="button" class="btn-small btn-add" onclick="addSegment(event)">æ·»åŠ ç¼–ç æ®µ</button>
              </div>
              <div class="code-preview">
                <strong>ç¼–ç é¢„è§ˆï¼š</strong><span id="codePreview">è¯·é…ç½®ç¼–ç è§„åˆ™</span>
              </div>
              <div id="segmentsContainer">
                <!-- ç¼–ç æ®µå°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
              </div>
            </div>
          </div>

          <!-- æ‰‹åŠ¨ç¼–ç é…ç½® -->
          <div id="manualCodeConfig" class="hidden">
            <div class="form-row">
              <div class="form-group">
                <div class="form-label">ç¼–ç é•¿åº¦<span class="required">*</span>ï¼š</div>
                <div class="form-value"><input type="number" id="manualLength" min="1" max="50" placeholder="è¯·è¾“å…¥ç¼–ç é•¿åº¦"></div>
              </div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn-main">ä¿å­˜</button>
          <button type="button" class="btn-line" id="drawerCancel">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    // æ•°æ®æ¨¡æ‹Ÿ
    let data = [
      { 
        code: 'RULE001', 
        name: 'ä¾›åº”å•†ç¼–ç è§„åˆ™', 
        type: 'è‡ªåŠ¨ç¼–ç ', 
        desc: 'ä¾›åº”å•†è‡ªåŠ¨ç¼–ç è§„åˆ™ï¼ŒåŒ…å«å›ºå®šå‰ç¼€+æ—¥æœŸ+æµæ°´å·', 
        field: 'supplier_code', 
        status: 'å¯ç”¨',
        segments: [
          { type: 'å›ºå®šç ', config: { value: 'SUP' }, separator: '-' },
          { type: 'æ—¥æœŸç ', config: { field: 'create_date', format: 'YYYYMMDD' }, separator: '-' },
          { type: 'æµæ°´ç ', config: { maxLength: 4, padZero: true, step: 1 }, separator: '' }
        ]
      },
      { 
        code: 'RULE002', 
        name: 'å‘˜å·¥ç¼–ç è§„åˆ™', 
        type: 'æ‰‹åŠ¨ç¼–ç ', 
        desc: 'å‘˜å·¥æ‰‹åŠ¨ç¼–ç è§„åˆ™', 
        field: 'employee_code', 
        status: 'å¯ç”¨',
        manualLength: 8
      },
      { 
        code: 'RULE003', 
        name: 'äº§å“ç¼–ç è§„åˆ™', 
        type: 'è‡ªåŠ¨ç¼–ç ', 
        desc: 'äº§å“ç¼–ç è§„åˆ™ï¼ŒåŒ…å«åˆ†ç±»ä»£ç +æµæ°´å·', 
        field: 'product_code', 
        status: 'ç¦ç”¨',
        segments: [
          { type: 'å­—æ®µç ', config: { field: 'category_code' }, separator: '-' },
          { type: 'æµæ°´ç ', config: { maxLength: 6, padZero: true, step: 1 }, separator: '' }
        ]
      }
    ];
    let editIdx = -1;

    function renderTable() {
      const tbody = document.getElementById('tableBody');
      if (data.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="7">
              <div class="empty-state">
                <div class="icon">ğŸ“‹</div>
                <div class="text">æš‚æ— ç¼–ç è§„åˆ™</div>
                <div class="sub-text">ç‚¹å‡»"æ–°å¢ç¼–ç è§„åˆ™"å¼€å§‹åˆ›å»º</div>
              </div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = data.map((item, idx) => `
        <tr>
          <td class="checkbox-cell"><input type="checkbox" class="rowCheck" data-idx="${idx}"></td>
          <td>${item.code}</td>
          <td>ä¾›åº”å•†ç¼–ç è§„åˆ™${idx+1}</td>
          <td>${item.type}</td>
          <td>code</td>
          <td class="center">
            <label class="switch" style="vertical-align:middle;">
              <input type="checkbox" class="row-status-switch" data-idx="${idx}" ${item.status === 'å¯ç”¨' ? 'checked' : ''}>
              <span class="slider"></span>
            </label>
          </td>
          <td class="center">
            <button type="button" class="row-btn-edit" onclick="editRow(${idx})" style="background:none;border:none;color:#2176c7;cursor:pointer;font-size:14px;padding:0 8px;">ç¼–è¾‘</button>
            <button type="button" class="row-btn-del" onclick="deleteRow(${idx})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;padding:0 8px;">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }

    function showDrawer() {
      document.getElementById('modalMask').style.display = 'block';
      setTimeout(() => {
        document.getElementById('modal-content').classList.add('show');
      }, 10);
    }

    function hideDrawer() {
      document.getElementById('modal-content').classList.remove('show');
      setTimeout(() => {
        document.getElementById('modalMask').style.display = 'none';
      }, 300);
    }

    function toggleCodeConfig() {
      const codeType = document.getElementById('editType').value;
      const autoConfig = document.getElementById('autoCodeConfig');
      // æ— è®ºè‡ªåŠ¨è¿˜æ˜¯æ‰‹åŠ¨ç¼–ç ï¼Œéƒ½æ˜¾ç¤ºç¼–ç æ®µé…ç½®
      autoConfig.classList.remove('hidden');
      // æ¸…ç©ºç¼–ç æ®µï¼Œå› ä¸ºç±»å‹æ”¹å˜äº†
      document.getElementById('segmentsContainer').innerHTML = '';
      document.getElementById('codePreview').textContent = 'è¯·é…ç½®ç¼–ç è§„åˆ™';
    }

    function addSegment(event) {
      if (event) {
        event.stopPropagation();
      }
      const container = document.getElementById('segmentsContainer');
      const segmentId = Date.now();
      const codeType = document.getElementById('editType').value;

      let typeOptions = '';
      if (codeType === 'è‡ªåŠ¨ç¼–ç ') {
        typeOptions = `
          <option value="å›ºå®šç ">å›ºå®šç </option>
          <option value="æ—¥æœŸç ">æ—¥æœŸç </option>
          <option value="å­—æ®µç ">å­—æ®µç </option>
          <option value="æµæ°´ç ">æµæ°´ç </option>
          <option value="å¼•ç”¨ç ">å¼•ç”¨ç </option>
        `;
      } else {
        typeOptions = `
          <option value="å›ºå®šç ">å›ºå®šç </option>
          <option value="æ—¥æœŸç ">æ—¥æœŸç </option>
          <option value="å­—æ®µç ">å­—æ®µç </option>
          <option value="å¼•ç”¨ç ">å¼•ç”¨ç </option>
          <option value="æ‰‹å·¥ç ">æ‰‹å·¥ç </option>
        `;
      }

      // ç»“æ„ï¼šä¸»å­—æ®µ+åˆ†éš”ç¬¦+åˆ é™¤æŒ‰é’®åŒè¡Œ
      const segmentHtml = `
        <div class="segment-item" data-segment-id="${segmentId}" style="margin-bottom:12px;display:flex;align-items:center;gap:8px;">
          <div class="segment-type" style="width:120px;flex-shrink:0;">
            <select class="segment-type-select" onchange="updateSegmentConfig(${segmentId})">
              ${typeOptions}
            </select>
          </div>
          <div class="segment-config" id="config-${segmentId}" style="display:inline-block;"></div>
          <button type="button" class="btn-small btn-remove" onclick="removeSegment(${segmentId}, event)" style="height:32px;margin-left:0;white-space:nowrap;">åˆ é™¤</button>
        </div>
      `;
      container.insertAdjacentHTML('beforeend', segmentHtml);
      updateSegmentConfig(segmentId);
    }

    function updateSegmentConfig(segmentId) {
      const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
      const typeSelect = segment.querySelector('.segment-type-select');
      const configDiv = segment.querySelector('.segment-config');
      const type = typeSelect.value;
      const codeType = document.getElementById('editType').value;

      // å…ˆæ¸…ç©º
      configDiv.innerHTML = '';

      let configHtml = '';

      if (codeType === 'è‡ªåŠ¨ç¼–ç ') {
        switch(type) {
          case 'å›ºå®šç ':
            configHtml = `<input type="text" class="fixed-value" placeholder="å›ºå®šå­—ç¬¦" style="width:120px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">`;
            break;
          case 'æ—¥æœŸç ':
            configHtml = `
              <select class="date-field" style="width:120px;" onchange="updateCodePreview()">
                <option value="create_date">åˆ›å»ºæ—¥æœŸ</option>
                <option value="update_date">æ›´æ–°æ—¥æœŸ</option>
              </select>
              <input type="text" class="date-format" placeholder="æ—¥æœŸæ ¼å¼" value="YYYYMMDD" style="width:100px;" oninput="updateCodePreview()">
              <input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">
            `;
            break;
          case 'å­—æ®µç ':
            configHtml = `
              <select class="field-name" style="width:120px;" onchange="updateCodePreview()">
                <option value="">æ¨¡å‹å±æ€§</option>
                <option value="attr1">å±æ€§1</option>
                <option value="attr2">å±æ€§2</option>
                <option value="attr3">å±æ€§3</option>
              </select>
              <select class="ref-attr" style="width:120px;margin-left:8px;" onchange="updateCodePreview()">
                <option value="">å¼•ç”¨å±æ€§</option>
                <option value="ref1">å¼•ç”¨1</option>
                <option value="ref2">å¼•ç”¨2</option>
                <option value="ref3">å¼•ç”¨3</option>
              </select>
              <input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">
            `;
            break;
          case 'æµæ°´ç ':
            configHtml = `
              <div class="serial-group-row" style="max-width:900px;">
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">æœ€å¤§é•¿åº¦</label>
                  <input type="number" class="serial-length" min="1" max="10" value="4" oninput="updateCodePreview()" style="width:58px;">
                </div>
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:90px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">è¡¥é›¶æ–¹å¼</label>
                  <select class="serial-pad" onchange="updateCodePreview()" style="width:80px;">
                    <option value="none">ä¸è¡¥é›¶</option>
                    <option value="prefix">å‰é¢è¡¥é›¶</option>
                    <option value="suffix">åé¢è¡¥é›¶</option>
                  </select>
                </div>
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">æ­¥é•¿</label>
                  <input type="number" class="serial-step" value="1" min="1" oninput="updateCodePreview()" style="width:35px;">
                </div>
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">èµ·å§‹å€¼</label>
                  <input type="number" class="serial-start" value="1" min="0" oninput="updateCodePreview()" style="width:40px;">
                </div>
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">ç»ˆæ­¢å€¼</label>
                  <input type="number" class="serial-end" value="9999" min="0" oninput="updateCodePreview()" style="width:58px;">
                </div>
                <div class="serial-group" style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                  <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">åˆ†éš”ç¬¦</label>
                  <input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:40px;">
                </div>
              </div>
              <div style='display:flex;align-items:center;gap:8px;flex-wrap:nowrap;justify-content:flex-start;'>
                <label style='white-space:nowrap;'>é‡ç½®ç±»å‹</label>
                <select class="serial-reset-type" style="width:90px;" onchange="updateSerialResetConfig(this, ${segmentId})">
                  <option value="none">ä¸é‡ç½®</option>
                  <option value="date">æŒ‰æ—¥æœŸé‡ç½®</option>
                  <option value="field">æŒ‰å­—æ®µå€¼é‡ç½®</option>
                </select>
                <div id='serial-reset-extra-${segmentId}'></div>
              </div>
            `;
            break;
          case 'å¼•ç”¨ç ':
            configHtml = `<input type="text" class="parent-field" placeholder="çˆ¶çº§å­—æ®µ" style="width:120px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">`;
            break;
        }
      } else {
        // æ‰‹åŠ¨ç¼–ç æ¨¡å¼
        switch(type) {
          case 'å›ºå®šç ':
            configHtml = `<input type="text" class="fixed-value" placeholder="å›ºå®šå­—ç¬¦" style="width:120px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">`;
            break;
          case 'æ—¥æœŸç ':
            configHtml = `
              <select class="date-field" style="width:120px;" onchange="updateCodePreview()">
                <option value="create_date">åˆ›å»ºæ—¥æœŸ</option>
                <option value="update_date">æ›´æ–°æ—¥æœŸ</option>
              </select>
              <input type="text" class="date-format" placeholder="æ—¥æœŸæ ¼å¼" value="YYYYMMDD" style="width:100px;" oninput="updateCodePreview()">
              <input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">
            `;
            break;
          case 'å­—æ®µç ':
            configHtml = `
              <select class="field-name" style="width:120px;" onchange="updateCodePreview()">
                <option value="">æ¨¡å‹å±æ€§</option>
                <option value="attr1">å±æ€§1</option>
                <option value="attr2">å±æ€§2</option>
                <option value="attr3">å±æ€§3</option>
              </select>
              <select class="ref-attr" style="width:120px;margin-left:8px;" onchange="updateCodePreview()">
                <option value="">å¼•ç”¨å±æ€§</option>
                <option value="ref1">å¼•ç”¨1</option>
                <option value="ref2">å¼•ç”¨2</option>
                <option value="ref3">å¼•ç”¨3</option>
              </select>
              <input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">
            `;
            break;
          case 'å¼•ç”¨ç ':
            configHtml = `<input type="text" class="parent-field" placeholder="çˆ¶çº§å­—æ®µ" style="width:120px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">`;
            break;
          case 'æ‰‹å·¥ç ':
            configHtml = `<input type="number" class="manual-min-length" placeholder="æœ€å°é•¿åº¦" min="1" max="50" style="width:80px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="number" class="manual-max-length" placeholder="æœ€å¤§é•¿åº¦" min="1" max="50" style="width:80px;margin-left:8px;" oninput="updateCodePreview()">`;
            configHtml += `<input type="text" class="separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodePreview()" style="width:64px;margin-left:8px;">`;
            break;
        }
      }

      configDiv.innerHTML = configHtml;
      updateCodePreview();
    }

    function updateCodePreview() {
      const segments = document.querySelectorAll('.segment-item');
      let preview = '';
      
      segments.forEach((segment, index) => {
        const type = segment.querySelector('.segment-type-select').value;
        const separator = segment.querySelector('.separator-input').value;
        
        let segmentValue = '';
        switch(type) {
          case 'å›ºå®šç ':
            segmentValue = segment.querySelector('.fixed-value').value || 'FIX';
            break;
          case 'æ—¥æœŸç ':
            segmentValue = '20241201';
            break;
          case 'å­—æ®µç ':
            segmentValue = segment.querySelector('.field-name').value || 'FIELD';
            break;
          case 'æµæ°´ç ':
            const length = segment.querySelector('.serial-length').value || 4;
            const start = segment.querySelector('.serial-start') ? segment.querySelector('.serial-start').value : 1;
            const pad = segment.querySelector('.serial-pad').value || 'none';
            let paddedValue = String(start).padStart(length, '0');
            if (pad === 'prefix') {
              paddedValue = paddedValue.padStart(length, '0');
            } else if (pad === 'suffix') {
              paddedValue = paddedValue.padEnd(length, '0');
            }
            segmentValue = paddedValue;
            break;
          case 'å¼•ç”¨ç ':
            segmentValue = segment.querySelector('.parent-field').value || 'REF';
            break;
        }
        
        preview += segmentValue;
        if (index < segments.length - 1 && separator) {
          preview += separator;
        }
      });
      
      document.getElementById('codePreview').textContent = preview || 'è¯·é…ç½®ç¼–ç è§„åˆ™';
    }

    function removeSegment(segmentId, event) {
      if (event) {
        event.stopPropagation();
      }
      const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
      if (segment) {
        segment.remove();
        updateCodePreview();
      }
    }

    function saveRow() {
      const formData = {
        code: document.getElementById('editCode').value,
        name: document.getElementById('editName').value,
        type: document.getElementById('editType').value,
        field: document.getElementById('editField').value,
        status: document.getElementById('statusSwitch').checked ? 'å¯ç”¨' : 'ç¦ç”¨'
      };

      if (formData.type === 'è‡ªåŠ¨ç¼–ç ') {
        const segments = [];
        document.querySelectorAll('.segment-item').forEach(segment => {
          const type = segment.querySelector('.segment-type-select').value;
          const separator = segment.querySelector('.separator-input').value;
          let config = {};
          
          if (type === 'å›ºå®šç ') {
            config.value = segment.querySelector('.fixed-value').value;
          } else if (type === 'æ—¥æœŸç ') {
            config.field = segment.querySelector('.date-field').value;
            config.format = segment.querySelector('.date-format').value;
          } else if (type === 'å­—æ®µç ') {
            config.field = segment.querySelector('.field-name').value;
            config.ref = segment.querySelector('.ref-attr').value;
          } else if (type === 'æµæ°´ç ') {
            config.maxLength = parseInt(segment.querySelector('.serial-length').value);
            config.padZero = segment.querySelector('.serial-pad').value === 'prefix' || segment.querySelector('.serial-pad').value === 'suffix';
            config.step = parseInt(segment.querySelector('.serial-step').value);
            config.start = parseInt(segment.querySelector('.serial-start').value);
            config.end = parseInt(segment.querySelector('.serial-end').value);
            config.resetType = segment.querySelector('.serial-reset-type').value;
            if(config.resetType === 'date') {
              config.resetDate = segment.querySelector('.serial-reset-date').value;
            } else if(config.resetType === 'field') {
              config.resetField = segment.querySelector('.serial-reset-field').value;
            }
          } else if (type === 'å¼•ç”¨ç ') {
            config.field = segment.querySelector('.parent-field').value;
          }
          
          segments.push({ type, config, separator });
        });
        formData.segments = segments;
      } else if (formData.type === 'æ‰‹åŠ¨ç¼–ç ') {
        formData.manualLength = parseInt(document.getElementById('manualLength').value);
      }

      if (editIdx === -1) {
        data.push(formData);
      } else {
        data[editIdx] = formData;
      }
      
      renderTable();
      hideDrawer();
    }

    // æ–°å¢
    function addRow() {
      editIdx = -1;
      document.getElementById('drawerTitle').textContent = 'æ–°å¢ç¼–ç è§„åˆ™';
      document.getElementById('editForm').reset();
      document.getElementById('statusSwitch').checked = true;
      document.getElementById('segmentsContainer').innerHTML = '';
      document.getElementById('codePreview').textContent = 'è¯·é…ç½®ç¼–ç è§„åˆ™';
      toggleCodeConfig();
      showDrawer();
    }

    // ç¼–è¾‘
    function editRow(idx) {
      editIdx = idx;
      const item = data[idx];
      document.getElementById('drawerTitle').textContent = 'ç¼–è¾‘ç¼–ç è§„åˆ™';
      document.getElementById('editCode').value = item.code;
      document.getElementById('editName').value = item.name;
      document.getElementById('editType').value = item.type;
      document.getElementById('editField').value = item.field;
      document.getElementById('statusSwitch').checked = item.status === 'å¯ç”¨';
      
      if (item.type === 'è‡ªåŠ¨ç¼–ç ' && item.segments) {
        document.getElementById('segmentsContainer').innerHTML = '';
        item.segments.forEach(segment => {
          addSegment(null);
          const lastSegment = document.querySelector('.segment-item:last-child');
          const typeSelect = lastSegment.querySelector('.segment-type-select');
          typeSelect.value = segment.type;
          updateSegmentConfig(lastSegment.dataset.segmentId);
          
          // è®¾ç½®é…ç½®å€¼
          setTimeout(() => {
            const configDiv = lastSegment.querySelector('.segment-config');
            const separatorInput = lastSegment.querySelector('.separator-input');
            
            if (segment.type === 'å›ºå®šç ') {
              configDiv.querySelector('.fixed-value').value = segment.config.value;
            } else if (segment.type === 'æ—¥æœŸç ') {
              configDiv.querySelector('.date-field').value = segment.config.field;
              configDiv.querySelector('.date-format').value = segment.config.format;
            } else if (segment.type === 'å­—æ®µç ') {
              configDiv.querySelector('.field-name').value = segment.config.field;
              configDiv.querySelector('.ref-attr').value = segment.config.ref || '';
            } else if (segment.type === 'æµæ°´ç ') {
              configDiv.querySelector('.serial-length').value = segment.config.maxLength;
              configDiv.querySelector('.serial-pad').value = segment.config.padZero ? 'prefix' : 'none';
              configDiv.querySelector('.serial-step').value = segment.config.step;
              if(configDiv.querySelector('.serial-start')) configDiv.querySelector('.serial-start').value = segment.config.start || 1;
              if(configDiv.querySelector('.serial-end')) configDiv.querySelector('.serial-end').value = segment.config.end || 9999;
              // å›æ˜¾é‡ç½®ç±»å‹
              const resetType = segment.config.resetType || 'none';
              const resetTypeSelect = configDiv.parentElement.querySelector('.serial-reset-type');
              if(resetTypeSelect) {
                resetTypeSelect.value = resetType;
                updateSerialResetConfig(resetTypeSelect, segmentId);
                if(resetType === 'date' && configDiv.parentElement.querySelector('.serial-reset-date')) {
                  configDiv.parentElement.querySelector('.serial-reset-date').value = segment.config.resetDate || 'year';
                } else if(resetType === 'field' && configDiv.parentElement.querySelector('.serial-reset-field')) {
                  configDiv.parentElement.querySelector('.serial-reset-field').value = segment.config.resetField || 'field1';
                }
              }
            } else if (segment.type === 'å¼•ç”¨ç ') {
              configDiv.querySelector('.parent-field').value = segment.config.field;
            }
            
            separatorInput.value = segment.separator;
          }, 100);
        });
        updateCodePreview();
      } else if (item.type === 'æ‰‹åŠ¨ç¼–ç ') {
        document.getElementById('manualLength').value = item.manualLength || '';
      }
      
      toggleCodeConfig();
      showDrawer();
    }

    // åˆ é™¤
    function deleteRow(idx) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¼–ç è§„åˆ™å—ï¼Ÿ')) {
        data.splice(idx, 1);
        renderTable();
      }
    }

    // äº‹ä»¶ç›‘å¬
    document.getElementById('addBtn').addEventListener('click', addRow);
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      saveRow();
    });
    document.getElementById('drawerClose').addEventListener('click', hideDrawer);
    document.getElementById('drawerCancel').addEventListener('click', hideDrawer);
    document.getElementById('modalMask').addEventListener('click', function(e) {
      if (e.target === this) {
        hideDrawer();
      }
    });

    // å…¨é€‰åŠŸèƒ½
    document.getElementById('checkAll').onchange = function() {
      const checkboxes = document.querySelectorAll('.rowCheck');
      checkboxes.forEach(cb => cb.checked = this.checked);
    };

    // åˆ é™¤é€‰ä¸­
    document.getElementById('deleteBtn').onclick = function() {
      const checkedBoxes = document.querySelectorAll('.rowCheck:checked');
      if (checkedBoxes.length === 0) {
        alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
        return;
      }
      
      if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedBoxes.length} æ¡è®°å½•å—ï¼Ÿ`)) {
        const indices = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.idx)).sort((a, b) => b - a);
        indices.forEach(idx => data.splice(idx, 1));
        renderTable();
        document.getElementById('checkAll').checked = false;
      }
    };

    // åˆå§‹åŒ–
    renderTable();
    
    // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ç”¨äºå®æ—¶æ›´æ–°é¢„è§ˆ
    document.addEventListener('input', function(e) {
      if (e.target.closest('.code-segments')) {
        updateCodePreview();
      }
    });

    // é˜»æ­¢ç¼–ç æ®µé…ç½®åŒºåŸŸçš„äº‹ä»¶å†’æ³¡
    document.addEventListener('click', function(e) {
      if (e.target.closest('.code-segments') || e.target.closest('.modal-body')) {
        e.stopPropagation();
      }
    });

    // æ–°å¢JSå‡½æ•°
    function updateSerialResetConfig(select, segmentId) {
      const val = select.value;
      const extraDiv = document.getElementById('serial-reset-extra-' + segmentId);
      if(val === 'date') {
        extraDiv.style.display = '';
        extraDiv.innerHTML = `
          <div style='display:flex;align-items:center;gap:16px;'>
            <select class='serial-reset-date-field' style='width:110px;'>
              <option value='create_date'>åˆ›å»ºæ—¥æœŸ</option>
              <option value='update_date'>æ›´æ–°æ—¶é—´</option>
            </select>
            <span class='serial-reset-date-group'>
              <label style='margin:0;'><input type='radio' name='serial-reset-date-${segmentId}' class='serial-reset-date' value='year' checked>å¹´</label>
              <label style='margin:0;'><input type='radio' name='serial-reset-date-${segmentId}' class='serial-reset-date' value='quarter'>å­£åº¦</label>
              <label style='margin:0;'><input type='radio' name='serial-reset-date-${segmentId}' class='serial-reset-date' value='month'>æœˆ</label>
              <label style='margin:0;'><input type='radio' name='serial-reset-date-${segmentId}' class='serial-reset-date' value='day'>æ—¥</label>
            </span>
          </div>
        `;
      } else if(val === 'field') {
        extraDiv.style.display = '';
        extraDiv.innerHTML = `<div style='display:flex;align-items:center;gap:4px;'><label style='margin-right:4px;'>å­—æ®µ</label><select class='serial-reset-field' style='width:90px;'><option value='field1'>å­—æ®µ1</option><option value='field2'>å­—æ®µ2</option></select></div>`;
      } else {
        extraDiv.style.display = 'none';
        extraDiv.innerHTML = '';
      }
    }

    // é€‚ç”¨æ¡ä»¶æœç´¢æŒ‰é’®äº‹ä»¶
    document.getElementById('conditionSearchBtn').onclick = function() {
      window.open('condition_new.html', '_blank');
    };
  </script>
</body>
</html> 