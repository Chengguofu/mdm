<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>模型详情</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: 'Microsoft YaHei', Arial, sans-serif; background:rgba(0,0,0,0.15); font-size:12px; }
    .modal-mask {
      position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.25); z-index:1000; display:flex; align-items:center; justify-content:center;
    }
    .modal-window {
      background:#fff; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.18); 
      width:972px; /* 原1080px缩小10% */
      max-width:98vw; 
      min-height:444px; /* 原467px再缩小5% */
      height:500px;    /* 原526px再缩小5% */
      max-height:108vh; /* 原90vh扩大20% */
      overflow:hidden; 
      position:relative; 
      animation:popin .25s;
      display: flex;
      flex-direction: column;
      overflow-y: auto !important;
      max-height: 98vh !important;
    }
    @keyframes popin { from{transform:scale(0.95);opacity:0;} to{transform:scale(1);opacity:1;} }
    .modal-header {
      padding:22px 32px 0 32px; display:flex; align-items:center; justify-content:space-between;
    }
    .modal-title {
      font-size: 14px !important;
      font-weight: 600;
      color: #185a99;
    }
    .modal-close {
      font-size:20px; color:#888; cursor:pointer; border:none; background:none; transition:.2s; }
    .modal-close:hover { color:#d33; }
    .modal-tabs {
      display:flex; border-bottom:1.5px solid #e5e6eb; margin:18px 32px 0 32px;
    }
    .modal-tab {
      padding:10px 32px; font-size:15px; color:#185a99; cursor:pointer; background:none; border:none; outline:none; border-bottom:2.5px solid transparent; transition:.2s; }
    .modal-tab.active {
      color:#2176c7; font-weight:600; border-bottom:2.5px solid #2176c7; background:#f6f8fa;
    }
    .modal-content { padding:28px 32px 32px 32px; min-height:320px; font-size:15px; padding-bottom: 110px !important; }
    /* 表格样式 */
    table { border-collapse:collapse; width:100%; background:#fff; font-size:15px; }
    th,td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .section-title { font-size:15px; color:#2176c7; margin:18px 0 10px 0; font-weight:600; }
    .kv-row { display:flex; margin-bottom:12px; }
    .kv-label { width:140px; color:#444; font-size:15px; text-align:right; margin-right:12px; }
    .kv-value { flex:1; color:#222; font-size:15px; }
    .tag { display:inline-block; background:#eaf3ff; color:#2176c7; border-radius:3px; padding:2px 8px; font-size:13px; margin-right:6px; }
    .rule-list { margin:0; padding-left:18px; color:#444; font-size:15px; }
    .layout-box { background:#f6f8fa; border-radius:6px; padding:18px; margin-bottom:12px; font-size:15px; }
    .form-2col { display:flex; flex-direction:column; gap:0; margin-top:10px; }
    .form-row { display:flex; align-items:center; margin-bottom:18px; }
    .form-label { width:160px; color:#333; font-size:15px; text-align:right; margin-right:8px; }
    .form-value { width:320px; color:#222; font-size:15px; margin-right:32px; background:#f8fafd; border-radius:4px; min-height:32px; display:flex; align-items:center; padding-left:8px; }
    .required { color:#e53935; margin-left:2px; font-size:15px; }
    .attr-flexbox {
      display: flex;
      height: 100%;
      min-height: 320px;
      box-sizing: border-box;
      width: 100%;
    }
    .attr-field-list {
      width: 182px;
      background: #f6f8fa;
      border-radius: 6px 0 0 6px;
      padding: 0;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      max-height: 100%;
      height: 100%;
      overflow-y: auto;
      flex-shrink: 0;
    }
    .attr-field-list > div > span {
      font-size: 12px !important;
    }
    .attr-field-item {
      font-size: 13px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background 0.18s, border-color 0.18s;
    }
    .attr-field-item.active {
      background: #eaf3ff;
      border-left: 3px solid #2176c7;
    }
    .attr-field-item:hover {
      background: #f4f8fd;
    }
    .attr-field-detail {
      flex: 1;
      background: none !important;
      border-radius: 0 6px 6px 0;
      padding: 0 0 60px 0;
      overflow-y: auto;
      max-height: 100%;
      min-width: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 378px; /* 原420px缩小10% */
      max-height: 378px; /* 原420px缩小10% */
    }
    .attr-field-detail .form-2col {
      display: grid;
      grid-template-columns: 140px 168px 140px 168px;
      gap: 0 24px;
      row-gap: 6px;
      align-items: center;
      margin-top: 0;
    }
    .attr-field-detail .form-row {
      display: contents;
    }
    .attr-field-detail .form-label,
    .attr-field-detail .form-value,
    .attr-detail-label,
    .attr-detail-value,
    .attr-detail-title {
      color: #185a99 !important;
    }
    .attr-field-detail .form-control,
    .attr-field-detail input[type="text"],
    .attr-field-detail select,
    .attr-field-detail textarea {
      width: 168px !important;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c0d3eb;
      border-radius: 7px;
      padding: 8px 14px;
      font-size: 15px;
      background: #fff !important;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    .attr-field-detail .form-control:focus,
    .attr-field-detail input[type="text"]:focus,
    .attr-field-detail select:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px rgba(33,118,199,0.13);
      background: #fff;
    }
    .attr-field-detail .form-control:hover,
    .attr-field-detail input[type="text"]:hover,
    .attr-field-detail select:hover {
      border-color: #3ba1e3;
    }
    .attr-field-detail textarea.form-control {
      width: 168px !important;
      min-width: 0;
      max-width: 100%;
      resize: vertical;
    }
    .attr-detail-title {
      color: #185a99;
      font-size: 12px !important;
      font-weight: 600;
      padding: 0 0 10px 0;
      margin-bottom: 10px;
      background: none;
      border-radius: 0;
    }
    .attr-detail-table {
      width: 100%;
    }
    .attr-detail-row {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
    }
    .attr-detail-label {
      width: 140px;
      color: #222;
      font-size: 15px;
      text-align: right;
      margin-right: 8px;
    }
    .attr-detail-value {
      width: 220px;
      color: #222;
      font-size: 15px;
      background: none !important;
      border-radius: 4px;
      min-height: 32px;
      display: flex;
      align-items: center;
      padding-left: 8px;
      margin-right: 32px;
    }
    .attr-detail-label .required {
      color: #e53935;
      margin-left: 2px;
      font-size: 15px;
    }
    .rule-table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; }
    .rule-table th, .rule-table td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    .rule-table th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .rule-link { color:#2176c7; cursor:pointer; text-decoration:underline; }
    .rule-link:hover { color:#e53935; }
    .rule-detail-modal { position:fixed; left:0;top:0;right:0;bottom:0;z-index:2000; }
    .rule-detail-mask { position:absolute;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.18); }
    .rule-detail-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border-radius:8px; box-shadow:0 4px 24px rgba(0,0,0,0.18); min-width:380px; max-width:90vw; min-height:180px; padding:28px 32px 22px 32px; }
    .rule-detail-title { font-size:15px; color:#185a99; font-weight:600; margin-bottom:16px; }
    .rule-detail-close { margin-top:18px; background:#2176c7; color:#fff; border:none; border-radius:4px; padding:6px 22px; font-size:15px; cursor:pointer; }
    .code-rule-table th, .code-rule-table td { font-size: 15px; }
    .code-rule-table td { white-space: nowrap; }
    .code-rule-table .code-rule-btn { white-space: nowrap; font-size: 13px; padding: 2px 10px; line-height: 1.5; }
    .layout-tabs { display:flex; border-bottom:1.5px solid #e5e6eb; margin-bottom:12px; }
    .layout-tab { padding:8px 32px; font-size:15px; color:#185a99; cursor:pointer; background:none; border:none; outline:none; border-bottom:2.5px solid transparent; transition:.2s; }
    .layout-tab.active { color:#2176c7; font-weight:600; border-bottom:2.5px solid #2176c7; background:#f6f8fa; }
    .layout-content { margin-top:10px; }
    .layout-table { width:100%; border-collapse:collapse; background:#fff; font-size:15px; }
    .layout-table th, .layout-table td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    .layout-table th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .layout-width-input { width:80px; padding:4px 6px; font-size:15px; border:1px solid #bfc8d6; border-radius:3px; }
    
    .layout-detail-flexbox { display: flex; min-height: 360px; border: 1px solid #e5e6eb; border-radius: 6px; }
    .layout-detail-nav { width: 160px; background: #f6f8fa; border-right: 1px solid #e5e6eb; padding: 8px 0; }
    .layout-detail-nav-item { padding: 12px 20px; font-size: 15px; color: #185a99; cursor: pointer; border-left: 3px solid transparent; transition: .2s; }
    .layout-detail-nav-item.active { background: #fff; color: #2176c7; font-weight: 600; border-left-color: #2176c7; }
    .layout-detail-pane-container { flex: 1; padding: 20px; overflow-y: auto; }
    .layout-detail-pane { display: none; }
    .layout-detail-pane.active { display: block; }
    /* Modern input/button style for modal_detail_new.html */
    #tab-base .form-control, #tab-base input[type="text"], #tab-base select, #tab-base textarea {
      border: 1.5px solid #c0d3eb;
      border-radius: 7px;
      padding: 8px 14px;
      font-size: 15px;
      background: #fff !important;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    #tab-base .form-control:focus, #tab-base input[type="text"]:focus, #tab-base select:focus, #tab-base textarea:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px rgba(33,118,199,0.13);
      background: #fff;
    }
    #tab-base .form-control:hover, #tab-base input[type="text"]:hover, #tab-base select:hover, #tab-base textarea:hover {
      border-color: #3ba1e3;
    }
    #tab-base .form-value {
      background: none;
      padding: 0;
      min-height: unset;
    }
    #tab-base .form-row {
      margin-bottom: 22px;
    }
    #tab-base .form-label {
      font-size: 15px;
      color: #185a99;
      font-weight: 500;
    }
    .modal-footer-fixed {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      box-shadow: 0 -2px 12px rgba(33,118,199,0.06);
      padding: 18px 40px 18px 0;
      display: flex;
      justify-content: flex-end;
      z-index: 10;
      box-sizing: border-box;
      width: auto;
      max-width: none;
    }
    .btn-modern {
      background: #2176c7;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 15px;
      padding: 6px 22px;
      margin-left: 6px;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 2px 8px rgba(33,118,199,0.08);
    }
    .btn-modern:hover {
      background: #185a99;
    }
    .btn-line-modern {
      background: #fff;
      color: #2176c7;
      border: 1.5px solid #2176c7;
      border-radius: 6px;
      font-size: 15px;
      padding: 6px 22px;
      margin-left: 6px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
    }
    .btn-line-modern:hover {
      background: #f7faff;
      color: #185a99;
      border-color: #185a99;
    }
    #tab-base .form-2col {
      display: grid;
      grid-template-columns: 140px 240px 140px 240px;
      gap: 0 16px;
      row-gap: 28px;
      align-items: center;
      margin-top: 10px;
    }
    #tab-base .form-row {
      display: contents;
    }
    #tab-base .form-label {
      text-align: right;
      font-size: 16px;
      color: #185a99;
      font-weight: 600;
      padding-right: 16px;
    }
    #tab-base .form-value {
      width: 100%;
      min-width: 0;
      margin-right: 0;
      background: none;
      padding: 0;
      min-height: unset;
      display: flex;
      align-items: center;
    }
    #tab-base .form-row.desc-row {
      grid-column: 1 / 5;
      display: contents;
    }
    #tab-base .form-label.desc-label {
      grid-column: 1 / 2;
      align-self: start;
      margin-top: 8px;
    }
    #tab-base .form-value.desc-value {
      grid-column: 2 / 5;
      width: 100%;
      min-width: 0;
      margin-top: 0;
    }
    #tab-base .form-value.desc-value textarea.form-control {
      width: 100% !important;
      min-width: 0;
      max-width: 100%;
    }
    #tab-attr.modal-content {
      height: 100%;
      display: flex;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      padding-bottom: 110px !important;
    }
    #tab-base .form-value .form-control,
    #tab-base .form-value input[type="text"],
    #tab-base .form-value select,
    #tab-base .form-value textarea {
      width: 240px !important;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
    #tab-base textarea.form-control {
      width: 100% !important;
      min-width: 0;
      max-width: 100%;
    }
    #tab-base .form-label.required-label:after {
      content: '';
    }
    #tab-base.modal-content {
      max-height: 380px;
      overflow-y: auto;
    }
    .modal-content#tab-base {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
    }
    .table-link-delete {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 15px;
      cursor: pointer;
      padding: 0 8px;
      transition: color 0.18s;
    }
    .table-link-delete:hover {
      color: #b71c1c;
      text-decoration: underline;
    }
    .section-collapse-title,
    .section-collapse-title * {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: #2176c7 !important;
    }
    .section-collapse-title {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-bottom: 8px;
      margin-top: 10px;
    }
    .section-collapse-title svg {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .section-collapse-title.collapsed svg {
      transform: rotate(-90deg);
    }
    .section-content {
      transition: max-height 0.2s, opacity 0.2s;
      overflow: hidden;
    }
    .section-content.collapsed {
      max-height: 0 !important;
      opacity: 0;
      padding: 0 !important;
      pointer-events: none;
    }
    #tab-rule.modal-content {
      padding-bottom: 110px !important;
    }
    #tab-code.modal-content {
      padding-bottom: 110px !important;
    }
    #tab-layout.modal-content {
      padding-bottom: 110px !important;
    }
    .modal-title, .modal-tab, .modal-content, .form-label, .form-value, .form-control, .attr-field-item, .attr-detail-title, .attr-detail-label, .attr-detail-value, .section-title, .rule-list, .layout-box, .table, th, td, .btn-modern, .btn-line-modern, .section-collapse-title, .tag, .rule-detail-title, .layout-detail-nav-item, .layout-detail-pane-container, .layout-detail-pane, .layout-tab, .layout-table th, .layout-table td, .code-rule-table th, .code-rule-table td, .modal-footer-fixed, .form-2col, .form-row, .form-label, .form-value, .form-control, .attr-detail-label, .attr-detail-value, .table-link-delete {
      font-size:12px !important;
    }
    .modal-window .modal-title, .modal-title {
      font-size: 14px !important;
      font-weight: 600;
      color: #185a99;
    }
    .attr-detail-title, .section-collapse-title, .section-collapse-title * {
      font-size: 12px !important;
    }
    .modal-steps { user-select:none; }
    .modal-step {
      display:flex;align-items:center;gap:8px;position:relative;cursor:pointer;font-size:15px;color:#b0b8c1;font-weight:500;transition:.18s;flex:1;justify-content:center;
    }
    .modal-step .step-index {
      display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#e5e6eb;color:#888;font-size:15px;font-weight:600;margin-right:6px;transition:.18s;
    }
    .modal-step.active {
      color:#2176c7;font-weight:600;
    }
    .modal-step.active .step-index {
      background:#2176c7;color:#fff;
    }
    .modal-step.done {
      color:#4db6ac;
    }
    .modal-step.done .step-index {
      background:#4db6ac;color:#fff;
    }
    .modal-step:not(:last-child):after {
      content:'';display:block;position:absolute;right:-2px;top:50%;transform:translateY(-50%);width:36px;height:3px;background:#e5e6eb;z-index:0;
    }
    .modal-step.done:not(:last-child):after {
      background:#4db6ac;
    }
  </style>
</head>
<body>
<div class="modal-mask">
  <div class="modal-window">
    <div class="modal-header">
      <span class="modal-title">模型详情</span>
      <button class="modal-close" onclick="closeModal()">×</button>
    </div>
    <div class="modal-steps" style="display:flex;align-items:center;justify-content:space-between;margin:24px 32px 0 32px;">
      <div class="modal-step" data-step="base"><span class="step-index">1</span> 基本配置</div>
      <div class="modal-step" data-step="attr"><span class="step-index">2</span> 属性配置</div>
      <div class="modal-step" data-step="rule"><span class="step-index">3</span> 业务规则</div>
      <div class="modal-step" data-step="code"><span class="step-index">4</span> 编码规则</div>
      <div class="modal-step" data-step="layout"><span class="step-index">5</span> 布局配置</div>
    </div>
    <div class="modal-content" id="tab-base">
      <div class="section-collapse-title" id="baseInfoCollapseBtn">
        <svg width="16" height="16" viewBox="0 0 1024 1024"><path d="M384 192l256 320-256 320z" fill="#2176c7"/></svg>
        基本信息
      </div>
      <div class="section-content" id="baseInfoSection">
        <div class="form-2col">
          <div class="form-row">
            <div class="form-label required-label"><span class='required'>*</span>模型分类：</div>
            <div class="form-value">
              <select class="form-control" name="category" id="modelCategorySelect" required>
                <option value="普通模型">普通模型</option>
                <option value="多视图模型">多视图模型</option>
                <option value="引用分类模型">引用分类模型</option>
                <option value="引用分类多视图">引用分类多视图</option>
              </select>
            </div>
            <div class="form-label required-label"><span class='required'>*</span>主数据类型：</div>
            <div class="form-value">
              <select class="form-control" name="type" id="mainDataTypeSelect" required>
                <option value="系统字典表">系统字典表</option>
                <option value="字典表">字典表</option>
                <option value="主数据">主数据</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label required-label"><span class='required'>*</span>模型编码：</div>
            <div class="form-value"><input type="text" class="form-control" name="code" value="mdm_sys_master_data_type" required></div>
            <div class="form-label required-label"><span class='required'>*</span>模型名称：</div>
            <div class="form-value"><input type="text" class="form-control" name="name" value="模型类型" required></div>
          </div>
          <div class="form-row ref-row" style="display:none;">
            <div class="form-label required-label"><span class='required'>*</span>引用主数据：</div>
            <div class="form-value">
              <select class="form-control" id="refMasterSelect" required></select>
            </div>
            <div class="form-label required-label"><span class='required'>*</span>引用字段：</div>
            <div class="form-value">
              <select class="form-control" id="refFieldSelect" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">是否树形展示：</div>
            <div class="form-value"><select class="form-control" name="tree"><option value="否" selected>否</option><option value="是">是</option></select></div>
          </div>
          <div class="form-row desc-row">
            <div class="form-label desc-label">模型描述：</div>
            <div class="form-value desc-value">
              <textarea class="form-control" name="desc" rows="3" style="resize:vertical;min-height:60px;max-height:180px;"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="section-collapse-title" id="viewInfoCollapseBtn">
        <svg width="16" height="16" viewBox="0 0 1024 1024"><path d="M384 192l256 320-256 320z" fill="#2176c7"/></svg>
        视图信息
      </div>
      <div class="section-content" id="viewInfoSection">
        <div id="viewListBox"></div>
      </div>
    </div>
    <div class="modal-footer-fixed">
      <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
      <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
    </div>
    <div class="modal-content" id="tab-attr" style="display:none;">
      <div class="attr-flexbox">
        <div class="attr-field-list" id="attrFieldList">
          <!-- 字段项由JS渲染 -->
        </div>
        <div class="attr-field-detail" id="attr-detail-box">
          <!-- 详情内容由JS渲染 -->
        </div>
      </div>
    </div>
    <!-- 字段库弹窗 -->
    <div id="fieldLibModal" class="modal-mask" style="display:none;z-index:2001;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,0.18);width:700px;max-width:98vw;min-height:420px;position:relative;">
        <div style="background:#2176c7;color:#fff;font-size:18px;font-weight:500;padding:16px 28px 12px 28px;border-radius:10px 10px 0 0;">标准库 <span style='position:absolute;right:28px;top:16px;cursor:pointer;font-size:22px;' id="closeFieldLibModal">×</span></div>
        <div style="padding:18px 28px 18px 28px;">
          <div style="margin-bottom:12px;display:flex;align-items:center;gap:12px;">
            <input id="fieldLibSearch" type="text" class="form-control" placeholder="快速查询字段名/描述" style="width:220px;">
            <button class="btn-modern" id="fieldLibSearchBtn">查询</button>
          </div>
          <div style="max-height:320px;overflow:auto;">
            <table style="width:100%;border-collapse:collapse;background:#fff;font-size:15px;">
              <thead>
                <tr style="background:#f6f8fa;">
                  <th style="width:40px;"><input type="checkbox" id="fieldLibCheckAll"></th>
                  <th style="width:120px;">值</th>
                  <th>名称</th>
                </tr>
              </thead>
              <tbody id="fieldLibTableBody">
                <!-- 字段库数据由JS渲染 -->
              </tbody>
            </table>
          </div>
          <div style="margin-top:18px;text-align:right;">
            <button class="btn-modern" id="fieldLibAddBtn">添加所选字段</button>
            <button class="btn-line-modern" id="fieldLibCancelBtn">取消</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-content" id="tab-rule" style="display:none;">
      <table class="rule-table">
        <thead>
          <tr>
            <th style="width:180px;">规则名称</th>
            <th style="width:120px;">规则类型</th>
            <th style="width:100px;">创建人</th>
            <th style="width:160px;">创建时间</th>
          </tr>
        </thead>
        <tbody id="ruleTableBody">
        </tbody>
      </table>
      <div id="ruleDetailModal" class="rule-detail-modal" style="display:none;">
        <div class="rule-detail-mask" onclick="closeRuleDetail()"></div>
        <div class="rule-detail-box">
          <div class="rule-detail-title">规则详情</div>
          <div id="ruleDetailContent"></div>
          <button class="rule-detail-close" onclick="closeRuleDetail()">关闭</button>
        </div>
      </div>
    </div>
    <div class="modal-content" id="tab-code" style="display:none;">
      <table class="rule-table code-rule-table">
        <thead>
          <tr>
            <th style="width:60px;">编码ID</th>
            <th style="width:100px;">生成方式</th>
            <th style="width:100px;">起始值</th>
            <th style="width:100px;">终止值</th>
            <th style="width:120px;">是否引用上层编码</th>
            <th style="width:80px;">步长</th>
            <th style="width:100px;">编码长度</th>
            <th style="width:100px;">编码状态</th>
            <th style="width:100px;">创建人</th>
            <th style="width:120px;">创建时间</th>
            <th style="width:90px;">操作</th>
          </tr>
        </thead>
        <tbody id="codeRuleTableBody">
        </tbody>
      </table>
      <div id="codeRuleDetailModal" class="rule-detail-modal" style="display:none;">
        <div class="rule-detail-mask" onclick="closeCodeRuleDetail()"></div>
        <div class="rule-detail-box">
          <div class="rule-detail-title">编码规则详情</div>
          <div id="codeRuleDetailContent"></div>
          <button class="rule-detail-close" onclick="closeCodeRuleDetail()">关闭</button>
        </div>
      </div>
    </div>
    <div class="modal-content" id="tab-layout" style="display:none;">
    </div>
  </div>
</div>

<!-- 发布并提交弹窗 -->
<div id="publishModal" class="modal-mask" style="display:none;z-index:2001;">
  <div style="background:#fff;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,0.18);width:500px;max-width:98vw;min-height:320px;position:relative;">
    <div style="background:#2176c7;color:#fff;font-size:16px;font-weight:500;padding:16px 24px 12px 24px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">
      <span>发布并提交</span>
      <span style='cursor:pointer;font-size:20px;' id="closePublishModal">×</span>
    </div>
    <div style="padding:24px;">
      <div style="margin-bottom:20px;">
        <div style="font-size:15px;color:#185a99;font-weight:600;margin-bottom:12px;">请选择菜单位置：</div>
        <div id="menuTreeContainer" style="border:1px solid #c0d3eb;border-radius:6px;max-height:200px;overflow-y:auto;background:#fff;">
          <div class="menu-tree-item" data-value="main" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#333;">主菜单</span>
          </div>
          <div class="menu-tree-item" data-value="sub1" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">├─ 数据管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  ├─ 主数据管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  ├─ 数据字典</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-3" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  └─ 数据标准</span>
          </div>
          <div class="menu-tree-item" data-value="sub2" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">├─ 系统管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  ├─ 用户管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  ├─ 角色管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-3" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">│  └─ 权限管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub3" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">└─ 业务管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub3-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">   ├─ 流程管理</span>
          </div>
          <div class="menu-tree-item" data-value="sub3-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">   └─ 报表管理</span>
          </div>
        </div>
        <div id="selectedMenuDisplay" style="margin-top:8px;padding:8px 12px;background:#f6f8fa;border-radius:4px;font-size:13px;color:#666;display:none;">
          已选择：<span id="selectedMenuText"></span>
        </div>
      </div>
      
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;">
        <button class="btn-line-modern" id="cancelPublishBtn" style="margin:0;">取消</button>
        <button class="btn-modern" id="confirmPublishBtn" style="margin:0;">确认发布</button>
      </div>
    </div>
  </div>
</div>

<script>
// ========== 统一步骤条与Tab切换逻辑 ========== //
(function(){
  // 步骤顺序
  const stepOrder = ['base','attr','rule','code','layout'];
  const stepEls = document.querySelectorAll('.modal-step');
  const tabEls = stepOrder.map(s=>document.getElementById('tab-'+s));
  const footer = document.querySelector('.modal-footer-fixed');

  // 步骤条高亮与对勾
  function updateStepBar(activeStep) {
    stepEls.forEach((el,idx)=>{
      el.classList.remove('active','done');
      if(stepOrder.indexOf(activeStep)>idx) el.classList.add('done');
      else if(stepOrder.indexOf(activeStep)===idx) el.classList.add('active');
      // 对勾
      const idxSpan = el.querySelector('.step-index');
      if(el.classList.contains('done')) idxSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8" fill="#4db6ac"/><path d="M4 8l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>';
      else idxSpan.textContent = (idx+1);
    });
  }
  // 显示指定步骤内容区
  function showStep(idx) {
    tabEls.forEach((el,i)=>el.style.display = i===idx?'':'none');
    updateStepBar(stepOrder[idx]);
    renderFooter(stepOrder[idx]);
  }
  // 渲染footer按钮
  function renderFooter(step) {
    if(typeof step==='object' && step.dataset) step = step.dataset.tab || step.dataset.step;
    if(step === 'attr' || step === 'rule' || step === 'code') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
        <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
      `;
    } else if(step === 'layout') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
        <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
        <button type="button" class="btn-modern" id="modalFinishBtn">提交</button>
        <button type="button" class="btn-modern" id="modalPublishBtn">发布并提交</button>
      `;
    } else {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
        <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
      `;
    }
    bindFooterEvents();
  }
  // 绑定footer按钮事件
  function bindFooterEvents() {
    document.getElementById('modalPrevBtn') && (document.getElementById('modalPrevBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx>0) showStep(idx-1);
    });
    document.getElementById('modalNextBtn') && (document.getElementById('modalNextBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx<stepOrder.length-1) showStep(idx+1);
    });
    document.getElementById('modalSaveBtn') && (document.getElementById('modalSaveBtn').onclick = function() { alert('保存成功！'); });
    document.getElementById('modalFinishBtn') && (document.getElementById('modalFinishBtn').onclick = function() { alert('提交成功！'); });
    document.getElementById('modalPublishBtn') && (document.getElementById('modalPublishBtn').onclick = function() { 
      // 显示发布并提交弹窗
      document.getElementById('publishModal').style.display = 'flex';
    });
  }
  // 步骤条点击切换
  stepEls.forEach((el,idx)=>{
    el.onclick = function(){ showStep(idx); };
  });
  // 页面初始化时高亮第一个tab和footer
  showStep(0);

  // ========== 发布弹窗事件绑定 ========== //
  // 关闭发布弹窗
  document.getElementById('closePublishModal') && (document.getElementById('closePublishModal').onclick = function() {
    document.getElementById('publishModal').style.display = 'none';
  });
  document.getElementById('cancelPublishBtn') && (document.getElementById('cancelPublishBtn').onclick = function() {
    document.getElementById('publishModal').style.display = 'none';
  });
  
  // 菜单树选择事件
  document.addEventListener('click', function(e) {
    if(e.target.closest('.menu-tree-item')) {
      const menuItem = e.target.closest('.menu-tree-item');
      const value = menuItem.getAttribute('data-value');
      const text = menuItem.querySelector('span').textContent.trim();
      
      // 移除其他选中状态
      document.querySelectorAll('.menu-tree-item').forEach(item => {
        item.style.background = '';
        item.style.color = '';
      });
      
      // 高亮当前选中项
      menuItem.style.background = '#eaf3ff';
      menuItem.style.color = '#2176c7';
      
      // 显示选择结果
      document.getElementById('selectedMenuDisplay').style.display = 'block';
      document.getElementById('selectedMenuText').textContent = text;
      
      // 保存选择的值
      window.selectedMenuValue = value;
      window.selectedMenuText = text;
    }
  });
  
  // 确认发布
  document.getElementById('confirmPublishBtn') && (document.getElementById('confirmPublishBtn').onclick = function() {
    if(!window.selectedMenuValue) {
      alert('请先选择菜单位置！');
      return;
    }
    
    const menuPosition = window.selectedMenuValue;
    const menuText = window.selectedMenuText;
    
    // 构建发布信息
    let positionText = '';
    switch(menuPosition) {
      case 'main': positionText = '主菜单'; break;
      case 'sub1': positionText = '数据管理'; break;
      case 'sub1-1': positionText = '数据管理 > 主数据管理'; break;
      case 'sub1-2': positionText = '数据管理 > 数据字典'; break;
      case 'sub1-3': positionText = '数据管理 > 数据标准'; break;
      case 'sub2': positionText = '系统管理'; break;
      case 'sub2-1': positionText = '系统管理 > 用户管理'; break;
      case 'sub2-2': positionText = '系统管理 > 角色管理'; break;
      case 'sub2-3': positionText = '系统管理 > 权限管理'; break;
      case 'sub3': positionText = '业务管理'; break;
      case 'sub3-1': positionText = '业务管理 > 流程管理'; break;
      case 'sub3-2': positionText = '业务管理 > 报表管理'; break;
      default: positionText = menuText;
    }
    
    const message = `发布成功！\n\n菜单位置：${positionText}`;
    alert(message);
    
    // 关闭弹窗
    document.getElementById('publishModal').style.display = 'none';
  });

  // ========== 清理所有重复/老的tab切换、footer渲染、步骤条相关JS ========== //
  // 1. 移除所有多余的stepOrder/stepEls/updateStepBar/renderFooter相关全局变量和函数
  // 2. 移除所有多余的DOMContentLoaded事件中关于tab切换、footer渲染、步骤条的绑定
  // 3. 保证全局只有本套逻辑

  // ========== closeModal函数补充 ========== //
  window.closeModal = function() {
    // 支持关闭弹窗（可根据实际情况隐藏modal-mask或window.close）
    var mask = document.querySelector('.modal-mask');
    if(mask) mask.style.display = 'none';
    // 或 window.close();
  };
})();
// ... existing code ...

// JS步骤条切换逻辑
const stepOrder = ['base','attr','rule','code','layout'];
const stepEls = document.querySelectorAll('.modal-step');
function updateStepBar(activeStep) {
  stepEls.forEach((el,idx)=>{
    el.classList.remove('active','done');
    if(stepOrder.indexOf(activeStep)>idx) el.classList.add('done');
    else if(stepOrder.indexOf(activeStep)===idx) el.classList.add('active');
    // 对勾
    const idxSpan = el.querySelector('.step-index');
    if(el.classList.contains('done')) idxSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8" fill="#4db6ac"/><path d="M4 8l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>';
    else idxSpan.textContent = (idx+1);
  });
}
stepEls.forEach((el,idx)=>{
  el.onclick = function(){
    stepOrder.forEach(s=>document.getElementById('tab-'+s).style.display='none');
    document.getElementById('tab-'+stepOrder[idx]).style.display='';
    updateStepBar(stepOrder[idx]);
    renderFooter({dataset:{tab:stepOrder[idx]}});
  };
});
// 页面初始化时高亮第一个
updateStepBar('base');

// 字段库模拟数据
const FIELD_LIBRARY = [
  { value: 'desc31', name: '国籍' },
  { value: 'desc32', name: '身份证号码' },
  { value: 'desc33', name: '出生日期' },
  { value: 'desc34', name: '所属组织机构' },
  { value: 'desc35', name: '现工作单位组织机构' },
  { value: 'desc36', name: '参加工作时间' },
  { value: 'desc37', name: '到首钢工作时间' },
  { value: 'desc38', name: '职称等级' },
  // 可扩展更多字段
];
// 当前属性字段，含状态和属性详情
let attrFields = [
  { value: 'desc31', name: '国籍', status: 'normal', enabled: true, detail: { code: 'code1', name: '国籍', type: '字符串', length: '32', required: '是', getType: '自动生成' } },
  { value: 'desc32', name: '身份证号码', status: 'normal', enabled: true, detail: { code: 'code2', name: '身份证号码', type: '字符串', length: '32', required: '是', getType: '自动生成' } },
  { value: 'desc33', name: '出生日期', status: 'normal', enabled: true, detail: { code: 'code3', name: '出生日期', type: '日期', length: '', required: '否', getType: '自动生成' } },
  { value: 'desc34', name: '所属组织机构', status: 'normal', enabled: true, detail: { code: 'code4', name: '所属组织机构', type: '字符串', length: '32', required: '否', getType: '自动生成' } },
  { value: 'desc35', name: '现工作单位组织机构', status: 'normal', enabled: true, detail: { code: 'code5', name: '现工作单位组织机构', type: '字符串', length: '32', required: '否', getType: '自动生成' } },
  { value: 'desc36', name: '参加工作时间', status: 'normal', enabled: true, detail: { code: 'code6', name: '参加工作时间', type: '日期', length: '', required: '否', getType: '自动生成' } },
  { value: 'desc37', name: '到首钢工作时间', status: 'normal', enabled: true, detail: { code: 'code7', name: '到首钢工作时间', type: '日期', length: '', required: '否', getType: '自动生成' } },
  { value: 'desc38', name: '职称等级', status: 'normal', enabled: true, detail: { code: 'code8', name: '职称等级', type: '字符串', length: '32', required: '否', getType: '自动生成' } },
];
// 选中字段索引
let selectedAttrIdx = 0;
function renderAttrDetailBox() {
  const box = document.getElementById('attr-detail-box');
  const f = attrFields[selectedAttrIdx];
  if (!f) { box.innerHTML = '<div style="color:#888;padding:32px;">无属性</div>'; return; }
  if (!f.enabled) {
    box.innerHTML = `<div style='color:#d33;font-size:16px;padding:48px 0 0 0;text-align:center;'>该字段已被禁用，请点击左侧启用</div>`;
    return;
  }
  // 折叠状态
  if(typeof window.attrPanelCollapse === 'undefined') window.attrPanelCollapse = { attr: false, validate: true };
  const collapse = window.attrPanelCollapse;
  if(typeof collapse.advanced === 'undefined') collapse.advanced = false;
  // 判断是否为编码或名称
  const isCode = selectedAttrIdx === 0;
  const isName = selectedAttrIdx === 1;
  box.innerHTML = `
    <div style='font-size:15px;font-weight:600;color:#2176c7;margin-bottom:6px;display:flex;align-items:center;cursor:pointer;user-select:none;' id='attrInfoToggle'>
      <svg style='margin-right:6px;transition:.2s;transform:rotate(${collapse.attr?0:90}deg);' width='14' height='14' viewBox='0 0 1024 1024'><path d='M384 192l256 320-256 320z' fill='#2176c7'/></svg>属性信息
    </div>
    <div id='attrInfoPanel' style='display:${collapse.attr?'none':'block'};'>
      <form class='form-2col' style='padding-bottom:8px;'>
        <div class='form-row'><div class='form-label'>字段名称</div><div class='form-value'><input class='form-control' value='${f.name}' ${isCode?'readonly':''}></div>
          <div class='form-label'>输入类型</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>文本</option><option>下拉</option><option>只读</option></select></div></div>
        <div class='form-row'><div class='form-label'>元属性编码</div><div class='form-value'><input class='form-control' value='${f.detail?.code||''}' readonly></div>
          <div class='form-label'>是否引用元数据描述</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div></div>
        <div class='form-row'><div class='form-label'>元属性名称</div><div class='form-value'><input class='form-control' value='${f.detail?.name||''}' ${isCode?'readonly':''}></div>
          <div class='form-label'>取值方式</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>自动生成</option><option>手动输入</option></select></div></div>
        <div class='form-row'><div class='form-label'>字段类型</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>字符串</option><option>数字</option><option>日期</option></select></div>
          <div class='form-label'>长度 (byte)</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>是否敏感信息</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div>
          <div class='form-label'>敏感起始位置</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>敏感终止位置</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div>
          <div class='form-label'>是否必填</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div></div>
        <div class='form-row'><div class='form-label'>小数位长度</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div>
          <div class='form-label'>默认值</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>字典表引用</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>无</option><option>引用A</option></select></div>
          <div class='form-label'>字典表引用字段</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>字段1</option><option>字段2</option></select></div></div>
        <div class='form-row'><div class='form-label'>是否显示字典表代码</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div>
          <div class='form-label'>字典表筛选字段</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>字段A</option><option>字段B</option></select></div></div>
        <div class='form-row'><div class='form-label'>字典表筛选条件</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div>
          <div class='form-label'>是否树节点</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div></div>
        <div class='form-row'><div class='form-label'>节点描述</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>描述A</option><option>描述B</option></select></div>
          <div class='form-label'>根节点</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>节点描述字段</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>字段A</option><option>字段B</option></select></div>
          <div class='form-label'>是否显示树名称</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div></div>
        <div class='form-row'><div class='form-label'>关联主数据</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>主数据A</option><option>主数据B</option></select></div>
          <div class='form-label'>大小写转换</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>无</option><option>大写</option><option>小写</option></select></div></div>
        <div class='form-row'><div class='form-label'>全半角转换</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>无</option><option>全角</option><option>半角</option></select></div>
          <div class='form-label'>是否过滤空格</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>是</option><option>否</option></select></div></div>
      </form>
    </div>
    <div style='font-size:15px;font-weight:600;color:#2176c7;margin-bottom:6px;margin-top:8px;display:flex;align-items:center;cursor:pointer;user-select:none;' id='validateInfoToggle'>
      <svg style='margin-right:6px;transition:.2s;transform:rotate(${collapse.validate?0:90}deg);' width='14' height='14' viewBox='0 0 1024 1024'><path d='M384 192l256 320-256 320z' fill='#2176c7'/></svg>校验信息
    </div>
    <div id='validateInfoPanel' style='display:${collapse.validate?'none':'block'};'>
      <form class='form-2col' style='padding-bottom:8px;'>
        <div class='form-row'><div class='form-label'>是否可编辑</div><div class='form-value'><select class='form-control'><option>是</option><option>否</option></select></div>
          <div class='form-label'>最大长度</div><div class='form-value'><input class='form-control'></div></div>
        <div class='form-row'><div class='form-label'>最小长度</div><div class='form-value'><input class='form-control'></div>
          <div class='form-label'>是否启用上下限</div><div class='form-value'><select class='form-control'><option>是</option><option>否</option></select></div></div>
        <div class='form-row'><div class='form-label'>上限</div><div class='form-value'><input class='form-control'></div>
          <div class='form-label'>下限</div><div class='form-value'><input class='form-control'></div></div>
        <div class='form-row'><div class='form-label'>是否唯一</div><div class='form-value'><select class='form-control'><option>是</option><option>否</option></select></div>
          <div class='form-label'>校验类型</div><div class='form-value'><select class='form-control'><option>无</option><option>类型A</option></select></div></div>
        <div class='form-row'><div class='form-label'>检验正则表达式</div><div class='form-value'><button type='button' class='btn-line-modern' style='padding:4px 12px;font-size:13px;'>选择正则</button></div></div>
      </form>
    </div>
    <div style='font-size:15px;font-weight:600;color:#2176c7;margin-bottom:6px;margin-top:8px;display:flex;align-items:center;cursor:pointer;user-select:none;' id='advancedConfigToggle'>
      <svg width='16' height='16' viewBox='0 0 1024 1024'><path d='M384 192l256 320-256 320z' fill='#2176c7'/></svg>
      高级配置
    </div>
    <div class='section-content' id='advancedConfigPanel' style='display:${collapse.advanced?'none':'block'};'>
      <form class='form-2col' style='padding-bottom:8px;'>
        <div class='form-row'>
          <div class='form-label'>开启智能联想</div>
          <div class='form-value'>
            <select class='form-control' id='enableSmartSuggest'>
              <option value='否'>否</option>
              <option value='是'>是</option>
            </select>
          </div>
        </div>
        <div class='form-row' id='smartSuggestServiceRow' style='display:none;'>
          <div class='form-label'>智能联想服务</div>
          <div class='form-value'>
            <select class='form-control' id='smartSuggestService'>
              <option value='服务A'>服务A</option>
              <option value='服务B'>服务B</option>
              <option value='服务C'>服务C</option>
            </select>
          </div>
        </div>
      </form>
    </div>
  `;
  // 折叠/展开事件
  setTimeout(()=>{
    document.getElementById('attrInfoToggle').onclick = function(){
      window.attrPanelCollapse.attr = !window.attrPanelCollapse.attr;
      renderAttrDetailBox();
    };
    document.getElementById('validateInfoToggle').onclick = function(){
      window.attrPanelCollapse.validate = !window.attrPanelCollapse.validate;
      renderAttrDetailBox();
    };
    document.getElementById('advancedConfigToggle').onclick = function(){
      if(typeof window.attrPanelCollapse.advanced === 'undefined') window.attrPanelCollapse.advanced = false;
      window.attrPanelCollapse.advanced = !window.attrPanelCollapse.advanced;
      renderAttrDetailBox();
    };
    // 智能联想服务下拉显示逻辑
    const smartSelect = document.getElementById('enableSmartSuggest');
    const serviceRow = document.getElementById('smartSuggestServiceRow');
    if(smartSelect && serviceRow) {
      function updateServiceRow() {
        serviceRow.style.display = smartSelect.value==='是' ? '' : 'none';
      }
      smartSelect.onchange = updateServiceRow;
      updateServiceRow();
    }
  },0);
}
function renderAttrFieldList() {
  const list = document.getElementById('attrFieldList');
  // 批量删除按钮
  let deleteBtn = `<button class="btn-modern" id="batchDeleteBtn" style="display:flex;align-items:center;gap:3px;font-size:10px;padding:1px 7px;margin-left:6px;min-width:unset;height:20px;line-height:1;background:#e53935;"><svg width='13' height='13' viewBox='0 0 1024 1024'><path d='M256 256l512 512M768 256L256 768' stroke='#fff' stroke-width='48' stroke-linecap='round'/></svg></button>`;
  list.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 12px 8px 12px;">
      <span style="font-size:15px;font-weight:600;color:#185a99;">属性列表</span>
      <div style="display:flex;align-items:center;gap:4px;">
        <button class="btn-modern" id="openFieldLibBtn" style="display:flex;align-items:center;gap:3px;font-size:10px;padding:1px 7px;margin:0;min-width:unset;height:20px;line-height:1;">
          <span style='display:inline-flex;width:11px;height:11px;border-radius:50%;background:transparent;align-items:center;justify-content:center;'><svg width="11" height="11" viewBox="0 0 13 13"><path d="M6.5 2v9M2 6.5h9" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span style='color:#fff;font-weight:500;'>添加</span>
        </button>
        ${deleteBtn}
      </div>
    </div>
  ` +
    attrFields.map((f, idx) => {
      let main = idx === 0 ? '编码' : (idx === 1 ? '名称' : f.name);
      let sub = idx === 0 ? `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>code</div>` : (idx === 1 ? `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>name</div>` : `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>desc${idx+1}</div>`);
      let icon = '';
      if(idx > 0) {
        icon = f.enabled
          ? `<span class='field-enable-icon' title='点击禁用' data-idx='${idx}' style='margin-left:auto;cursor:pointer;display:inline-flex;align-items:center;'><svg width='28' height='18' viewBox='0 0 28 18'><rect x='1' y='1' width='26' height='16' rx='8' fill='#2176c7'/><circle cx='20' cy='9' r='6' fill='#fff' stroke='#2176c7' stroke-width='2'/></svg></span>`
          : `<span class='field-enable-icon' title='点击启用' data-idx='${idx}' style='margin-left:auto;cursor:pointer;display:inline-flex;align-items:center;'><svg width='28' height='18' viewBox='0 0 28 18'><rect x='1' y='1' width='26' height='16' rx='8' fill='#d6d8db'/><circle cx='8' cy='9' r='6' fill='#fff' stroke='#bfc8d6' stroke-width='2'/></svg></span>`;
      }
      // 多选checkbox（编码、名称不可选）
      let checkbox = idx > 1 ? `<input type='checkbox' class='field-checkbox' data-idx='${idx}' style='margin-right:6px;' ${f.selected?'checked':''}>` : `<span style='display:inline-block;width:18px;'></span>`;
      return `
        <div class="attr-field-item${idx===selectedAttrIdx?' active':''}" data-field="${f.value}" data-idx="${idx}" style="display:flex;flex-direction:column;align-items:flex-start;gap:0;padding:10px 12px;position:relative;">
          <div style='display:flex;align-items:center;width:100%;'>
            ${checkbox}
            <span style="color:#2176c7;font-weight:500;">${main}</span>
            ${icon}
          </div>
          ${sub}
        </div>
      `;
    }).join('');
  // 绑定点击选中
  Array.from(list.querySelectorAll('.attr-field-item')).forEach(item => {
    item.onclick = function(e) {
      // 禁用/启用/checkbox点击不切换选中
      if(e.target.closest('.field-enable-icon') || e.target.classList.contains('field-checkbox')) return;
      selectedAttrIdx = parseInt(this.getAttribute('data-idx'));
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  });
  // 绑定启用/禁用切换
  Array.from(list.querySelectorAll('.field-enable-icon')).forEach(icon => {
    icon.onclick = function(e) {
      e.stopPropagation();
      const idx = parseInt(this.getAttribute('data-idx'));
      attrFields[idx].enabled = !attrFields[idx].enabled;
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  });
  // 绑定checkbox多选
  Array.from(list.querySelectorAll('.field-checkbox')).forEach(cb => {
    cb.onclick = function(e) {
      e.stopPropagation();
      const idx = parseInt(this.getAttribute('data-idx'));
      attrFields[idx].selected = this.checked;
    }
  });
  // 绑定批量删除
  const batchDeleteBtn = document.getElementById('batchDeleteBtn');
  if(batchDeleteBtn) {
    batchDeleteBtn.onclick = function(e) {
      e.stopPropagation();
      // 只删除勾选的，且idx>1
      attrFields = attrFields.filter((f, idx) => idx<=1 || !f.selected);
      // 重置选中
      if(selectedAttrIdx >= attrFields.length) selectedAttrIdx = attrFields.length-1;
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  }
  // 渲染右侧属性
  renderAttrDetailBox();
}
window.toggleFieldStatus = function(value) {
  attrFields = attrFields.map(f => f.value===value ? { ...f, status: f.status==='normal'?'deleted':'normal' } : f);
  renderAttrFieldList();
}
// 字段库弹窗逻辑
const fieldLibModal = document.getElementById('fieldLibModal');
document.body.addEventListener('click', function(e) {
  const btn = e.target.closest('#openFieldLibBtn');
  if (btn) {
    renderFieldLibTable();
    fieldLibModal.style.display = 'flex';
  }
  if(e.target && (e.target.id==='closeFieldLibModal'||e.target.id==='fieldLibCancelBtn')) {
    fieldLibModal.style.display = 'none';
  }
  if(e.target && e.target.id==='fieldLibAddBtn') {
    // 添加所选字段
    const checked = Array.from(document.querySelectorAll('.field-lib-checkbox:checked')).map(cb=>cb.value);
    checked.forEach(val => {
      if(!attrFields.some(f=>f.value===val)) {
        const field = FIELD_LIBRARY.find(f=>f.value===val);
        if(field) attrFields.push({ ...field, status: 'normal' });
      } else {
        // 如果已存在但被删除，恢复为正常
        attrFields = attrFields.map(f=>f.value===val ? { ...f, status: 'normal' } : f);
      }
    });
    renderAttrFieldList();
    fieldLibModal.style.display = 'none';
  }
  // tab-attr 上一步、下一步
  if(e.target && e.target.id==='modalPrevBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // 切换到基本配置
    document.querySelectorAll('.modal-step').forEach(t=>t.classList.remove('active'));
    document.querySelector('.modal-step[data-step="base"]').classList.add('active');
    document.querySelectorAll('.modal-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-base').style.display = '';
    updateStepBar('base');
  }
  if(e.target && e.target.id==='modalNextBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // 切换到业务规则
    document.querySelectorAll('.modal-step').forEach(t=>t.classList.remove('active'));
    document.querySelector('.modal-step[data-step="rule"]').classList.add('active');
    document.querySelectorAll('.modal-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-rule').style.display = '';
    updateStepBar('rule');
  }
  // 属性配置保存
  if(e.target && e.target.id==='modalSaveBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // 只允许模型名称和模型描述可编辑
    document.querySelector('input[name="name"]').removeAttribute('readonly');
    document.querySelector('textarea[name="desc"]').removeAttribute('readonly');
    // 其它输入框禁用
    document.querySelectorAll('#tab-base input, #tab-base select, #tab-base textarea').forEach(el => {
      if(el.name!=='name' && el.name!=='desc') el.setAttribute('readonly','readonly');
      if(el.tagName==='SELECT' && el.name!=='name' && el.name!=='desc') el.setAttribute('disabled','disabled');
    });
  }
  // 基本配置页保存
  if(e.target && e.target.id==='modalSaveBtn' && document.querySelector('.modal-step.active').dataset.step==='base') {
    // 判断模型分类
    const cat = document.getElementById('modelCategorySelect').value;
    if(cat==='多视图模型' || cat==='引用分类多视图') {
      // 如果视图信息区域未显示，则渲染
      renderViewList();
      // 如果没有视图，自动添加一行
      if(!window.viewList || window.viewList.length===0) {
        window.viewList = [{name:'',desc:''}];
        renderViewList();
      }
      // 滚动到视图信息区域
      const viewListBox = document.getElementById('viewListBox');
      if(viewListBox) viewListBox.scrollIntoView({behavior:'smooth',block:'center'});
    }
  }
});
function renderFieldLibTable() {
  const tbody = document.getElementById('fieldLibTableBody');
  tbody.innerHTML = FIELD_LIBRARY.map(f => `
    <tr>
      <td><input type="checkbox" class="field-lib-checkbox" value="${f.value}" ${attrFields.some(a=>a.value===f.value&&a.status==='normal')?'checked disabled':''}></td>
      <td>${f.value}</td>
      <td>${f.name}</td>
    </tr>
  `).join('');
}
renderAttrFieldList();

// 模拟主数据模型和属性
const MASTER_MODELS = [
  { code: 'mdm1', name: '主数据模型A', fields: [ { code: 'f1', name: '属性A1' }, { code: 'f2', name: '属性A2' } ] },
  { code: 'mdm2', name: '主数据模型B', fields: [ { code: 'f3', name: '属性B1' }, { code: 'f4', name: '属性B2' } ] },
  { code: 'mdm3', name: '主数据模型C', fields: [ { code: 'f5', name: '属性C1' }, { code: 'f6', name: '属性C2' } ] },
];
function updateRefMasterOptions() {
  const refMaster = document.getElementById('refMasterSelect');
  if (!refMaster) return;
  refMaster.innerHTML = MASTER_MODELS.map(m => `<option value="${m.code}">${m.name}</option>`).join('');
  updateRefFieldOptions();
}
function updateRefFieldOptions() {
  const refMaster = document.getElementById('refMasterSelect');
  const refField = document.getElementById('refFieldSelect');
  if (!refMaster || !refField) return;
  const model = MASTER_MODELS.find(m => m.code === refMaster.value) || MASTER_MODELS[0];
  refField.innerHTML = model.fields.map(f => `<option value="${f.code}">${f.name}</option>`).join('');
}
function updateRefRowVisibility() {
  const cat = document.getElementById('modelCategorySelect').value;
  const refRow = document.querySelector('.ref-row');
  if (cat === '引用分类模型' || cat === '引用分类多视图') {
    refRow.style.display = '';
    document.getElementById('refMasterSelect').setAttribute('required', 'required');
    document.getElementById('refFieldSelect').setAttribute('required', 'required');
  } else {
    refRow.style.display = 'none';
    document.getElementById('refMasterSelect').removeAttribute('required');
    document.getElementById('refFieldSelect').removeAttribute('required');
  }
}
document.addEventListener('DOMContentLoaded', function() {
  updateRefMasterOptions();
  updateRefRowVisibility();
  document.getElementById('modelCategorySelect').addEventListener('change', function() {
    updateRefRowVisibility();
    renderViewList();
  });
  document.getElementById('refMasterSelect').addEventListener('change', function() {
    updateRefFieldOptions();
  });
});
// 视图信息动态渲染
function renderViewList() {
  const cat = document.getElementById('modelCategorySelect').value;
  let viewListBox = document.getElementById('viewListBox');
  let viewInfoBtn = document.getElementById('viewInfoCollapseBtn');
  let viewInfoSection = document.getElementById('viewInfoSection');
  if(!viewListBox || !viewInfoBtn || !viewInfoSection) return;
  if(cat==='多视图模型'||cat==='引用分类多视图') {
    viewInfoBtn.style.display = '';
    viewInfoSection.style.display = '';
    viewListBox.style.display = '';
    if(!window.viewList) window.viewList = [];
    const viewOptions = ["人事视图","财务视图","生产视图"];
    viewListBox.innerHTML = `
      <div style='margin-bottom:8px;display:flex;justify-content:flex-end;align-items:center;'>
        <button type='button' class='btn-modern' id='addViewRowBtn' style='margin-bottom:0;'>添加</button>
      </div>
      <table style='width:100%;margin-bottom:8px;'>
        <thead><tr><th style='width:120px;'>视图名称</th><th style='width:40px;'>操作</th></tr></thead>
        <tbody id='viewListTbody'>
          ${window.viewList.map((v,i)=>`<tr><td><select class='view-name' data-idx='${i}' style='width:110px;'>${viewOptions.map(opt=>`<option value='${opt}'${v.name===opt?" selected":''}>${opt}</option>`).join('')}</select></td><td><button type='button' class='table-link-delete' onclick='deleteViewRow(${i})'>删除</button></td></tr>`).join('')}
        </tbody>
      </table>`;
    document.getElementById('addViewRowBtn').onclick = function() {
      window.viewList.push({name:viewOptions[0],desc:''});
      renderViewList();
    };
    // 删除
    window.deleteViewRow = function(idx) { window.viewList.splice(idx,1); renderViewList(); };
    // 输入同步
    viewListBox.querySelectorAll('.view-name').forEach(select=>{
      select.onchange = function(){ window.viewList[this.dataset.idx].name = this.value; };
    });
  } else {
    viewInfoBtn.style.display = 'none';
    viewInfoSection.style.display = 'none';
    viewListBox.style.display = 'none';
    viewListBox.innerHTML = '';
  }
}
document.addEventListener('DOMContentLoaded', function() {
  // ...已有代码...
  document.getElementById('modelCategorySelect').addEventListener('change', function() {
    updateRefRowVisibility();
    renderViewList();
  });
  renderViewList();
  // ...已有代码...
});
// 折叠/展开逻辑
let isBaseInfoCollapsed = false;
let isViewInfoCollapsed = false;
function updateSectionCollapse() {
  const baseBtn = document.getElementById('baseInfoCollapseBtn');
  const baseSec = document.getElementById('baseInfoSection');
  const viewBtn = document.getElementById('viewInfoCollapseBtn');
  const viewSec = document.getElementById('viewInfoSection');
  if(isBaseInfoCollapsed) {
    baseBtn.classList.add('collapsed');
    baseSec.classList.add('collapsed');
  } else {
    baseBtn.classList.remove('collapsed');
    baseSec.classList.remove('collapsed');
  }
  if(isViewInfoCollapsed) {
    viewBtn.classList.add('collapsed');
    viewSec.classList.add('collapsed');
  } else {
    viewBtn.classList.remove('collapsed');
    viewSec.classList.remove('collapsed');
  }
}
document.addEventListener('DOMContentLoaded', function() {
  // ...已有代码...
  document.getElementById('baseInfoCollapseBtn').onclick = function() {
    isBaseInfoCollapsed = !isBaseInfoCollapsed;
    updateSectionCollapse();
  };
  document.getElementById('viewInfoCollapseBtn').onclick = function() {
    isViewInfoCollapsed = !isViewInfoCollapsed;
    updateSectionCollapse();
  };
  updateSectionCollapse();
});
// 步骤条底部按钮跳转逻辑
function renderFooter(tab) {
  const step = tab.dataset ? tab.dataset.tab || tab.dataset.step : tab;
  if(step === 'attr') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
      <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
    `;
  } else if(step === 'rule') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
      <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
    `;
  } else if(step === 'code') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
      <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
    `;
  } else if(step === 'layout') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
      <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
      <button type="button" class="btn-modern" id="modalFinishBtn">提交</button>
      <button type="button" class="btn-modern" id="modalPublishBtn">发布并提交</button>
    `;
  } else {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
      <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
    `;
  }
}
// 步骤条按钮跳转
footer.onclick = function(e) {
  const activeStep = document.querySelector('.modal-step.active');
  const idx = stepOrder.indexOf(activeStep.dataset.step);
  if(e.target.id==='modalNextBtn' && idx < stepOrder.length-1) {
    stepOrder.forEach(s=>document.getElementById('tab-'+s).style.display='none');
    document.getElementById('tab-'+stepOrder[idx+1]).style.display='';
    updateStepBar(stepOrder[idx+1]);
    renderFooter({dataset:{tab:stepOrder[idx+1]}});
  }
  if(e.target.id==='modalPrevBtn' && idx > 0) {
    stepOrder.forEach(s=>document.getElementById('tab-'+s).style.display='none');
    document.getElementById('tab-'+stepOrder[idx-1]).style.display='';
    updateStepBar(stepOrder[idx-1]);
    renderFooter({dataset:{tab:stepOrder[idx-1]}});
  }
  // 保存、提交、发布并提交可自定义逻辑
  if(e.target.id==='modalSaveBtn') { alert('保存成功！'); }
  if(e.target.id==='modalFinishBtn') { alert('提交成功！'); }
  if(e.target.id==='modalPublishBtn') { alert('发布并提交成功！'); }
}
// ========== 步骤条与底部按钮逻辑 ========== //
document.addEventListener('DOMContentLoaded', function() {
  const stepOrder = ['base','attr','rule','code','layout'];
  const stepEls = document.querySelectorAll('.modal-step');
  const footer = document.querySelector('.modal-footer-fixed');
  function updateStepBar(activeStep) {
    stepEls.forEach((el,idx)=>{
      el.classList.remove('active','done');
      if(stepOrder.indexOf(activeStep)>idx) el.classList.add('done');
      else if(stepOrder.indexOf(activeStep)===idx) el.classList.add('active');
      // 对勾
      const idxSpan = el.querySelector('.step-index');
      if(el.classList.contains('done')) idxSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8" fill="#4db6ac"/><path d="M4 8l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>';
      else idxSpan.textContent = (idx+1);
    });
  }
  function renderFooter(tab) {
    const step = tab.dataset ? tab.dataset.tab || tab.dataset.step : tab;
    if(step === 'attr' || step === 'rule' || step === 'code') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
        <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
      `;
    } else if(step === 'layout') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">上一步</button>
        <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
        <button type="button" class="btn-modern" id="modalFinishBtn">提交</button>
        <button type="button" class="btn-modern" id="modalPublishBtn">发布并提交</button>
      `;
    } else {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalSaveBtn">保存</button>
        <button type="button" class="btn-modern" id="modalNextBtn">下一步</button>
      `;
    }
    bindFooterEvents();
  }
  function showStep(idx) {
    stepOrder.forEach((s,i)=>{
      document.getElementById('tab-'+s).style.display = i===idx?'':'none';
    });
    updateStepBar(stepOrder[idx]);
    renderFooter({dataset:{tab:stepOrder[idx]}});
  }
  function bindFooterEvents() {
    document.getElementById('modalPrevBtn') && (document.getElementById('modalPrevBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx>0) showStep(idx-1);
    });
    document.getElementById('modalNextBtn') && (document.getElementById('modalNextBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx<stepOrder.length-1) showStep(idx+1);
    });
    document.getElementById('modalSaveBtn') && (document.getElementById('modalSaveBtn').onclick = function() { alert('保存成功！'); });
    document.getElementById('modalFinishBtn') && (document.getElementById('modalFinishBtn').onclick = function() { alert('提交成功！'); });
    document.getElementById('modalPublishBtn') && (document.getElementById('modalPublishBtn').onclick = function() { alert('发布并提交成功！'); });
  }
  // 步骤条点击切换
  stepEls.forEach((el,idx)=>{
    el.onclick = function(){ showStep(idx); };
  });
  // 页面初始化时高亮第一个
  showStep(0);
});
</script>
</body>
</html> 