<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>业务规则配置</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f7faff; margin:0; font-size: 13px; }
    .container { max-width: 1100px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(33,118,199,0.10); padding: 32px 36px 28px 36px; font-size: 13px; }
    .section-title { color: #2176c7; font-size: 17px; font-weight: 600; margin-bottom: 18px; }
    .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .btn-main { background: #2176c7; color: #fff; border: none; border-radius: 4px; padding: 0 18px; height: 36px; font-size: 13px; display: flex; align-items: center; font-weight: 500; transition: background 0.18s; }
    .btn-main:hover { background: #185a99; }
    .btn-line { background: #fff; color: #444; border: 1px solid #d0d7de; border-radius: 4px; padding: 0 14px; height: 36px; font-size: 13px; display: flex; align-items: center; transition: background 0.18s, border 0.18s; }
    .btn-line:hover { background: #f5f7fa; border-color: #b0b8c1; }
    .table-wrap { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(33, 118, 199, 0.06); padding: 18px 0 0 0; overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; background: #fff; min-width: 900px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left; white-space: nowrap; }
    th { background: #f4f8fb; color: #2176c7; font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f0f6fd; }
    td.center { text-align: center; }
    .modal-mask { display:none; position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:2000; }
    .drawer-content { position:fixed;top:0;right:-616px;width:616px;height:100vh;background:#fff;box-shadow:-4px 0 24px rgba(33,118,199,0.13);transition:right 0.3s ease;overflow:hidden;display:flex;flex-direction:column; }
    .drawer-header { background:#2176c7;color:#fff;font-size:18px;font-weight:500;padding:16px 24px;display:flex;justify-content:space-between;align-items:center; }
    .drawer-body { flex:1;overflow-y:auto;padding:24px; padding-bottom:96px; }
    .drawer-footer { padding:14px 24px;border-top:1px solid #e3eaf3;display:flex;justify-content:flex-end;gap:18px;background:#fff;z-index:10;position:sticky;bottom:0; }
    .drawer-close { cursor:pointer;font-size:22px; }
    .form-row { display:flex;align-items:center;margin-bottom:18px; }
    .form-label { width:120px;color:#185a99;font-size:13px;text-align:right;margin-right:8px; }
    .form-value { flex:1; }
    .form-value input, .form-value select, .form-value textarea { width:70%;padding:6px 10px;border:1.2px solid #c0d3eb;border-radius:4px;font-size:13px;background:#f9fbfd; }
    .required { color:#e53935; margin-left:2px; font-size:13px; }
    .condition-group { background:#f6f8fa; border-radius:6px; padding:12px 16px; margin-bottom:12px; max-height:300px; overflow-y:auto; }
    .condition-row { display:flex;align-items:center;gap:8px;margin-bottom:8px; }
    .condition-row:last-child { margin-bottom:0; }
    .condition-op { width:56px; }
    .condition-field { width:98px; }
    .condition-value { width:84px; }
    .condition-btn { background:#eaf3fb; color:#2176c7; border:none; border-radius:4px; padding:2px 10px; font-size:13px; cursor:pointer; margin-left:6px; white-space:nowrap; }
    .condition-btn:hover { background:#d0e7fa; }
    .adv-toggle { color:#2176c7; cursor:pointer; font-size:13px; margin-left:8px; }
    .adv-area { margin-top:8px; }
    .op-btn { background:none;border:none;color:#2176c7;cursor:pointer;font-size:13px;padding:0 8px; }
    .op-btn.op-del { color:#e74c3c; }
    /* 1. 状态开关样式 */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      vertical-align: middle;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2176c7;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .switch-label {
      margin-left: 8px;
      font-size: 13px;
      color: #2176c7;
      vertical-align: middle;
    }
    /* 2. 条件设置支持组合 */
    .cond-group-wrap { margin-bottom: 18px; border: 1px solid #e3eaf3; border-radius: 6px; padding: 12px; background: #f8fafc; }
    .cond-group-head { display: flex; align-items: center; margin-bottom: 8px; }
    .cond-group-logic { margin-right: 10px; }
    .cond-group-del { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 13px; margin-left: 8px; }
    .cond-items { margin-left: 18px; }
    .cond-item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .cond-item-row:last-child { margin-bottom: 0; }
    .cond-item-del { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 13px; }
    .cond-add-btn, .cond-group-add-btn { color: #2176c7; background: none; border: none; cursor: pointer; font-size: 13px; margin-top: 6px; }
    .drawer-body #condDrawerArea { max-height: 60vh; overflow-y: auto; }
    /* Modern style for .condition-builder */
    .condition-builder {
        padding: 18px;
        border: 1.5px solid #e0e6ed;
        border-radius: 12px;
        background: #fafdff;
        box-shadow: 0 2px 12px rgba(33,118,199,0.07);
    }
    .condition-builder .condition-group {
        padding: 18px;
        border: 1.5px dashed #b6c6e3;
        border-radius: 10px;
        background: #fff;
        margin-top: 14px;
        box-shadow: 0 2px 8px rgba(33,118,199,0.04);
    }
    .condition-builder .condition-group .condition-group {
        margin-left: 24px;
        border-left: 2.5px solid #2176c7;
    }
    .condition-builder .group-controls {
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
    }
    .condition-builder .condition-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr) auto;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
        font-size: 13px;
    }
    .condition-builder .condition-row > * {
        min-width: 0;
    }
    .condition-builder .group-placeholder {
        padding: 22px;
        text-align: center;
        color: #b0b8c1;
        background-color: #f4f8fb;
        border-radius: 6px;
        border: 1.5px dashed #d0d7de;
        font-size: 13px;
    }
    .condition-builder .form-select, .condition-builder .form-control {
        border-radius: 8px;
        border: 1.5px solid #d0d7de;
        background: #fafdff;
        font-size: 13px;
        padding: 8px 14px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: none;
    }
    .condition-builder .form-select:focus, .condition-builder .form-control:focus {
        border-color: #2176c7;
        box-shadow: 0 0 0 2px #e3f0fc;
        outline: none;
        background: #fff;
    }
    .condition-builder .btn, .condition-builder .btn-sm {
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.18s, box-shadow 0.18s, border 0.18s;
        box-shadow: 0 1px 4px rgba(33,118,199,0.06);
        border: none;
    }
    .condition-builder .btn-primary {
        background: linear-gradient(90deg, #2176c7 60%, #5fa8e6 100%);
        color: #fff;
    }
    .condition-builder .btn-primary:hover {
        background: linear-gradient(90deg, #185a99 60%, #2176c7 100%);
    }
    .condition-builder .btn-secondary {
        background: #e3eaf3;
        color: #2176c7;
    }
    .condition-builder .btn-secondary:hover {
        background: #d0d7de;
        color: #185a99;
    }
    .condition-builder .btn-danger.delete-condition-btn {
        min-width: 44px;
        padding: 6px 0;
        font-size: 13px;
        text-align: center;
        background: linear-gradient(90deg, #e53935 60%, #ff6f60 100%);
        color: #fff;
        border: none;
        box-shadow: 0 1px 4px rgba(229,57,53,0.08);
    }
    .condition-builder .btn-danger.delete-condition-btn:hover {
        background: linear-gradient(90deg, #b71c1c 60%, #e53935 100%);
    }
    /* 调整条件设置抽屉宽度 */
    .drawer-content#condDrawerContent {
        width: 800px !important;
        max-width: 95vw;
    }
    /* 只保留一层条件编辑区域，去除多余嵌套样式影响 */
    .drawer-body #condDrawerArea > .condition-builder {
        border: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
    }
    .drawer-body #condDrawerArea > .condition-builder > .condition-group {
        margin-top: 0;
    }
    /* 校验字段设置卡片和现代输入风格 */
    .field-group {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(33,118,199,0.07);
        border: 1.5px solid #e0e6ed;
        padding: 18px 16px 14px 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: box-shadow 0.2s, border 0.2s;
    }
    .field-group:hover {
        box-shadow: 0 4px 16px rgba(33,118,199,0.13);
        border-color: #2176c7;
    }
    .field-group .form-control, .field-group .form-select {
        width: 80%;
        font-size: 13px;
        border-radius: 8px;
        border: 1.5px solid #d0d7de;
        background: #fafdff;
        padding: 8px 14px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: none;
    }
    .field-group .form-control:focus, .field-group .form-select:focus {
        border-color: #2176c7;
        box-shadow: 0 0 0 2px #e3f0fc;
        outline: none;
        background: #fff;
    }
    .field-group .btn-danger.del-field-group {
        min-width: 44px;
        padding: 6px 0;
        font-size: 13px;
        text-align: center;
        background: linear-gradient(90deg, #e53935 60%, #ff6f60 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(229,57,53,0.08);
        transition: background 0.18s;
    }
    .field-group .btn-danger.del-field-group:hover {
        background: linear-gradient(90deg, #b71c1c 60%, #e53935 100%);
    }
    /* 美化"添加一组"按钮 */
    #fieldGroupList + .btn-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        min-width: 0;
        justify-content: center;
        font-size: 13px;
        font-weight: 500;
        border-radius: 8px;
        padding: 10px 0;
        background: linear-gradient(90deg, #2176c7 60%, #5fa8e6 100%);
        color: #fff;
        box-shadow: 0 1px 4px rgba(33,118,199,0.08);
        border: none;
        transition: background 0.18s, box-shadow 0.18s;
    }
    #fieldGroupList + .btn-primary:hover {
        background: linear-gradient(90deg, #185a99 60%, #2176c7 100%);
    }
    #fieldGroupList + .btn-primary .icon {
        font-size: 18px;
        display: inline-flex;
        align-items: center;
    }
    /* 在原有样式后追加美化多选下拉的CSS */
    select[multiple] {
      min-height: 38px;
      border: 1.5px solid #b6c6e3;
      border-radius: 8px;
      background: #fafdff;
      font-size: 13px;
      padding: 8px 14px;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }
    select[multiple]:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px #e3f0fc;
      background: #fff;
    }
    select[multiple] option {
      padding: 6px 10px;
      border-radius: 4px;
      margin: 2px 0;
    }
    #addUniqueCardBtn {
      width: 90%;
      max-width: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1.5px solid #2176c7;
      color: #2176c7;
      border-radius: 6px;
      padding: 6px 0;
      font-size: 13px;
      cursor: pointer;
      gap: 5px;
      box-shadow: none;
      transition: background 0.18s, color 0.18s, border 0.18s;
      height: 32px;
      margin: 6px auto 4px auto;
    }
    #addUniqueCardBtn:hover {
      background: #2176c7;
      color: #fff;
    }
    #addUniqueCardBtn .icon {
      font-size: 16px;
      display: inline-flex;
      align-items: center;
    }
    .multi-select-wrap {
      position: relative;
    }
    .multi-select-input {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      min-height: 25px;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      padding: 1px 4px 1px 4px;
      background: #fff;
      cursor: pointer;
    }
    .multi-select-hidden-input {
      border: none;
      outline: none;
      flex: 1 1 28px;
      min-width: 28px;
      height: 19px;
      background: transparent;
      padding: 0;
      margin: 0;
      display: inline-block;
    }
    .multi-select-option {
      padding: 6px 12px;
      cursor: pointer;
      background: #fff;
    }
    .multi-select-option:hover {
      background: #f4f7fa;
    }
    .multi-select-option.selected {
      color: #2176c7;
    }
    .multi-tag {
      display: inline-block;
      padding: 1px 4px;
      margin: 1px;
      border-radius: 3px;
      background: #e0e6ed;
    }
    .multi-tag-close {
      margin-left: 2px;
      cursor: pointer;
    }
    .multi-select-dropdown {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      width: 100%;
      background: #fff;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      box-shadow: 0 2px 12px rgba(33,118,199,0.10);
      z-index: 10;
      max-height: 180px;
      overflow: auto;
    }
    .multi-select-input, .form-control {
      min-height: 36px !important;
      height: 36px !important;
      box-sizing: border-box;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      font-size: 15px;
      padding: 2px 10px 2px 10px;
      background: #fff;
      width: 100%;
      display: flex;
      align-items: center;
    }
    .multi-select-input {
      flex-wrap: wrap;
      cursor: pointer;
      padding: 2px 10px 2px 10px;
    }
    .multi-select-hidden-input {
      border: none;
      outline: none;
      flex: 1 1 28px;
      min-width: 28px;
      height: 28px;
      background: transparent;
      padding: 0;
      margin: 0;
      display: inline-block;
      font-size: 15px;
    }
    select.form-control {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #fff;
      padding-right: 30px;
      cursor: pointer;
    }
    .multi-tag {
      display: inline-block;
      padding: 1px 8px;
      margin: 1px;
      border-radius: 3px;
      background: #e0e6ed;
      font-size: 15px;
      height: 28px;
      line-height: 26px;
      vertical-align: middle;
    }
    
    /* 联合校验区域样式 */
    #jointValidationArea {
      transition: all 0.3s ease;
      border-left: 3px solid #2176c7;
      padding-left: 16px;
      margin-left: 8px;
      background: linear-gradient(90deg, rgba(33,118,199,0.03) 0%, rgba(33,118,199,0.01) 100%);
      border-radius: 0 8px 8px 0;
    }
    
    /* 联合校验开关标签样式 */
    .switch-label {
      margin-left: 8px;
      font-size: 13px;
      color: #2176c7;
      vertical-align: middle;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section-title">业务规则配置</div>
    <div class="action-bar">
      <button class="btn-main" id="addBtn">新增规则</button>
    </div>
    <div class="table-wrap">
      <table id="ruleTable">
        <thead>
          <tr>
            <th>规则名称</th>
            <th>规则类型</th>
            <!--<th>校验类型</th>-->
            <th>状态</th>
            <th>创建人</th>
            <th>创建时间</th>
            <th style="text-align:center;">操作</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <!-- 新增/编辑抽屉 -->
  <div class="modal-mask" id="editDrawerMask">
    <div class="drawer-content" id="editDrawerContent">
      <div class="drawer-header">
        <span id="drawerTitle">新增业务规则</span>
        <span class="drawer-close" id="drawerClose">×</span>
      </div>
      <form id="editForm">
        <div class="drawer-body" style="overflow-y:auto;max-height:calc(100vh - 120px);">
          <div class="form-row">
            <div class="form-label">规则名称<span class="required">*</span>：</div>
            <div class="form-value"><input type="text" id="editName" required style="width:308px"></div>
          </div>
          <div class="form-row">
            <div class="form-label">规则类型<span class="required">*</span>：</div>
            <div class="form-value">
              <select id="editType" required style="width:70%">
                <option value="唯一性校验">唯一性校验</option>
                <option value="约束条件校验">约束条件校验</option>
                <option value="必填规则">必填规则</option>
                <option value="只读规则">只读规则</option>
                <option value="赋值规则">赋值规则</option>
                <option value="显隐规则">显隐规则</option>
                <option value="数据联动">数据联动</option>
              </select>
            </div>
          </div>
          <div id="ruleDetailArea"></div>
          <div class="form-row">
            <div class="form-label">状态：</div>
            <div class="form-value">
              <label class="switch"><input type="checkbox" id="editStatusSwitch"><span class="slider"></span></label>
            </div>
          </div>
        </div>
        <div class="drawer-footer">
          <button type="submit" class="btn-main">保存</button>
          <button type="button" class="btn-line" id="drawerCancel">取消</button>
        </div>
      </form>
    </div>
  </div>
  <!-- 条件设置抽屉 -->
  <div class="modal-mask" id="condDrawerMask">
    <div class="drawer-content" id="condDrawerContent">
      <div class="drawer-header">
        <span>条件设置</span>
        <span class="drawer-close" id="condDrawerClose">×</span>
      </div>
      <form id="condForm">
        <div class="drawer-body">
          <div id="condDrawerArea" class="condition-builder"></div>
        </div>
        <div class="drawer-footer">
          <button type="button" class="btn-main" id="condDrawerSave">保存</button>
          <button type="button" class="btn-line" id="condDrawerCancel">取消</button>
        </div>
      </form>
    </div>
  </div>

  <!-- 校验字段抽屉 -->
  <div class="modal-mask" id="fieldDrawerMask">
    <div class="drawer-content" id="fieldDrawerContent">
      <div class="drawer-header">
        <span>校验字段设置</span>
        <span class="drawer-close" id="fieldDrawerClose">×</span>
      </div>
      <form id="fieldForm">
        <div class="drawer-body">
          <div id="fieldDrawerArea" class="condition-builder"></div>
        </div>
        <div class="drawer-footer">
          <button type="button" class="btn-main" id="fieldDrawerSave">保存</button>
          <button type="button" class="btn-line" id="fieldDrawerCancel">取消</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // 规则数据
    let rules = [];
    let editIdx = -1;
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = rules.map((item, idx) => `
        <tr>
          <td>${item.name}</td>
          <td>${item.type}</td>
          <!--<td>${item.type === '校验规则' ? (item.detail && item.detail.validateType ? item.detail.validateType : '-') : '-'}</td>-->
          <td><label class="switch"><input type="checkbox" ${item.status==='启用'?'checked':''} onchange="toggleRowStatus(${idx})"><span class="slider"></span></label><span class="switch-label">${item.status}</span></td>
          <td>${item.creator || '管理员'}</td>
          <td>${item.createTime}</td>
          <td class="center">
            <!-- <button type="button" onclick="showCondDrawer(${idx})" class="op-btn">条件设置</button><button type="button" onclick="showFieldDrawer(${idx})" class="op-btn">校验字段</button> -->
            <button type="button" onclick="editRule(${idx})" class="op-btn">编辑</button>
            <button type="button" onclick="deleteRule(${idx})" class="op-btn op-del">删除</button>
          </td>
        </tr>
      `).join('');
    }
    renderTable();
    document.getElementById('addBtn').onclick = function() {
      editIdx = -1;
      var drawerTitle = document.getElementById('drawerTitle');
      if (drawerTitle) drawerTitle.textContent = '新增业务规则';
      var editName = document.getElementById('editName');
      if (editName) editName.value = '';
      var editType = document.getElementById('editType');
      if (editType) editType.value = '校验规则';
      var editStatusSwitch = document.getElementById('editStatusSwitch');
      if (editStatusSwitch) editStatusSwitch.checked = true;
      var editStatusLabel = document.getElementById('editStatusLabel');
      if (editStatusLabel) editStatusLabel.textContent = '启用';
      var ruleDetailArea = document.getElementById('ruleDetailArea');
      if (ruleDetailArea) ruleDetailArea.innerHTML = '';
      renderRuleDetail('校验规则', null);
      showDrawer();
    };
    document.getElementById('drawerClose').onclick = document.getElementById('drawerCancel').onclick = function() {
      hideDrawer();
    };
    document.getElementById('editType').onchange = function() {
      renderRuleDetail(this.value, null);
    };
    // 显示抽屉
    function showDrawer() {
      document.getElementById('editDrawerMask').style.display = 'block';
      setTimeout(() => {
        document.getElementById('editDrawerContent').style.right = '0';
      }, 10);
    }
    // 隐藏抽屉
    function hideDrawer() {
      document.getElementById('editDrawerContent').style.right = '-616px';
      setTimeout(() => {
        document.getElementById('editDrawerMask').style.display = 'none';
      }, 300);
    }
    // 编辑
    window.editRule = function(idx) {
      editIdx = idx;
      const item = rules[idx];
      var drawerTitle = document.getElementById('drawerTitle');
      if (drawerTitle) drawerTitle.textContent = '编辑业务规则';
      var editName = document.getElementById('editName');
      if (editName) editName.value = item.name;
      var editType = document.getElementById('editType');
      if (editType) editType.value = item.type;
      var editStatusSwitch = document.getElementById('editStatusSwitch');
      if (editStatusSwitch) editStatusSwitch.checked = item.status === '启用';
      var editStatusLabel = document.getElementById('editStatusLabel');
      if (editStatusLabel) editStatusLabel.textContent = item.status;
      renderRuleDetail(item.type, item.detail);
      showDrawer();
    };
    // 删除
    window.deleteRule = function(idx) {
      if (!confirm('确定要删除该规则吗？')) return;
      rules.splice(idx, 1);
      renderTable();
    };
    // 保存
    document.getElementById('editForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const type = document.getElementById('editType').value;
      const status = document.getElementById('editStatusSwitch').checked ? '启用' : '停用';
      const createTime = new Date().toLocaleString();
      const detail = collectRuleDetail(type);
      if (!name) { alert('规则名称为必填项！'); return; }
      if (!detail) return;
      if (editIdx === -1) {
        rules.push({ name, type, status, creator: '管理员', createTime, detail });
      } else {
        rules[editIdx] = { name, type, status, creator: '管理员', createTime, detail };
      }
      renderTable();
      hideDrawer();
    };
    // 规则类型表单渲染
    function renderRuleDetail(type, detail) {
      const area = document.getElementById('ruleDetailArea');
      let html = '';
      if (type === '唯一性校验' || type === '约束条件校验') {
        // 原校验规则+校验类型逻辑
        html += `<div class='form-row'><div class='form-label'>规则级别：</div><div class='form-value'><select id='validateLevel'><option value='错误型校验规则'>错误型校验规则</option><option value='警告型校验规则'>警告型校验规则</option></select></div></div>`;
        html += `<div class='form-row'><div class='form-label'>校验提示信息：</div><div class='form-value'><input id='validateMsg' placeholder='提示内容'></div></div>`;
        
        if (type === '唯一性校验') {
          // 先初始化唯一性校验数据
          if (!window.uniqueCards || !window.uniqueCards[0]) {
            window.uniqueCards = [{ 
              uniqueAttr: '', 
              uniqueAttrArr: [], 
              uniqueMaster: '', 
              uniqueMasterAttr: '', 
              uniqueMasterAttrArr: [],
              enableJointValidation: false, // 新增：是否启用联合校验
              caseSensitive: false, // 新增：区分大小写
              ignoreAllSpace: true, // 新增：忽略所有空格，默认true
              ignoreFullHalf: false // 新增：不区分全角半角
            }];
          }
          
          // 如果是编辑模式，恢复保存的数据
          if (detail) {
            window.uniqueCards[0].uniqueAttr = detail.uniqueAttr || '';
            window.uniqueCards[0].uniqueAttrArr = detail.uniqueAttrArr || [];
            window.uniqueCards[0].enableJointValidation = detail.enableJointValidation || false;
            window.uniqueCards[0].uniqueMaster = detail.uniqueMaster || '';
            window.uniqueCards[0].uniqueMasterAttr = detail.uniqueMasterAttr || '';
            window.uniqueCards[0].uniqueMasterAttrArr = detail.uniqueMasterAttrArr || [];
            window.uniqueCards[0].caseSensitive = detail.caseSensitive || false;
            window.uniqueCards[0].ignoreAllSpace = detail.ignoreAllSpace !== false;
            window.uniqueCards[0].ignoreFullHalf = detail.ignoreFullHalf || false;
          }
          
          // 唯一性校验表单区域
          html += `
            <div class='form-row'>
              <div class='form-label'>属性</div>
              <div class='form-value'>
                <div class='multi-select-wrap' style='width:100%;position:relative;'>
                  <div class='multi-select-input' tabindex='0' style='width:100%;' data-idx='0'>
                    ${(window.uniqueCards[0].uniqueAttrArr||[]).map(attr=>`<span class='multi-tag'>${attr}<span class='multi-tag-close' data-value='${attr}' style='margin-left:2px;cursor:pointer;'>&times;</span></span>`).join('')}
                    <input class='multi-select-hidden-input' style='border:none;outline:none;flex:1 1 40px;min-width:40px;height:28px;background:transparent;padding:0;margin:0;display:inline-block;' readonly placeholder='请选择属性，可多选'>
                  </div>
                  <div class='multi-select-dropdown' style='display:none;position:absolute;top:110%;left:0;width:100%;background:#fff;border:1.5px solid #d0d7de;border-radius:7px;box-shadow:0 2px 12px rgba(33,118,199,0.10);z-index:10;max-height:180px;overflow:auto;'></div>
                </div>
              </div>
            </div>
            <div id='uniqueOptionsRow' style='margin-top:0;margin-bottom:18px;display:flex;justify-content:flex-start;'>
              <div style='display:flex;align-items:center;gap:28px;margin-left:120px;'>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='caseSensitive' ${(window.uniqueCards[0].caseSensitive)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>区分大小写</span></label>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='ignoreAllSpace' ${(window.uniqueCards[0].ignoreAllSpace!==false)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>忽略所有空格</span></label>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='ignoreFullHalf' ${(window.uniqueCards[0].ignoreFullHalf)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>区分全角半角</span></label>
              </div>
            </div>
            <div class='form-row'>
              <div class='form-label'>联合校验：</div>
              <div class='form-value' style='display:flex;align-items:center;gap:8px;'>
                <label class="switch">
                  <input type="checkbox" id="jointValidationSwitch" ${(window.uniqueCards[0].enableJointValidation || false) ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
                <span class="joint-help-icon" style="font-size:16px;color:#2176c7;border-radius:50%;border:1px solid #b6c6e3;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;line-height:18px;cursor:pointer;margin-left:6px;position:relative;z-index:101;">?
                  <span class="joint-help-pop" style="display:none;position:absolute;left:24px;top:50%;transform:translateY(-50%);background:#fff;border:1px solid #b6c6e3;border-radius:6px;padding:8px 14px;box-shadow:0 2px 8px rgba(33,118,199,0.13);font-size:13px;min-width:220px;z-index:999;white-space:normal;">校验当前输入值与另一个主数据模型中的对应属性值，确保数据在两个模型中同时保持唯一</span>
                </span>
              </div>
            </div>
            <div id="jointValidationArea" style="display: ${(window.uniqueCards[0].enableJointValidation || false) ? 'block' : 'none'};">
              <div class='form-row'>
                <div class='form-label'>主数据</div>
                <div class='form-value'>
                  <select class='form-control' style='width:100%;' id='uniqueMasterSelect'>
                    <option value=''>请选择主数据</option>
                    <option value='master1' ${(window.uniqueCards[0].uniqueMaster === 'master1') ? 'selected' : ''}>主数据1</option>
                    <option value='master2' ${(window.uniqueCards[0].uniqueMaster === 'master2') ? 'selected' : ''}>主数据2</option>
                    <option value='master3' ${(window.uniqueCards[0].uniqueMaster === 'master3') ? 'selected' : ''}>主数据3</option>
                  </select>
                </div>
              </div>
              <div class='form-row'>
                <div class='form-label'>主数据属性</div>
                <div class='form-value'>
                  <select id='uniqueMasterAttrSelect' style='width:100%;'>
                    <option value=''>请选择主数据属性</option>
                    <option value='客户名称' ${(window.uniqueCards[0].uniqueMasterAttr==="客户名称")?'selected':''}>客户名称</option>
                    <option value='客户编码' ${(window.uniqueCards[0].uniqueMasterAttr==="客户编码")?'selected':''}>客户编码</option>
                    <option value='供应商名称' ${(window.uniqueCards[0].uniqueMasterAttr==="供应商名称")?'selected':''}>供应商名称</option>
                    <option value='供应商编码' ${(window.uniqueCards[0].uniqueMasterAttr==="供应商编码")?'selected':''}>供应商编码</option>
                    <option value='物料名称' ${(window.uniqueCards[0].uniqueMasterAttr==="物料名称")?'selected':''}>物料名称</option>
                    <option value='物料编码' ${(window.uniqueCards[0].uniqueMasterAttr==="物料编码")?'selected':''}>物料编码</option>
                    <option value='使用单位名称' ${(window.uniqueCards[0].uniqueMasterAttr==="使用单位名称")?'selected':''}>使用单位名称</option>
                    <option value='使用单位编码' ${(window.uniqueCards[0].uniqueMasterAttr==="使用单位编码")?'selected':''}>使用单位编码</option>
                  </select>
                </div>
              </div>
            </div>
          `;
          // 适用条件和状态区域
          html += `<div id='uniqueCondStatusArea'></div>`;
        } else if (type === '约束条件校验') {
          // 新增：校验类型下拉
          let validateType = (detail && detail.validateType) || '正则表达式校验';
          html += `<div class='form-row'><div class='form-label'>校验类型：</div><div class='form-value'><select id='validateTypeSelect' style='width:70%'><option value='正则表达式校验' ${validateType==='正则表达式校验'?'selected':''}>正则表达式校验</option><option value='约束表达式' ${validateType==='约束表达式'?'selected':''}>约束表达式</option></select></div></div>`;
          // 正则表达式输入框
          html += `<div class='form-row' id='regexRow' style='display:${validateType==='正则表达式校验'?'flex':'none'};'><div class='form-label'>正则表达式：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='regexInput' class='form-control' style='width:100%;' placeholder='请输入或选择正则表达式'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='选择正则表达式' id='regexSelectBtn'>🔍</span></div></div>`;
          // 约束表达式输入框
          html += `<div class='form-row' id='constraintRuleRow' style='display:${validateType==='约束表达式'?'flex':'none'};'><div class='form-label'>约束规则：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='constraintRuleInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑约束规则'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='约束规则编辑' id='constraintRuleBtn'>🔍</span></div></div>`;
          html += `<div class='form-row'><div class='form-label'>适用条件：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='constraintCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='适用条件编辑' id='constraintCondBtn'>🔍</span></div></div>`;
        }
      } else if (type === '必填规则' || type === '显隐规则') {
        // 显隐规则增加操作字段
        if (type === '显隐规则') {
          html += `<div class='form-row'><div class='form-label'>操作：</div><div class='form-value'><select id='showHideType' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'><option value='显示'>显示</option><option value='隐藏'>隐藏</option></select></div></div>`;
        }
        // 字段下拉单选，label为"模型属性"
        const fieldOptions = [
          { name: '客户名称', code: 'customerName' },
          { name: '客户编码', code: 'customerCode' },
          { name: '供应商名称', code: 'supplierName' },
          { name: '供应商编码', code: 'supplierCode' },
          { name: '物料名称', code: 'materialName' },
          { name: '物料编码', code: 'materialCode' },
          { name: '使用单位名称', code: 'useUnitName' },
          { name: '使用单位编码', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.fields) {
          selected = detail.fields;
        }
        html += `<div class='form-row'><div class='form-label'>模型属性：</div><div class='form-value'>`;
        html += `<select id='fieldsInput' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择模型属性</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // 适用条件字段
        html += `<div class='form-row'><div class='form-label'>适用条件：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='requiredCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='适用条件编辑' id='requiredCondBtn'>🔍</span>
        </div></div>`;
      } else if (type === '只读规则') {
        // 字段下拉单选，label为"模型属性"
        const fieldOptions = [
          { name: '客户名称', code: 'customerName' },
          { name: '客户编码', code: 'customerCode' },
          { name: '供应商名称', code: 'supplierName' },
          { name: '供应商编码', code: 'supplierCode' },
          { name: '物料名称', code: 'materialName' },
          { name: '物料编码', code: 'materialCode' },
          { name: '使用单位名称', code: 'useUnitName' },
          { name: '使用单位编码', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.fields) {
          selected = detail.fields;
        }
        html += `<div class='form-row'><div class='form-label'>模型属性：</div><div class='form-value'>`;
        html += `<select id='fieldsInput' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择模型属性</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // 适用条件字段
        html += `<div class='form-row'><div class='form-label'>适用条件：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='readonlyCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='适用条件编辑' id='readonlyCondBtn'>🔍</span>
        </div></div>`;
      } else if (type === '赋值规则') {
        // 字段和操作符选项
        const fieldOptions = [
          { name: '客户名称', code: 'customerName' },
          { name: '客户编码', code: 'customerCode' },
          { name: '供应商名称', code: 'supplierName' },
          { name: '供应商编码', code: 'supplierCode' },
          { name: '物料名称', code: 'materialName' },
          { name: '物料编码', code: 'materialCode' },
          { name: '使用单位名称', code: 'useUnitName' },
          { name: '使用单位编码', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.assignField) {
          selected = detail.assignField;
        }
        // "当模型属性"字段改为下拉单选
        let triggerSelected = '';
        if (detail && detail.assignTrigger) {
          triggerSelected = detail.assignTrigger;
        }
        html += `<div class='form-row'><div class='form-label'>当模型属性：</div><div class='form-value'>`;
        html += `<select id='assignTrigger' style='width: 75%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择模型属性</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${triggerSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select><span style='margin-left:8px;color:#888;'>发生变化时</span></div></div>`;
        html += `<div class='form-row'><div class='form-label'>赋值于：</div><div class='form-value'>`;
        html += `<select id='assignField' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择字段</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // 新增：值等于 下拉
        let valueEqualSelected = '';
        if (detail && detail.valueEqual) {
          valueEqualSelected = detail.valueEqual;
        }
        html += `<div class='form-row'><div class='form-label'>值等于：</div><div class='form-value'>`;
        html += `<select id='valueEqual' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择模型属性</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${valueEqualSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // 新增：引用属性 下拉
        let refAttrSelected = '';
        if (detail && detail.refAttr) {
          refAttrSelected = detail.refAttr;
        }
        html += `<div class='form-row'><div class='form-label'>引用属性：</div><div class='form-value'>`;
        html += `<select id='refAttr' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>请选择模型属性</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${refAttrSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // 赋值表达式字段
        html += `<div class='form-row'><div class='form-label'>赋值表达式：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='assignExpr' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑' value='${detail && detail.assignExpr ? detail.assignExpr : ''}'>
          <span class='expr-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='表达式编辑' id='assignExprBtn'>🔍</span>
        </div></div>`;
        // 适用条件字段
        html += `<div class='form-row'><div class='form-label'>适用条件：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='assignCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='适用条件编辑' id='assignCondBtn'>🔍</span>
        </div></div>`;
      } else if (type === '数据联动' || type === '数据联动规则') {
        // 字段选项
        const fieldOptions = [
          { name: '客户名称', code: 'customerName' },
          { name: '客户编码', code: 'customerCode' },
          { name: '供应商名称', code: 'supplierName' },
          { name: '供应商编码', code: 'supplierCode' },
          { name: '物料名称', code: 'materialName' },
          { name: '物料编码', code: 'materialCode' },
          { name: '使用单位名称', code: 'useUnitName' },
          { name: '使用单位编码', code: 'useUnitCode' },
          { name: '市', code: 'city' }
        ];
        // 先渲染"当模型属性"
        html += `<div class='form-row'><div class='form-label'>当模型属性：</div><div class='form-value'><input id='linkageTrigger' placeholder='如：省' value='${detail && detail.linkageTrigger ? detail.linkageTrigger : ''}' style='width:70%;'><span style='margin-left:8px;color:#888;'>发生变化时</span></div></div>`;
        // 仅在规则类型为"数据联动规则"时显示联动字段和联动条件
        if (type === '数据联动规则') {
          // 联动字段下拉单选
          html += `<div class='form-row'><div class='form-label'>联动字段：</div><div class='form-value'><select id='linkageField' style='width:70%;'>`;
          html += `<option value=''>请选择联动字段</option>`;
          html += fieldOptions.map(opt => `<option value='${opt.code}' ${(detail && detail.linkageField===opt.code)?'selected':''}>${opt.name}</option>`).join('');
          html += `</select></div></div>`;
          // 新增：联动条件（引用属性下拉）
          html += `<div class='form-row'><div class='form-label'>联动条件：</div><div class='form-value'><select id='linkageRefAttr' style='width:70%;'>`;
          html += `<option value=''>请选择引用属性</option>`;
          html += fieldOptions.map(opt => `<option value='${opt.code}' ${(detail && detail.linkageRefAttr===opt.code)?'selected':''}>${opt.name}</option>`).join('');
          html += `</select></div></div>`;
        }
        // 联动表达式输入
        html += `<div class='form-row'><div class='form-label'>联动表达式：</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>`;
        html += `<input id='linkageExpr' placeholder='city.province = province' value='${detail && detail.linkageExpr ? detail.linkageExpr : ''}' style='width:100%;padding-right:36px;'>`;
        html += `<span id='exprEditBtn' style='position:absolute;right:8px;cursor:pointer;font-size:18px;color:#2176c7;' title='表达式编辑'>🔍</span>`;
        html += `</div></div>`;
      }
      area.innerHTML = html;
              // 唯一性校验卡片区域渲染
        if (type === '唯一性校验') {
          // 直接初始化多选和下拉交互
          const area = document.getElementById('ruleDetailArea');
          // 多选下拉属性列表
          const ATTR_OPTIONS = [
            '客户名称',
            '客户编码',
            '供应商名称',
            '供应商编码',
            '物料名称',
            '物料编码',
            '使用单位名称',
            '使用单位编码'
          ];
          
          // 联合校验开关事件处理
          const jointValidationSwitch = document.getElementById('jointValidationSwitch');
          const jointValidationArea = document.getElementById('jointValidationArea');
          if (jointValidationSwitch) {
            jointValidationSwitch.onchange = function() {
              const isEnabled = this.checked;
              window.uniqueCards[0].enableJointValidation = isEnabled;
              if (jointValidationArea) {
                jointValidationArea.style.display = isEnabled ? 'block' : 'none';
              }
              // 如果关闭联合校验，清空主数据相关字段
              if (!isEnabled) {
                window.uniqueCards[0].uniqueMaster = '';
                window.uniqueCards[0].uniqueMasterAttrArr = [];
                window.uniqueCards[0].uniqueMasterAttr = '';
                // 重新渲染以更新显示
                renderRuleDetail('唯一性校验');
              }
            };
          }
          
          // 主数据选择事件处理
          const uniqueMasterSelect = document.getElementById('uniqueMasterSelect');
          if (uniqueMasterSelect) {
            uniqueMasterSelect.onchange = function() {
              window.uniqueCards[0].uniqueMaster = this.value;
            };
          }
          
          // 属性多选
          const inputWrap = area.querySelector('.multi-select-input[data-idx="0"]');
          const dropdown = area.querySelector('.multi-select-dropdown');
          function renderDropdown() {
            const selected = window.uniqueCards[0].uniqueAttrArr||[];
            dropdown.innerHTML = ATTR_OPTIONS.map(opt=>`<div class='multi-select-option' data-value='${opt}' style='padding:6px 12px;cursor:pointer;background:${selected.includes(opt)?'#f4f7fa':'#fff'};'>${opt}${selected.includes(opt)?' <span style=\"color:#2176c7;\">✔</span>':''}</div>`).join('');
          }
          inputWrap.onclick = function(e) {
            e.stopPropagation();
            renderDropdown();
            dropdown.style.display = 'block';
          };
          dropdown.onclick = function(e) {
            const v = e.target.getAttribute('data-value');
            if (!v) return;
            let arr = window.uniqueCards[0].uniqueAttrArr||[];
            if (arr.includes(v)) {
              arr = arr.filter(x=>x!==v);
            } else {
              arr = arr.concat(v);
            }
            window.uniqueCards[0].uniqueAttrArr = arr;
            window.uniqueCards[0].uniqueAttr = arr.join(',');
            renderRuleDetail('唯一性校验');
          };
          inputWrap.querySelectorAll('.multi-tag-close').forEach(closeBtn => {
            closeBtn.onclick = function(ev) {
              ev.stopPropagation();
              const v = closeBtn.getAttribute('data-value');
              let arr = window.uniqueCards[0].uniqueAttrArr||[];
              arr = arr.filter(x=>x!==v);
              window.uniqueCards[0].uniqueAttrArr = arr;
              window.uniqueCards[0].uniqueAttr = arr.join(',');
              renderRuleDetail('唯一性校验');
            };
          });
          inputWrap.onblur = function() {
            setTimeout(()=>{dropdown.style.display='none';},120);
          };
          
          // 主数据属性多选（只在联合校验启用时初始化）
          if (window.uniqueCards[0].enableJointValidation) {
            const masterInputWrap = area.querySelector('.master-attr-input[data-idx="0"]');
            const masterDropdown = area.querySelector('.master-attr-dropdown');
            const MASTER_ATTR_OPTIONS = [
              '客户名称',
              '客户编码',
              '供应商名称',
              '供应商编码',
              '物料名称',
              '物料编码',
              '使用单位名称',
              '使用单位编码'
            ];
            // 可输入筛选
            let filterValue = '';
            function renderMasterDropdown() {
              const selected = window.uniqueCards[0].uniqueMasterAttrArr||[];
              const filtered = filterValue ? MASTER_ATTR_OPTIONS.filter(opt=>opt.includes(filterValue)) : MASTER_ATTR_OPTIONS;
              masterDropdown.innerHTML = filtered.map(opt=>`<div class='multi-select-option' data-value='${opt}' style='padding:6px 12px;cursor:pointer;background:${selected.includes(opt)?'#f4f7fa':'#fff'};'>${opt}${selected.includes(opt)?' <span style=\"color:#2176c7;\">✔</span>':''}</div>`).join('');
            }
            masterInputWrap.onclick = function(e) {
              e.stopPropagation();
              filterValue = '';
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
              masterInputWrap.querySelector('.multi-select-hidden-input').focus();
            };
            masterDropdown.onclick = function(e) {
              const v = e.target.getAttribute('data-value');
              if (!v) return;
              let arr = window.uniqueCards[0].uniqueMasterAttrArr||[];
              if (arr.includes(v)) {
                arr = arr.filter(x=>x!==v);
              } else {
                arr = arr.concat(v);
              }
              window.uniqueCards[0].uniqueMasterAttrArr = arr;
              window.uniqueCards[0].uniqueMasterAttr = arr.join(',');
              renderRuleDetail('唯一性校验');
            };
            masterInputWrap.querySelectorAll('.multi-tag-close').forEach(closeBtn => {
              closeBtn.onclick = function(ev) {
                ev.stopPropagation();
                const v = closeBtn.getAttribute('data-value');
                let arr = window.uniqueCards[0].uniqueMasterAttrArr||[];
                arr = arr.filter(x=>x!==v);
                window.uniqueCards[0].uniqueMasterAttrArr = arr;
                window.uniqueCards[0].uniqueMasterAttr = arr.join(',');
                renderRuleDetail('唯一性校验');
              };
            });
            // 输入筛选
            const inputEl = masterInputWrap.querySelector('.multi-select-hidden-input');
            inputEl.readOnly = false;
            inputEl.value = '';
            inputEl.oninput = function(e) {
              filterValue = inputEl.value.trim();
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
            };
            inputEl.onfocus = function() {
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
            };
            inputEl.onblur = function() {
              setTimeout(()=>{masterDropdown.style.display='none';},120);
            };
          }
          
          // 点击页面其他地方关闭所有下拉
          document.addEventListener('click', function(){
            area.querySelectorAll('.multi-select-dropdown').forEach(d=>d.style.display='none');
          });
          renderUniqueCondStatusArea();
          return;
        }
      // 约束条件校验适用条件按钮事件
      if (type === '约束条件校验') {
        const constraintRuleBtn = document.getElementById('constraintRuleBtn');
        if (constraintRuleBtn) {
          constraintRuleBtn.onclick = function() {
            const currentValue = document.getElementById('constraintRuleInput').value || '';
            const exprWindow = window.open('expression.html', '_blank', 'width=700,height=600');
            
            // 监听表达式编辑器返回的结果
            const messageHandler = function(e) {
              if (e.data && e.data.type === 'getExprInit') {
                // 表达式编辑器请求初始值
                exprWindow.postMessage({ type: 'exprInit', value: currentValue }, '*');
              } else if (e.data && e.data.type === 'exprResult') {
                // 接收到表达式结果
                document.getElementById('constraintRuleInput').value = e.data.value || '';
                window.removeEventListener('message', messageHandler);
              }
            };
            window.addEventListener('message', messageHandler);
          };
        }
        const constraintCondBtn = document.getElementById('constraintCondBtn');
        if (constraintCondBtn) {
          constraintCondBtn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }
      }
      // 赋值规则表达式编辑按钮事件
      if (type === '赋值规则') {
        setTimeout(()=>{
          const exprBtn = document.getElementById('assignExprBtn');
          if(exprBtn) exprBtn.onclick = function() {
            const exprInput = document.getElementById('assignExpr');
            const win = window.open('expression.html', '_blank', 'width=700,height=600');
            // 监听子窗口请求初始值
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'getExprInit') {
                win.postMessage({ type: 'exprInit', value: exprInput.value }, '*');
                window.removeEventListener('message', handler);
              }
            });
            // 监听子窗口回传表达式
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'exprResult') {
                exprInput.value = e.data.value;
                win.close && win.close();
                window.removeEventListener('message', handler);
              }
            });
          };
          const condBtn = document.getElementById('assignCondBtn');
          if(condBtn) condBtn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // 只读规则适用条件按钮事件
      if (type === '只读规则') {
        setTimeout(()=>{
          const btn = document.getElementById('readonlyCondBtn');
          if(btn) btn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // 必填规则和显隐规则适用条件按钮事件
      if (type === '必填规则' || type === '显隐规则') {
        setTimeout(()=>{
          const btn = document.getElementById('requiredCondBtn');
          if(btn) btn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // 数据联动规则下的联动条件查询按钮事件
      if (type === '数据联动' || type === '数据联动规则') {
        setTimeout(()=>{
          const exprBtn = document.getElementById('exprEditBtn');
          if(exprBtn) exprBtn.onclick = function() {
            const exprInput = document.getElementById('linkageExpr');
            const win = window.open('expression.html', '_blank', 'width=700,height=600');
            // 监听子窗口请求初始值
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'getExprInit') {
                win.postMessage({ type: 'exprInit', value: exprInput.value }, '*');
                window.removeEventListener('message', handler);
              }
            });
            // 监听子窗口回传表达式
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'exprResult') {
                exprInput.value = e.data.value;
                win.close && win.close();
                window.removeEventListener('message', handler);
              }
            });
          };
        }, 0);
      }
      // 约束条件校验校验类型切换逻辑
      if (type === '约束条件校验') {
        setTimeout(()=>{
          const validateTypeSelect = document.getElementById('validateTypeSelect');
          const regexRow = document.getElementById('regexRow');
          const constraintRuleRow = document.getElementById('constraintRuleRow');
          if(validateTypeSelect && regexRow && constraintRuleRow) {
            validateTypeSelect.onchange = function() {
              if(this.value==='正则表达式校验') {
                regexRow.style.display = 'flex';
                constraintRuleRow.style.display = 'none';
              } else {
                regexRow.style.display = 'none';
                constraintRuleRow.style.display = 'flex';
              }
            };
          }
          // 正则选择按钮事件（可扩展弹窗选择）
          const regexSelectBtn = document.getElementById('regexSelectBtn');
          if(regexSelectBtn) {
            regexSelectBtn.onclick = function() {
              alert('此处可弹出正则表达式选择器');
            };
          }
        },0);
      }
    }
    // 采集规则详细信息
    function collectRuleDetail(type) {
      let detail = {};
      if (type === '唯一性校验' || type === '约束条件校验') {
        // 原校验规则+校验类型逻辑
        if (type === '唯一性校验') {
          // 唯一性校验字段采集
          if (window.uniqueCards && window.uniqueCards[0]) {
            detail.uniqueAttr = window.uniqueCards[0].uniqueAttr || '';
            detail.uniqueAttrArr = window.uniqueCards[0].uniqueAttrArr || [];
            detail.enableJointValidation = window.uniqueCards[0].enableJointValidation || false;
            // 新增：采集三个选项
            detail.caseSensitive = window.uniqueCards[0].caseSensitive || false;
            detail.ignoreAllSpace = window.uniqueCards[0].ignoreAllSpace !== false;
            detail.ignoreFullHalf = window.uniqueCards[0].ignoreFullHalf || false;
            
            // 只有在启用联合校验时才采集主数据相关字段
            if (window.uniqueCards[0].enableJointValidation) {
              detail.uniqueMaster = window.uniqueCards[0].uniqueMaster || '';
              detail.uniqueMasterAttr = window.uniqueCards[0].uniqueMasterAttr || '';
              detail.uniqueMasterAttrArr = window.uniqueCards[0].uniqueMasterAttrArr || [];
            }
          }
        } else if (type === '约束条件校验') {
          // 约束条件校验不显示约束条件和提示语，所以不采集这些字段
          const constraintRuleEl = document.getElementById('constraintRuleInput');
          if (constraintRuleEl) detail.constraintRule = constraintRuleEl.value;
          const constraintCondEl = document.getElementById('constraintCondInput');
          if (constraintCondEl) detail.constraintCond = constraintCondEl.value;
        } else {
          // 其他校验类型才采集约束条件和提示语
          const constraintCondEl = document.getElementById('constraintCond');
          const constraintMsgEl = document.getElementById('constraintMsg');
          if (constraintCondEl) detail.constraintCond = constraintCondEl.value;
          if (constraintMsgEl) detail.constraintMsg = constraintMsgEl.value;
        }
        detail.validateMsg = document.getElementById('validateMsg').value;
        detail.validateLevel = document.getElementById('validateLevel').value;
      } else if (type === '必填规则') {
        detail.fields = document.getElementById('fieldsInput').value;
      } else if (type === '只读规则') {
        // 多选下拉，拼接为逗号分隔
        const select = document.getElementById('fieldsInput');
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);
        detail.fields = selected.join(',');
      } else if (type === '显隐规则') {
        detail.showHideType = document.getElementById('showHideType').value;
        detail.fields = document.getElementById('fieldsInput').value;
      } else if (type === '赋值规则') {
        detail.assignField = document.getElementById('assignField').value;
        detail.valueEqual = document.getElementById('valueEqual').value;
        detail.refAttr = document.getElementById('refAttr').value;
        detail.assignExpr = document.getElementById('assignExpr').value;
        detail.assignTrigger = document.getElementById('assignTrigger').value;
      } else if (type === '数据联动' || type === '数据联动规则') {
        detail.linkageTrigger = document.getElementById('linkageTrigger').value;
        detail.linkageField = document.getElementById('linkageField').value;
        detail.linkageRefAttr = document.getElementById('linkageRefAttr').value;
        detail.linkageExpr = document.getElementById('linkageExpr').value;
      }
      return detail;
    }
    // 2. 条件设置抽屉逻辑
    function showCondDrawer(idx) {
      window.currentCondIdx = idx;
      document.getElementById('condDrawerMask').style.display = 'block';
      setTimeout(()=>{document.getElementById('condDrawerContent').style.right='0';},10);
    }
    function hideCondDrawer() {
      document.getElementById('condDrawerContent').style.right = '-616px';
      setTimeout(()=>{document.getElementById('condDrawerMask').style.display='none';},300);
    }
    document.getElementById('condDrawerClose').onclick = document.getElementById('condDrawerCancel').onclick = hideCondDrawer;
    // 3. 校验字段抽屉逻辑
    function showFieldDrawer(idx) {
      window.currentFieldIdx = idx;
      document.getElementById('fieldDrawerMask').style.display = 'block';
      setTimeout(()=>{document.getElementById('fieldDrawerContent').style.right='0';},10);
    }
    function hideFieldDrawer() {
      document.getElementById('fieldDrawerContent').style.right = '-616px';
      setTimeout(()=>{document.getElementById('fieldDrawerMask').style.display='none';},300);
    }
    document.getElementById('fieldDrawerClose').onclick = document.getElementById('fieldDrawerCancel').onclick = hideFieldDrawer;
    // 替换条件设置抽屉内容为condition_new.html功能，并激活JS逻辑
    function renderCondDrawerInit() {
      const condDrawerArea = document.getElementById('condDrawerArea');
      condDrawerArea.innerHTML = '';
      // 创建条件编辑区域
      const builder = document.createElement('div');
      builder.className = 'condition-builder';
      condDrawerArea.appendChild(builder);

      // 以下为condition_new.html核心JS逻辑，目标容器为builder
      const mainModelFields = ['客户编码', '客户名称', '供应商编码', '供应商名称', '物料编码', '物料名称'];
      const subModelFields = [...mainModelFields, '使用单位名称', '使用单位编码'];
      const relationOptions = ['等于', '不等于', '大于', '小于', '大于等于', '小于等于', '包含', '不包含'];

      function createGroupElement(data = { logic: 'AND', children: [] }) {
        const groupEl = document.createElement('div');
        groupEl.className = 'condition-group';
        const isRoot = !data.isSubgroup;
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'group-controls';
        controlsDiv.innerHTML = `
          <button class="btn btn-primary btn-sm add-condition-btn">＋ 条件</button>
          <button class="btn btn-secondary btn-sm add-group-btn">＋ 分组</button>
          ${!isRoot ? '<button class="btn btn-danger btn-sm delete-group-btn ms-auto">删除分组</button>' : ''}
        `;
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'group-children';
        let conditionIdx = 0;
        if (data.children) {
          data.children.forEach((childData, idx) => {
            if (childData.type === 'group') {
              childData.isSubgroup = true;
              const childGroupEl = createGroupElement(childData);
              childrenContainer.appendChild(childGroupEl);
            } else {
              const rowWrapper = document.createElement('div');
              rowWrapper.style.display = 'flex';
              rowWrapper.style.alignItems = 'center';
              if (conditionIdx > 0) {
                const logicSelect = document.createElement('select');
                logicSelect.className = 'form-select form-select-sm logic-between-select';
                logicSelect.style.width = '110px';
                logicSelect.style.marginRight = '8px';
                logicSelect.innerHTML = `
                  <option value="AND" ${childData.logic === 'AND' ? 'selected' : ''}>并且</option>
                  <option value="OR" ${childData.logic === 'OR' ? 'selected' : ''}>或者</option>
                `;
                rowWrapper.appendChild(logicSelect);
              }
              const childConditionEl = createConditionElement(childData);
              rowWrapper.appendChild(childConditionEl);
              childrenContainer.appendChild(rowWrapper);
              conditionIdx++;
            }
          });
        }
        const placeholderDiv = document.createElement('div');
        placeholderDiv.className = 'group-placeholder';
        placeholderDiv.style.display = 'none';
        placeholderDiv.innerText = '使用上方按钮添加条件或子分组';
        groupEl.appendChild(controlsDiv);
        groupEl.appendChild(childrenContainer);
        groupEl.appendChild(placeholderDiv);
        updateGroupPlaceholder(groupEl);
        return groupEl;
      }
      function createConditionElement(data = {}) {
        const conditionEl = document.createElement('div');
        conditionEl.className = 'condition-row';
        const currentFields = ['客户编码', '客户名称', '供应商编码', '供应商名称', '物料编码', '物料名称', '使用单位名称', '使用单位编码'];
        const relationOptions = ['等于', '不等于', '大于', '小于', '大于等于', '小于等于', '包含', '不包含'];
        conditionEl.innerHTML = `
          <select class="form-select field-select">
            ${currentFields.map(f => `<option value=\"${f}\" ${data.field === f ? 'selected' : ''}>${f}</option>`).join('')}
          </select>
          <select class="form-select relation-select">
            ${relationOptions.map(r => `<option value=\"${r}\" ${data.relation === r ? 'selected' : ''}>${r}</option>`).join('')}
          </select>
          <input type="text" class="form-control value-input" value="${data.value || ''}">
          <button class="btn btn-danger btn-sm delete-condition-btn delete-condition-btn">删除</button>
        `;
        return conditionEl;
      }
      function updateGroupPlaceholder(groupEl) {
        if (!groupEl) return;
        const childrenContainer = groupEl.querySelector('.group-children');
        const placeholder = groupEl.querySelector('.group-placeholder');
        if (placeholder) {
          placeholder.style.display = childrenContainer.children.length === 0 ? 'block' : 'none';
        }
      }
      // 事件委托
      builder.addEventListener('click', function(e) {
        const groupEl = e.target.closest('.condition-group');
        if (!groupEl) return;
        if (e.target.classList.contains('add-condition-btn')) {
          const childrenContainer = groupEl.querySelector('.group-children');
          const isFirst = childrenContainer.querySelectorAll('.condition-row, .condition-group').length === 0;
          const newCond = isFirst ? { type: 'condition' } : { type: 'condition', logic: 'AND' };
          const groupData = parseGroup(groupEl);
          groupData.children.push(newCond);
          const newGroupEl = createGroupElement(groupData);
          groupEl.replaceWith(newGroupEl);
        }
        if (e.target.classList.contains('add-group-btn')) {
          const childrenContainer = groupEl.querySelector('.group-children');
          const groupData = parseGroup(groupEl);
          groupData.children.push({ type: 'group', logic: 'AND', children: [], isSubgroup: true });
          const newGroupEl = createGroupElement(groupData);
          groupEl.replaceWith(newGroupEl);
        }
        if (e.target.classList.contains('delete-condition-btn')) {
          const rowWrapper = e.target.closest('div[style*="display: flex"]') || e.target.closest('.condition-row');
          if (rowWrapper) rowWrapper.remove();
          updateGroupPlaceholder(groupEl);
        }
        if (e.target.classList.contains('delete-group-btn')) {
          const parentGroup = groupEl.parentElement.closest('.condition-group');
          groupEl.remove();
          updateGroupPlaceholder(parentGroup);
        }
      });
      function parseGroup(element) {
        const children = [];
        const childrenContainer = element.querySelector('.group-children');
        let conditionIdx = 0;
        for (const child of childrenContainer.children) {
          const conditionRow = child.querySelector('.condition-row');
          if (conditionRow) {
            const cond = parseCondition(conditionRow);
            if (conditionIdx > 0) {
              const logicSelect = child.querySelector('.logic-between-select');
              cond.logic = logicSelect ? logicSelect.value : 'AND';
            }
            children.push(cond);
            conditionIdx++;
          } else if (child.classList.contains('condition-group')) {
            children.push(parseGroup(child));
          }
        }
        return { type: 'group', children };
      }
      function parseCondition(element) {
        return {
          type: 'condition',
          field: element.querySelector('.field-select').value,
          relation: element.querySelector('.relation-select').value,
          value: element.querySelector('.value-input').value.trim()
        };
      }
      // 初始化为空分组
      builder.innerHTML = '';
      const defaultGroup = { logic: 'AND', children: [] };
      builder.appendChild(createGroupElement(defaultGroup));
    }
    // 每次打开条件设置抽屉时初始化
    const oldShowCondDrawer = window.showCondDrawer;
    window.showCondDrawer = function(idx) {
      oldShowCondDrawer(idx);
      renderCondDrawerInit();
    }
    // 校验字段弹窗多组录入功能
    function renderFieldDrawerInit() {
      const area = document.getElementById('fieldDrawerContent').querySelector('.drawer-body');
      area.innerHTML = '';
      
      // 获取当前规则的校验类型
      const currentRule = rules[window.currentFieldIdx];
      const isGeneralValidation = currentRule && currentRule.detail && currentRule.detail.validateType === '约束条件校验';
      
      // 字段名称与编码映射
      const fieldOptions = [
        { name: '客户名称', code: 'customerName' },
        { name: '客户编码', code: 'customerCode' },
        { name: '供应商名称', code: 'supplierName' },
        { name: '供应商编码', code: 'supplierCode' },
        { name: '物料名称', code: 'materialName' },
        { name: '物料编码', code: 'materialCode' },
        { name: '使用单位名称', code: 'useUnitName' },
        { name: '使用单位编码', code: 'useUnitCode' }
      ];
      
      if (isGeneralValidation) {
        // 一般性校验：只显示字段名称（下拉）和字段编码（自动赋值）
        const title = document.createElement('div');
        title.style.cssText = 'font-size: 16px; font-weight: 600; color: #2176c7; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e3eaf3;';
        title.textContent = '唯一性校验设置';
        area.appendChild(title);
        
        const groupList = document.createElement('div');
        groupList.id = 'fieldGroupList';
        area.appendChild(groupList);
        
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-primary btn-sm';
        addBtn.innerHTML = '<span class="icon">＋</span>添加';
        addBtn.style.margin = '12px 0';
        area.appendChild(addBtn);
        
        function createFieldGroup(data = {}) {
          const group = document.createElement('div');
          group.className = 'field-group';
          group.style.display = 'flex';
          group.style.alignItems = 'center';
          group.style.gap = '12px';
          group.style.marginBottom = '12px';
          
          // 字段名称下拉
          const select = document.createElement('select');
          select.className = 'form-select field-name-select';
          select.style.width = '180px';
          select.innerHTML = '<option value="">校验属性</option>' +
            fieldOptions.map(opt => `<option value="${opt.code}" ${data.fieldCode===opt.code?'selected':''}>${opt.name}</option>`).join('');
          
          // 字段编码输入框（只读）
          const codeInput = document.createElement('input');
          codeInput.className = 'form-control field-code-input';
          codeInput.placeholder = '字段编码';
          codeInput.style.width = '180px';
          codeInput.readOnly = true;
          codeInput.value = data.fieldCode || '';
          
          // 选择字段名称时自动赋值编码
          select.onchange = function() {
            const selected = fieldOptions.find(opt => opt.code === select.value);
            codeInput.value = selected ? selected.code : '';
          };
          // 初始化时自动赋值
          if (select.value) {
            const selected = fieldOptions.find(opt => opt.code === select.value);
            codeInput.value = selected ? selected.code : '';
          }
          
          // 删除按钮
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'btn btn-danger btn-sm del-field-group';
          delBtn.style.minWidth = '44px';
          delBtn.textContent = '删除';
          delBtn.onclick = function() {
            group.remove();
          };
          
          group.appendChild(select);
          group.appendChild(codeInput);
          group.appendChild(delBtn);
          return group;
        }
        
        function addFieldGroup(data) {
          groupList.appendChild(createFieldGroup(data));
        }
        
        addBtn.onclick = function() { addFieldGroup({}); };
        // 默认先加一组
        addFieldGroup({});
        
      } else {
        // 其他校验类型：保持原有逻辑
        const groupList = document.createElement('div');
        groupList.id = 'fieldGroupList';
        area.appendChild(groupList);
        
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-primary btn-sm';
        addBtn.innerHTML = '<span class="icon">＋</span>添加';
        addBtn.style.margin = '12px 0';
        area.appendChild(addBtn);
        
        function createFieldGroup(data = {}) {
          const group = document.createElement('div');
          group.className = 'field-group';
          group.style.display = 'flex';
          group.style.alignItems = 'center';
          group.style.gap = '8px';
          group.style.marginBottom = '10px';
          group.innerHTML = `
            <input class="form-control field-input" placeholder="校验属性" value="${data.field||''}" style="width:120px;">
            <select class="form-select master-type" style="width:120px;">
              <option value="">主数据类型</option>
              <option value="客户" ${data.masterType==='客户'?'selected':''}>客户</option>
              <option value="产品" ${data.masterType==='产品'?'selected':''}>产品</option>
              <option value="供应商" ${data.masterType==='供应商'?'selected':''}>供应商</option>
            </select>
            <select class="form-select master-field" style="width:120px;">
              <option value="">属性字段</option>
              <option value="编码" ${data.masterField==='编码'?'selected':''}>编码</option>
              <option value="名称" ${data.masterField==='名称'?'selected':''}>名称</option>
              <option value="类型" ${data.masterField==='类型'?'selected':''}>类型</option>
            </select>
            <button type="button" class="btn btn-danger btn-sm del-field-group">删除</button>
          `;
          return group;
        }
        
        function addFieldGroup(data) {
          groupList.appendChild(createFieldGroup(data));
        }
        
        addBtn.onclick = function() { addFieldGroup({}); };
        groupList.onclick = function(e) {
          if (e.target.classList.contains('del-field-group')) {
            e.target.parentElement.remove();
          }
        };
        
        // 默认先加一组
        addFieldGroup({});
      }
    }
    // 打开校验字段弹窗时初始化
    const oldShowFieldDrawer = window.showFieldDrawer;
    window.showFieldDrawer = function(idx) {
      oldShowFieldDrawer(idx);
      renderFieldDrawerInit();
    }
    // 唯一性校验适用条件和状态区域渲染
    function renderUniqueCondStatusArea() {
      const area = document.getElementById('uniqueCondStatusArea');
      if (!area) return;
      area.innerHTML = `<div class='form-row' style='margin-top:8px;'>
        <div class='form-label'>适用条件：</div>
        <div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='uniqueCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='点击右侧按钮编辑'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='适用条件编辑' id='uniqueCondBtn'>🔍</span>
        </div>
      </div>`;
      document.getElementById('uniqueCondBtn').onclick = function() {
        window.open('condition_new.html', '_blank', 'width=800,height=600');
      };
    }
    // 新增：三个选项事件处理
    const caseSensitive = document.getElementById('caseSensitive');
    const ignoreAllSpace = document.getElementById('ignoreAllSpace');
    const ignoreFullHalf = document.getElementById('ignoreFullHalf');
    if (caseSensitive) {
      caseSensitive.onchange = function() {
        window.uniqueCards[0].caseSensitive = this.checked;
      };
    }
    if (ignoreAllSpace) {
      ignoreAllSpace.onchange = function() {
        window.uniqueCards[0].ignoreAllSpace = this.checked;
      };
    }
    if (ignoreFullHalf) {
      ignoreFullHalf.onchange = function() {
        window.uniqueCards[0].ignoreFullHalf = this.checked;
      };
    }
    // 在renderRuleDetail函数结尾处，绑定select事件和帮助气泡事件
    setTimeout(()=>{
      // 主数据属性下拉单选采集
      const uniqueMasterAttrSelect = document.getElementById('uniqueMasterAttrSelect');
      if(uniqueMasterAttrSelect){
        uniqueMasterAttrSelect.onchange = function(){
          window.uniqueCards[0].uniqueMasterAttr = this.value;
          window.uniqueCards[0].uniqueMasterAttrArr = this.value ? [this.value] : [];
        };
      }
      // 联合校验帮助气泡
      const helpIcon = document.querySelector('.joint-help-icon');
      const helpPop = document.querySelector('.joint-help-pop');
      if (helpIcon && helpPop) {
        helpIcon.onmouseenter = () => { helpPop.style.display = 'block'; };
        helpIcon.onmouseleave = () => { helpPop.style.display = 'none'; };
        helpPop.onmouseenter = () => { helpPop.style.display = 'block'; };
        helpPop.onmouseleave = () => { helpPop.style.display = 'none'; };
      }
    },0);
  </script>
</body>
</html> 
</html> 