<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>é¡µé¢å¸ƒå±€é…ç½®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f7faff; margin:0; font-size: 14px; }
    .setup-container { max-width: 1400px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(33,118,199,0.10); padding: 32px 36px 28px 36px; display: flex; gap: 32px; }
    .setup-left { flex: 1.2; min-width: 420px; border-right: 1px solid #e0e6ed; padding-right: 32px; }
    .setup-right { flex: 2; min-width: 500px; padding-left: 32px; }
    .setup-title { color: #2176c7; font-size: 18px; font-weight: 600; margin-bottom: 18px; }
    .tab-bar { display: flex; gap: 16px; margin-bottom: 18px; }
    .tab-bar button { background: #f4f8fb; border: none; border-radius: 4px 4px 0 0; padding: 8px 24px; font-size: 15px; color: #2176c7; cursor: pointer; }
    .tab-bar button.active { background: #2176c7; color: #fff; }
    .config-section { margin-bottom: 24px; }
    .config-label { font-weight: 500; color: #185a99; margin-bottom: 6px; display: block; }
    .config-row { display: flex; align-items: center; gap: 16px; margin-bottom: 10px; }
    .config-row label { min-width: 120px; color: #444; }
    .config-row input[type="checkbox"] { margin-right: 6px; }
    .config-row select, .config-row input[type="text"] { padding: 4px 8px; border: 1px solid #c0d3eb; border-radius: 3px; font-size: 13px; }
    .draggable-list { border: 1px solid #c0d3eb; border-radius: 6px; background: #f8fafc; padding: 12px; min-height: 60px; margin-bottom: 10px; }
    .draggable-item { background: #e3eaf3; border-radius: 4px; padding: 6px 12px; margin-bottom: 6px; cursor: grab; display: flex; align-items: center; justify-content: space-between; }
    .draggable-item:last-child { margin-bottom: 0; }
    .drag-handle { margin-right: 8px; color: #2176c7; cursor: grab; }
    .preview-title { font-size: 16px; color: #2176c7; font-weight: 600; margin-bottom: 12px; }
    .preview-area { background: #f0f6fd; border: 1px solid #c0d3eb; border-radius: 6px; padding: 18px; min-height: 320px; }
    .btn-bar { display: flex; gap: 16px; margin-top: 24px; }
    .btn-main { background: #4db6ac; color: #fff; border: none; border-radius: 4px; padding: 0 18px; height: 36px; font-size: 14px; display: flex; align-items: center; font-weight: 500; transition: background 0.18s; }
    .btn-main:hover { background: #399488; }
    .btn-line { background: #fff; color: #444; border: 1px solid #d0d7de; border-radius: 4px; padding: 0 14px; height: 36px; font-size: 14px; display: flex; align-items: center; transition: background 0.18s, border 0.18s; }
    .btn-line:hover { background: #f5f7fa; border-color: #b0b8c1; }
    .field-config-row { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
    .field-config-row label { min-width: 60px; }
    .field-config-row input, .field-config-row select { width: 90px; }
    .tab-preview-bar { display:flex; gap:0; border-bottom:2px solid #e0e6ed; margin-bottom:18px; }
    .tab-preview-btn { background:none; border:none; outline:none; font-size:15px; color:#2176c7; padding:8px 32px; cursor:pointer; border-radius:8px 8px 0 0; border-bottom:2px solid transparent; transition:background 0.18s, color 0.18s, border-bottom 0.18s; margin-right:2px; }
    .tab-preview-btn.active { background:#f4f8fb; color:#185a99; border-bottom:2px solid #2176c7; font-weight:600; }
    .modern-select {
      border: 1.2px solid #c0d3eb;
      border-radius: 6px;
      padding: 6px 18px 6px 10px;
      font-size: 14px;
      background: #f9fbfd;
      transition: border 0.18s, box-shadow 0.18s;
      outline: none;
    }
    .modern-select:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px #e3eaf3;
    }
    .btn-modern {
      background: none;
      color: #2176c7;
      border: none;
      border-radius: 6px;
      padding: 5px 16px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
    }
    .btn-modern:hover {
      background: #e3eaf3;
      color: #185a99;
    }
    .sort-row-flex { display: flex; align-items: center; gap: 8px; justify-content: flex-start; position: relative; }
    .sort-row-delete { position: absolute; right: 12px; }
    .field-group-title {
      font-weight: 600;
      color: #185a99;
      margin: 8px 0 4px 0;
      font-size: 13px;
    }
    .model-field-item {
      padding: 6px 10px;
      margin-bottom: 6px;
      background: #fff;
      border: 1px solid #c0d3eb;
      border-radius: 4px;
      cursor: grab;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .field-type {
      font-size: 12px;
      color: #888;
      background: #f4f8fb;
      border-radius: 3px;
      padding: 1px 6px;
    }
    .canvas-field-remove:hover { color: #c62828; }
    .btn-preview-modern {
      background: #fff;
      color: #222;
      border: 1.5px solid #e0e6ed;
      border-radius: 10px;
      padding: 0 12px;
      height: 30px;
      font-size: 14px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background 0.18s, color 0.18s, border 0.18s;
    }
    .btn-preview-modern:hover {
      background: #f4f8fb;
      color: #2176c7;
      border-color: #b0c4de;
    }
    .btn-preview-text { font-size: 14px; }
    .btn-save-modern {
      background: #18191a;
      color: #fff;
      border: none;
      border-radius: 10px;
      padding: 0 32px;
      height: 48px;
      font-size: 20px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.18s, color 0.18s;
    }
    .btn-save-modern:hover {
      background: #444;
    }
    .icon-eye {
      display:inline-block;width:22px;height:22px;background:url('data:image/svg+xml;utf8,<svg fill="none" stroke="%23000" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><circle cx="12" cy="12" r="3.5"/><path d="M2 12s3.5-7 10-7 10 7 10 7-3.5 7-10 7S2 12 2 12Z"/></svg>') center/contain no-repeat;vertical-align:middle;}
    .icon-save {
      display:inline-block;width:22px;height:22px;background:url('data:image/svg+xml;utf8,<svg fill="none" stroke="%23fff" stroke-width="2" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><rect x="3" y="3" width="18" height="18" rx="2"/><path d="M7 3v6h10V3"/></svg>') center/contain no-repeat;vertical-align:middle;}
    .input-modern {
      border: 1.5px solid #c0d3eb;
      border-radius: 8px;
      padding: 7px 14px;
      font-size: 15px;
      background: #f9fbfd;
      transition: border 0.18s, box-shadow 0.18s;
      outline: none;
    }
    .input-modern:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px #e3eaf3;
    }
    .checkbox-modern {
      width:18px;height:18px;accent-color:#2176c7;vertical-align:middle;
    }
    #previewModal, #previewDrawer { z-index: 9999 !important; }
    /* æŠ˜å /å±•å¼€æ ·å¼ */
    .section-collapse-title,
    .section-collapse-title * {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: #2176c7 !important;
    }
    .section-collapse-title {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-bottom: 8px;
      margin-top: 10px;
    }
    .section-collapse-title svg {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .section-collapse-title.collapsed svg {
      transform: rotate(-90deg);
    }
    .section-content {
      transition: max-height 0.2s, opacity 0.2s;
      overflow: hidden;
    }
    .section-content.collapsed {
      max-height: 0 !important;
      opacity: 0;
      padding: 0 !important;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="setup-container" style="transform:scale(0.9);transform-origin:top center;">
    <!-- é¡¶éƒ¨æ“ä½œæŒ‰é’®åŒº -->
    <div style="position:absolute;top:36px;right:136px;z-index:10;display:flex;gap:18px;">
      <button class="btn-preview-modern" onclick="previewConfig()"><span class="icon-eye"></span> <span class="btn-preview-text">é¢„è§ˆ</span></button>
    </div>
    <!-- é…ç½®åŒº -->
    <div class="setup-left">
      <div class="setup-title">é¡µé¢å¸ƒå±€é…ç½®</div>
      <div class="tab-bar">
        <button id="tabList" class="active" onclick="switchTab('list')">åˆ—è¡¨é¡µå¸ƒå±€</button>
        <button id="tabDetail" onclick="switchTab('detail')">è¯¦æƒ…é¡µå¸ƒå±€</button>
      </div>
      <div id="listConfig" class="config-section">
        <div class="config-row"><label><input type="checkbox" id="autoFit">å®½åº¦è‡ªé€‚åº”</label></div>
        <div style="margin-top:16px;">
          <div class="tab-preview-bar" style="margin-bottom:0;">
            <button id="tabListFields" class="tab-preview-btn active" onclick="switchListTab('fields')">åˆ—è¡¨é…ç½®</button>
            <button id="tabSortConfig" class="tab-preview-btn" onclick="switchListTab('sort')">æ’åºé…ç½®</button>
          </div>
          <div id="listFieldsTab" style="display:block;">
            <div id="listFields" class="draggable-list"></div>
          </div>
          <div id="sortConfigTab" style="display:none;">
            <div style="margin-bottom:10px;">
              <button type="button" class="btn-modern" onclick="openSortFieldModal()">æ·»åŠ æ’åºå­—æ®µ</button>
            </div>
            <div id="sortFieldsConfig" style="display:flex;flex-direction:column;gap:4px;"></div>
          </div>
        </div>
        <div class="config-label" style="margin-top:16px;">è¯¦æƒ…é¡µå±•ç¤ºé€‰é¡¹</div>
        <div class="config-row"><label><input type="radio" name="listDetailMode" value="drawer" checked>æŠ½å±‰è”åŠ¨</label></div>
        <div class="config-row"><label><input type="radio" name="listDetailMode" value="bottom">ä¸Šä¸‹å¸ƒå±€</label></div>
      </div>
      <div id="detailConfig" class="config-section" style="display:none;">
        <div style="display:flex;gap:18px;align-items:flex-start;min-height:420px;">
          <!-- ç¬¬ä¸€æ ï¼šæ ‘å‹ç»“æ„ -->
          <div style="flex:1;min-width:180px;max-width:240px;background:#f8fafc;border:1px solid #e0e6ed;border-radius:8px;padding:12px 8px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
              <div style="font-weight:600;color:#2176c7;">ç‰©æ–™åˆ†ç±»æ ‘</div>
              <div style="display:flex;gap:6px;">
                <button type="button" class="btn-modern" onclick="expandAllTreeNodes()" style="font-size:11px;padding:3px 6px;background:#e3eaf3;color:#2176c7;border:1px solid #c0d3eb;">
                  å…¨éƒ¨å±•å¼€
                </button>
                <button type="button" class="btn-modern" onclick="collapseAllTreeNodes()" style="font-size:11px;padding:3px 6px;background:#e3eaf3;color:#2176c7;border:1px solid #c0d3eb;">
                  å…¨éƒ¨æŠ˜å 
                </button>
              </div>
            </div>
            <div id="materialTree" style="max-height:380px;overflow-y:auto;">
              <!-- æ ¹èŠ‚ç‚¹ -->
              <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;background:#f4f8fb;font-weight:600;" onclick="toggleTreeNode(this)">
                <div style="display:flex;align-items:center;">
                  <span style="color:#2176c7;margin-right:4px;">â–¼</span>
                  <span>å…¨éƒ¨</span>
                </div>
                <span class="layout-indicator" data-node="root" style="font-size:12px;color:#4caf50;margin-left:8px;">âš™ï¸</span>
              </div>
              <div class="tree-children" style="margin-left:16px;display:block;">
                <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                  <div style="display:flex;align-items:center;">
                    <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                    <span>åŸææ–™</span>
                  </div>
                  <!-- æ— å›¾æ ‡ -->
                </div>
                <div class="tree-children" style="margin-left:16px;display:none;">
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                      <span>é‡‘å±ææ–™</span>
                    </div>
                    <!-- æ— å›¾æ ‡ -->
                  </div>
                  <div class="tree-children" style="margin-left:16px;display:none;">
                    <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                      <div style="display:flex;align-items:center;">
                        <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                        <span>é’¢æ</span>
                      </div>
                      <!-- æ— å›¾æ ‡ -->
                    </div>
                    <div class="tree-children" style="margin-left:16px;display:none;">
                      <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                        <div style="display:flex;align-items:center;">
                          <span style="margin-right:4px;">â—</span>
                          <span>ç¢³é’¢</span>
                        </div>
                        <span class="layout-indicator" data-node="carbon_steel" style="font-size:12px;color:#4caf50;margin-left:8px;">âš™ï¸</span>
                      </div>
                      <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                        <div style="display:flex;align-items:center;">
                          <span style="margin-right:4px;">â—</span>
                          <span>ä¸é”ˆé’¢</span>
                        </div>
                        <!-- æ— å›¾æ ‡ -->
                      </div>
                    </div>
                    <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                      <div style="display:flex;align-items:center;">
                        <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                        <span>é“æ</span>
                      </div>
                      <!-- æ— å›¾æ ‡ -->
                    </div>
                    <div class="tree-children" style="margin-left:16px;display:none;">
                      <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                        <div style="display:flex;align-items:center;">
                          <span style="margin-right:4px;">â—</span>
                          <span>é“åˆé‡‘</span>
                        </div>
                        <!-- æ— å›¾æ ‡ -->
                      </div>
                    </div>
                  </div>
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                      <span>éé‡‘å±ææ–™</span>
                    </div>
                    <!-- æ— å›¾æ ‡ -->
                  </div>
                  <div class="tree-children" style="margin-left:16px;display:none;">
                    <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                      <div style="display:flex;align-items:center;">
                        <span style="margin-right:4px;">â—</span>
                        <span>å¡‘æ–™</span>
                      </div>
                      <!-- æ— å›¾æ ‡ -->
                    </div>
                    <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                      <div style="display:flex;align-items:center;">
                        <span style="margin-right:4px;">â—</span>
                        <span>æ©¡èƒ¶</span>
                      </div>
                      <!-- æ— å›¾æ ‡ -->
                    </div>
                  </div>
                </div>
                <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                  <div style="display:flex;align-items:center;">
                    <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                    <span>åŠæˆå“</span>
                  </div>
                  <!-- æ— å›¾æ ‡ -->
                </div>
                <div class="tree-children" style="margin-left:16px;display:none;">
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="margin-right:4px;">â—</span>
                      <span>é“¸ä»¶</span>
                    </div>
                    <span class="layout-indicator" data-node="casting" style="font-size:12px;color:#4caf50;margin-left:8px;">âš™ï¸</span>
                  </div>
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="margin-right:4px;">â—</span>
                      <span>é”»ä»¶</span>
                    </div>
                    <!-- æ— å›¾æ ‡ -->
                  </div>
                </div>
                <div class="tree-node" style="padding:4px 0;cursor:pointer;display:flex;justify-content:space-between;align-items:center;" onclick="toggleTreeNode(this)">
                  <div style="display:flex;align-items:center;">
                    <span style="color:#2176c7;margin-right:4px;">â–¶</span>
                    <span>æˆå“</span>
                  </div>
                  <!-- æ— å›¾æ ‡ -->
                </div>
                <div class="tree-children" style="margin-left:16px;display:none;">
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="margin-right:4px;">â—</span>
                      <span>æœºæ¢°é›¶ä»¶</span>
                    </div>
                    <!-- æ— å›¾æ ‡ -->
                  </div>
                  <div class="tree-node" style="padding:4px 0;cursor:pointer;color:#2176c7;display:flex;justify-content:space-between;align-items:center;" onclick="selectTreeNode(this)">
                    <div style="display:flex;align-items:center;">
                      <span style="margin-right:4px;">â—</span>
                      <span>ç”µå­å…ƒä»¶</span>
                    </div>
                    <!-- æ— å›¾æ ‡ -->
                  </div>
                </div>
              </div>
            </div>
          </div>
          <!-- ç¬¬äºŒæ ï¼šå­—æ®µæ±  -->
          <div style="flex:1;min-width:160px;max-width:220px;background:#f8fafc;border:1px solid #e0e6ed;border-radius:8px;padding:12px 8px;">
            <div id="modelFieldPool"></div>
          </div>
          <!-- ç¬¬ä¸‰æ ï¼šå¸ƒå±€é…ç½®+ç”»å¸ƒ -->
          <div style="flex:2;min-width:320px;max-width:600px;background:#fff;border:1px solid #e0e6ed;border-radius:8px;padding:12px 18px;">
            <!-- æ–°å¢å…¬å…±å¸ƒå±€é…ç½®åŒºåŸŸ -->
            <div id="detailLayoutConfig" style="margin-bottom:14px;padding-bottom:10px;border-bottom:1px dashed #e0e6ed;">
              <div style="display:flex;justify-content:space-between;align-items:center;">
                <div>
                  <span style="font-weight:500;color:#185a99;margin-right:18px;">ä¸»å­è¡¨å¸ƒå±€ï¼š</span>
                  <label style="margin-right:18px;"><input type="radio" name="detailLayoutType" value="tab" checked onchange="setDetailLayoutType('tab')"> åˆ†é¡µç­¾å¹³é“º</label>
                  <label><input type="radio" name="detailLayoutType" value="mainSubTab" onchange="setDetailLayoutType('mainSubTab')"> ä¸Šä¸‹é¡µç­¾</label>
                </div>
                <button type="button" class="btn-modern" onclick="openCopyLayoutModal()" style="background:#e3eaf3;color:#2176c7;border:1px solid #c0d3eb;padding:6px 12px;border-radius:4px;">
                  <span style="margin-right:4px;">ğŸ“‹</span>å¤åˆ¶å¸ƒå±€
                </button>
              </div>
            </div>
            <div id="detailCanvasTabs"></div>
          </div>
          <!-- ç¬¬å››æ ï¼šå±æ€§é…ç½® -->
          <div style="flex:1;min-width:180px;max-width:260px;background:#f8fafc;border:1px solid #e0e6ed;border-radius:8px;padding:12px 14px;">
            <div style="font-weight:600;color:#2176c7;margin-bottom:10px;">å±æ€§é…ç½®</div>
            <div id="canvasFieldProps"></div>
          </div>
        </div>
      </div>
    </div>
    <!-- é¢„è§ˆåŒº -->
    <div id="previewModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:9999;align-items:center;justify-content:center;">
      <div style="background:#fff;min-width:864px;max-width:1296px;max-height:1296px;overflow:auto;border-radius:8px;box-shadow:0 4px 24px rgba(33,118,199,0.18);padding:28px 32px 24px 32px;position:relative;">
        <div style="font-size:18px;color:#2176c7;font-weight:600;margin-bottom:16px;">é¡µé¢é¢„è§ˆ
          <span onclick="closePreview()" style="position:absolute;right:24px;top:18px;font-size:22px;cursor:pointer;color:#888;">Ã—</span>
        </div>
        <div style="position:relative;">
          <div id="previewArea" class="preview-area" style="background:#f0f6fd;border:1px solid #c0d3eb;border-radius:6px;padding:18px;min-height:320px;"></div>
          <div id="previewDrawer" style="display:none;position:absolute;top:0;right:0;width:605px;height:100%;background:#fff;box-shadow:-2px 0 16px rgba(33,118,199,0.12);z-index:1001;transition:right 0.3s;overflow:auto;">
            <div style="padding:24px 28px 18px 28px;position:relative;">
              <span style="font-size:18px;color:#2176c7;font-weight:600;">è¯¦æƒ…é¡µ</span>
              <span onclick="closePreviewDrawer()" style="position:absolute;right:18px;top:18px;font-size:22px;cursor:pointer;color:#888;">Ã—</span>
              <div id="previewDrawerContent" style="margin-top:18px;"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="sortFieldModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;min-width:320px;max-width:90vw;max-height:80vh;overflow:auto;border-radius:8px;box-shadow:0 4px 24px rgba(33,118,199,0.18);padding:28px 32px 24px 32px;position:relative;">
      <div style="font-size:16px;color:#2176c7;font-weight:600;margin-bottom:16px;">é€‰æ‹©æ’åºå­—æ®µ
        <span onclick="closeSortFieldModal()" style="position:absolute;right:24px;top:18px;font-size:22px;cursor:pointer;color:#888;">Ã—</span>
      </div>
      <div id="sortFieldList" style="display:flex;flex-direction:column;gap:8px;margin-bottom:18px;"></div>
      <button type="button" class="btn-main" onclick="addSelectedSortFields()">æ·»åŠ </button>
    </div>
  </div>
  
  <!-- å¤åˆ¶å¸ƒå±€å¼¹çª— -->
  <div id="copyLayoutModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.25);z-index:9999;align-items:center;justify-content:center;">
    <div style="background:#fff;min-width:480px;max-width:90vw;max-height:80vh;overflow:auto;border-radius:8px;box-shadow:0 4px 24px rgba(33,118,199,0.18);padding:28px 32px 24px 32px;position:relative;">
      <div style="font-size:16px;color:#2176c7;font-weight:600;margin-bottom:16px;">å¤åˆ¶å¸ƒå±€åˆ°å…¶ä»–èŠ‚ç‚¹
        <span onclick="closeCopyLayoutModal()" style="position:absolute;right:24px;top:18px;font-size:22px;cursor:pointer;color:#888;">Ã—</span>
      </div>
      <div style="margin-bottom:16px;color:#666;font-size:14px;">
        å½“å‰å¸ƒå±€ï¼š<span id="currentLayoutName" style="color:#2176c7;font-weight:500;"></span>
      </div>
      <div style="margin-bottom:16px;">
        <div style="font-weight:500;color:#185a99;margin-bottom:8px;">é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹ï¼ˆå¯å¤šé€‰ï¼‰ï¼š</div>
        <div id="copyLayoutTree" style="max-height:300px;overflow-y:auto;border:1px solid #c0d3eb;border-radius:6px;padding:12px;background:#f8fafc;"></div>
      </div>
      <div style="display:flex;gap:12px;justify-content:flex-end;">
        <button type="button" class="btn-line" onclick="closeCopyLayoutModal()">å–æ¶ˆ</button>
        <button type="button" class="btn-main" onclick="copyLayoutToSelectedNodes()">ç¡®è®¤å¤åˆ¶</button>
      </div>
    </div>
  </div>
  <script>
    // ç¤ºä¾‹å­—æ®µ
    const defaultListFields = [
      { key: 'code', label: 'ç¼–ç ', width: 120 },
      { key: 'name', label: 'åç§°', width: 160 },
      { key: 'type', label: 'ç±»å‹', width: 100 },
      { key: 'status', label: 'çŠ¶æ€', width: 80 }
    ];
    const modelFields = [
      { key: 'code', label: 'ä»£ç ' },
      { key: 'name', label: 'åç§°' },
      { key: 'country', label: 'å›½å®¶' },
      { key: 'orgName', label: 'å•ä½åç§°' },
      { key: 'financeUnit', label: 'è´¢åŠ¡æ ¸ç®—å•ä½' },
      { key: 'hrParent', label: 'äººäº‹ä¸Šçº§å•ä½' }
    ];
    // è¯¦æƒ…é¡µå¸ƒå±€ä¸“ç”¨æ•°æ®
    const detailBasicFields = [
      { key: 'code', label: 'ä»£ç ', type: 'æ–‡æœ¬' },
      { key: 'name', label: 'åç§°', type: 'æ–‡æœ¬' },
      { key: 'country', label: 'å›½å®¶', type: 'æ–‡æœ¬' },
      { key: 'orgName', label: 'å•ä½åç§°', type: 'æ–‡æœ¬' }
    ];
    const detailFinanceFields = [
      { key: 'financeUnit', label: 'è´¢åŠ¡æ ¸ç®—å•ä½', type: 'å•ä½' }
    ];
    const detailHRFields = [
      { key: 'hrParent', label: 'äººäº‹ä¸Šçº§å•ä½', type: 'å•ä½' }
    ];
    const detailViews = [
      { key: 'base', label: 'åŸºæœ¬è§†å›¾' },
      { key: 'finance', label: 'è´¢åŠ¡è§†å›¾' },
      { key: 'hr', label: 'äººäº‹è§†å›¾' }
    ];
    let listFields = JSON.parse(JSON.stringify(defaultListFields));
    let detailFields = JSON.parse(JSON.stringify(modelFields));
    let fieldProps = {};
    let sortFields = [{field: 'code', order: 'asc'}];
    let canvasConfig = {
      base: { layout: 'vertical', cols: 2, fields: [] },
      finance: { layout: 'vertical', cols: 2, fields: [] },
      hr: { layout: 'vertical', cols: 2, fields: [] }
    };
    let selectedView = 'base';
    let selectedCanvasField = null;
    let detailCanvasConfig = {
      base: { layout: 'vertical', cols: 2, fields: [] },
      finance: { layout: 'vertical', cols: 2, fields: [] },
      hr: { layout: 'vertical', cols: 2, fields: [] }
    };
    let detailSelectedView = 'base';
    let detailSelectedCanvasField = null;
    // æ–°å¢å…¨å±€å˜é‡ä¿å­˜å¸ƒå±€æ–¹å¼
    let detailLayoutType = 'tab';
    // æ‹–æ‹½æ’åº
    function renderDraggableList(list, containerId, type) {
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      const autoFit = document.getElementById('autoFit') && document.getElementById('autoFit').checked;
      list.forEach((field, idx) => {
        const item = document.createElement('div');
        item.className = 'draggable-item';
        item.draggable = true;
        let widthVal = autoFit ? 0 : field.width;
        item.innerHTML = `<span class='drag-handle'>â˜°</span>${field.label} <input type='number' min='40' max='400' value='${widthVal}' style='width:50px;margin-left:8px;' onchange='updateFieldWidth("${type}",${idx},this.value)' ${autoFit?'disabled':''}>`;
        item.ondragstart = e => {
          e.dataTransfer.setData('text/plain', idx);
        };
        item.ondragover = e => e.preventDefault();
        item.ondrop = e => {
          const from = +e.dataTransfer.getData('text/plain');
          const to = idx;
          if (from !== to) {
            const arr = type === 'list' ? listFields : detailFields;
            const moved = arr.splice(from, 1)[0];
            arr.splice(to, 0, moved);
            renderDraggableList(arr, containerId, type);
          }
        };
        container.appendChild(item);
      });
    }
    function updateFieldWidth(type, idx, value) {
      if (type === 'list') listFields[idx].width = +value;
      else detailFields[idx].width = +value;
    }
    // å­—æ®µå±æ€§é…ç½®
    function renderFieldProps() {
      const container = document.getElementById('fieldProps');
      container.innerHTML = '';
      detailFields.forEach((field, idx) => {
        if (!fieldProps[field.key]) fieldProps[field.key] = { layout: 'vertical', format: '', placeholder: '', showLabel: true };
        const props = fieldProps[field.key];
        const row = document.createElement('div');
        row.className = 'field-config-row';
        row.innerHTML = `
          <label>${field.label}</label>
          <select onchange="setFieldProp('${field.key}','layout',this.value)"><option value="vertical" ${props.layout==='vertical'?'selected':''}>ä¸Šä¸‹</option><option value="horizontal" ${props.layout==='horizontal'?'selected':''}>å·¦å³</option></select>
          <input type="text" placeholder="æç¤ºæ–‡å­—" value="${props.placeholder}" onchange="setFieldProp('${field.key}','placeholder',this.value)">
          <input type="text" placeholder="æ˜¾ç¤ºæ ¼å¼" value="${props.format}" onchange="setFieldProp('${field.key}','format',this.value)">
          <label><input type="checkbox" ${props.showLabel?'checked':''} onchange="setFieldProp('${field.key}','showLabel',this.checked)">æ˜¾ç¤ºæ ‡é¢˜</label>
        `;
        container.appendChild(row);
      });
    }
    function setFieldProp(key, prop, value) {
      if (!fieldProps[key]) fieldProps[key] = { layout: 'vertical', format: '', placeholder: '', showLabel: true };
      if (prop === 'showLabel') fieldProps[key][prop] = value;
      else fieldProps[key][prop] = value;
    }
    // Tabåˆ‡æ¢
    function switchTab(tab) {
      document.getElementById('tabList').classList.remove('active');
      document.getElementById('tabDetail').classList.remove('active');
      document.getElementById('listConfig').style.display = tab==='list'?'block':'none';
      document.getElementById('detailConfig').style.display = tab==='detail'?'block':'none';
      if(tab==='list') {
        document.getElementById('tabList').classList.add('active');
        // ...åŸæœ‰åˆ—è¡¨é¡µæ¸²æŸ“...
      } else {
        document.getElementById('tabDetail').classList.add('active');
        renderDetailModelFieldPool();
        renderDetailCanvasTabs();
        renderDetailCanvasFieldProps();
      }
    }
    // ä¿å­˜
    function saveConfig() {
      alert('é…ç½®å·²ä¿å­˜ï¼\nï¼ˆå®é™…ä¿å­˜é€»è¾‘è¯·å¯¹æ¥åç«¯ï¼‰');
    }
    // é¢„è§ˆ
    function previewConfig() {
      const modal = document.getElementById('previewModal');
      modal.style.display = 'flex';
      modal.style.zIndex = 9999;
      const tab = document.getElementById('tabList').classList.contains('active') ? 'list' : 'detail';
      let html = '';
      if(tab==='list') {
        // åˆ¤æ–­è¯¦æƒ…é¡µå±•ç¤ºé€‰é¡¹
        const detailMode = document.querySelector('input[name="listDetailMode"]:checked').value;
        if(detailMode==='drawer') {
          html += `<table style='width:100%;border-collapse:collapse;'><tr>`;
          listFields.forEach(f=>{
            html += `<th style='border:1px solid #c0d3eb;padding:6px;width:${f.width}px;'>${f.label}</th>`;
          });
          html += `</tr>`;
          for(let i=0;i<3;i++) {
            html += `<tr>`;
            listFields.forEach(f=>{
              if(f.key==='code') {
                html += `<td class='preview-code-cell' style='border:1px solid #c0d3eb;padding:6px;color:#2176c7;cursor:pointer;text-decoration:underline;'>ç¤ºä¾‹${f.label}</td>`;
              } else {
                html += `<td style='border:1px solid #c0d3eb;padding:6px;'>ç¤ºä¾‹${f.label}</td>`;
              }
            });
            html += `</tr>`;
          }
          html += `</table>`;
          html += `<div style='margin-top:18px;color:#888;'>ï¼ˆç‚¹å‡»ç¼–ç å­—æ®µå¼¹å‡ºæŠ½å±‰å±•ç¤ºè¯¦æƒ…é¡µï¼‰</div>`;
        } else {
          // ä¸Šä¸‹å¸ƒå±€
          html += `<div style='display:flex;flex-direction:column;gap:18px;'>`;
          html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
          html += `<table style='width:100%;border-collapse:collapse;'><tr>`;
          listFields.forEach(f=>{
            html += `<th style='border:1px solid #c0d3eb;padding:6px;width:${f.width}px;'>${f.label}</th>`;
          });
          html += `</tr>`;
          for(let i=0;i<3;i++) {
            html += `<tr>`;
            listFields.forEach(f=>{
              html += `<td style='border:1px solid #c0d3eb;padding:6px;'>ç¤ºä¾‹${f.label}</td>`;
            });
            html += `</tr>`;
          }
          html += `</table>`;
          html += `</div>`;
          // ä¸‹åŠè¯¦æƒ…é¡µåŒºåŸŸï¼šå­è¡¨å¤šé¡µç­¾
          html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
          html += `<div class='tab-preview-bar' id='previewSubTabs'>`;
          html += `<button class='tab-preview-btn active' data-subtab='sub1'>å­è¡¨1</button>`;
          html += `<button class='tab-preview-btn' data-subtab='sub2'>å­è¡¨2</button>`;
          html += `</div>`;
          html += `<div id='previewSubTabContent'></div>`;
          html += `</div>`;
          html += `</div>`;
        }
      } else {
        // è¯¦æƒ…é¡µé¢„è§ˆ
        if(detailLayoutType==='tab') {
          // åˆ†é¡µç­¾å¹³é“ºï¼šå¤šé¡µç­¾ï¼ŒåŒ…å«åŸºæœ¬è§†å›¾ã€è´¢åŠ¡è§†å›¾ã€äººäº‹è§†å›¾ã€å­è¡¨ä¸€ã€å­è¡¨äºŒ
          html += `<div class='tab-preview-bar' id='previewDetailTabs'>`;
          html += `<button class='tab-preview-btn active' data-tab='base'>åŸºæœ¬è§†å›¾</button>`;
          html += `<button class='tab-preview-btn' data-tab='finance'>è´¢åŠ¡è§†å›¾</button>`;
          html += `<button class='tab-preview-btn' data-tab='hr'>äººäº‹è§†å›¾</button>`;
          html += `<button class='tab-preview-btn' data-tab='sub1'>å­è¡¨ä¸€</button>`;
          html += `<button class='tab-preview-btn' data-tab='sub2'>å­è¡¨äºŒ</button>`;
          html += `</div>`;
          html += `<div id='previewDetailTabContent'></div>`;
        } else {
          // ä¸Šä¸‹é¡µç­¾ï¼šä¸ŠåŠå¤šé¡µç­¾ï¼ˆåŸºæœ¬ã€è´¢åŠ¡ã€äººäº‹ï¼‰ï¼Œä¸‹åŠå¤šé¡µç­¾ï¼ˆå­è¡¨ä¸€ã€å­è¡¨äºŒï¼‰
          html += `<div style='display:flex;flex-direction:column;gap:18px;'>`;
          html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
          html += `<div class='tab-preview-bar' id='previewDetailTabsUp'>`;
          html += `<button class='tab-preview-btn active' data-tab='base'>åŸºæœ¬è§†å›¾</button>`;
          html += `<button class='tab-preview-btn' data-tab='finance'>è´¢åŠ¡è§†å›¾</button>`;
          html += `<button class='tab-preview-btn' data-tab='hr'>äººäº‹è§†å›¾</button>`;
          html += `</div>`;
          html += `<div id='previewDetailTabContentUp'></div>`;
          html += `</div>`;
          html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
          html += `<div class='tab-preview-bar' id='previewDetailTabsDown'>`;
          html += `<button class='tab-preview-btn active' data-tab='sub1'>å­è¡¨ä¸€</button>`;
          html += `<button class='tab-preview-btn' data-tab='sub2'>å­è¡¨äºŒ</button>`;
          html += `</div>`;
          html += `<div id='previewDetailTabContentDown'></div>`;
          html += `</div>`;
          html += `</div>`;
        }
      }
      document.getElementById('previewArea').innerHTML = html;
      // ä¿®å¤ï¼šä¸ºæ‰€æœ‰ç¼–ç å­—æ®µç»‘å®šæŠ½å±‰å¼¹å‡ºäº‹ä»¶ï¼Œä½¿ç”¨setTimeoutç¡®ä¿DOMå·²æ¸²æŸ“
      if(tab==='list') {
        setTimeout(()=>{
          document.querySelectorAll('.preview-code-cell').forEach(cell => {
            cell.onclick = openPreviewDrawer;
          });
        }, 0);
      }
      // è¯¦æƒ…é¡µtabåˆ‡æ¢äº‹ä»¶å’Œå†…å®¹æ¸²æŸ“
      if(tab==='detail') {
        if(detailLayoutType==='tab') {
          const tabs = document.querySelectorAll('#previewDetailTabs .tab-preview-btn');
          const content = document.getElementById('previewDetailTabContent');
          function renderTab(tab) {
            if(tab==='base') content.innerHTML = renderPreviewFields(detailCanvasConfig.base);
            else if(tab==='finance') content.innerHTML = renderPreviewFields(detailCanvasConfig.finance);
            else if(tab==='hr') content.innerHTML = renderPreviewFields(detailCanvasConfig.hr);
            else content.innerHTML = `<div style='padding:12px 0;'>${tab==='sub1'?'å­è¡¨ä¸€':'å­è¡¨äºŒ'}å†…å®¹ç¤ºä¾‹ï¼ˆå¯è‡ªå®šä¹‰å­—æ®µ/è¡¨æ ¼ï¼‰</div>`;
          }
          tabs.forEach(btn => {
            btn.onclick = function() {
              tabs.forEach(b=>b.classList.remove('active'));
              this.classList.add('active');
              renderTab(this.getAttribute('data-tab'));
            };
          });
          renderTab('base');
        } else {
          // ä¸Šä¸‹é¡µç­¾
          const tabsUp = document.querySelectorAll('#previewDetailTabsUp .tab-preview-btn');
          const contentUp = document.getElementById('previewDetailTabContentUp');
          function renderTabUp(tab) {
            if(tab==='base') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.base);
            else if(tab==='finance') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.finance);
            else if(tab==='hr') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.hr);
          }
          tabsUp.forEach(btn => {
            btn.onclick = function() {
              tabsUp.forEach(b=>b.classList.remove('active'));
              this.classList.add('active');
              renderTabUp(this.getAttribute('data-tab'));
            };
          });
          renderTabUp('base');
          const tabsDown = document.querySelectorAll('#previewDetailTabsDown .tab-preview-btn');
          const contentDown = document.getElementById('previewDetailTabContentDown');
          function renderTabDown(tab) {
            contentDown.innerHTML = `<div style='padding:12px 0;'>${tab==='sub1'?'å­è¡¨ä¸€':'å­è¡¨äºŒ'}å†…å®¹ç¤ºä¾‹ï¼ˆå¯è‡ªå®šä¹‰å­—æ®µ/è¡¨æ ¼ï¼‰</div>`;
          }
          tabsDown.forEach(btn => {
            btn.onclick = function() {
              tabsDown.forEach(b=>b.classList.remove('active'));
              this.classList.add('active');
              renderTabDown(this.getAttribute('data-tab'));
            };
          });
          renderTabDown('sub1');
        }
      }
    }
    function closePreview() {
      document.getElementById('previewModal').style.display = 'none';
    }
    // åˆå§‹åŒ–
    renderDraggableList(listFields, 'listFields', 'list');
    renderDraggableList(detailFields, 'detailFields', 'detail');
    renderFieldProps();
    // åˆå§‹åŒ–æ’åºå­—æ®µé…ç½®
    renderSortFieldsConfig();
    // æ–°å¢tabåˆ‡æ¢é€»è¾‘
    function switchListTab(tab) {
      document.getElementById('tabListFields').classList.remove('active');
      document.getElementById('tabSortConfig').classList.remove('active');
      document.getElementById('listFieldsTab').style.display = tab==='fields'?'block':'none';
      document.getElementById('sortConfigTab').style.display = tab==='sort'?'block':'none';
      if(tab==='fields') document.getElementById('tabListFields').classList.add('active');
      else document.getElementById('tabSortConfig').classList.add('active');
    }
    // æ’åºé…ç½®åŒºç¾åŒ–ï¼Œå‚è€ƒExcelæ’åºåŠŸèƒ½
    function renderSortFieldsConfig() {
      const container = document.getElementById('sortFieldsConfig');
      container.innerHTML = '';
      sortFields.forEach((sf, idx) => {
        const row = document.createElement('div');
        row.className = 'sort-row-flex';
        row.style.background = '#f8fafc';
        row.style.border = '1px solid #c0d3eb';
        row.style.borderRadius = '4px';
        row.style.padding = '6px 10px';
        row.style.marginBottom = '6px';
        row.innerHTML = `
          <span style='color:#2176c7;font-size:15px;cursor:move;'>â˜°</span>
          <select class='modern-select' onchange="updateSortField(${idx},'field',this.value)">
            ${listFields.map(f=>`<option value='${f.key}' ${sf.field===f.key?'selected':''}>${f.label}</option>`).join('')}
          </select>
          <select class='modern-select' onchange="updateSortField(${idx},'order',this.value)">
            <option value='asc' ${sf.order==='asc'?'selected':''}>å‡åº</option>
            <option value='desc' ${sf.order==='desc'?'selected':''}>é™åº</option>
          </select>
          <button type='button' class='btn-modern sort-row-delete' onclick='removeSortField(${idx})'>åˆ é™¤</button>
        `;
        // æ‹–æ‹½æ’åº
        row.draggable = true;
        row.ondragstart = e => { e.dataTransfer.setData('text/plain', idx); };
        row.ondragover = e => e.preventDefault();
        row.ondrop = e => {
          const from = +e.dataTransfer.getData('text/plain');
          const to = idx;
          if (from !== to) {
            const moved = sortFields.splice(from, 1)[0];
            sortFields.splice(to, 0, moved);
            renderSortFieldsConfig();
          }
        };
        container.appendChild(row);
      });
    }
    function removeSortField(idx) {
      sortFields.splice(idx, 1);
      renderSortFieldsConfig();
    }
    function updateSortField(idx, prop, value) {
      if (prop === 'field') sortFields[idx].field = value;
      else sortFields[idx].order = value;
      renderSortFieldsConfig();
    }
    // å¤šé€‰å­—æ®µå¼¹çª—é€»è¾‘
    function openSortFieldModal() {
      const modal = document.getElementById('sortFieldModal');
      const list = document.getElementById('sortFieldList');
      const used = sortFields.map(s=>s.field);
      list.innerHTML = listFields.filter(f=>!used.includes(f.key)).map(f=>`<label style='display:flex;align-items:center;gap:8px;'><input type='checkbox' value='${f.key}'>${f.label}</label>`).join('');
      modal.style.display = 'flex';
    }
    function closeSortFieldModal() {
      document.getElementById('sortFieldModal').style.display = 'none';
    }
    function addSelectedSortFields() {
      const checks = document.querySelectorAll('#sortFieldList input[type=checkbox]:checked');
      checks.forEach(c=>{
        if(!sortFields.some(s=>s.field===c.value)) sortFields.push({field: c.value, order:'asc'});
      });
      closeSortFieldModal();
      renderSortFieldsConfig();
    }
    // ç›‘å¬autoFitå˜åŒ–ï¼Œå®æ—¶åˆ·æ–°ä¸»è¡¨åˆ—é…ç½®å¹¶ç»Ÿä¸€å®½åº¦ä¸º0
    const autoFitBox = document.getElementById('autoFit');
    autoFitBox && autoFitBox.addEventListener('change', function(){
      if(this.checked) listFields.forEach(f=>f.width=0);
      renderDraggableList(listFields, 'listFields', 'list');
    });
    // æ–°å¢æŠ½å±‰å¼¹å‡º/å…³é—­é€»è¾‘
    function openPreviewDrawer() {
      const drawer = document.getElementById('previewDrawer');
      const content = document.getElementById('previewDrawerContent');
      if(!drawer || !content) return;
      drawer.style.display = 'block';
      // å†…å®¹ä¸è¯¦æƒ…é¡µå¸ƒå±€ä¸Šä¸‹é¡µç­¾ä¸€è‡´
      let html = `<div style='display:flex;flex-direction:column;gap:18px;'>`;
      html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
      html += `<div class='tab-preview-bar' id='drawerDetailTabsUp'>`;
      html += `<button class='tab-preview-btn active' data-tab='base'>åŸºæœ¬è§†å›¾</button>`;
      html += `<button class='tab-preview-btn' data-tab='finance'>è´¢åŠ¡è§†å›¾</button>`;
      html += `<button class='tab-preview-btn' data-tab='hr'>äººäº‹è§†å›¾</button>`;
      html += `</div>`;
      html += `<div id='drawerDetailTabContentUp'></div>`;
      html += `</div>`;
      html += `<div style='background:#fff;border:1px solid #c0d3eb;border-radius:6px;padding:12px;'>`;
      html += `<div class='tab-preview-bar' id='drawerDetailTabsDown'>`;
      html += `<button class='tab-preview-btn active' data-tab='sub1'>å­è¡¨ä¸€</button>`;
      html += `<button class='tab-preview-btn' data-tab='sub2'>å­è¡¨äºŒ</button>`;
      html += `</div>`;
      html += `<div id='drawerDetailTabContentDown'></div>`;
      html += `</div>`;
      html += `</div>`;
      content.innerHTML = html;
      // ç»‘å®štabåˆ‡æ¢äº‹ä»¶å’Œå†…å®¹æ¸²æŸ“
      const tabsUp = document.querySelectorAll('#drawerDetailTabsUp .tab-preview-btn');
      const contentUp = document.getElementById('drawerDetailTabContentUp');
      function renderTabUp(tab) {
        if(tab==='base') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.base);
        else if(tab==='finance') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.finance);
        else if(tab==='hr') contentUp.innerHTML = renderPreviewFields(detailCanvasConfig.hr);
      }
      tabsUp.forEach(btn => {
        btn.onclick = function() {
          tabsUp.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          renderTabUp(this.getAttribute('data-tab'));
        };
      });
      renderTabUp('base');
      const tabsDown = document.querySelectorAll('#drawerDetailTabsDown .tab-preview-btn');
      const contentDown = document.getElementById('drawerDetailTabContentDown');
      function renderTabDown(tab) {
        contentDown.innerHTML = `<div style='padding:12px 0;'>${tab==='sub1'?'å­è¡¨ä¸€':'å­è¡¨äºŒ'}å†…å®¹ç¤ºä¾‹ï¼ˆå¯è‡ªå®šä¹‰å­—æ®µ/è¡¨æ ¼ï¼‰</div>`;
      }
      tabsDown.forEach(btn => {
        btn.onclick = function() {
          tabsDown.forEach(b=>b.classList.remove('active'));
          this.classList.add('active');
          renderTabDown(this.getAttribute('data-tab'));
        };
      });
      renderTabDown('sub1');
    }
    function closePreviewDrawer() {
      document.getElementById('previewDrawer').style.display = 'none';
    }
    // æ¸²æŸ“å­—æ®µæ± 
    function renderDetailModelFieldPool() {
      const pool = document.getElementById('modelFieldPool');
      let html = '';
      // ä¿ç•™æ‰€æœ‰å­—æ®µï¼Œä½†ä¸æ˜¾ç¤ºåˆ†ç»„æ ‡é¢˜
      html += detailBasicFields.map(f => `<div class='model-field-item' draggable='true' data-key='${f.key}' style='padding:6px 10px;margin-bottom:6px;background:#fff;border:1px solid #c0d3eb;border-radius:4px;cursor:grab;display:flex;align-items:center;gap:8px;'>${f.label}<span class='field-type'>${f.type}</span></div>`).join('');
      html += detailFinanceFields.map(f => `<div class='model-field-item' draggable='true' data-key='${f.key}' style='padding:6px 10px;margin-bottom:6px;background:#fff;border:1px solid #c0d3eb;border-radius:4px;cursor:grab;display:flex;align-items:center;gap:8px;'>${f.label}<span class='field-type'>${f.type}</span></div>`).join('');
      html += detailHRFields.map(f => `<div class='model-field-item' draggable='true' data-key='${f.key}' style='padding:6px 10px;margin-bottom:6px;background:#fff;border:1px solid #c0d3eb;border-radius:4px;cursor:grab;display:flex;align-items:center;gap:8px;'>${f.label}<span class='field-type'>${f.type}</span></div>`).join('');
      pool.innerHTML = html;
      enableFieldDragDrop();
    }
    // ç¬¬äºŒæ å¢åŠ é¡µç­¾ï¼Œåˆ‡æ¢é¡µç­¾æ—¶æ¸²æŸ“å¯¹åº”é…ç½®å’Œç”»å¸ƒ
    function renderDetailCanvasTabs() {
      const tabBar = document.createElement('div');
      tabBar.className = 'tab-preview-bar';
      detailViews.forEach(v => {
        const btn = document.createElement('button');
        btn.className = 'tab-preview-btn' + (detailSelectedView===v.key?' active':'');
        btn.textContent = v.label;
        btn.onclick = () => { detailSelectedView = v.key; detailSelectedCanvasField = null; renderDetailCanvasTabs(); };
        tabBar.appendChild(btn);
      });
      const canvasWrap = document.createElement('div');
      canvasWrap.style.marginTop = '8px';
      // é…ç½®åŒº
      const conf = detailCanvasConfig[detailSelectedView];
      canvasWrap.innerHTML = `
        <div style='margin-bottom:12px;'>
          <label style='margin-right:16px;'>å­—æ®µå¸ƒå±€æ–¹å¼
            <select id='canvasFieldLayout' class='modern-select' style='width:90px;'>
              <option value='vertical' ${conf.layout==='vertical'?'selected':''}>ä¸Šä¸‹</option>
              <option value='horizontal' ${conf.layout==='horizontal'?'selected':''}>å·¦å³</option>
            </select>
          </label>
          <label>æ¯è¡Œæ˜¾ç¤ºæ æ•°
            <select id='canvasCols' class='modern-select' style='width:80px;'>
              <option value='1' ${conf.cols===1?'selected':''}>1æ </option>
              <option value='2' ${conf.cols===2?'selected':''}>2æ </option>
              <option value='3' ${conf.cols===3?'selected':''}>3æ </option>
              <option value='4' ${conf.cols===4?'selected':''}>4æ </option>
            </select>
          </label>
        </div>
        <div id='canvasArea' style='min-height:260px;background:#f4f8fb;border:1.5px dashed #c0d3eb;border-radius:6px;padding:16px;display:flex;flex-direction:column;gap:12px;'></div>
      `;
      const container = document.getElementById('detailCanvasTabs');
      container.innerHTML = '';
      container.appendChild(tabBar);
      container.appendChild(canvasWrap);
      // äº‹ä»¶ç»‘å®š
      document.getElementById('canvasFieldLayout').onchange = e => { conf.layout = e.target.value; renderDetailCanvasTabs(); };
      document.getElementById('canvasCols').onchange = e => { conf.cols = +e.target.value; renderDetailCanvasTabs(); };
      renderDetailCanvasArea();
    }
    // æ¸²æŸ“ç”»å¸ƒ
    function renderDetailCanvasArea() {
      const conf = detailCanvasConfig[detailSelectedView];
      const area = document.getElementById('canvasArea');
      let html = '';
      const totalSlots = Math.max(conf.fields.length, conf.cols); // è‡³å°‘ä¸€è¡Œ
      for(let i=0;i<totalSlots;i+=conf.cols) {
        html += `<div class='canvas-row' style='display:flex;gap:12px;margin-bottom:8px;'>`;
        for(let j=0;j<conf.cols;j++) {
          const idx = i+j;
          const f = conf.fields[idx];
          html += `<div class='canvas-slot' data-slot='${idx}' style='flex:1;min-width:0;min-height:48px;background:${['#eaf6ff','#f9fbe7','#fffbe7','#fce4ec'][j%4]};border:2px dashed #b0c4de;border-radius:6px;display:flex;align-items:center;justify-content:center;position:relative;'>`;
          if(f) {
            html += `<div class='canvas-field-item' data-key='${f.key}' draggable='true' data-idx='${idx}' style='width:90%;padding:8px 10px;background:#fff;border:2px solid ${detailSelectedCanvasField===f.key?'#2176c7':'#c0d3eb'};border-radius:5px;cursor:grab;margin-bottom:0;text-align:center;position:relative;'>${f.label}<span class='canvas-field-remove' data-remove-idx='${idx}' style='position:absolute;right:4px;top:2px;color:#e74c3c;cursor:pointer;font-size:16px;'>Ã—</span></div>`;
          } else {
            html += `<span style='color:#bbb;font-size:13px;'>æ‹–æ‹½å­—æ®µåˆ°æ­¤å¤„</span>`;
          }
          html += `</div>`;
        }
        html += `</div>`;
      }
      area.innerHTML = html;
      enableFieldDragDrop();
    }
    function enableFieldDragDrop() {
      // å­—æ®µæ± å­—æ®µæ‹–æ‹½
      document.querySelectorAll('.model-field-item').forEach(item => {
        item.addEventListener('dragstart', e => {
          e.dataTransfer.setData('fieldKey', item.getAttribute('data-key'));
          e.dataTransfer.setData('fieldLabel', item.textContent.trim());
          e.dataTransfer.setData('from', 'pool');
        });
      });
      // ç”»å¸ƒæ ä½æ‹–æ‹½æ”¾ç½®
      document.querySelectorAll('.canvas-slot').forEach(slot => {
        slot.addEventListener('dragover', e => {
          e.preventDefault();
          slot.style.borderColor = '#2176c7';
        });
        slot.addEventListener('dragleave', e => {
          slot.style.borderColor = '#b0c4de';
        });
        slot.addEventListener('drop', e => {
          e.preventDefault();
          slot.style.borderColor = '#b0c4de';
          const conf = detailCanvasConfig[detailSelectedView];
          const key = e.dataTransfer.getData('fieldKey');
          const label = e.dataTransfer.getData('fieldLabel');
          const from = e.dataTransfer.getData('from');
          const idx = parseInt(slot.getAttribute('data-slot'));
          if (from === 'pool') {
            if (!key || conf.fields.some(f => f && f.key === key) || conf.fields[idx]) return;
            while (conf.fields.length < idx) conf.fields.push(null);
            conf.fields[idx] = { key, label };
          } else if (from === 'canvas') {
            const fromIdx = parseInt(e.dataTransfer.getData('fromIdx'));
            if (fromIdx === idx) return;
            const temp = conf.fields[fromIdx];
            conf.fields[fromIdx] = conf.fields[idx];
            conf.fields[idx] = temp;
          }
          renderDetailCanvasTabs();
          renderDetailCanvasFieldProps();
        });
      });
      // ç”»å¸ƒå­—æ®µæ‹–æ‹½æ’åºå’Œé€‰ä¸­
      document.querySelectorAll('.canvas-field-item').forEach(item => {
        item.addEventListener('dragstart', e => {
          e.dataTransfer.setData('fieldKey', item.getAttribute('data-key'));
          e.dataTransfer.setData('from', 'canvas');
          e.dataTransfer.setData('fromIdx', item.getAttribute('data-idx'));
        });
        item.addEventListener('click', e => {
          e.stopPropagation();
          detailSelectedCanvasField = item.getAttribute('data-key');
          renderDetailCanvasTabs();
          renderDetailCanvasFieldProps();
        });
      });
      // åˆ é™¤icon
      document.querySelectorAll('.canvas-field-remove').forEach(icon => {
        icon.addEventListener('click', e => {
          e.stopPropagation();
          const idx = parseInt(icon.getAttribute('data-remove-idx'));
          const conf = detailCanvasConfig[detailSelectedView];
          conf.fields[idx] = null;
          renderDetailCanvasTabs();
          renderDetailCanvasFieldProps();
        });
      });
    }
    // æ¸²æŸ“å±æ€§é…ç½®
    function renderDetailCanvasFieldProps() {
      const propsDiv = document.getElementById('canvasFieldProps');
      // å±•å¼€æ”¶ç¼©çŠ¶æ€ï¼ˆå…¨å±€å˜é‡ï¼‰
      if (window.__attrCollapseState === undefined) {
        window.__attrCollapseState = { base: true, smart: true };
      }
      const collapseState = window.__attrCollapseState;
      
      if(!detailSelectedCanvasField) { 
        propsDiv.innerHTML = '<div style="color:#aaa;">è¯·é€‰æ‹©ç”»å¸ƒä¸­çš„å­—æ®µ</div>'; 
        return; 
      }
      
      const field = [...detailBasicFields, ...detailFinanceFields, ...detailHRFields].find(f=>f.key===detailSelectedCanvasField);
      if (!field) { 
        propsDiv.innerHTML = '<div style="color:#aaa;">å­—æ®µä¸å­˜åœ¨</div>'; 
        return; 
      }
      
      if (!fieldProps[field.key]) fieldProps[field.key] = { showLabel: true, width: 120, placeholder: '', isSensitive: false, sensitiveStart: 0, sensitiveEnd: 0 };
      const props = fieldProps[field.key];
      
      // åŸºæœ¬é…ç½®åˆ†ç»„
      let html = `<div style='font-weight:600;color:#2176c7;margin-bottom:6px;cursor:pointer;user-select:none;' onclick='toggleAttrCollapseGroup("base")'>
        <span style='display:inline-block;transform:rotate(${collapseState.base?"90deg":"0deg"});transition:.2s;'>â–¶</span> åŸºæœ¬é…ç½®
      </div>`;
      html += `<div id='attrBaseGroup' style='margin-bottom:18px;${collapseState.base?"":"display:none;"}'>`;
      html += `
        <div class='field-config-row'><label>å­—æ®µæ ‡é¢˜</label><input type='text' class='input-modern' value='${field.label}' disabled style='background:#f4f8fb;'></div>
        <div class='field-config-row'><label>æ˜¾ç¤ºæ ‡é¢˜</label><input type='checkbox' class='checkbox-modern' ${props.showLabel?'checked':''} onchange="setDetailFieldProp('${field.key}','showLabel',this.checked)"></div>
        <div class='field-config-row'><label>å­—æ®µå®½åº¦</label><input type='number' class='input-modern' min='40' max='400' value='${props.width||120}' onchange="setDetailFieldProp('${field.key}','width',this.value)"></div>
        <div class='field-config-row'><label>æç¤ºæ–‡å­—</label><input type='text' class='input-modern' value='${props.placeholder||''}' placeholder='è¯·è¾“å…¥æç¤ºæ–‡å­—' onchange="setDetailFieldProp('${field.key}','placeholder',this.value)"></div>
        <div class='field-config-row'><label>æ˜¯å¦æ•æ„Ÿä¿¡æ¯</label><input type='checkbox' class='checkbox-modern' ${props.isSensitive?'checked':''} onchange="toggleSensitiveConfig('${field.key}', this.checked)"></div>
        ${props.isSensitive ? `
        <div class='field-config-row'><label>æ•æ„Ÿèµ·å§‹ä½ç½®</label><input type='number' class='input-modern' min='0' value='${props.sensitiveStart||0}' onchange="setDetailFieldProp('${field.key}','sensitiveStart',this.value)"></div>
        <div class='field-config-row'><label>æ•æ„Ÿç»ˆæ­¢ä½ç½®</label><input type='number' class='input-modern' min='0' value='${props.sensitiveEnd||0}' onchange="setDetailFieldProp('${field.key}','sensitiveEnd',this.value)"></div>
        ` : ''}
      `;
      html += '</div>';
      
      // æ™ºèƒ½æœåŠ¡åˆ†ç»„
      html += `<div style='font-weight:600;color:#2176c7;margin-bottom:6px;cursor:pointer;user-select:none;' onclick='toggleAttrCollapseGroup("smart")'>
        <span style='display:inline-block;transform:rotate(${collapseState.smart?"90deg":"0deg"});transition:.2s;'>â–¶</span> æ™ºèƒ½æœåŠ¡
      </div>`;
      html += `<div id='attrSmartGroup' style='${collapseState.smart?"":"display:none;"}'>`;
      html += `<div style="color:#aaa;">æ™ºèƒ½æœåŠ¡é…ç½®åŠŸèƒ½</div>`;
      html += `</div>`;
      
      propsDiv.innerHTML = html;
    }
    function setDetailFieldProp(key, prop, value) {
      if (!fieldProps[key]) fieldProps[key] = { showLabel: true, width: 120, placeholder: '', isSensitive: false, sensitiveStart: 0, sensitiveEnd: 0 };
      if (prop === 'showLabel') fieldProps[key][prop] = value;
      else if (prop === 'width') fieldProps[key][prop] = +value;
      else if (prop === 'isSensitive') fieldProps[key][prop] = value;
      else if (prop === 'sensitiveStart') fieldProps[key][prop] = +value;
      else if (prop === 'sensitiveEnd') fieldProps[key][prop] = +value;
      else fieldProps[key][prop] = value;
      renderDetailCanvasFieldProps();
    }
    
    function toggleSensitiveConfig(key, isSensitive) {
      setDetailFieldProp(key, 'isSensitive', isSensitive);
      // å¦‚æœå–æ¶ˆæ•æ„Ÿä¿¡æ¯ï¼Œæ¸…ç©ºç›¸å…³å€¼
      if (!isSensitive) {
        setDetailFieldProp(key, 'sensitiveStart', 0);
        setDetailFieldProp(key, 'sensitiveEnd', 0);
      }
    }
    
    function toggleAttrCollapseGroup(group) {
      if (window.__attrCollapseState === undefined) {
        window.__attrCollapseState = { base: true, smart: true };
      }
      window.__attrCollapseState[group] = !window.__attrCollapseState[group];
      renderDetailCanvasFieldProps();
    }
    // æ–°å¢å…¨å±€å˜é‡ä¿å­˜å¸ƒå±€æ–¹å¼
    function setDetailLayoutType(type) {
      detailLayoutType = type;
      // å¯æ ¹æ®éœ€è¦åˆ·æ–°ç”»å¸ƒæˆ–å­è¡¨åŒºåŸŸ
      // renderDetailCanvasTabs();
    }
    
    // å¤åˆ¶å¸ƒå±€ç›¸å…³åŠŸèƒ½
    function openCopyLayoutModal() {
      const modal = document.getElementById('copyLayoutModal');
      const currentLayoutName = document.getElementById('currentLayoutName');
      const treeContainer = document.getElementById('copyLayoutTree');
      
      // æ˜¾ç¤ºå½“å‰å¸ƒå±€åç§°
      const currentView = detailViews.find(v => v.key === detailSelectedView);
      currentLayoutName.textContent = currentView ? currentView.label : 'æœªçŸ¥å¸ƒå±€';
      
      // æ¸²æŸ“æ ‘å½¢é€‰æ‹©å™¨
      renderCopyLayoutTree(treeContainer);
      
      modal.style.display = 'flex';
    }
    
    function closeCopyLayoutModal() {
      document.getElementById('copyLayoutModal').style.display = 'none';
    }
    
    function renderCopyLayoutTree(container) {
      // æ„å»ºå®Œæ•´çš„æ ‘å½¢ç»“æ„æ•°æ®
      const treeData = [
        {
          id: 'raw',
          name: 'åŸææ–™',
          children: [
            {
              id: 'metal',
              name: 'é‡‘å±ææ–™',
              children: [
                {
                  id: 'steel',
                  name: 'é’¢æ',
                  children: [
                    { id: 'carbon_steel', name: 'ç¢³é’¢' },
                    { id: 'stainless_steel', name: 'ä¸é”ˆé’¢' }
                  ]
                },
                {
                  id: 'aluminum',
                  name: 'é“æ',
                  children: [
                    { id: 'aluminum_alloy', name: 'é“åˆé‡‘' }
                  ]
                }
              ]
            },
            {
              id: 'non_metal',
              name: 'éé‡‘å±ææ–™',
              children: [
                { id: 'plastic', name: 'å¡‘æ–™' },
                { id: 'rubber', name: 'æ©¡èƒ¶' }
              ]
            }
          ]
        },
        {
          id: 'semi_finished',
          name: 'åŠæˆå“',
          children: [
            { id: 'casting', name: 'é“¸ä»¶' },
            { id: 'forging', name: 'é”»ä»¶' }
          ]
        },
        {
          id: 'finished',
          name: 'æˆå“',
          children: [
            { id: 'mechanical_parts', name: 'æœºæ¢°é›¶ä»¶' },
            { id: 'electronic_components', name: 'ç”µå­å…ƒä»¶' }
          ]
        }
      ];
      
      let html = '';
      
      function renderNode(node, level = 0) {
        const indent = level * 20;
        const hasChildren = node.children && node.children.length > 0;
        
        html += `<div style="margin-left:${indent}px;">`;
        
        if (hasChildren) {
          html += `<div class="copy-tree-node" data-id="${node.id}" style="display:flex;align-items:center;padding:4px 0;cursor:pointer;">`;
          html += `<span class="copy-tree-toggle" style="color:#2176c7;margin-right:6px;font-size:12px;transition:transform 0.2s;">â–¶</span>`;
          html += `<input type="checkbox" class="copy-tree-checkbox" data-id="${node.id}" style="margin-right:6px;">`;
          html += `<span>${node.name}</span>`;
          html += `</div>`;
          
          html += `<div class="copy-tree-children" data-parent="${node.id}" style="display:none;">`;
          node.children.forEach(child => renderNode(child, level + 1));
          html += `</div>`;
        } else {
          html += `<div class="copy-tree-node" data-id="${node.id}" style="display:flex;align-items:center;padding:4px 0;">`;
          html += `<span style="margin-right:6px;color:#999;">â—</span>`;
          html += `<input type="checkbox" class="copy-tree-checkbox" data-id="${node.id}" style="margin-right:6px;">`;
          html += `<span>${node.name}</span>`;
          html += `</div>`;
        }
        
        html += `</div>`;
      }
      
      treeData.forEach(node => renderNode(node));
      container.innerHTML = html;
      
      // ç»‘å®šäº‹ä»¶
      bindCopyTreeEvents();
    }
    
    function bindCopyTreeEvents() {
      // å±•å¼€/æ”¶èµ·èŠ‚ç‚¹
      document.querySelectorAll('.copy-tree-toggle').forEach(toggle => {
        toggle.addEventListener('click', function(e) {
          e.stopPropagation();
          const node = this.parentElement;
          const nodeId = node.getAttribute('data-id');
          const children = document.querySelector(`.copy-tree-children[data-parent="${nodeId}"]`);
          
          if (children) {
            if (children.style.display === 'none') {
              children.style.display = 'block';
              this.textContent = 'â–¼';
              this.style.transform = 'rotate(0deg)';
            } else {
              children.style.display = 'none';
              this.textContent = 'â–¶';
              this.style.transform = 'rotate(-90deg)';
            }
          }
        });
      });
      
      // çˆ¶èŠ‚ç‚¹é€‰ä¸­æ—¶ï¼Œå­èŠ‚ç‚¹ä¹Ÿé€‰ä¸­
      document.querySelectorAll('.copy-tree-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          const nodeId = this.getAttribute('data-id');
          const isChecked = this.checked;
          
          // é€‰ä¸­å­èŠ‚ç‚¹
          const children = document.querySelectorAll(`.copy-tree-children[data-parent="${nodeId}"] .copy-tree-checkbox`);
          children.forEach(child => {
            child.checked = isChecked;
          });
          
          // æ£€æŸ¥çˆ¶èŠ‚ç‚¹çŠ¶æ€
          updateParentCheckboxState(nodeId);
        });
      });
    }
    
    function updateParentCheckboxState(nodeId) {
      const parent = document.querySelector(`.copy-tree-children[data-parent="${nodeId}"]`);
      if (parent) {
        const parentId = parent.getAttribute('data-parent');
        const parentCheckbox = document.querySelector(`.copy-tree-checkbox[data-id="${parentId}"]`);
        const siblingCheckboxes = parent.querySelectorAll('.copy-tree-checkbox');
        const checkedSiblings = parent.querySelectorAll('.copy-tree-checkbox:checked');
        
        if (checkedSiblings.length === 0) {
          parentCheckbox.checked = false;
          parentCheckbox.indeterminate = false;
        } else if (checkedSiblings.length === siblingCheckboxes.length) {
          parentCheckbox.checked = true;
          parentCheckbox.indeterminate = false;
        } else {
          parentCheckbox.checked = false;
          parentCheckbox.indeterminate = true;
        }
      }
    }
    
    function copyLayoutToSelectedNodes() {
      const selectedCheckboxes = document.querySelectorAll('.copy-tree-checkbox:checked');
      const selectedNodes = Array.from(selectedCheckboxes).map(cb => ({
        id: cb.getAttribute('data-id'),
        name: cb.parentElement.querySelector('span:last-child').textContent
      }));
      
      if (selectedNodes.length === 0) {
        alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªç›®æ ‡èŠ‚ç‚¹');
        return;
      }
      
      // è·å–å½“å‰å¸ƒå±€é…ç½®
      const currentConfig = JSON.parse(JSON.stringify(detailCanvasConfig[detailSelectedView]));
      const currentLayoutType = detailLayoutType;
      
      // æ¨¡æ‹Ÿå¤åˆ¶åˆ°é€‰ä¸­çš„èŠ‚ç‚¹
      const nodeNames = selectedNodes.map(n => n.name).join('ã€');
      alert(`å¸ƒå±€å·²å¤åˆ¶åˆ°ä»¥ä¸‹èŠ‚ç‚¹ï¼š\n${nodeNames}\n\nï¼ˆå®é™…å¤åˆ¶é€»è¾‘è¯·å¯¹æ¥åç«¯APIï¼‰`);
      
      console.log('å¤åˆ¶å¸ƒå±€é…ç½®:', {
        sourceView: detailSelectedView,
        targetNodes: selectedNodes,
        layoutConfig: currentConfig,
        layoutType: currentLayoutType
      });
      
      closeCopyLayoutModal();
    }
    // æ–°å¢æ¸²æŸ“å­—æ®µæ–¹æ³•
    function renderPreviewFields(conf) {
      if(!conf || !conf.fields) return '<div style="color:#aaa;">æš‚æ— å­—æ®µ</div>';
      let html = `<div style='display:flex;flex-direction:column;gap:12px;'>`;
      const cols = conf.cols || 2;
      for(let i=0;i<conf.fields.length;i+=cols) {
        html += `<div style='display:flex;gap:16px;'>`;
        for(let j=0;j<cols;j++) {
          const f = conf.fields[i+j];
          if(f) {
            html += `<div style='flex:1;min-width:0;'><div style='font-weight:500;color:#2176c7;margin-bottom:2px;'>${f.label}</div><div style='border:1px solid #c0d3eb;background:#fff;padding:6px 10px;border-radius:4px;'>ç¤ºä¾‹${f.label}</div></div>`;
          }
        }
        html += `</div>`;
      }
      html += `</div>`;
      return html;
    }
    // é¡µé¢åˆå§‹åŒ–
    renderDraggableList(listFields, 'listFields', 'list');
    renderDraggableList(detailFields, 'detailFields', 'detail');
    renderFieldProps();
    renderDetailModelFieldPool();
    enableFieldDragDrop();
    renderDetailCanvasTabs();
    renderDetailCanvasFieldProps();
    
    // æ ‘å‹ç»“æ„äº¤äº’åŠŸèƒ½
    function toggleTreeNode(node) {
      const children = node.nextElementSibling;
      const icon = node.querySelector('span');
      if (children && children.classList.contains('tree-children')) {
        if (children.style.display === 'none') {
          children.style.display = 'block';
          icon.textContent = 'â–¼';
        } else {
          children.style.display = 'none';
          icon.textContent = 'â–¶';
        }
      }
    }
    
    function selectTreeNode(node) {
      // æ¸…é™¤ä¹‹å‰é€‰ä¸­çš„èŠ‚ç‚¹
      document.querySelectorAll('.tree-node').forEach(n => {
        n.style.backgroundColor = '';
        n.style.color = '';
      });
      
      // é€‰ä¸­å½“å‰èŠ‚ç‚¹
      node.style.backgroundColor = '#e3eaf3';
      node.style.color = '#2176c7';
      
      // å¯ä»¥åœ¨è¿™é‡Œæ·»åŠ é€‰ä¸­èŠ‚ç‚¹åçš„é€»è¾‘
      console.log('é€‰ä¸­èŠ‚ç‚¹:', node.textContent.trim());
    }
    
    // å…¨éƒ¨å±•å¼€æ ‘èŠ‚ç‚¹
    function expandAllTreeNodes() {
      const treeChildren = document.querySelectorAll('#materialTree .tree-children');
      const treeIcons = document.querySelectorAll('#materialTree .tree-node span');
      
      treeChildren.forEach(children => {
        children.style.display = 'block';
      });
      
      treeIcons.forEach(icon => {
        if (icon.textContent === 'â–¶') {
          icon.textContent = 'â–¼';
        }
      });
    }
    
    // å…¨éƒ¨æŠ˜å æ ‘èŠ‚ç‚¹
    function collapseAllTreeNodes() {
      const treeChildren = document.querySelectorAll('#materialTree .tree-children');
      const treeIcons = document.querySelectorAll('#materialTree .tree-node span');
      
      treeChildren.forEach(children => {
        children.style.display = 'none';
      });
      
      treeIcons.forEach(icon => {
        if (icon.textContent === 'â–¼') {
          icon.textContent = 'â–¶';
        }
      });
    }
    
    // æ›´æ–°å¸ƒå±€é…ç½®æŒ‡ç¤ºå™¨
    function updateLayoutIndicators() {}
    // é¡µé¢åˆå§‹åŒ–æ—¶æ›´æ–°æŒ‡ç¤ºå™¨
    document.addEventListener('DOMContentLoaded', function() {
      updateLayoutIndicators();
    });
  </script>
</body>
</html> 