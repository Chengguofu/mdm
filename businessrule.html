<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>ä¸šåŠ¡è§„åˆ™é…ç½®</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f7faff; margin:0; font-size: 13px; }
    .container { max-width: 1100px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 2px 12px rgba(33,118,199,0.10); padding: 32px 36px 28px 36px; font-size: 13px; }
    .section-title { color: #2176c7; font-size: 17px; font-weight: 600; margin-bottom: 18px; }
    .action-bar { display: flex; gap: 8px; align-items: center; margin-bottom: 10px; }
    .btn-main { background: #2176c7; color: #fff; border: none; border-radius: 4px; padding: 0 18px; height: 36px; font-size: 13px; display: flex; align-items: center; font-weight: 500; transition: background 0.18s; }
    .btn-main:hover { background: #185a99; }
    .btn-line { background: #fff; color: #444; border: 1px solid #d0d7de; border-radius: 4px; padding: 0 14px; height: 36px; font-size: 13px; display: flex; align-items: center; transition: background 0.18s, border 0.18s; }
    .btn-line:hover { background: #f5f7fa; border-color: #b0b8c1; }
    .table-wrap { background: #fff; border-radius: 8px; box-shadow: 0 2px 8px rgba(33, 118, 199, 0.06); padding: 18px 0 0 0; overflow-x: auto; }
    table { width: 100%; border-collapse: separate; border-spacing: 0; font-size: 13px; background: #fff; min-width: 900px; }
    th, td { padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left; white-space: nowrap; }
    th { background: #f4f8fb; color: #2176c7; font-weight: 600; }
    tr:last-child td { border-bottom: none; }
    tr:hover td { background: #f0f6fd; }
    td.center { text-align: center; }
    .modal-mask { display:none; position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.18);z-index:2000; }
    .drawer-content { position:fixed;top:0;right:-616px;width:616px;height:100vh;background:#fff;box-shadow:-4px 0 24px rgba(33,118,199,0.13);transition:right 0.3s ease;overflow:hidden;display:flex;flex-direction:column; }
    .drawer-header { background:#2176c7;color:#fff;font-size:18px;font-weight:500;padding:16px 24px;display:flex;justify-content:space-between;align-items:center; }
    .drawer-body { flex:1;overflow-y:auto;padding:24px; padding-bottom:96px; }
    .drawer-footer { padding:14px 24px;border-top:1px solid #e3eaf3;display:flex;justify-content:flex-end;gap:18px;background:#fff;z-index:10;position:sticky;bottom:0; }
    .drawer-close { cursor:pointer;font-size:22px; }
    .form-row { display:flex;align-items:center;margin-bottom:18px; }
    .form-label { width:120px;color:#185a99;font-size:13px;text-align:right;margin-right:8px; }
    .form-value { flex:1; }
    .form-value input, .form-value select, .form-value textarea { width:70%;padding:6px 10px;border:1.2px solid #c0d3eb;border-radius:4px;font-size:13px;background:#f9fbfd; }
    .required { color:#e53935; margin-left:2px; font-size:13px; }
    .condition-group { background:#f6f8fa; border-radius:6px; padding:12px 16px; margin-bottom:12px; max-height:300px; overflow-y:auto; }
    .condition-row { display:flex;align-items:center;gap:8px;margin-bottom:8px; }
    .condition-row:last-child { margin-bottom:0; }
    .condition-op { width:56px; }
    .condition-field { width:98px; }
    .condition-value { width:84px; }
    .condition-btn { background:#eaf3fb; color:#2176c7; border:none; border-radius:4px; padding:2px 10px; font-size:13px; cursor:pointer; margin-left:6px; white-space:nowrap; }
    .condition-btn:hover { background:#d0e7fa; }
    .adv-toggle { color:#2176c7; cursor:pointer; font-size:13px; margin-left:8px; }
    .adv-area { margin-top:8px; }
    .op-btn { background:none;border:none;color:#2176c7;cursor:pointer;font-size:13px;padding:0 8px; }
    .op-btn.op-del { color:#e74c3c; }
    /* 1. çŠ¶æ€å¼€å…³æ ·å¼ */
    .switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 24px;
      vertical-align: middle;
    }
    .switch input { display: none; }
    .slider {
      position: absolute;
      cursor: pointer;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: #ccc;
      transition: .3s;
      border-radius: 24px;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 3px;
      bottom: 3px;
      background-color: white;
      transition: .3s;
      border-radius: 50%;
    }
    input:checked + .slider {
      background-color: #2176c7;
    }
    input:checked + .slider:before {
      transform: translateX(20px);
    }
    .switch-label {
      margin-left: 8px;
      font-size: 13px;
      color: #2176c7;
      vertical-align: middle;
    }
    /* 2. æ¡ä»¶è®¾ç½®æ”¯æŒç»„åˆ */
    .cond-group-wrap { margin-bottom: 18px; border: 1px solid #e3eaf3; border-radius: 6px; padding: 12px; background: #f8fafc; }
    .cond-group-head { display: flex; align-items: center; margin-bottom: 8px; }
    .cond-group-logic { margin-right: 10px; }
    .cond-group-del { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 13px; margin-left: 8px; }
    .cond-items { margin-left: 18px; }
    .cond-item-row { display: flex; align-items: center; gap: 8px; margin-bottom: 6px; }
    .cond-item-row:last-child { margin-bottom: 0; }
    .cond-item-del { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 13px; }
    .cond-add-btn, .cond-group-add-btn { color: #2176c7; background: none; border: none; cursor: pointer; font-size: 13px; margin-top: 6px; }
    .drawer-body #condDrawerArea { max-height: 60vh; overflow-y: auto; }
    /* Modern style for .condition-builder */
    .condition-builder {
        padding: 18px;
        border: 1.5px solid #e0e6ed;
        border-radius: 12px;
        background: #fafdff;
        box-shadow: 0 2px 12px rgba(33,118,199,0.07);
    }
    .condition-builder .condition-group {
        padding: 18px;
        border: 1.5px dashed #b6c6e3;
        border-radius: 10px;
        background: #fff;
        margin-top: 14px;
        box-shadow: 0 2px 8px rgba(33,118,199,0.04);
    }
    .condition-builder .condition-group .condition-group {
        margin-left: 24px;
        border-left: 2.5px solid #2176c7;
    }
    .condition-builder .group-controls {
        margin-bottom: 14px;
        display: flex;
        align-items: center;
        gap: 12px;
        font-size: 13px;
    }
    .condition-builder .condition-row {
        display: grid;
        grid-template-columns: repeat(4, 1fr) auto;
        gap: 12px;
        align-items: center;
        margin-bottom: 12px;
        font-size: 13px;
    }
    .condition-builder .condition-row > * {
        min-width: 0;
    }
    .condition-builder .group-placeholder {
        padding: 22px;
        text-align: center;
        color: #b0b8c1;
        background-color: #f4f8fb;
        border-radius: 6px;
        border: 1.5px dashed #d0d7de;
        font-size: 13px;
    }
    .condition-builder .form-select, .condition-builder .form-control {
        border-radius: 8px;
        border: 1.5px solid #d0d7de;
        background: #fafdff;
        font-size: 13px;
        padding: 8px 14px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: none;
    }
    .condition-builder .form-select:focus, .condition-builder .form-control:focus {
        border-color: #2176c7;
        box-shadow: 0 0 0 2px #e3f0fc;
        outline: none;
        background: #fff;
    }
    .condition-builder .btn, .condition-builder .btn-sm {
        border-radius: 8px;
        font-size: 13px;
        font-weight: 500;
        transition: background 0.18s, box-shadow 0.18s, border 0.18s;
        box-shadow: 0 1px 4px rgba(33,118,199,0.06);
        border: none;
    }
    .condition-builder .btn-primary {
        background: linear-gradient(90deg, #2176c7 60%, #5fa8e6 100%);
        color: #fff;
    }
    .condition-builder .btn-primary:hover {
        background: linear-gradient(90deg, #185a99 60%, #2176c7 100%);
    }
    .condition-builder .btn-secondary {
        background: #e3eaf3;
        color: #2176c7;
    }
    .condition-builder .btn-secondary:hover {
        background: #d0d7de;
        color: #185a99;
    }
    .condition-builder .btn-danger.delete-condition-btn {
        min-width: 44px;
        padding: 6px 0;
        font-size: 13px;
        text-align: center;
        background: linear-gradient(90deg, #e53935 60%, #ff6f60 100%);
        color: #fff;
        border: none;
        box-shadow: 0 1px 4px rgba(229,57,53,0.08);
    }
    .condition-builder .btn-danger.delete-condition-btn:hover {
        background: linear-gradient(90deg, #b71c1c 60%, #e53935 100%);
    }
    /* è°ƒæ•´æ¡ä»¶è®¾ç½®æŠ½å±‰å®½åº¦ */
    .drawer-content#condDrawerContent {
        width: 800px !important;
        max-width: 95vw;
    }
    /* åªä¿ç•™ä¸€å±‚æ¡ä»¶ç¼–è¾‘åŒºåŸŸï¼Œå»é™¤å¤šä½™åµŒå¥—æ ·å¼å½±å“ */
    .drawer-body #condDrawerArea > .condition-builder {
        border: none;
        box-shadow: none;
        padding: 0;
        margin: 0;
    }
    .drawer-body #condDrawerArea > .condition-builder > .condition-group {
        margin-top: 0;
    }
    /* æ ¡éªŒå­—æ®µè®¾ç½®å¡ç‰‡å’Œç°ä»£è¾“å…¥é£æ ¼ */
    .field-group {
        background: #fff;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(33,118,199,0.07);
        border: 1.5px solid #e0e6ed;
        padding: 18px 16px 14px 16px;
        margin-bottom: 16px;
        display: flex;
        align-items: center;
        gap: 14px;
        transition: box-shadow 0.2s, border 0.2s;
    }
    .field-group:hover {
        box-shadow: 0 4px 16px rgba(33,118,199,0.13);
        border-color: #2176c7;
    }
    .field-group .form-control, .field-group .form-select {
        width: 80%;
        font-size: 13px;
        border-radius: 8px;
        border: 1.5px solid #d0d7de;
        background: #fafdff;
        padding: 8px 14px;
        transition: border 0.2s, box-shadow 0.2s;
        box-shadow: none;
    }
    .field-group .form-control:focus, .field-group .form-select:focus {
        border-color: #2176c7;
        box-shadow: 0 0 0 2px #e3f0fc;
        outline: none;
        background: #fff;
    }
    .field-group .btn-danger.del-field-group {
        min-width: 44px;
        padding: 6px 0;
        font-size: 13px;
        text-align: center;
        background: linear-gradient(90deg, #e53935 60%, #ff6f60 100%);
        color: #fff;
        border: none;
        border-radius: 8px;
        box-shadow: 0 1px 4px rgba(229,57,53,0.08);
        transition: background 0.18s;
    }
    .field-group .btn-danger.del-field-group:hover {
        background: linear-gradient(90deg, #b71c1c 60%, #e53935 100%);
    }
    /* ç¾åŒ–"æ·»åŠ ä¸€ç»„"æŒ‰é’® */
    #fieldGroupList + .btn-primary {
        display: flex;
        align-items: center;
        gap: 8px;
        width: 100%;
        min-width: 0;
        justify-content: center;
        font-size: 13px;
        font-weight: 500;
        border-radius: 8px;
        padding: 10px 0;
        background: linear-gradient(90deg, #2176c7 60%, #5fa8e6 100%);
        color: #fff;
        box-shadow: 0 1px 4px rgba(33,118,199,0.08);
        border: none;
        transition: background 0.18s, box-shadow 0.18s;
    }
    #fieldGroupList + .btn-primary:hover {
        background: linear-gradient(90deg, #185a99 60%, #2176c7 100%);
    }
    #fieldGroupList + .btn-primary .icon {
        font-size: 18px;
        display: inline-flex;
        align-items: center;
    }
    /* åœ¨åŸæœ‰æ ·å¼åè¿½åŠ ç¾åŒ–å¤šé€‰ä¸‹æ‹‰çš„CSS */
    select[multiple] {
      min-height: 38px;
      border: 1.5px solid #b6c6e3;
      border-radius: 8px;
      background: #fafdff;
      font-size: 13px;
      padding: 8px 14px;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      outline: none;
      transition: border 0.2s, box-shadow 0.2s;
    }
    select[multiple]:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px #e3f0fc;
      background: #fff;
    }
    select[multiple] option {
      padding: 6px 10px;
      border-radius: 4px;
      margin: 2px 0;
    }
    #addUniqueCardBtn {
      width: 90%;
      max-width: 400px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: 1.5px solid #2176c7;
      color: #2176c7;
      border-radius: 6px;
      padding: 6px 0;
      font-size: 13px;
      cursor: pointer;
      gap: 5px;
      box-shadow: none;
      transition: background 0.18s, color 0.18s, border 0.18s;
      height: 32px;
      margin: 6px auto 4px auto;
    }
    #addUniqueCardBtn:hover {
      background: #2176c7;
      color: #fff;
    }
    #addUniqueCardBtn .icon {
      font-size: 16px;
      display: inline-flex;
      align-items: center;
    }
    .multi-select-wrap {
      position: relative;
    }
    .multi-select-input {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      min-height: 25px;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      padding: 1px 4px 1px 4px;
      background: #fff;
      cursor: pointer;
    }
    .multi-select-hidden-input {
      border: none;
      outline: none;
      flex: 1 1 28px;
      min-width: 28px;
      height: 19px;
      background: transparent;
      padding: 0;
      margin: 0;
      display: inline-block;
    }
    .multi-select-option {
      padding: 6px 12px;
      cursor: pointer;
      background: #fff;
    }
    .multi-select-option:hover {
      background: #f4f7fa;
    }
    .multi-select-option.selected {
      color: #2176c7;
    }
    .multi-tag {
      display: inline-block;
      padding: 1px 4px;
      margin: 1px;
      border-radius: 3px;
      background: #e0e6ed;
    }
    .multi-tag-close {
      margin-left: 2px;
      cursor: pointer;
    }
    .multi-select-dropdown {
      display: none;
      position: absolute;
      top: 110%;
      left: 0;
      width: 100%;
      background: #fff;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      box-shadow: 0 2px 12px rgba(33,118,199,0.10);
      z-index: 10;
      max-height: 180px;
      overflow: auto;
    }
    .multi-select-input, .form-control {
      min-height: 36px !important;
      height: 36px !important;
      box-sizing: border-box;
      border: 1.5px solid #d0d7de;
      border-radius: 7px;
      font-size: 15px;
      padding: 2px 10px 2px 10px;
      background: #fff;
      width: 100%;
      display: flex;
      align-items: center;
    }
    .multi-select-input {
      flex-wrap: wrap;
      cursor: pointer;
      padding: 2px 10px 2px 10px;
    }
    .multi-select-hidden-input {
      border: none;
      outline: none;
      flex: 1 1 28px;
      min-width: 28px;
      height: 28px;
      background: transparent;
      padding: 0;
      margin: 0;
      display: inline-block;
      font-size: 15px;
    }
    select.form-control {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
      background: #fff;
      padding-right: 30px;
      cursor: pointer;
    }
    .multi-tag {
      display: inline-block;
      padding: 1px 8px;
      margin: 1px;
      border-radius: 3px;
      background: #e0e6ed;
      font-size: 15px;
      height: 28px;
      line-height: 26px;
      vertical-align: middle;
    }
    
    /* è”åˆæ ¡éªŒåŒºåŸŸæ ·å¼ */
    #jointValidationArea {
      transition: all 0.3s ease;
      border-left: 3px solid #2176c7;
      padding-left: 16px;
      margin-left: 8px;
      background: linear-gradient(90deg, rgba(33,118,199,0.03) 0%, rgba(33,118,199,0.01) 100%);
      border-radius: 0 8px 8px 0;
    }
    
    /* è”åˆæ ¡éªŒå¼€å…³æ ‡ç­¾æ ·å¼ */
    .switch-label {
      margin-left: 8px;
      font-size: 13px;
      color: #2176c7;
      vertical-align: middle;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="section-title">ä¸šåŠ¡è§„åˆ™é…ç½®</div>
    <div class="action-bar">
      <button class="btn-main" id="addBtn">æ–°å¢è§„åˆ™</button>
    </div>
    <div class="table-wrap">
      <table id="ruleTable">
        <thead>
          <tr>
            <th>è§„åˆ™åç§°</th>
            <th>è§„åˆ™ç±»å‹</th>
            <!--<th>æ ¡éªŒç±»å‹</th>-->
            <th>çŠ¶æ€</th>
            <th>åˆ›å»ºäºº</th>
            <th>åˆ›å»ºæ—¶é—´</th>
            <th style="text-align:center;">æ“ä½œ</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
  </div>
  <!-- æ–°å¢/ç¼–è¾‘æŠ½å±‰ -->
  <div class="modal-mask" id="editDrawerMask">
    <div class="drawer-content" id="editDrawerContent">
      <div class="drawer-header">
        <span id="drawerTitle">æ–°å¢ä¸šåŠ¡è§„åˆ™</span>
        <span class="drawer-close" id="drawerClose">Ã—</span>
      </div>
      <form id="editForm">
        <div class="drawer-body" style="overflow-y:auto;max-height:calc(100vh - 120px);">
          <div class="form-row">
            <div class="form-label">è§„åˆ™åç§°<span class="required">*</span>ï¼š</div>
            <div class="form-value"><input type="text" id="editName" required style="width:308px"></div>
          </div>
          <div class="form-row">
            <div class="form-label">è§„åˆ™ç±»å‹<span class="required">*</span>ï¼š</div>
            <div class="form-value">
              <select id="editType" required style="width:70%">
                <option value="å”¯ä¸€æ€§æ ¡éªŒ">å”¯ä¸€æ€§æ ¡éªŒ</option>
                <option value="çº¦æŸæ¡ä»¶æ ¡éªŒ">çº¦æŸæ¡ä»¶æ ¡éªŒ</option>
                <option value="å¿…å¡«è§„åˆ™">å¿…å¡«è§„åˆ™</option>
                <option value="åªè¯»è§„åˆ™">åªè¯»è§„åˆ™</option>
                <option value="èµ‹å€¼è§„åˆ™">èµ‹å€¼è§„åˆ™</option>
                <option value="æ˜¾éšè§„åˆ™">æ˜¾éšè§„åˆ™</option>
                <option value="æ•°æ®è”åŠ¨">æ•°æ®è”åŠ¨</option>
              </select>
            </div>
          </div>
          <div id="ruleDetailArea"></div>
          <div class="form-row">
            <div class="form-label">çŠ¶æ€ï¼š</div>
            <div class="form-value">
              <label class="switch"><input type="checkbox" id="editStatusSwitch"><span class="slider"></span></label>
            </div>
          </div>
        </div>
        <div class="drawer-footer">
          <button type="submit" class="btn-main">ä¿å­˜</button>
          <button type="button" class="btn-line" id="drawerCancel">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>
  <!-- æ¡ä»¶è®¾ç½®æŠ½å±‰ -->
  <div class="modal-mask" id="condDrawerMask">
    <div class="drawer-content" id="condDrawerContent">
      <div class="drawer-header">
        <span>æ¡ä»¶è®¾ç½®</span>
        <span class="drawer-close" id="condDrawerClose">Ã—</span>
      </div>
      <form id="condForm">
        <div class="drawer-body">
          <div id="condDrawerArea" class="condition-builder"></div>
        </div>
        <div class="drawer-footer">
          <button type="button" class="btn-main" id="condDrawerSave">ä¿å­˜</button>
          <button type="button" class="btn-line" id="condDrawerCancel">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>

  <!-- æ ¡éªŒå­—æ®µæŠ½å±‰ -->
  <div class="modal-mask" id="fieldDrawerMask">
    <div class="drawer-content" id="fieldDrawerContent">
      <div class="drawer-header">
        <span>æ ¡éªŒå­—æ®µè®¾ç½®</span>
        <span class="drawer-close" id="fieldDrawerClose">Ã—</span>
      </div>
      <form id="fieldForm">
        <div class="drawer-body">
          <div id="fieldDrawerArea" class="condition-builder"></div>
        </div>
        <div class="drawer-footer">
          <button type="button" class="btn-main" id="fieldDrawerSave">ä¿å­˜</button>
          <button type="button" class="btn-line" id="fieldDrawerCancel">å–æ¶ˆ</button>
        </div>
      </form>
    </div>
  </div>
  <script>
    // è§„åˆ™æ•°æ®
    let rules = [];
    let editIdx = -1;
    function renderTable() {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = rules.map((item, idx) => `
        <tr>
          <td>${item.name}</td>
          <td>${item.type}</td>
          <!--<td>${item.type === 'æ ¡éªŒè§„åˆ™' ? (item.detail && item.detail.validateType ? item.detail.validateType : '-') : '-'}</td>-->
          <td><label class="switch"><input type="checkbox" ${item.status==='å¯ç”¨'?'checked':''} onchange="toggleRowStatus(${idx})"><span class="slider"></span></label><span class="switch-label">${item.status}</span></td>
          <td>${item.creator || 'ç®¡ç†å‘˜'}</td>
          <td>${item.createTime}</td>
          <td class="center">
            <!-- <button type="button" onclick="showCondDrawer(${idx})" class="op-btn">æ¡ä»¶è®¾ç½®</button><button type="button" onclick="showFieldDrawer(${idx})" class="op-btn">æ ¡éªŒå­—æ®µ</button> -->
            <button type="button" onclick="editRule(${idx})" class="op-btn">ç¼–è¾‘</button>
            <button type="button" onclick="deleteRule(${idx})" class="op-btn op-del">åˆ é™¤</button>
          </td>
        </tr>
      `).join('');
    }
    renderTable();
    document.getElementById('addBtn').onclick = function() {
      editIdx = -1;
      var drawerTitle = document.getElementById('drawerTitle');
      if (drawerTitle) drawerTitle.textContent = 'æ–°å¢ä¸šåŠ¡è§„åˆ™';
      var editName = document.getElementById('editName');
      if (editName) editName.value = '';
      var editType = document.getElementById('editType');
      if (editType) editType.value = 'æ ¡éªŒè§„åˆ™';
      var editStatusSwitch = document.getElementById('editStatusSwitch');
      if (editStatusSwitch) editStatusSwitch.checked = true;
      var editStatusLabel = document.getElementById('editStatusLabel');
      if (editStatusLabel) editStatusLabel.textContent = 'å¯ç”¨';
      var ruleDetailArea = document.getElementById('ruleDetailArea');
      if (ruleDetailArea) ruleDetailArea.innerHTML = '';
      renderRuleDetail('æ ¡éªŒè§„åˆ™', null);
      showDrawer();
    };
    document.getElementById('drawerClose').onclick = document.getElementById('drawerCancel').onclick = function() {
      hideDrawer();
    };
    document.getElementById('editType').onchange = function() {
      renderRuleDetail(this.value, null);
    };
    // æ˜¾ç¤ºæŠ½å±‰
    function showDrawer() {
      document.getElementById('editDrawerMask').style.display = 'block';
      setTimeout(() => {
        document.getElementById('editDrawerContent').style.right = '0';
      }, 10);
    }
    // éšè—æŠ½å±‰
    function hideDrawer() {
      document.getElementById('editDrawerContent').style.right = '-616px';
      setTimeout(() => {
        document.getElementById('editDrawerMask').style.display = 'none';
      }, 300);
    }
    // ç¼–è¾‘
    window.editRule = function(idx) {
      editIdx = idx;
      const item = rules[idx];
      var drawerTitle = document.getElementById('drawerTitle');
      if (drawerTitle) drawerTitle.textContent = 'ç¼–è¾‘ä¸šåŠ¡è§„åˆ™';
      var editName = document.getElementById('editName');
      if (editName) editName.value = item.name;
      var editType = document.getElementById('editType');
      if (editType) editType.value = item.type;
      var editStatusSwitch = document.getElementById('editStatusSwitch');
      if (editStatusSwitch) editStatusSwitch.checked = item.status === 'å¯ç”¨';
      var editStatusLabel = document.getElementById('editStatusLabel');
      if (editStatusLabel) editStatusLabel.textContent = item.status;
      renderRuleDetail(item.type, item.detail);
      showDrawer();
    };
    // åˆ é™¤
    window.deleteRule = function(idx) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥è§„åˆ™å—ï¼Ÿ')) return;
      rules.splice(idx, 1);
      renderTable();
    };
    // ä¿å­˜
    document.getElementById('editForm').onsubmit = function(e) {
      e.preventDefault();
      const name = document.getElementById('editName').value.trim();
      const type = document.getElementById('editType').value;
      const status = document.getElementById('editStatusSwitch').checked ? 'å¯ç”¨' : 'åœç”¨';
      const createTime = new Date().toLocaleString();
      const detail = collectRuleDetail(type);
      if (!name) { alert('è§„åˆ™åç§°ä¸ºå¿…å¡«é¡¹ï¼'); return; }
      if (!detail) return;
      if (editIdx === -1) {
        rules.push({ name, type, status, creator: 'ç®¡ç†å‘˜', createTime, detail });
      } else {
        rules[editIdx] = { name, type, status, creator: 'ç®¡ç†å‘˜', createTime, detail };
      }
      renderTable();
      hideDrawer();
    };
    // è§„åˆ™ç±»å‹è¡¨å•æ¸²æŸ“
    function renderRuleDetail(type, detail) {
      const area = document.getElementById('ruleDetailArea');
      let html = '';
      if (type === 'å”¯ä¸€æ€§æ ¡éªŒ' || type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
        // åŸæ ¡éªŒè§„åˆ™+æ ¡éªŒç±»å‹é€»è¾‘
        html += `<div class='form-row'><div class='form-label'>è§„åˆ™çº§åˆ«ï¼š</div><div class='form-value'><select id='validateLevel'><option value='é”™è¯¯å‹æ ¡éªŒè§„åˆ™'>é”™è¯¯å‹æ ¡éªŒè§„åˆ™</option><option value='è­¦å‘Šå‹æ ¡éªŒè§„åˆ™'>è­¦å‘Šå‹æ ¡éªŒè§„åˆ™</option></select></div></div>`;
        html += `<div class='form-row'><div class='form-label'>æ ¡éªŒæç¤ºä¿¡æ¯ï¼š</div><div class='form-value'><input id='validateMsg' placeholder='æç¤ºå†…å®¹'></div></div>`;
        
        if (type === 'å”¯ä¸€æ€§æ ¡éªŒ') {
          // å…ˆåˆå§‹åŒ–å”¯ä¸€æ€§æ ¡éªŒæ•°æ®
          if (!window.uniqueCards || !window.uniqueCards[0]) {
            window.uniqueCards = [{ 
              uniqueAttr: '', 
              uniqueAttrArr: [], 
              uniqueMaster: '', 
              uniqueMasterAttr: '', 
              uniqueMasterAttrArr: [],
              enableJointValidation: false, // æ–°å¢ï¼šæ˜¯å¦å¯ç”¨è”åˆæ ¡éªŒ
              caseSensitive: false, // æ–°å¢ï¼šåŒºåˆ†å¤§å°å†™
              ignoreAllSpace: true, // æ–°å¢ï¼šå¿½ç•¥æ‰€æœ‰ç©ºæ ¼ï¼Œé»˜è®¤true
              ignoreFullHalf: false // æ–°å¢ï¼šä¸åŒºåˆ†å…¨è§’åŠè§’
            }];
          }
          
          // å¦‚æœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼Œæ¢å¤ä¿å­˜çš„æ•°æ®
          if (detail) {
            window.uniqueCards[0].uniqueAttr = detail.uniqueAttr || '';
            window.uniqueCards[0].uniqueAttrArr = detail.uniqueAttrArr || [];
            window.uniqueCards[0].enableJointValidation = detail.enableJointValidation || false;
            window.uniqueCards[0].uniqueMaster = detail.uniqueMaster || '';
            window.uniqueCards[0].uniqueMasterAttr = detail.uniqueMasterAttr || '';
            window.uniqueCards[0].uniqueMasterAttrArr = detail.uniqueMasterAttrArr || [];
            window.uniqueCards[0].caseSensitive = detail.caseSensitive || false;
            window.uniqueCards[0].ignoreAllSpace = detail.ignoreAllSpace !== false;
            window.uniqueCards[0].ignoreFullHalf = detail.ignoreFullHalf || false;
          }
          
          // å”¯ä¸€æ€§æ ¡éªŒè¡¨å•åŒºåŸŸ
          html += `
            <div class='form-row'>
              <div class='form-label'>å±æ€§</div>
              <div class='form-value'>
                <div class='multi-select-wrap' style='width:100%;position:relative;'>
                  <div class='multi-select-input' tabindex='0' style='width:100%;' data-idx='0'>
                    ${(window.uniqueCards[0].uniqueAttrArr||[]).map(attr=>`<span class='multi-tag'>${attr}<span class='multi-tag-close' data-value='${attr}' style='margin-left:2px;cursor:pointer;'>&times;</span></span>`).join('')}
                    <input class='multi-select-hidden-input' style='border:none;outline:none;flex:1 1 40px;min-width:40px;height:28px;background:transparent;padding:0;margin:0;display:inline-block;' readonly placeholder='è¯·é€‰æ‹©å±æ€§ï¼Œå¯å¤šé€‰'>
                  </div>
                  <div class='multi-select-dropdown' style='display:none;position:absolute;top:110%;left:0;width:100%;background:#fff;border:1.5px solid #d0d7de;border-radius:7px;box-shadow:0 2px 12px rgba(33,118,199,0.10);z-index:10;max-height:180px;overflow:auto;'></div>
                </div>
              </div>
            </div>
            <div id='uniqueOptionsRow' style='margin-top:0;margin-bottom:18px;display:flex;justify-content:flex-start;'>
              <div style='display:flex;align-items:center;gap:28px;margin-left:120px;'>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='caseSensitive' ${(window.uniqueCards[0].caseSensitive)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>åŒºåˆ†å¤§å°å†™</span></label>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='ignoreAllSpace' ${(window.uniqueCards[0].ignoreAllSpace!==false)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>å¿½ç•¥æ‰€æœ‰ç©ºæ ¼</span></label>
                <label style='display:flex;align-items:center;font-weight:400;color:#185a99;'><input type='checkbox' id='ignoreFullHalf' ${(window.uniqueCards[0].ignoreFullHalf)?'checked':''} style='margin-right:6px;'><span style='font-size:13px;'>åŒºåˆ†å…¨è§’åŠè§’</span></label>
              </div>
            </div>
            <div class='form-row'>
              <div class='form-label'>è”åˆæ ¡éªŒï¼š</div>
              <div class='form-value' style='display:flex;align-items:center;gap:8px;'>
                <label class="switch">
                  <input type="checkbox" id="jointValidationSwitch" ${(window.uniqueCards[0].enableJointValidation || false) ? 'checked' : ''}>
                  <span class="slider"></span>
                </label>
                <span class="joint-help-icon" style="font-size:16px;color:#2176c7;border-radius:50%;border:1px solid #b6c6e3;width:18px;height:18px;display:inline-flex;align-items:center;justify-content:center;line-height:18px;cursor:pointer;margin-left:6px;position:relative;z-index:101;">?
                  <span class="joint-help-pop" style="display:none;position:absolute;left:24px;top:50%;transform:translateY(-50%);background:#fff;border:1px solid #b6c6e3;border-radius:6px;padding:8px 14px;box-shadow:0 2px 8px rgba(33,118,199,0.13);font-size:13px;min-width:220px;z-index:999;white-space:normal;">æ ¡éªŒå½“å‰è¾“å…¥å€¼ä¸å¦ä¸€ä¸ªä¸»æ•°æ®æ¨¡å‹ä¸­çš„å¯¹åº”å±æ€§å€¼ï¼Œç¡®ä¿æ•°æ®åœ¨ä¸¤ä¸ªæ¨¡å‹ä¸­åŒæ—¶ä¿æŒå”¯ä¸€</span>
                </span>
              </div>
            </div>
            <div id="jointValidationArea" style="display: ${(window.uniqueCards[0].enableJointValidation || false) ? 'block' : 'none'};">
              <div class='form-row'>
                <div class='form-label'>ä¸»æ•°æ®</div>
                <div class='form-value'>
                  <select class='form-control' style='width:100%;' id='uniqueMasterSelect'>
                    <option value=''>è¯·é€‰æ‹©ä¸»æ•°æ®</option>
                    <option value='master1' ${(window.uniqueCards[0].uniqueMaster === 'master1') ? 'selected' : ''}>ä¸»æ•°æ®1</option>
                    <option value='master2' ${(window.uniqueCards[0].uniqueMaster === 'master2') ? 'selected' : ''}>ä¸»æ•°æ®2</option>
                    <option value='master3' ${(window.uniqueCards[0].uniqueMaster === 'master3') ? 'selected' : ''}>ä¸»æ•°æ®3</option>
                  </select>
                </div>
              </div>
              <div class='form-row'>
                <div class='form-label'>ä¸»æ•°æ®å±æ€§</div>
                <div class='form-value'>
                  <select id='uniqueMasterAttrSelect' style='width:100%;'>
                    <option value=''>è¯·é€‰æ‹©ä¸»æ•°æ®å±æ€§</option>
                    <option value='å®¢æˆ·åç§°' ${(window.uniqueCards[0].uniqueMasterAttr==="å®¢æˆ·åç§°")?'selected':''}>å®¢æˆ·åç§°</option>
                    <option value='å®¢æˆ·ç¼–ç ' ${(window.uniqueCards[0].uniqueMasterAttr==="å®¢æˆ·ç¼–ç ")?'selected':''}>å®¢æˆ·ç¼–ç </option>
                    <option value='ä¾›åº”å•†åç§°' ${(window.uniqueCards[0].uniqueMasterAttr==="ä¾›åº”å•†åç§°")?'selected':''}>ä¾›åº”å•†åç§°</option>
                    <option value='ä¾›åº”å•†ç¼–ç ' ${(window.uniqueCards[0].uniqueMasterAttr==="ä¾›åº”å•†ç¼–ç ")?'selected':''}>ä¾›åº”å•†ç¼–ç </option>
                    <option value='ç‰©æ–™åç§°' ${(window.uniqueCards[0].uniqueMasterAttr==="ç‰©æ–™åç§°")?'selected':''}>ç‰©æ–™åç§°</option>
                    <option value='ç‰©æ–™ç¼–ç ' ${(window.uniqueCards[0].uniqueMasterAttr==="ç‰©æ–™ç¼–ç ")?'selected':''}>ç‰©æ–™ç¼–ç </option>
                    <option value='ä½¿ç”¨å•ä½åç§°' ${(window.uniqueCards[0].uniqueMasterAttr==="ä½¿ç”¨å•ä½åç§°")?'selected':''}>ä½¿ç”¨å•ä½åç§°</option>
                    <option value='ä½¿ç”¨å•ä½ç¼–ç ' ${(window.uniqueCards[0].uniqueMasterAttr==="ä½¿ç”¨å•ä½ç¼–ç ")?'selected':''}>ä½¿ç”¨å•ä½ç¼–ç </option>
                  </select>
                </div>
              </div>
            </div>
          `;
          // é€‚ç”¨æ¡ä»¶å’ŒçŠ¶æ€åŒºåŸŸ
          html += `<div id='uniqueCondStatusArea'></div>`;
        } else if (type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
          // æ–°å¢ï¼šæ ¡éªŒç±»å‹ä¸‹æ‹‰
          let validateType = (detail && detail.validateType) || 'æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ';
          html += `<div class='form-row'><div class='form-label'>æ ¡éªŒç±»å‹ï¼š</div><div class='form-value'><select id='validateTypeSelect' style='width:70%'><option value='æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ' ${validateType==='æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ'?'selected':''}>æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ</option><option value='çº¦æŸè¡¨è¾¾å¼' ${validateType==='çº¦æŸè¡¨è¾¾å¼'?'selected':''}>çº¦æŸè¡¨è¾¾å¼</option></select></div></div>`;
          // æ­£åˆ™è¡¨è¾¾å¼è¾“å…¥æ¡†
          html += `<div class='form-row' id='regexRow' style='display:${validateType==='æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ'?'flex':'none'};'><div class='form-label'>æ­£åˆ™è¡¨è¾¾å¼ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='regexInput' class='form-control' style='width:100%;' placeholder='è¯·è¾“å…¥æˆ–é€‰æ‹©æ­£åˆ™è¡¨è¾¾å¼'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‰æ‹©æ­£åˆ™è¡¨è¾¾å¼' id='regexSelectBtn'>ğŸ”</span></div></div>`;
          // çº¦æŸè¡¨è¾¾å¼è¾“å…¥æ¡†
          html += `<div class='form-row' id='constraintRuleRow' style='display:${validateType==='çº¦æŸè¡¨è¾¾å¼'?'flex':'none'};'><div class='form-label'>çº¦æŸè§„åˆ™ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='constraintRuleInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘çº¦æŸè§„åˆ™'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='çº¦æŸè§„åˆ™ç¼–è¾‘' id='constraintRuleBtn'>ğŸ”</span></div></div>`;
          html += `<div class='form-row'><div class='form-label'>é€‚ç”¨æ¡ä»¶ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'><input id='constraintCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘'><span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‚ç”¨æ¡ä»¶ç¼–è¾‘' id='constraintCondBtn'>ğŸ”</span></div></div>`;
        }
      } else if (type === 'å¿…å¡«è§„åˆ™' || type === 'æ˜¾éšè§„åˆ™') {
        // æ˜¾éšè§„åˆ™å¢åŠ æ“ä½œå­—æ®µ
        if (type === 'æ˜¾éšè§„åˆ™') {
          html += `<div class='form-row'><div class='form-label'>æ“ä½œï¼š</div><div class='form-value'><select id='showHideType' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'><option value='æ˜¾ç¤º'>æ˜¾ç¤º</option><option value='éšè—'>éšè—</option></select></div></div>`;
        }
        // å­—æ®µä¸‹æ‹‰å•é€‰ï¼Œlabelä¸º"æ¨¡å‹å±æ€§"
        const fieldOptions = [
          { name: 'å®¢æˆ·åç§°', code: 'customerName' },
          { name: 'å®¢æˆ·ç¼–ç ', code: 'customerCode' },
          { name: 'ä¾›åº”å•†åç§°', code: 'supplierName' },
          { name: 'ä¾›åº”å•†ç¼–ç ', code: 'supplierCode' },
          { name: 'ç‰©æ–™åç§°', code: 'materialName' },
          { name: 'ç‰©æ–™ç¼–ç ', code: 'materialCode' },
          { name: 'ä½¿ç”¨å•ä½åç§°', code: 'useUnitName' },
          { name: 'ä½¿ç”¨å•ä½ç¼–ç ', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.fields) {
          selected = detail.fields;
        }
        html += `<div class='form-row'><div class='form-label'>æ¨¡å‹å±æ€§ï¼š</div><div class='form-value'>`;
        html += `<select id='fieldsInput' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©æ¨¡å‹å±æ€§</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // é€‚ç”¨æ¡ä»¶å­—æ®µ
        html += `<div class='form-row'><div class='form-label'>é€‚ç”¨æ¡ä»¶ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='requiredCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‚ç”¨æ¡ä»¶ç¼–è¾‘' id='requiredCondBtn'>ğŸ”</span>
        </div></div>`;
      } else if (type === 'åªè¯»è§„åˆ™') {
        // å­—æ®µä¸‹æ‹‰å•é€‰ï¼Œlabelä¸º"æ¨¡å‹å±æ€§"
        const fieldOptions = [
          { name: 'å®¢æˆ·åç§°', code: 'customerName' },
          { name: 'å®¢æˆ·ç¼–ç ', code: 'customerCode' },
          { name: 'ä¾›åº”å•†åç§°', code: 'supplierName' },
          { name: 'ä¾›åº”å•†ç¼–ç ', code: 'supplierCode' },
          { name: 'ç‰©æ–™åç§°', code: 'materialName' },
          { name: 'ç‰©æ–™ç¼–ç ', code: 'materialCode' },
          { name: 'ä½¿ç”¨å•ä½åç§°', code: 'useUnitName' },
          { name: 'ä½¿ç”¨å•ä½ç¼–ç ', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.fields) {
          selected = detail.fields;
        }
        html += `<div class='form-row'><div class='form-label'>æ¨¡å‹å±æ€§ï¼š</div><div class='form-value'>`;
        html += `<select id='fieldsInput' style='width: 100%; min-height: 38px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©æ¨¡å‹å±æ€§</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // é€‚ç”¨æ¡ä»¶å­—æ®µ
        html += `<div class='form-row'><div class='form-label'>é€‚ç”¨æ¡ä»¶ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='readonlyCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‚ç”¨æ¡ä»¶ç¼–è¾‘' id='readonlyCondBtn'>ğŸ”</span>
        </div></div>`;
      } else if (type === 'èµ‹å€¼è§„åˆ™') {
        // å­—æ®µå’Œæ“ä½œç¬¦é€‰é¡¹
        const fieldOptions = [
          { name: 'å®¢æˆ·åç§°', code: 'customerName' },
          { name: 'å®¢æˆ·ç¼–ç ', code: 'customerCode' },
          { name: 'ä¾›åº”å•†åç§°', code: 'supplierName' },
          { name: 'ä¾›åº”å•†ç¼–ç ', code: 'supplierCode' },
          { name: 'ç‰©æ–™åç§°', code: 'materialName' },
          { name: 'ç‰©æ–™ç¼–ç ', code: 'materialCode' },
          { name: 'ä½¿ç”¨å•ä½åç§°', code: 'useUnitName' },
          { name: 'ä½¿ç”¨å•ä½ç¼–ç ', code: 'useUnitCode' }
        ];
        let selected = '';
        if (detail && detail.assignField) {
          selected = detail.assignField;
        }
        // "å½“æ¨¡å‹å±æ€§"å­—æ®µæ”¹ä¸ºä¸‹æ‹‰å•é€‰
        let triggerSelected = '';
        if (detail && detail.assignTrigger) {
          triggerSelected = detail.assignTrigger;
        }
        html += `<div class='form-row'><div class='form-label'>å½“æ¨¡å‹å±æ€§ï¼š</div><div class='form-value'>`;
        html += `<select id='assignTrigger' style='width: 75%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©æ¨¡å‹å±æ€§</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${triggerSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select><span style='margin-left:8px;color:#888;'>å‘ç”Ÿå˜åŒ–æ—¶</span></div></div>`;
        html += `<div class='form-row'><div class='form-label'>èµ‹å€¼äºï¼š</div><div class='form-value'>`;
        html += `<select id='assignField' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©å­—æ®µ</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${selected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // æ–°å¢ï¼šå€¼ç­‰äº ä¸‹æ‹‰
        let valueEqualSelected = '';
        if (detail && detail.valueEqual) {
          valueEqualSelected = detail.valueEqual;
        }
        html += `<div class='form-row'><div class='form-label'>å€¼ç­‰äºï¼š</div><div class='form-value'>`;
        html += `<select id='valueEqual' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©æ¨¡å‹å±æ€§</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${valueEqualSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // æ–°å¢ï¼šå¼•ç”¨å±æ€§ ä¸‹æ‹‰
        let refAttrSelected = '';
        if (detail && detail.refAttr) {
          refAttrSelected = detail.refAttr;
        }
        html += `<div class='form-row'><div class='form-label'>å¼•ç”¨å±æ€§ï¼š</div><div class='form-value'>`;
        html += `<select id='refAttr' style='width: 100%; min-height: 32px; padding: 6px 10px; border: 1.2px solid #c0d3eb; border-radius: 8px; font-size: 13px; background: #f9fbfd;'>`;
        html += `<option value=''>è¯·é€‰æ‹©æ¨¡å‹å±æ€§</option>`;
        html += fieldOptions.map(opt => `<option value='${opt.code}' ${refAttrSelected===opt.code?'selected':''}>${opt.name}</option>`).join('');
        html += `</select></div></div>`;
        // èµ‹å€¼è¡¨è¾¾å¼å­—æ®µ
        html += `<div class='form-row'><div class='form-label'>èµ‹å€¼è¡¨è¾¾å¼ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='assignExpr' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘' value='${detail && detail.assignExpr ? detail.assignExpr : ''}'>
          <span class='expr-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='è¡¨è¾¾å¼ç¼–è¾‘' id='assignExprBtn'>ğŸ”</span>
        </div></div>`;
        // é€‚ç”¨æ¡ä»¶å­—æ®µ
        html += `<div class='form-row'><div class='form-label'>é€‚ç”¨æ¡ä»¶ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='assignCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‚ç”¨æ¡ä»¶ç¼–è¾‘' id='assignCondBtn'>ğŸ”</span>
        </div></div>`;
      } else if (type === 'æ•°æ®è”åŠ¨' || type === 'æ•°æ®è”åŠ¨è§„åˆ™') {
        // å­—æ®µé€‰é¡¹
        const fieldOptions = [
          { name: 'å®¢æˆ·åç§°', code: 'customerName' },
          { name: 'å®¢æˆ·ç¼–ç ', code: 'customerCode' },
          { name: 'ä¾›åº”å•†åç§°', code: 'supplierName' },
          { name: 'ä¾›åº”å•†ç¼–ç ', code: 'supplierCode' },
          { name: 'ç‰©æ–™åç§°', code: 'materialName' },
          { name: 'ç‰©æ–™ç¼–ç ', code: 'materialCode' },
          { name: 'ä½¿ç”¨å•ä½åç§°', code: 'useUnitName' },
          { name: 'ä½¿ç”¨å•ä½ç¼–ç ', code: 'useUnitCode' },
          { name: 'å¸‚', code: 'city' }
        ];
        // å…ˆæ¸²æŸ“"å½“æ¨¡å‹å±æ€§"
        html += `<div class='form-row'><div class='form-label'>å½“æ¨¡å‹å±æ€§ï¼š</div><div class='form-value'><input id='linkageTrigger' placeholder='å¦‚ï¼šçœ' value='${detail && detail.linkageTrigger ? detail.linkageTrigger : ''}' style='width:70%;'><span style='margin-left:8px;color:#888;'>å‘ç”Ÿå˜åŒ–æ—¶</span></div></div>`;
        // ä»…åœ¨è§„åˆ™ç±»å‹ä¸º"æ•°æ®è”åŠ¨è§„åˆ™"æ—¶æ˜¾ç¤ºè”åŠ¨å­—æ®µå’Œè”åŠ¨æ¡ä»¶
        if (type === 'æ•°æ®è”åŠ¨è§„åˆ™') {
          // è”åŠ¨å­—æ®µä¸‹æ‹‰å•é€‰
          html += `<div class='form-row'><div class='form-label'>è”åŠ¨å­—æ®µï¼š</div><div class='form-value'><select id='linkageField' style='width:70%;'>`;
          html += `<option value=''>è¯·é€‰æ‹©è”åŠ¨å­—æ®µ</option>`;
          html += fieldOptions.map(opt => `<option value='${opt.code}' ${(detail && detail.linkageField===opt.code)?'selected':''}>${opt.name}</option>`).join('');
          html += `</select></div></div>`;
          // æ–°å¢ï¼šè”åŠ¨æ¡ä»¶ï¼ˆå¼•ç”¨å±æ€§ä¸‹æ‹‰ï¼‰
          html += `<div class='form-row'><div class='form-label'>è”åŠ¨æ¡ä»¶ï¼š</div><div class='form-value'><select id='linkageRefAttr' style='width:70%;'>`;
          html += `<option value=''>è¯·é€‰æ‹©å¼•ç”¨å±æ€§</option>`;
          html += fieldOptions.map(opt => `<option value='${opt.code}' ${(detail && detail.linkageRefAttr===opt.code)?'selected':''}>${opt.name}</option>`).join('');
          html += `</select></div></div>`;
        }
        // è”åŠ¨è¡¨è¾¾å¼è¾“å…¥
        html += `<div class='form-row'><div class='form-label'>è”åŠ¨è¡¨è¾¾å¼ï¼š</div><div class='form-value' style='position:relative;display:flex;align-items:center;'>`;
        html += `<input id='linkageExpr' placeholder='city.province = province' value='${detail && detail.linkageExpr ? detail.linkageExpr : ''}' style='width:100%;padding-right:36px;'>`;
        html += `<span id='exprEditBtn' style='position:absolute;right:8px;cursor:pointer;font-size:18px;color:#2176c7;' title='è¡¨è¾¾å¼ç¼–è¾‘'>ğŸ”</span>`;
        html += `</div></div>`;
      }
      area.innerHTML = html;
              // å”¯ä¸€æ€§æ ¡éªŒå¡ç‰‡åŒºåŸŸæ¸²æŸ“
        if (type === 'å”¯ä¸€æ€§æ ¡éªŒ') {
          // ç›´æ¥åˆå§‹åŒ–å¤šé€‰å’Œä¸‹æ‹‰äº¤äº’
          const area = document.getElementById('ruleDetailArea');
          // å¤šé€‰ä¸‹æ‹‰å±æ€§åˆ—è¡¨
          const ATTR_OPTIONS = [
            'å®¢æˆ·åç§°',
            'å®¢æˆ·ç¼–ç ',
            'ä¾›åº”å•†åç§°',
            'ä¾›åº”å•†ç¼–ç ',
            'ç‰©æ–™åç§°',
            'ç‰©æ–™ç¼–ç ',
            'ä½¿ç”¨å•ä½åç§°',
            'ä½¿ç”¨å•ä½ç¼–ç '
          ];
          
          // è”åˆæ ¡éªŒå¼€å…³äº‹ä»¶å¤„ç†
          const jointValidationSwitch = document.getElementById('jointValidationSwitch');
          const jointValidationArea = document.getElementById('jointValidationArea');
          if (jointValidationSwitch) {
            jointValidationSwitch.onchange = function() {
              const isEnabled = this.checked;
              window.uniqueCards[0].enableJointValidation = isEnabled;
              if (jointValidationArea) {
                jointValidationArea.style.display = isEnabled ? 'block' : 'none';
              }
              // å¦‚æœå…³é—­è”åˆæ ¡éªŒï¼Œæ¸…ç©ºä¸»æ•°æ®ç›¸å…³å­—æ®µ
              if (!isEnabled) {
                window.uniqueCards[0].uniqueMaster = '';
                window.uniqueCards[0].uniqueMasterAttrArr = [];
                window.uniqueCards[0].uniqueMasterAttr = '';
                // é‡æ–°æ¸²æŸ“ä»¥æ›´æ–°æ˜¾ç¤º
                renderRuleDetail('å”¯ä¸€æ€§æ ¡éªŒ');
              }
            };
          }
          
          // ä¸»æ•°æ®é€‰æ‹©äº‹ä»¶å¤„ç†
          const uniqueMasterSelect = document.getElementById('uniqueMasterSelect');
          if (uniqueMasterSelect) {
            uniqueMasterSelect.onchange = function() {
              window.uniqueCards[0].uniqueMaster = this.value;
            };
          }
          
          // å±æ€§å¤šé€‰
          const inputWrap = area.querySelector('.multi-select-input[data-idx="0"]');
          const dropdown = area.querySelector('.multi-select-dropdown');
          function renderDropdown() {
            const selected = window.uniqueCards[0].uniqueAttrArr||[];
            dropdown.innerHTML = ATTR_OPTIONS.map(opt=>`<div class='multi-select-option' data-value='${opt}' style='padding:6px 12px;cursor:pointer;background:${selected.includes(opt)?'#f4f7fa':'#fff'};'>${opt}${selected.includes(opt)?' <span style=\"color:#2176c7;\">âœ”</span>':''}</div>`).join('');
          }
          inputWrap.onclick = function(e) {
            e.stopPropagation();
            renderDropdown();
            dropdown.style.display = 'block';
          };
          dropdown.onclick = function(e) {
            const v = e.target.getAttribute('data-value');
            if (!v) return;
            let arr = window.uniqueCards[0].uniqueAttrArr||[];
            if (arr.includes(v)) {
              arr = arr.filter(x=>x!==v);
            } else {
              arr = arr.concat(v);
            }
            window.uniqueCards[0].uniqueAttrArr = arr;
            window.uniqueCards[0].uniqueAttr = arr.join(',');
            renderRuleDetail('å”¯ä¸€æ€§æ ¡éªŒ');
          };
          inputWrap.querySelectorAll('.multi-tag-close').forEach(closeBtn => {
            closeBtn.onclick = function(ev) {
              ev.stopPropagation();
              const v = closeBtn.getAttribute('data-value');
              let arr = window.uniqueCards[0].uniqueAttrArr||[];
              arr = arr.filter(x=>x!==v);
              window.uniqueCards[0].uniqueAttrArr = arr;
              window.uniqueCards[0].uniqueAttr = arr.join(',');
              renderRuleDetail('å”¯ä¸€æ€§æ ¡éªŒ');
            };
          });
          inputWrap.onblur = function() {
            setTimeout(()=>{dropdown.style.display='none';},120);
          };
          
          // ä¸»æ•°æ®å±æ€§å¤šé€‰ï¼ˆåªåœ¨è”åˆæ ¡éªŒå¯ç”¨æ—¶åˆå§‹åŒ–ï¼‰
          if (window.uniqueCards[0].enableJointValidation) {
            const masterInputWrap = area.querySelector('.master-attr-input[data-idx="0"]');
            const masterDropdown = area.querySelector('.master-attr-dropdown');
            const MASTER_ATTR_OPTIONS = [
              'å®¢æˆ·åç§°',
              'å®¢æˆ·ç¼–ç ',
              'ä¾›åº”å•†åç§°',
              'ä¾›åº”å•†ç¼–ç ',
              'ç‰©æ–™åç§°',
              'ç‰©æ–™ç¼–ç ',
              'ä½¿ç”¨å•ä½åç§°',
              'ä½¿ç”¨å•ä½ç¼–ç '
            ];
            // å¯è¾“å…¥ç­›é€‰
            let filterValue = '';
            function renderMasterDropdown() {
              const selected = window.uniqueCards[0].uniqueMasterAttrArr||[];
              const filtered = filterValue ? MASTER_ATTR_OPTIONS.filter(opt=>opt.includes(filterValue)) : MASTER_ATTR_OPTIONS;
              masterDropdown.innerHTML = filtered.map(opt=>`<div class='multi-select-option' data-value='${opt}' style='padding:6px 12px;cursor:pointer;background:${selected.includes(opt)?'#f4f7fa':'#fff'};'>${opt}${selected.includes(opt)?' <span style=\"color:#2176c7;\">âœ”</span>':''}</div>`).join('');
            }
            masterInputWrap.onclick = function(e) {
              e.stopPropagation();
              filterValue = '';
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
              masterInputWrap.querySelector('.multi-select-hidden-input').focus();
            };
            masterDropdown.onclick = function(e) {
              const v = e.target.getAttribute('data-value');
              if (!v) return;
              let arr = window.uniqueCards[0].uniqueMasterAttrArr||[];
              if (arr.includes(v)) {
                arr = arr.filter(x=>x!==v);
              } else {
                arr = arr.concat(v);
              }
              window.uniqueCards[0].uniqueMasterAttrArr = arr;
              window.uniqueCards[0].uniqueMasterAttr = arr.join(',');
              renderRuleDetail('å”¯ä¸€æ€§æ ¡éªŒ');
            };
            masterInputWrap.querySelectorAll('.multi-tag-close').forEach(closeBtn => {
              closeBtn.onclick = function(ev) {
                ev.stopPropagation();
                const v = closeBtn.getAttribute('data-value');
                let arr = window.uniqueCards[0].uniqueMasterAttrArr||[];
                arr = arr.filter(x=>x!==v);
                window.uniqueCards[0].uniqueMasterAttrArr = arr;
                window.uniqueCards[0].uniqueMasterAttr = arr.join(',');
                renderRuleDetail('å”¯ä¸€æ€§æ ¡éªŒ');
              };
            });
            // è¾“å…¥ç­›é€‰
            const inputEl = masterInputWrap.querySelector('.multi-select-hidden-input');
            inputEl.readOnly = false;
            inputEl.value = '';
            inputEl.oninput = function(e) {
              filterValue = inputEl.value.trim();
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
            };
            inputEl.onfocus = function() {
              renderMasterDropdown();
              masterDropdown.style.display = 'block';
            };
            inputEl.onblur = function() {
              setTimeout(()=>{masterDropdown.style.display='none';},120);
            };
          }
          
          // ç‚¹å‡»é¡µé¢å…¶ä»–åœ°æ–¹å…³é—­æ‰€æœ‰ä¸‹æ‹‰
          document.addEventListener('click', function(){
            area.querySelectorAll('.multi-select-dropdown').forEach(d=>d.style.display='none');
          });
          renderUniqueCondStatusArea();
          return;
        }
      // çº¦æŸæ¡ä»¶æ ¡éªŒé€‚ç”¨æ¡ä»¶æŒ‰é’®äº‹ä»¶
      if (type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
        const constraintRuleBtn = document.getElementById('constraintRuleBtn');
        if (constraintRuleBtn) {
          constraintRuleBtn.onclick = function() {
            const currentValue = document.getElementById('constraintRuleInput').value || '';
            const exprWindow = window.open('expression.html', '_blank', 'width=700,height=600');
            
            // ç›‘å¬è¡¨è¾¾å¼ç¼–è¾‘å™¨è¿”å›çš„ç»“æœ
            const messageHandler = function(e) {
              if (e.data && e.data.type === 'getExprInit') {
                // è¡¨è¾¾å¼ç¼–è¾‘å™¨è¯·æ±‚åˆå§‹å€¼
                exprWindow.postMessage({ type: 'exprInit', value: currentValue }, '*');
              } else if (e.data && e.data.type === 'exprResult') {
                // æ¥æ”¶åˆ°è¡¨è¾¾å¼ç»“æœ
                document.getElementById('constraintRuleInput').value = e.data.value || '';
                window.removeEventListener('message', messageHandler);
              }
            };
            window.addEventListener('message', messageHandler);
          };
        }
        const constraintCondBtn = document.getElementById('constraintCondBtn');
        if (constraintCondBtn) {
          constraintCondBtn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }
      }
      // èµ‹å€¼è§„åˆ™è¡¨è¾¾å¼ç¼–è¾‘æŒ‰é’®äº‹ä»¶
      if (type === 'èµ‹å€¼è§„åˆ™') {
        setTimeout(()=>{
          const exprBtn = document.getElementById('assignExprBtn');
          if(exprBtn) exprBtn.onclick = function() {
            const exprInput = document.getElementById('assignExpr');
            const win = window.open('expression.html', '_blank', 'width=700,height=600');
            // ç›‘å¬å­çª—å£è¯·æ±‚åˆå§‹å€¼
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'getExprInit') {
                win.postMessage({ type: 'exprInit', value: exprInput.value }, '*');
                window.removeEventListener('message', handler);
              }
            });
            // ç›‘å¬å­çª—å£å›ä¼ è¡¨è¾¾å¼
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'exprResult') {
                exprInput.value = e.data.value;
                win.close && win.close();
                window.removeEventListener('message', handler);
              }
            });
          };
          const condBtn = document.getElementById('assignCondBtn');
          if(condBtn) condBtn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // åªè¯»è§„åˆ™é€‚ç”¨æ¡ä»¶æŒ‰é’®äº‹ä»¶
      if (type === 'åªè¯»è§„åˆ™') {
        setTimeout(()=>{
          const btn = document.getElementById('readonlyCondBtn');
          if(btn) btn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // å¿…å¡«è§„åˆ™å’Œæ˜¾éšè§„åˆ™é€‚ç”¨æ¡ä»¶æŒ‰é’®äº‹ä»¶
      if (type === 'å¿…å¡«è§„åˆ™' || type === 'æ˜¾éšè§„åˆ™') {
        setTimeout(()=>{
          const btn = document.getElementById('requiredCondBtn');
          if(btn) btn.onclick = function() {
            window.open('condition_new.html', '_blank', 'width=800,height=600');
          };
        }, 0);
      }
      // æ•°æ®è”åŠ¨è§„åˆ™ä¸‹çš„è”åŠ¨æ¡ä»¶æŸ¥è¯¢æŒ‰é’®äº‹ä»¶
      if (type === 'æ•°æ®è”åŠ¨' || type === 'æ•°æ®è”åŠ¨è§„åˆ™') {
        setTimeout(()=>{
          const exprBtn = document.getElementById('exprEditBtn');
          if(exprBtn) exprBtn.onclick = function() {
            const exprInput = document.getElementById('linkageExpr');
            const win = window.open('expression.html', '_blank', 'width=700,height=600');
            // ç›‘å¬å­çª—å£è¯·æ±‚åˆå§‹å€¼
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'getExprInit') {
                win.postMessage({ type: 'exprInit', value: exprInput.value }, '*');
                window.removeEventListener('message', handler);
              }
            });
            // ç›‘å¬å­çª—å£å›ä¼ è¡¨è¾¾å¼
            window.addEventListener('message', function handler(e) {
              if (e.data && e.data.type === 'exprResult') {
                exprInput.value = e.data.value;
                win.close && win.close();
                window.removeEventListener('message', handler);
              }
            });
          };
        }, 0);
      }
      // çº¦æŸæ¡ä»¶æ ¡éªŒæ ¡éªŒç±»å‹åˆ‡æ¢é€»è¾‘
      if (type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
        setTimeout(()=>{
          const validateTypeSelect = document.getElementById('validateTypeSelect');
          const regexRow = document.getElementById('regexRow');
          const constraintRuleRow = document.getElementById('constraintRuleRow');
          if(validateTypeSelect && regexRow && constraintRuleRow) {
            validateTypeSelect.onchange = function() {
              if(this.value==='æ­£åˆ™è¡¨è¾¾å¼æ ¡éªŒ') {
                regexRow.style.display = 'flex';
                constraintRuleRow.style.display = 'none';
              } else {
                regexRow.style.display = 'none';
                constraintRuleRow.style.display = 'flex';
              }
            };
          }
          // æ­£åˆ™é€‰æ‹©æŒ‰é’®äº‹ä»¶ï¼ˆå¯æ‰©å±•å¼¹çª—é€‰æ‹©ï¼‰
          const regexSelectBtn = document.getElementById('regexSelectBtn');
          if(regexSelectBtn) {
            regexSelectBtn.onclick = function() {
              alert('æ­¤å¤„å¯å¼¹å‡ºæ­£åˆ™è¡¨è¾¾å¼é€‰æ‹©å™¨');
            };
          }
        },0);
      }
    }
    // é‡‡é›†è§„åˆ™è¯¦ç»†ä¿¡æ¯
    function collectRuleDetail(type) {
      let detail = {};
      if (type === 'å”¯ä¸€æ€§æ ¡éªŒ' || type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
        // åŸæ ¡éªŒè§„åˆ™+æ ¡éªŒç±»å‹é€»è¾‘
        if (type === 'å”¯ä¸€æ€§æ ¡éªŒ') {
          // å”¯ä¸€æ€§æ ¡éªŒå­—æ®µé‡‡é›†
          if (window.uniqueCards && window.uniqueCards[0]) {
            detail.uniqueAttr = window.uniqueCards[0].uniqueAttr || '';
            detail.uniqueAttrArr = window.uniqueCards[0].uniqueAttrArr || [];
            detail.enableJointValidation = window.uniqueCards[0].enableJointValidation || false;
            // æ–°å¢ï¼šé‡‡é›†ä¸‰ä¸ªé€‰é¡¹
            detail.caseSensitive = window.uniqueCards[0].caseSensitive || false;
            detail.ignoreAllSpace = window.uniqueCards[0].ignoreAllSpace !== false;
            detail.ignoreFullHalf = window.uniqueCards[0].ignoreFullHalf || false;
            
            // åªæœ‰åœ¨å¯ç”¨è”åˆæ ¡éªŒæ—¶æ‰é‡‡é›†ä¸»æ•°æ®ç›¸å…³å­—æ®µ
            if (window.uniqueCards[0].enableJointValidation) {
              detail.uniqueMaster = window.uniqueCards[0].uniqueMaster || '';
              detail.uniqueMasterAttr = window.uniqueCards[0].uniqueMasterAttr || '';
              detail.uniqueMasterAttrArr = window.uniqueCards[0].uniqueMasterAttrArr || [];
            }
          }
        } else if (type === 'çº¦æŸæ¡ä»¶æ ¡éªŒ') {
          // çº¦æŸæ¡ä»¶æ ¡éªŒä¸æ˜¾ç¤ºçº¦æŸæ¡ä»¶å’Œæç¤ºè¯­ï¼Œæ‰€ä»¥ä¸é‡‡é›†è¿™äº›å­—æ®µ
          const constraintRuleEl = document.getElementById('constraintRuleInput');
          if (constraintRuleEl) detail.constraintRule = constraintRuleEl.value;
          const constraintCondEl = document.getElementById('constraintCondInput');
          if (constraintCondEl) detail.constraintCond = constraintCondEl.value;
        } else {
          // å…¶ä»–æ ¡éªŒç±»å‹æ‰é‡‡é›†çº¦æŸæ¡ä»¶å’Œæç¤ºè¯­
          const constraintCondEl = document.getElementById('constraintCond');
          const constraintMsgEl = document.getElementById('constraintMsg');
          if (constraintCondEl) detail.constraintCond = constraintCondEl.value;
          if (constraintMsgEl) detail.constraintMsg = constraintMsgEl.value;
        }
        detail.validateMsg = document.getElementById('validateMsg').value;
        detail.validateLevel = document.getElementById('validateLevel').value;
      } else if (type === 'å¿…å¡«è§„åˆ™') {
        detail.fields = document.getElementById('fieldsInput').value;
      } else if (type === 'åªè¯»è§„åˆ™') {
        // å¤šé€‰ä¸‹æ‹‰ï¼Œæ‹¼æ¥ä¸ºé€—å·åˆ†éš”
        const select = document.getElementById('fieldsInput');
        const selected = Array.from(select.selectedOptions).map(opt => opt.value);
        detail.fields = selected.join(',');
      } else if (type === 'æ˜¾éšè§„åˆ™') {
        detail.showHideType = document.getElementById('showHideType').value;
        detail.fields = document.getElementById('fieldsInput').value;
      } else if (type === 'èµ‹å€¼è§„åˆ™') {
        detail.assignField = document.getElementById('assignField').value;
        detail.valueEqual = document.getElementById('valueEqual').value;
        detail.refAttr = document.getElementById('refAttr').value;
        detail.assignExpr = document.getElementById('assignExpr').value;
        detail.assignTrigger = document.getElementById('assignTrigger').value;
      } else if (type === 'æ•°æ®è”åŠ¨' || type === 'æ•°æ®è”åŠ¨è§„åˆ™') {
        detail.linkageTrigger = document.getElementById('linkageTrigger').value;
        detail.linkageField = document.getElementById('linkageField').value;
        detail.linkageRefAttr = document.getElementById('linkageRefAttr').value;
        detail.linkageExpr = document.getElementById('linkageExpr').value;
      }
      return detail;
    }
    // 2. æ¡ä»¶è®¾ç½®æŠ½å±‰é€»è¾‘
    function showCondDrawer(idx) {
      window.currentCondIdx = idx;
      document.getElementById('condDrawerMask').style.display = 'block';
      setTimeout(()=>{document.getElementById('condDrawerContent').style.right='0';},10);
    }
    function hideCondDrawer() {
      document.getElementById('condDrawerContent').style.right = '-616px';
      setTimeout(()=>{document.getElementById('condDrawerMask').style.display='none';},300);
    }
    document.getElementById('condDrawerClose').onclick = document.getElementById('condDrawerCancel').onclick = hideCondDrawer;
    // 3. æ ¡éªŒå­—æ®µæŠ½å±‰é€»è¾‘
    function showFieldDrawer(idx) {
      window.currentFieldIdx = idx;
      document.getElementById('fieldDrawerMask').style.display = 'block';
      setTimeout(()=>{document.getElementById('fieldDrawerContent').style.right='0';},10);
    }
    function hideFieldDrawer() {
      document.getElementById('fieldDrawerContent').style.right = '-616px';
      setTimeout(()=>{document.getElementById('fieldDrawerMask').style.display='none';},300);
    }
    document.getElementById('fieldDrawerClose').onclick = document.getElementById('fieldDrawerCancel').onclick = hideFieldDrawer;
    // æ›¿æ¢æ¡ä»¶è®¾ç½®æŠ½å±‰å†…å®¹ä¸ºcondition_new.htmlåŠŸèƒ½ï¼Œå¹¶æ¿€æ´»JSé€»è¾‘
    function renderCondDrawerInit() {
      const condDrawerArea = document.getElementById('condDrawerArea');
      condDrawerArea.innerHTML = '';
      // åˆ›å»ºæ¡ä»¶ç¼–è¾‘åŒºåŸŸ
      const builder = document.createElement('div');
      builder.className = 'condition-builder';
      condDrawerArea.appendChild(builder);

      // ä»¥ä¸‹ä¸ºcondition_new.htmlæ ¸å¿ƒJSé€»è¾‘ï¼Œç›®æ ‡å®¹å™¨ä¸ºbuilder
      const mainModelFields = ['å®¢æˆ·ç¼–ç ', 'å®¢æˆ·åç§°', 'ä¾›åº”å•†ç¼–ç ', 'ä¾›åº”å•†åç§°', 'ç‰©æ–™ç¼–ç ', 'ç‰©æ–™åç§°'];
      const subModelFields = [...mainModelFields, 'ä½¿ç”¨å•ä½åç§°', 'ä½¿ç”¨å•ä½ç¼–ç '];
      const relationOptions = ['ç­‰äº', 'ä¸ç­‰äº', 'å¤§äº', 'å°äº', 'å¤§äºç­‰äº', 'å°äºç­‰äº', 'åŒ…å«', 'ä¸åŒ…å«'];

      function createGroupElement(data = { logic: 'AND', children: [] }) {
        const groupEl = document.createElement('div');
        groupEl.className = 'condition-group';
        const isRoot = !data.isSubgroup;
        const controlsDiv = document.createElement('div');
        controlsDiv.className = 'group-controls';
        controlsDiv.innerHTML = `
          <button class="btn btn-primary btn-sm add-condition-btn">ï¼‹ æ¡ä»¶</button>
          <button class="btn btn-secondary btn-sm add-group-btn">ï¼‹ åˆ†ç»„</button>
          ${!isRoot ? '<button class="btn btn-danger btn-sm delete-group-btn ms-auto">åˆ é™¤åˆ†ç»„</button>' : ''}
        `;
        const childrenContainer = document.createElement('div');
        childrenContainer.className = 'group-children';
        let conditionIdx = 0;
        if (data.children) {
          data.children.forEach((childData, idx) => {
            if (childData.type === 'group') {
              childData.isSubgroup = true;
              const childGroupEl = createGroupElement(childData);
              childrenContainer.appendChild(childGroupEl);
            } else {
              const rowWrapper = document.createElement('div');
              rowWrapper.style.display = 'flex';
              rowWrapper.style.alignItems = 'center';
              if (conditionIdx > 0) {
                const logicSelect = document.createElement('select');
                logicSelect.className = 'form-select form-select-sm logic-between-select';
                logicSelect.style.width = '110px';
                logicSelect.style.marginRight = '8px';
                logicSelect.innerHTML = `
                  <option value="AND" ${childData.logic === 'AND' ? 'selected' : ''}>å¹¶ä¸”</option>
                  <option value="OR" ${childData.logic === 'OR' ? 'selected' : ''}>æˆ–è€…</option>
                `;
                rowWrapper.appendChild(logicSelect);
              }
              const childConditionEl = createConditionElement(childData);
              rowWrapper.appendChild(childConditionEl);
              childrenContainer.appendChild(rowWrapper);
              conditionIdx++;
            }
          });
        }
        const placeholderDiv = document.createElement('div');
        placeholderDiv.className = 'group-placeholder';
        placeholderDiv.style.display = 'none';
        placeholderDiv.innerText = 'ä½¿ç”¨ä¸Šæ–¹æŒ‰é’®æ·»åŠ æ¡ä»¶æˆ–å­åˆ†ç»„';
        groupEl.appendChild(controlsDiv);
        groupEl.appendChild(childrenContainer);
        groupEl.appendChild(placeholderDiv);
        updateGroupPlaceholder(groupEl);
        return groupEl;
      }
      function createConditionElement(data = {}) {
        const conditionEl = document.createElement('div');
        conditionEl.className = 'condition-row';
        const currentFields = ['å®¢æˆ·ç¼–ç ', 'å®¢æˆ·åç§°', 'ä¾›åº”å•†ç¼–ç ', 'ä¾›åº”å•†åç§°', 'ç‰©æ–™ç¼–ç ', 'ç‰©æ–™åç§°', 'ä½¿ç”¨å•ä½åç§°', 'ä½¿ç”¨å•ä½ç¼–ç '];
        const relationOptions = ['ç­‰äº', 'ä¸ç­‰äº', 'å¤§äº', 'å°äº', 'å¤§äºç­‰äº', 'å°äºç­‰äº', 'åŒ…å«', 'ä¸åŒ…å«'];
        conditionEl.innerHTML = `
          <select class="form-select field-select">
            ${currentFields.map(f => `<option value=\"${f}\" ${data.field === f ? 'selected' : ''}>${f}</option>`).join('')}
          </select>
          <select class="form-select relation-select">
            ${relationOptions.map(r => `<option value=\"${r}\" ${data.relation === r ? 'selected' : ''}>${r}</option>`).join('')}
          </select>
          <input type="text" class="form-control value-input" value="${data.value || ''}">
          <button class="btn btn-danger btn-sm delete-condition-btn delete-condition-btn">åˆ é™¤</button>
        `;
        return conditionEl;
      }
      function updateGroupPlaceholder(groupEl) {
        if (!groupEl) return;
        const childrenContainer = groupEl.querySelector('.group-children');
        const placeholder = groupEl.querySelector('.group-placeholder');
        if (placeholder) {
          placeholder.style.display = childrenContainer.children.length === 0 ? 'block' : 'none';
        }
      }
      // äº‹ä»¶å§”æ‰˜
      builder.addEventListener('click', function(e) {
        const groupEl = e.target.closest('.condition-group');
        if (!groupEl) return;
        if (e.target.classList.contains('add-condition-btn')) {
          const childrenContainer = groupEl.querySelector('.group-children');
          const isFirst = childrenContainer.querySelectorAll('.condition-row, .condition-group').length === 0;
          const newCond = isFirst ? { type: 'condition' } : { type: 'condition', logic: 'AND' };
          const groupData = parseGroup(groupEl);
          groupData.children.push(newCond);
          const newGroupEl = createGroupElement(groupData);
          groupEl.replaceWith(newGroupEl);
        }
        if (e.target.classList.contains('add-group-btn')) {
          const childrenContainer = groupEl.querySelector('.group-children');
          const groupData = parseGroup(groupEl);
          groupData.children.push({ type: 'group', logic: 'AND', children: [], isSubgroup: true });
          const newGroupEl = createGroupElement(groupData);
          groupEl.replaceWith(newGroupEl);
        }
        if (e.target.classList.contains('delete-condition-btn')) {
          const rowWrapper = e.target.closest('div[style*="display: flex"]') || e.target.closest('.condition-row');
          if (rowWrapper) rowWrapper.remove();
          updateGroupPlaceholder(groupEl);
        }
        if (e.target.classList.contains('delete-group-btn')) {
          const parentGroup = groupEl.parentElement.closest('.condition-group');
          groupEl.remove();
          updateGroupPlaceholder(parentGroup);
        }
      });
      function parseGroup(element) {
        const children = [];
        const childrenContainer = element.querySelector('.group-children');
        let conditionIdx = 0;
        for (const child of childrenContainer.children) {
          const conditionRow = child.querySelector('.condition-row');
          if (conditionRow) {
            const cond = parseCondition(conditionRow);
            if (conditionIdx > 0) {
              const logicSelect = child.querySelector('.logic-between-select');
              cond.logic = logicSelect ? logicSelect.value : 'AND';
            }
            children.push(cond);
            conditionIdx++;
          } else if (child.classList.contains('condition-group')) {
            children.push(parseGroup(child));
          }
        }
        return { type: 'group', children };
      }
      function parseCondition(element) {
        return {
          type: 'condition',
          field: element.querySelector('.field-select').value,
          relation: element.querySelector('.relation-select').value,
          value: element.querySelector('.value-input').value.trim()
        };
      }
      // åˆå§‹åŒ–ä¸ºç©ºåˆ†ç»„
      builder.innerHTML = '';
      const defaultGroup = { logic: 'AND', children: [] };
      builder.appendChild(createGroupElement(defaultGroup));
    }
    // æ¯æ¬¡æ‰“å¼€æ¡ä»¶è®¾ç½®æŠ½å±‰æ—¶åˆå§‹åŒ–
    const oldShowCondDrawer = window.showCondDrawer;
    window.showCondDrawer = function(idx) {
      oldShowCondDrawer(idx);
      renderCondDrawerInit();
    }
    // æ ¡éªŒå­—æ®µå¼¹çª—å¤šç»„å½•å…¥åŠŸèƒ½
    function renderFieldDrawerInit() {
      const area = document.getElementById('fieldDrawerContent').querySelector('.drawer-body');
      area.innerHTML = '';
      
      // è·å–å½“å‰è§„åˆ™çš„æ ¡éªŒç±»å‹
      const currentRule = rules[window.currentFieldIdx];
      const isGeneralValidation = currentRule && currentRule.detail && currentRule.detail.validateType === 'çº¦æŸæ¡ä»¶æ ¡éªŒ';
      
      // å­—æ®µåç§°ä¸ç¼–ç æ˜ å°„
      const fieldOptions = [
        { name: 'å®¢æˆ·åç§°', code: 'customerName' },
        { name: 'å®¢æˆ·ç¼–ç ', code: 'customerCode' },
        { name: 'ä¾›åº”å•†åç§°', code: 'supplierName' },
        { name: 'ä¾›åº”å•†ç¼–ç ', code: 'supplierCode' },
        { name: 'ç‰©æ–™åç§°', code: 'materialName' },
        { name: 'ç‰©æ–™ç¼–ç ', code: 'materialCode' },
        { name: 'ä½¿ç”¨å•ä½åç§°', code: 'useUnitName' },
        { name: 'ä½¿ç”¨å•ä½ç¼–ç ', code: 'useUnitCode' }
      ];
      
      if (isGeneralValidation) {
        // ä¸€èˆ¬æ€§æ ¡éªŒï¼šåªæ˜¾ç¤ºå­—æ®µåç§°ï¼ˆä¸‹æ‹‰ï¼‰å’Œå­—æ®µç¼–ç ï¼ˆè‡ªåŠ¨èµ‹å€¼ï¼‰
        const title = document.createElement('div');
        title.style.cssText = 'font-size: 16px; font-weight: 600; color: #2176c7; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #e3eaf3;';
        title.textContent = 'å”¯ä¸€æ€§æ ¡éªŒè®¾ç½®';
        area.appendChild(title);
        
        const groupList = document.createElement('div');
        groupList.id = 'fieldGroupList';
        area.appendChild(groupList);
        
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-primary btn-sm';
        addBtn.innerHTML = '<span class="icon">ï¼‹</span>æ·»åŠ ';
        addBtn.style.margin = '12px 0';
        area.appendChild(addBtn);
        
        function createFieldGroup(data = {}) {
          const group = document.createElement('div');
          group.className = 'field-group';
          group.style.display = 'flex';
          group.style.alignItems = 'center';
          group.style.gap = '12px';
          group.style.marginBottom = '12px';
          
          // å­—æ®µåç§°ä¸‹æ‹‰
          const select = document.createElement('select');
          select.className = 'form-select field-name-select';
          select.style.width = '180px';
          select.innerHTML = '<option value="">æ ¡éªŒå±æ€§</option>' +
            fieldOptions.map(opt => `<option value="${opt.code}" ${data.fieldCode===opt.code?'selected':''}>${opt.name}</option>`).join('');
          
          // å­—æ®µç¼–ç è¾“å…¥æ¡†ï¼ˆåªè¯»ï¼‰
          const codeInput = document.createElement('input');
          codeInput.className = 'form-control field-code-input';
          codeInput.placeholder = 'å­—æ®µç¼–ç ';
          codeInput.style.width = '180px';
          codeInput.readOnly = true;
          codeInput.value = data.fieldCode || '';
          
          // é€‰æ‹©å­—æ®µåç§°æ—¶è‡ªåŠ¨èµ‹å€¼ç¼–ç 
          select.onchange = function() {
            const selected = fieldOptions.find(opt => opt.code === select.value);
            codeInput.value = selected ? selected.code : '';
          };
          // åˆå§‹åŒ–æ—¶è‡ªåŠ¨èµ‹å€¼
          if (select.value) {
            const selected = fieldOptions.find(opt => opt.code === select.value);
            codeInput.value = selected ? selected.code : '';
          }
          
          // åˆ é™¤æŒ‰é’®
          const delBtn = document.createElement('button');
          delBtn.type = 'button';
          delBtn.className = 'btn btn-danger btn-sm del-field-group';
          delBtn.style.minWidth = '44px';
          delBtn.textContent = 'åˆ é™¤';
          delBtn.onclick = function() {
            group.remove();
          };
          
          group.appendChild(select);
          group.appendChild(codeInput);
          group.appendChild(delBtn);
          return group;
        }
        
        function addFieldGroup(data) {
          groupList.appendChild(createFieldGroup(data));
        }
        
        addBtn.onclick = function() { addFieldGroup({}); };
        // é»˜è®¤å…ˆåŠ ä¸€ç»„
        addFieldGroup({});
        
      } else {
        // å…¶ä»–æ ¡éªŒç±»å‹ï¼šä¿æŒåŸæœ‰é€»è¾‘
        const groupList = document.createElement('div');
        groupList.id = 'fieldGroupList';
        area.appendChild(groupList);
        
        const addBtn = document.createElement('button');
        addBtn.type = 'button';
        addBtn.className = 'btn btn-primary btn-sm';
        addBtn.innerHTML = '<span class="icon">ï¼‹</span>æ·»åŠ ';
        addBtn.style.margin = '12px 0';
        area.appendChild(addBtn);
        
        function createFieldGroup(data = {}) {
          const group = document.createElement('div');
          group.className = 'field-group';
          group.style.display = 'flex';
          group.style.alignItems = 'center';
          group.style.gap = '8px';
          group.style.marginBottom = '10px';
          group.innerHTML = `
            <input class="form-control field-input" placeholder="æ ¡éªŒå±æ€§" value="${data.field||''}" style="width:120px;">
            <select class="form-select master-type" style="width:120px;">
              <option value="">ä¸»æ•°æ®ç±»å‹</option>
              <option value="å®¢æˆ·" ${data.masterType==='å®¢æˆ·'?'selected':''}>å®¢æˆ·</option>
              <option value="äº§å“" ${data.masterType==='äº§å“'?'selected':''}>äº§å“</option>
              <option value="ä¾›åº”å•†" ${data.masterType==='ä¾›åº”å•†'?'selected':''}>ä¾›åº”å•†</option>
            </select>
            <select class="form-select master-field" style="width:120px;">
              <option value="">å±æ€§å­—æ®µ</option>
              <option value="ç¼–ç " ${data.masterField==='ç¼–ç '?'selected':''}>ç¼–ç </option>
              <option value="åç§°" ${data.masterField==='åç§°'?'selected':''}>åç§°</option>
              <option value="ç±»å‹" ${data.masterField==='ç±»å‹'?'selected':''}>ç±»å‹</option>
            </select>
            <button type="button" class="btn btn-danger btn-sm del-field-group">åˆ é™¤</button>
          `;
          return group;
        }
        
        function addFieldGroup(data) {
          groupList.appendChild(createFieldGroup(data));
        }
        
        addBtn.onclick = function() { addFieldGroup({}); };
        groupList.onclick = function(e) {
          if (e.target.classList.contains('del-field-group')) {
            e.target.parentElement.remove();
          }
        };
        
        // é»˜è®¤å…ˆåŠ ä¸€ç»„
        addFieldGroup({});
      }
    }
    // æ‰“å¼€æ ¡éªŒå­—æ®µå¼¹çª—æ—¶åˆå§‹åŒ–
    const oldShowFieldDrawer = window.showFieldDrawer;
    window.showFieldDrawer = function(idx) {
      oldShowFieldDrawer(idx);
      renderFieldDrawerInit();
    }
    // å”¯ä¸€æ€§æ ¡éªŒé€‚ç”¨æ¡ä»¶å’ŒçŠ¶æ€åŒºåŸŸæ¸²æŸ“
    function renderUniqueCondStatusArea() {
      const area = document.getElementById('uniqueCondStatusArea');
      if (!area) return;
      area.innerHTML = `<div class='form-row' style='margin-top:8px;'>
        <div class='form-label'>é€‚ç”¨æ¡ä»¶ï¼š</div>
        <div class='form-value' style='position:relative;display:flex;align-items:center;'>
          <input id='uniqueCondInput' class='form-control' style='width:100%;padding-right:32px;' readonly placeholder='ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘'>
          <span class='cond-query-btn' style='position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;' title='é€‚ç”¨æ¡ä»¶ç¼–è¾‘' id='uniqueCondBtn'>ğŸ”</span>
        </div>
      </div>`;
      document.getElementById('uniqueCondBtn').onclick = function() {
        window.open('condition_new.html', '_blank', 'width=800,height=600');
      };
    }
    // æ–°å¢ï¼šä¸‰ä¸ªé€‰é¡¹äº‹ä»¶å¤„ç†
    const caseSensitive = document.getElementById('caseSensitive');
    const ignoreAllSpace = document.getElementById('ignoreAllSpace');
    const ignoreFullHalf = document.getElementById('ignoreFullHalf');
    if (caseSensitive) {
      caseSensitive.onchange = function() {
        window.uniqueCards[0].caseSensitive = this.checked;
      };
    }
    if (ignoreAllSpace) {
      ignoreAllSpace.onchange = function() {
        window.uniqueCards[0].ignoreAllSpace = this.checked;
      };
    }
    if (ignoreFullHalf) {
      ignoreFullHalf.onchange = function() {
        window.uniqueCards[0].ignoreFullHalf = this.checked;
      };
    }
    // åœ¨renderRuleDetailå‡½æ•°ç»“å°¾å¤„ï¼Œç»‘å®šselectäº‹ä»¶å’Œå¸®åŠ©æ°”æ³¡äº‹ä»¶
    setTimeout(()=>{
      // ä¸»æ•°æ®å±æ€§ä¸‹æ‹‰å•é€‰é‡‡é›†
      const uniqueMasterAttrSelect = document.getElementById('uniqueMasterAttrSelect');
      if(uniqueMasterAttrSelect){
        uniqueMasterAttrSelect.onchange = function(){
          window.uniqueCards[0].uniqueMasterAttr = this.value;
          window.uniqueCards[0].uniqueMasterAttrArr = this.value ? [this.value] : [];
        };
      }
      // è”åˆæ ¡éªŒå¸®åŠ©æ°”æ³¡
      const helpIcon = document.querySelector('.joint-help-icon');
      const helpPop = document.querySelector('.joint-help-pop');
      if (helpIcon && helpPop) {
        helpIcon.onmouseenter = () => { helpPop.style.display = 'block'; };
        helpIcon.onmouseleave = () => { helpPop.style.display = 'none'; };
        helpPop.onmouseenter = () => { helpPop.style.display = 'block'; };
        helpPop.onmouseleave = () => { helpPop.style.display = 'none'; };
      }
    },0);
  </script>
</body>
</html> 
</html> 