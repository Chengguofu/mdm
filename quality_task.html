<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>è´¨é‡æ£€æŸ¥ä»»åŠ¡</title>
  <style>
    body { margin:0; font-family: 'Microsoft YaHei', Arial, sans-serif; background:#f6f8fa; font-size:14px; }
    .container { max-width: 1100px; margin: 36px auto; background: #fff; border-radius: 10px; box-shadow: 0 4px 24px rgba(0,0,0,0.08); padding: 32px 40px; }
    .title { font-size: 20px; color: #185a99; font-weight: 600; margin-bottom: 24px; }
    .toolbar { display: flex; align-items: center; margin-bottom: 18px; }
    .btn { background: #2176c7; color: #fff; border: none; border-radius: 6px; font-weight: 500; font-size: 14px; padding: 6px 22px; margin-right: 10px; cursor: pointer; transition: background 0.18s; }
    .btn:hover { background: #185a99; }
    .table { width: 100%; border-collapse: collapse; background: #fff; font-size: 14px; }
    th,td { border: 1px solid #e5e6eb; padding: 10px 12px; }
    th { background: #f6f8fa; color: #185a99; font-weight: 500; }
    .action-btn { background: none; border: none; color: #2176c7; cursor: pointer; font-size: 14px; margin-right: 8px; }
    .action-btn:hover { color: #e53935; }
    .modal-mask { position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.18); z-index:1000; display:flex; align-items:center; justify-content:center; }
    .modal-window { background:#fff; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.18); width:792px; min-height:422px; padding:42px 42px 32px 42px; position:relative; }
    .modal-title { font-size: 16px; font-weight: 600; color: #185a99; margin-bottom: 18px; }
    .step-bar { display: flex; align-items: center; margin-bottom: 24px; justify-content: center; }
    .step { display: flex; align-items: center; font-size: 15px; color: #888; font-weight: 500; margin-right: 32px; }
    .step.active { color: #2176c7; font-weight: 600; }
    .step-index { display: inline-flex; align-items: center; justify-content: center; width: 26px; height: 26px; border-radius: 50%; background: #e5e6eb; color: #888; font-size: 15px; font-weight: 600; margin-right: 6px; }
    .step.active .step-index { background: #2176c7; color: #fff; }
    .form-row { display: flex; align-items: center; margin-bottom: 16px; }
    .form-label { width: 110px; color: #333; font-size: 14px; text-align: right; margin-right: 8px; }
    .form-value { flex: 1; }
    .form-control { width: 100%; padding: 7px 12px; border: 1.5px solid #c0d3eb; border-radius: 6px; font-size: 14px; }
    .modal-footer { text-align: right; margin-top: 18px; }
    .btn-line { background: #fff; color: #2176c7; border: 1.5px solid #2176c7; border-radius: 6px; font-size: 14px; padding: 6px 22px; margin-left: 8px; cursor: pointer; }
    .btn-line:hover { background: #f7faff; color: #185a99; border-color: #185a99; }
    /* switch å¼€å…³æ ·å¼ */
    .switch { position: relative; display: inline-block; width: 38px; height: 22px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .2s; border-radius: 22px; }
    .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; }
    input:checked + .slider { background-color: #2176c7; }
    input:checked + .slider:before { transform: translateX(16px); }
    /* å­—æ®µæ˜ å°„è¡¨æ ¼æ•°æ®é›†å­—æ®µè¾“å…¥æ¡†å®½åº¦ç¼©å°10% */
    #mapping-area input.form-control { width: 90%; min-width: 40px; max-width: 180px; }
    /* æŠ½å±‰æ ·å¼ */
    .drawer-mask { position: fixed; top:0; right:0; bottom:0; left:0; background:rgba(0,0,0,0.18); z-index:2000; display:none; }
    .drawer { position: fixed; top:0; right:0; width:420px; height:100%; background:#fff; box-shadow: -2px 0 16px rgba(0,0,0,0.12); z-index:2100; padding:32px 28px; display:flex; flex-direction:column; }
    .drawer-title { font-size: 17px; font-weight: 600; color: #185a99; margin-bottom: 18px; }
    .drawer-close { position:absolute; right:18px; top:18px; font-size:22px; color:#888; cursor:pointer; }
    .drawer-footer { margin-top:auto; text-align:right; position:relative; bottom:50px; }
    /* æ­¥éª¤æ¡åº•éƒ¨æŒ‰é’®å›ºå®š */
    .modal-footer { position: absolute; left: 0; right: 0; bottom: 0; background: #fff; padding: 18px 42px 18px 0; box-shadow: 0 -2px 12px rgba(33,118,199,0.04); z-index: 10; }
    .modal-window { position: relative; }
    .drawer .form-row { margin-bottom: 14px; }
    .drawer .form-label { width: 90px; }
    .drawer .form-value { flex: 1; }
    /* å¤šé€‰ä¸‹æ‹‰æ ·å¼ */
    .multi-select-wrap { position: relative; }
    .multi-select-input { display: flex; align-items: center; padding: 0 8px; border: 1px solid #d0d7de; border-radius: 6px; height: 28px; background-color: #fff; cursor: pointer; }
    .multi-select-input:focus { border-color: #2176c7; box-shadow: 0 0 0 2px #2176c7; }
    .multi-select-hidden-input { border: none; outline: none; flex: 1 1 40px; min-width: 40px; height: 28px; background: transparent; padding: 0; margin: 0; display: inline-block; }
    .multi-tag { display: inline-flex; align-items: center; background-color: #e0e0e0; border-radius: 4px; padding: 2px 6px; margin-right: 4px; margin-bottom: 4px; font-size: 12px; color: #333; }
    .multi-tag-close { margin-left: 4px; cursor: pointer; color: #888; }
    .multi-select-dropdown { position: absolute; top: 110%; left: 0; width: 100%; background: #fff; border: 1.5px solid #d0d7de; border-radius: 7px; box-shadow: 0 2px 12px rgba(33,118,199,0.10); z-index: 10; max-height: 180px; overflow: auto; }
    .multi-select-option { padding: 6px 12px; cursor: pointer; background: #fff; }
    .multi-select-option:hover { background: #f4f7fa; }
    .multi-select-option.selected { background: #f4f7fa; }
  </style>
</head>
<body>
  <div class="container">
    <div class="title">è´¨é‡æ£€æŸ¥ä»»åŠ¡</div>
    <!-- æŸ¥è¯¢åŒº -->
    <div class="search-area" style="background:#f6f8fa;border-radius:8px;padding:18px 24px 10px 24px;margin-bottom:20px;">
      <form id="searchForm" style="display:flex;align-items:center;gap:18px;flex-wrap:wrap;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:#185a99;font-size:14px;width:70px;display:inline-block;">ä»»åŠ¡åç§°</span>
          <input id="searchName" class="form-control" style="width:140px;" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°">
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:#185a99;font-size:14px;width:48px;display:inline-block;">ç±»å‹</span>
          <select id="searchType" class="form-control" style="width:100px;">
            <option value="">å…¨éƒ¨</option>
            <option value="è´¨é‡è§„åˆ™">è´¨é‡è§„åˆ™</option>
            <option value="æ•°æ®å¯¹æ¯”">æ•°æ®å¯¹æ¯”</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:#185a99;font-size:14px;width:90px;display:inline-block;">ä¸»æ•°æ®æ¨¡å‹</span>
          <input id="searchModel" class="form-control" style="width:120px;" placeholder="è¯·è¾“å…¥ä¸»æ•°æ®æ¨¡å‹">
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:#185a99;font-size:14px;width:48px;display:inline-block;">çŠ¶æ€</span>
          <select id="searchStatus" class="form-control" style="width:100px;">
            <option value="">å…¨éƒ¨</option>
            <option value="å¯ç”¨">å¯ç”¨</option>
            <option value="ç¦ç”¨">ç¦ç”¨</option>
          </select>
        </div>
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:#185a99;font-size:14px;width:110px;display:inline-block;">æœ€åæ‰§è¡Œæ—¶é—´</span>
          <input id="searchExecTime" class="form-control" style="width:140px;" placeholder="å¦‚ 2024-01-15">
        </div>
        <button type="button" class="btn" onclick="searchTask()">æŸ¥è¯¢</button>
        <button type="button" class="btn-line" onclick="resetSearch()">é‡ç½®</button>
      </form>
    </div>
    <div class="toolbar">
      <button class="btn" onclick="openModal()">æ–°å¢ä»»åŠ¡</button>
    </div>
    <table class="table">
      <thead>
        <tr>
          <th>ä»»åŠ¡åç§°</th>
          <th>ç±»å‹</th>
          <th>ä¸»æ•°æ®æ¨¡å‹</th>
          <th>æ•°æ®é›†</th>
          <th>çŠ¶æ€</th>
          <th>æœ€åæ‰§è¡Œæ—¶é—´</th>
          <th>æ“ä½œ</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td>å‘˜å·¥ä¸»æ•°æ®å¯¹æ¯”</td>
          <td>æ•°æ®å¯¹æ¯”</td>
          <td>å‘˜å·¥ä¸»æ•°æ®</td>
          <td>å‘˜å·¥æ•°æ®é›†A</td>
          <td><label class="switch"><input type="checkbox" checked><span class="slider"></span></label></td>
          <td>2024-01-15 14:30:25</td>
          <td>
            <button class="action-btn">ç¼–è¾‘</button>
            <button class="action-btn">åˆ é™¤</button>
            <button class="action-btn">æ‰§è¡Œ</button>
            <button class="action-btn">ä»»åŠ¡è°ƒåº¦</button>
          </td>
        </tr>
        <tr>
          <td>å‘˜å·¥ä¸»æ•°æ®è´¨é‡è§„åˆ™</td>
          <td>è´¨é‡è§„åˆ™</td>
          <td>å‘˜å·¥ä¸»æ•°æ®</td>
          <td>å‘˜å·¥æ•°æ®é›†B</td>
          <td><label class="switch"><input type="checkbox"><span class="slider"></span></label></td>
          <td>2024-01-14 09:15:42</td>
          <td>
            <button class="action-btn">ç¼–è¾‘</button>
            <button class="action-btn">åˆ é™¤</button>
            <button class="action-btn">æ‰§è¡Œ</button>
            <button class="action-btn">ä»»åŠ¡è°ƒåº¦</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
  <!-- æ–°å¢/ç¼–è¾‘å¼¹çª— -->
  <div class="modal-mask" id="modal" style="display:none;">
    <div class="modal-window">
      <div class="modal-title">æ–°å¢è´¨é‡æ£€æŸ¥ä»»åŠ¡</div>
      <div class="step-bar" id="step-bar">
        <div class="step active"><span class="step-index">1</span>é€‰æ‹©æ¨¡å‹/æ•°æ®é›†</div>
        <div class="step" id="step2-bar"><span class="step-index">2</span>å­—æ®µæ˜ å°„</div>
        <div class="step"><span class="step-index">3</span>å®Œæˆ</div>
      </div>
      <!-- æ­¥éª¤1å†…å®¹åŒºåŸŸ -->
      <div id="step-content-1" style="margin-bottom: 16px;">
        <div class="form-row">
          <div class="form-label">ä»»åŠ¡åç§°ï¼š</div>
          <div class="form-value"><input class="form-control" placeholder="è¯·è¾“å…¥ä»»åŠ¡åç§°"></div>
        </div>
        <div class="form-row">
          <div class="form-label">è´¨æ£€ç±»å‹ï¼š</div>
          <div class="form-value">
            <select class="form-control" id="qc-type" onchange="onQcTypeChange(); showStep(1);">
              <option value="è´¨é‡è§„åˆ™">è´¨é‡è§„åˆ™</option>
              <option value="æ•°æ®å¯¹æ¯”">æ•°æ®å¯¹æ¯”</option>
            </select>
          </div>
        </div>
        <div class="form-row">
          <div class="form-label">ä¸»æ•°æ®æ¨¡å‹ï¼š</div>
          <div class="form-value">
            <select class="form-control">
              <option>å‘˜å·¥ä¸»æ•°æ®</option>
              <option>ä¾›åº”å•†ä¸»æ•°æ®</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="dataset-row" style="display:none;">
          <div class="form-label">æ•°æ®é›†ï¼š</div>
          <div class="form-value">
            <select class="form-control">
              <option>å‘˜å·¥æ•°æ®é›†A</option>
              <option>å‘˜å·¥æ•°æ®é›†B</option>
            </select>
          </div>
        </div>
        <div class="form-row" id="qc-scope-row">
          <div class="form-label">è´¨æ£€æ•°æ®èŒƒå›´ï¼š</div>
          <div class="form-value" style="position:relative;display:flex;align-items:center;">
            <input class="form-control" id="qc-scope-input" placeholder="ç‚¹å‡»å³ä¾§æŒ‰é’®ç¼–è¾‘" style="width:100%;padding-right:32px;" readonly onclick="openQcScopeEditor()">
            <span class="expr-query-btn" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;" title="èŒƒå›´ç¼–è¾‘" onclick="openQcScopeEditor()">ğŸ”</span>
          </div>
        </div>
      </div>
      <!-- æ­¥éª¤2å†…å®¹åŒºåŸŸ -->
      <div id="step-content-2" style="display:none; margin-bottom: 16px;">
        <!-- è´¨é‡è§„åˆ™ç±»å‹ä¸‹çš„è§„åˆ™åˆ—è¡¨å’Œæ–°å¢æŒ‰é’® -->
        <div id="rule-list-area" style="display:none;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <span style="font-weight:500; color:#185a99;">è´¨æ£€è§„åˆ™åˆ—è¡¨</span>
            <div>
              <button class="btn" onclick="loadModelBizRules()" style="margin-right:10px;">åŠ è½½æ¨¡å‹ä¸šåŠ¡è§„åˆ™</button>
              <button class="btn" onclick="openDrawer()">æ–°å¢è´¨æ£€è§„åˆ™</button>
            </div>
          </div>
          <table style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#f6f8fa;"><th style="padding:6px 8px; border:1px solid #e5e6eb;">å­—æ®µ</th><th style="padding:6px 8px; border:1px solid #e5e6eb;">è§„åˆ™ç±»å‹</th><th style="padding:6px 8px; border:1px solid #e5e6eb;">è§„åˆ™å†…å®¹</th><th style="padding:6px 8px; border:1px solid #e5e6eb;">æ“ä½œ</th></tr></thead>
            <tbody id="rule-list-tbody">
              <!-- åŠ¨æ€å¡«å…… -->
            </tbody>
          </table>
        </div>
        <!-- æ•°æ®å¯¹æ¯”ç±»å‹ä¸‹çš„å­—æ®µæ˜ å°„ -->
        <div id="mapping-area" style="display:none;">
          <div style="font-weight:500; color:#185a99; margin-bottom:8px;">è¯·æŒ‡å®šæ¨¡å‹å­—æ®µä¸æ•°æ®é›†å­—æ®µçš„æ˜ å°„å…³ç³»ï¼š</div>
          <table style="width:100%; border-collapse:collapse;">
            <thead><tr style="background:#f6f8fa;"><th style="padding:6px 8px; border:1px solid #e5e6eb;">æ¨¡å‹å­—æ®µ</th><th style="padding:6px 8px; border:1px solid #e5e6eb;">æ•°æ®é›†å­—æ®µ</th></tr></thead>
            <tbody>
              <tr><td style="padding:6px 8px; border:1px solid #e5e6eb;">name</td><td style="padding:6px 8px; border:1px solid #e5e6eb;"><input class="form-control" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥æ•°æ®é›†å­—æ®µ"></td></tr>
              <tr><td style="padding:6px 8px; border:1px solid #e5e6eb;">code</td><td style="padding:6px 8px; border:1px solid #e5e6eb;"><input class="form-control" placeholder="è¯·é€‰æ‹©æˆ–è¾“å…¥æ•°æ®é›†å­—æ®µ"></td></tr>
            </tbody>
          </table>
        </div>
      </div>
      <!-- æ­¥éª¤3å†…å®¹åŒºåŸŸ -->
      <div id="step-content-3" style="display:none; margin-bottom: 16px;">
        <div style="font-weight:500; color:#185a99; margin-bottom:8px;">ä»»åŠ¡å·²å®Œæˆï¼Œå¯ç‚¹å‡»ä¿å­˜ã€‚</div>
      </div>
      <div class="modal-footer">
        <button class="btn-line" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn" id="prev-btn" onclick="prevStep()" style="display:none;">ä¸Šä¸€æ­¥</button>
        <button class="btn" id="next-btn" onclick="nextStep()">ä¸‹ä¸€æ­¥</button>
        <button class="btn" id="save-btn" onclick="closeModal()" style="display:none;">ä¿å­˜</button>
      </div>
    </div>
  </div>
  <!-- è§„åˆ™æŠ½å±‰ -->
  <div class="drawer-mask" id="drawer-mask">
    <div class="drawer">
      <div class="drawer-title">æ–°å¢è´¨æ£€è§„åˆ™ <span class="drawer-close" onclick="closeDrawer()">Ã—</span></div>
      <div class="form-row">
        <div class="form-label">æ£€éªŒå­—æ®µï¼š</div>
        <div class="form-value">
          <div class='multi-select-wrap' style='width:100%;position:relative;'>
            <div class='multi-select-input' id='drawerFieldsMulti' tabindex='0' style='width:100%;'>
              <!-- åŠ¨æ€æ ‡ç­¾ -->
              <input class='multi-select-hidden-input' id='drawerFieldsInput' style='border:none;outline:none;flex:1 1 40px;min-width:40px;height:28px;background:transparent;padding:0;margin:0;display:inline-block;' readonly placeholder='è¯·é€‰æ‹©æ£€éªŒå­—æ®µï¼Œå¯å¤šé€‰'>
            </div>
            <div class='multi-select-dropdown' id='drawerFieldsDropdown' style='display:none;position:absolute;top:110%;left:0;width:100%;background:#fff;border:1.5px solid #d0d7de;border-radius:7px;box-shadow:0 2px 12px rgba(33,118,199,0.10);z-index:10;max-height:180px;overflow:auto;'></div>
          </div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-label">è§„åˆ™ç±»å‹ï¼š</div>
        <div class="form-value">
          <select class="form-control" id="drawer-rule-type" onchange="onDrawerRuleTypeChange()">
            <option value="å†…ç½®">ç³»ç»Ÿè§„åˆ™</option>
            <option value="è‡ªå®šä¹‰">è‡ªå®šä¹‰æ ¡éªŒè¡¨è¾¾å¼</option>
            <option value="sql">è‡ªå®šä¹‰SQL</option>
          </select>
        </div>
      </div>
      <div class="form-row" id="drawer-inner-rule-row">
        <div class="form-label">è´¨é‡è§„åˆ™ï¼š</div>
        <div class="form-value">
          <select class="form-control">
            <option>é•¿åº¦æ£€æŸ¥</option>
            <option>æ­£åˆ™æ ¡éªŒ</option>
            <option>éç©º</option>
          </select>
        </div>
      </div>
      <div class="form-row" id="drawer-custom-row" style="display:none;">
        <div class="form-label">æ ¡éªŒè¡¨è¾¾å¼ï¼š</div>
        <div class="form-value" style="position:relative;display:flex;align-items:center;">
          <input class="form-control" id="drawer-custom-expr" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰æ ¡éªŒè¡¨è¾¾å¼" style="width:100%;padding-right:32px;" readonly>
          <span class="expr-query-btn" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;" title="è¡¨è¾¾å¼ç¼–è¾‘" onclick="openCustomExprEditor()">ğŸ”</span>
        </div>
      </div>
      <div class="form-row" id="drawer-sql-row" style="display:none;">
        <div class="form-label">SQLï¼š</div>
        <div class="form-value" style="position:relative;display:flex;align-items:center;">
          <input class="form-control" id="drawer-sql-expr" placeholder="è¯·è¾“å…¥è‡ªå®šä¹‰SQL" style="width:100%;padding-right:32px;" readonly onclick="openSqlEditor()">
          <span class="expr-query-btn" style="position:absolute;right:8px;top:50%;transform:translateY(-50%);cursor:pointer;font-size:18px;color:#2176c7;" title="SQLç¼–è¾‘" onclick="openSqlEditor()">ğŸ”</span>
        </div>
      </div>
      <div class="form-row">
        <div class="form-label">è´¨æ£€ç»´åº¦ï¼š</div>
        <div class="form-value">
          <select class="form-control">
            <option value="æ•°æ®å®Œæ•´æ€§">æ•°æ®å®Œæ•´æ€§</option>
            <option value="æ•°æ®å‡†ç¡®ç‡">æ•°æ®å‡†ç¡®ç‡</option>
            <option value="æ•°æ®ä¸€è‡´æ€§">æ•°æ®ä¸€è‡´æ€§</option>
            <option value="æ•°æ®å”¯ä¸€æ€§">æ•°æ®å”¯ä¸€æ€§</option>
            <option value="æ•°æ®åŠæ—¶æ€§">æ•°æ®åŠæ—¶æ€§</option>
            <option value="æ•°æ®æœ‰æ•ˆæ€§">æ•°æ®æœ‰æ•ˆæ€§</option>
          </select>
        </div>
      </div>
      <div class="drawer-footer">
        <button class="btn" onclick="closeDrawer()">ç¡®å®š</button>
        <button class="btn-line" onclick="closeDrawer()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>
  <script>
    let currentStep = 1;
    function openModal() { document.getElementById('modal').style.display = 'flex'; onQcTypeChange(); showStep(1); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function onQcTypeChange() {
      var type = document.getElementById('qc-type').value;
      var datasetRow = document.getElementById('dataset-row');
      if(type === 'æ•°æ®å¯¹æ¯”') {
        datasetRow.style.display = 'flex';
      } else {
        datasetRow.style.display = 'none';
      }
    }
    // æ­¥éª¤å†…å®¹åˆ‡æ¢
    function showStep(step) {
      currentStep = step;
      // æ­¥éª¤æ¡é«˜äº®
      var steps = document.querySelectorAll('.step');
      steps.forEach((el, idx) => {
        if(idx === step-1) el.classList.add('active');
        else el.classList.remove('active');
      });
      // æŒ‰é’®æ˜¾ç¤º
      document.getElementById('prev-btn').style.display = step > 1 ? 'inline-block' : 'none';
      document.getElementById('next-btn').style.display = step < 3 ? 'inline-block' : 'none';
      document.getElementById('save-btn').style.display = step === 3 ? 'inline-block' : 'none';
      // æ­¥éª¤å†…å®¹æ˜¾ç¤º
      document.getElementById('step-content-1').style.display = step === 1 ? 'block' : 'none';
      document.getElementById('step-content-2').style.display = step === 2 ? 'block' : 'none';
      document.getElementById('step-content-3').style.display = step === 3 ? 'block' : 'none';
      // æ­¥éª¤2å†…å®¹å’Œåç§°åŠ¨æ€
      var qcType = document.getElementById('qc-type').value;
      var step2Bar = document.getElementById('step2-bar');
      var mappingArea = document.getElementById('mapping-area');
      var ruleListArea = document.getElementById('rule-list-area');
      if(step === 2 && qcType === 'æ•°æ®å¯¹æ¯”') {
        step2Bar.innerHTML = '<span class="step-index">2</span>å­—æ®µæ˜ å°„';
        mappingArea.style.display = 'block';
        ruleListArea.style.display = 'none';
      } else if(step === 2 && qcType === 'è´¨é‡è§„åˆ™') {
        step2Bar.innerHTML = '<span class="step-index">2</span>è´¨æ£€è§„åˆ™é…ç½®';
        mappingArea.style.display = 'none';
        ruleListArea.style.display = 'block';
        renderBizRuleList();
      } else {
        // æ­¥éª¤1æ—¶ä¹Ÿè¦æ ¹æ®ç±»å‹åŠ¨æ€æ˜¾ç¤ºç¬¬äºŒæ­¥åç§°
        if(step === 1 && qcType === 'è´¨é‡è§„åˆ™') {
          step2Bar.innerHTML = '<span class="step-index">2</span>è´¨æ£€è§„åˆ™é…ç½®';
        } else {
          step2Bar.innerHTML = '<span class="step-index">2</span>å­—æ®µæ˜ å°„';
        }
        mappingArea.style.display = 'none';
        ruleListArea.style.display = 'none';
      }
    }
    // è§„åˆ™æŠ½å±‰ç›¸å…³
    function openDrawer() {
      document.getElementById('drawer-mask').style.display = 'block';
      document.getElementById('drawer-rule-type').value = 'å†…ç½®';
      onDrawerRuleTypeChange();
      // æ£€éªŒå­—æ®µå¤šé€‰ä¸‹æ‹‰é€»è¾‘
      const QC_FIELD_OPTIONS = ['name', 'code', 'org'];
      let qcFieldSelected = [];
      function renderDrawerFieldsMulti() {
        const inputWrap = document.getElementById('drawerFieldsMulti');
        const dropdown = document.getElementById('drawerFieldsDropdown');
        inputWrap.innerHTML = qcFieldSelected.map(attr=>`<span class='multi-tag'>${attr}<span class='multi-tag-close' data-value='${attr}' style='margin-left:2px;cursor:pointer;'>&times;</span></span>`).join('') +
          `<input class='multi-select-hidden-input' id='drawerFieldsInput' style='border:none;outline:none;flex:1 1 40px;min-width:40px;height:28px;background:transparent;padding:0;margin:0;display:inline-block;' readonly placeholder='è¯·é€‰æ‹©æ£€éªŒå­—æ®µï¼Œå¯å¤šé€‰'>`;
        // ç»‘å®šåˆ é™¤äº‹ä»¶
        inputWrap.querySelectorAll('.multi-tag-close').forEach(closeBtn => {
          closeBtn.onclick = function(ev) {
            ev.stopPropagation();
            const v = closeBtn.getAttribute('data-value');
            qcFieldSelected = qcFieldSelected.filter(x=>x!==v);
            renderDrawerFieldsMulti();
          };
        });
      }
      function renderDrawerFieldsDropdown() {
        const dropdown = document.getElementById('drawerFieldsDropdown');
        dropdown.innerHTML = QC_FIELD_OPTIONS.map(opt=>`<div class='multi-select-option' data-value='${opt}' style='padding:6px 12px;cursor:pointer;background:${qcFieldSelected.includes(opt)?'#f4f7fa':'#fff'};'>${opt}${qcFieldSelected.includes(opt)?' <span style=\"color:#2176c7;\">âœ”</span>':''}</div>`).join('');
      }
      setTimeout(()=>{
        const inputWrap = document.getElementById('drawerFieldsMulti');
        const dropdown = document.getElementById('drawerFieldsDropdown');
        if(inputWrap && dropdown) {
          renderDrawerFieldsMulti();
          inputWrap.onclick = function(e) {
            e.stopPropagation();
            renderDrawerFieldsDropdown();
            dropdown.style.display = 'block';
          };
          dropdown.onclick = function(e) {
            const v = e.target.getAttribute('data-value');
            if (!v) return;
            if (qcFieldSelected.includes(v)) {
              qcFieldSelected = qcFieldSelected.filter(x=>x!==v);
            } else {
              qcFieldSelected = qcFieldSelected.concat(v);
            }
            renderDrawerFieldsMulti();
            renderDrawerFieldsDropdown();
          };
          inputWrap.onblur = function() { setTimeout(()=>{dropdown.style.display='none';},120); };
          document.addEventListener('click', function(){ dropdown.style.display='none'; });
        }
      }, 300);
    }
    function closeDrawer() {
      document.getElementById('drawer-mask').style.display = 'none';
    }
    function onDrawerRuleTypeChange() {
      var type = document.getElementById('drawer-rule-type').value;
      document.getElementById('drawer-inner-rule-row').style.display = (type === 'å†…ç½®') ? 'flex' : 'none';
      document.getElementById('drawer-custom-row').style.display = (type === 'è‡ªå®šä¹‰') ? 'flex' : 'none';
      document.getElementById('drawer-sql-row').style.display = (type === 'sql') ? 'flex' : 'none';
    }
    function nextStep() { if(currentStep < 3) showStep(currentStep+1); }
    function prevStep() { if(currentStep > 1) showStep(currentStep-1); }
    // è‡ªå®šä¹‰æ ¡éªŒè¡¨è¾¾å¼ç¼–è¾‘æŒ‰é’®äº‹ä»¶
    function openCustomExprEditor() {
      var input = document.getElementById('drawer-custom-expr');
      var win = window.open('expression.html', '_blank', 'width=700,height=600');
      // ç›‘å¬å­çª—å£è¯·æ±‚åˆå§‹å€¼
      window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'getExprInit') {
          win.postMessage({ type: 'exprInit', value: input.value }, '*');
          window.removeEventListener('message', handler);
        }
      });
      // ç›‘å¬å­çª—å£å›ä¼ è¡¨è¾¾å¼
      window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'exprResult') {
          input.value = e.data.value;
          win.close && win.close();
          window.removeEventListener('message', handler);
        }
      });
    }
    // è‡ªå®šä¹‰SQLç¼–è¾‘æŒ‰é’®äº‹ä»¶
    function openSqlEditor() {
      var input = document.getElementById('drawer-sql-expr');
      var win = window.open('sql_editor.html', '_blank', 'width=800,height=500');
      // ç›‘å¬å­çª—å£è¯·æ±‚åˆå§‹å€¼
      window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'getSqlInit') {
          win.postMessage({ type: 'sqlInit', value: input.value }, '*');
          window.removeEventListener('message', handler);
        }
      });
      // ç›‘å¬å­çª—å£å›ä¼ SQL
      window.addEventListener('message', function handler(e) {
        if (e.data && e.data.type === 'sqlResult') {
          input.value = e.data.value;
          win.close && win.close();
          window.removeEventListener('message', handler);
        }
      });
    }
    // è´¨æ£€æ•°æ®èŒƒå›´ç¼–è¾‘æŒ‰é’®äº‹ä»¶
    function openQcScopeEditor() {
      window.open('condition_new.html', '_blank', 'width=800,height=600');
    }
    // æ¨¡æ‹Ÿä¸šåŠ¡è§„åˆ™æ•°æ®
    const mockBizRules = [
      { field: 'name', type: 'å”¯ä¸€æ€§æ ¡éªŒ', content: 'å‘˜å·¥å§“åå”¯ä¸€', enabled: true },
      { field: 'code', type: 'å”¯ä¸€æ€§æ ¡éªŒ', content: 'å‘˜å·¥ç¼–ç å”¯ä¸€', enabled: true },
      { field: 'org', type: 'çº¦æŸæ¡ä»¶æ ¡éªŒ', content: 'æ‰€å±éƒ¨é—¨å¿…é¡»å­˜åœ¨', enabled: false }
    ];
    // æ¸²æŸ“ä¸šåŠ¡è§„åˆ™åˆ—è¡¨
    function renderBizRuleList() {
      const tbody = document.getElementById('rule-list-tbody');
      if (!tbody) return;
      tbody.innerHTML = mockBizRules.map((item, idx) => `
        <tr>
          <td>${item.field}</td>
          <td>${item.type}</td>
          <td>${item.content}</td>
          <td><label class="switch"><input type="checkbox" ${item.enabled ? 'checked' : ''} onchange="toggleBizRule(${idx})"><span class="slider"></span></label></td>
        </tr>
      `).join('');
    }
    // åˆ‡æ¢å¼€å…³
    window.toggleBizRule = function(idx) {
      mockBizRules[idx].enabled = !mockBizRules[idx].enabled;
    };

    // åŠ è½½æ¨¡å‹ä¸šåŠ¡è§„åˆ™æŒ‰é’®äº‹ä»¶
    function loadModelBizRules() {
      // è¿™é‡Œå¯ä»¥æ ¹æ®å®é™…ä¸šåŠ¡ä»åç«¯åŠ è½½ï¼Œè¿™é‡Œç›´æ¥é‡ç½®ä¸º mockBizRules
      renderBizRuleList();
    }

function searchTask() {
  alert('æŸ¥è¯¢åŠŸèƒ½å·²è§¦å‘ï¼Œä»»åŠ¡åç§°ï¼š' + document.getElementById('searchName').value + ', ç±»å‹ï¼š' + document.getElementById('searchType').value + ', ä¸»æ•°æ®æ¨¡å‹ï¼š' + document.getElementById('searchModel').value + ', çŠ¶æ€ï¼š' + document.getElementById('searchStatus').value + ', æœ€åæ‰§è¡Œæ—¶é—´ï¼š' + document.getElementById('searchExecTime').value);
}
function resetSearch() {
  document.getElementById('searchName').value = '';
  document.getElementById('searchType').value = '';
  document.getElementById('searchModel').value = '';
  document.getElementById('searchStatus').value = '';
  document.getElementById('searchExecTime').value = '';
}
  </script>
</body>
</html> 