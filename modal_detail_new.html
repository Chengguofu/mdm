<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>æ¨¡å‹è¯¦æƒ…</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { margin:0; font-family: 'Microsoft YaHei', Arial, sans-serif; background:rgba(0,0,0,0.15); font-size:12px; }
    .modal-mask {
      position: fixed; left:0; top:0; right:0; bottom:0; background:rgba(0,0,0,0.25); z-index:1000; display:flex; align-items:center; justify-content:center;
    }
    .modal-window {
      background:#fff; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.18); 
      width:1283px; /* åŸ1166pxå†æ‰©å¤§10% */
      max-width:129.4vw; /* åŸ117.6vwå†æ‰©å¤§10% */
      min-height:586px; /* åŸ532.8pxå†æ‰©å¤§10% */
      height:660px;    /* åŸ600pxå†æ‰©å¤§10% */
      max-height:129.4vh; /* åŸ117.6vhå†æ‰©å¤§10% */
      overflow:hidden; 
      position:relative; 
      animation:popin .25s;
      display: flex;
      flex-direction: column;
      overflow-y: auto !important;
      max-height: 129.4vh !important;
    }
    @keyframes popin { from{transform:scale(0.95);opacity:0;} to{transform:scale(1);opacity:1;} }
    .modal-header {
      padding:22px 32px 0 32px; display:flex; align-items:center; justify-content:space-between;
    }
    .modal-title {
      font-size: 14px !important;
      font-weight: 600;
      color: #185a99;
    }
    .modal-close {
      font-size:20px; color:#888; cursor:pointer; border:none; background:none; transition:.2s; }
    .modal-close:hover { color:#d33; }
    .modal-tabs {
      display:flex; border-bottom:1.5px solid #e5e6eb; margin:18px 32px 0 32px;
    }
    .modal-tab {
      padding:10px 32px; font-size:15px; color:#185a99; cursor:pointer; background:none; border:none; outline:none; border-bottom:2.5px solid transparent; transition:.2s; }
    .modal-tab.active {
      color:#2176c7; font-weight:600; border-bottom:2.5px solid #2176c7; background:#f6f8fa;
    }
    .modal-content { padding:28px 32px 32px 32px; min-height:320px; font-size:15px; padding-bottom: 110px !important; }
    /* è¡¨æ ¼æ ·å¼ */
    table { border-collapse:collapse; width:100%; background:#fff; font-size:15px; }
    th,td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .section-title { font-size:15px; color:#2176c7; margin:18px 0 10px 0; font-weight:600; }
    .kv-row { display:flex; margin-bottom:12px; }
    .kv-label { width:140px; color:#444; font-size:15px; text-align:right; margin-right:12px; }
    .kv-value { flex:1; color:#222; font-size:15px; }
    .tag { display:inline-block; background:#eaf3ff; color:#2176c7; border-radius:3px; padding:2px 8px; font-size:13px; margin-right:6px; }
    .rule-list { margin:0; padding-left:18px; color:#444; font-size:15px; }
    .layout-box { background:#f6f8fa; border-radius:6px; padding:18px; margin-bottom:12px; font-size:15px; }
    .form-2col { display:flex; flex-direction:column; gap:0; margin-top:10px; }
    .form-row { display:flex; align-items:center; margin-bottom:18px; }
    .form-label { width:160px; color:#333; font-size:15px; text-align:right; margin-right:8px; }
    .form-value { width:320px; color:#222; font-size:15px; margin-right:32px; background:#f8fafd; border-radius:4px; min-height:32px; display:flex; align-items:center; padding-left:8px; }
    .required { color:#e53935; margin-left:2px; font-size:15px; }
    .attr-flexbox {
      display: flex;
      height: 100%;
      min-height: 320px;
      box-sizing: border-box;
      width: 100%;
    }
    .attr-field-list {
      background: #f6f8fa;
      border-radius: 6px 0 0 6px;
      padding: 0;
      min-height: 100%;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      max-height: 100%;
      height: 100%;
      overflow-y: auto;
      flex-shrink: 0;
      width: 182px;
      box-sizing: border-box;
    }
    .attr-field-list > div > span {
      font-size: 12px !important;
    }
    .attr-field-item {
      font-size: 13px;
      cursor: pointer;
      border-left: 3px solid transparent;
      transition: background 0.18s, border-color 0.18s;
    }
    .attr-field-item.active {
      background: #eaf3ff;
      border-left: 3px solid #2176c7;
    }
    .attr-field-item:hover {
      background: #f4f8fd;
    }
    .attr-field-detail {
      flex: 1;
      background: none !important;
      border-radius: 0 6px 6px 0;
      padding: 0 0 60px 0;
      overflow-y: auto;
      max-height: 100%;
      min-width: 0;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      height: 378px; /* åŸ420pxç¼©å°10% */
      max-height: 378px; /* åŸ420pxç¼©å°10% */
    }
    .attr-field-detail .form-2col {
      display: grid;
      grid-template-columns: 140px 168px 140px 168px;
      gap: 0 24px;
      row-gap: 6px;
      align-items: center;
      margin-top: 0;
    }
    .attr-field-detail .form-row {
      display: contents;
    }
    .attr-field-detail .form-label,
    .attr-field-detail .form-value,
    .attr-detail-label,
    .attr-detail-value,
    .attr-detail-title {
      color: #185a99 !important;
    }
    .attr-field-detail .form-control,
    .attr-field-detail input[type="text"],
    .attr-field-detail select,
    .attr-field-detail textarea {
      width: 168px !important;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
      border: 1.5px solid #c0d3eb;
      border-radius: 7px;
      padding: 8px 14px;
      font-size: 15px;
      background: #fff !important;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    .attr-field-detail .form-control:focus,
    .attr-field-detail input[type="text"]:focus,
    .attr-field-detail select:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px rgba(33,118,199,0.13);
      background: #fff;
    }
    .attr-field-detail .form-control:hover,
    .attr-field-detail input[type="text"]:hover,
    .attr-field-detail select:hover {
      border-color: #3ba1e3;
    }
    .attr-field-detail textarea.form-control {
      width: 168px !important;
      min-width: 0;
      max-width: 100%;
      resize: vertical;
    }
    .attr-detail-title {
      color: #185a99;
      font-size: 12px !important;
      font-weight: 600;
      padding: 0 0 10px 0;
      margin-bottom: 10px;
      background: none;
      border-radius: 0;
    }
    .attr-detail-table {
      width: 100%;
    }
    .attr-detail-row {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
    }
    .attr-detail-label {
      width: 140px;
      color: #222;
      font-size: 15px;
      text-align: right;
      margin-right: 8px;
    }
    .attr-detail-value {
      width: 220px;
      color: #222;
      font-size: 15px;
      background: none !important;
      border-radius: 4px;
      min-height: 32px;
      display: flex;
      align-items: center;
      padding-left: 8px;
      margin-right: 32px;
    }
    .attr-detail-label .required {
      color: #e53935;
      margin-left: 2px;
      font-size: 15px;
    }
    .rule-table { width:100%; border-collapse:collapse; margin-top:10px; background:#fff; }
    .rule-table th, .rule-table td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    .rule-table th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .rule-link { color:#2176c7; cursor:pointer; text-decoration:underline; }
    .rule-link:hover { color:#e53935; }
    .rule-detail-modal { position:fixed; left:0;top:0;right:0;bottom:0;z-index:2000; }
    .rule-detail-mask { position:absolute;left:0;top:0;right:0;bottom:0;background:rgba(0,0,0,0.18); }
    .rule-detail-box { position:absolute; left:50%; top:50%; transform:translate(-50%,-50%); background:#fff; border-radius:8px; box-shadow:0 4px 24px rgba(0,0,0,0.18); min-width:380px; max-width:90vw; min-height:180px; padding:28px 32px 22px 32px; }
    .rule-detail-title { font-size:15px; color:#185a99; font-weight:600; margin-bottom:16px; }
    .rule-detail-close { margin-top:18px; background:#2176c7; color:#fff; border:none; border-radius:4px; padding:6px 22px; font-size:15px; cursor:pointer; }
    .code-rule-table th, .code-rule-table td { font-size: 15px; }
    .code-rule-table td { white-space: nowrap; }
    .code-rule-table .code-rule-btn { white-space: nowrap; font-size: 13px; padding: 2px 10px; line-height: 1.5; }
    .layout-tabs { display:flex; border-bottom:1.5px solid #e5e6eb; margin-bottom:12px; }
    .layout-tab { padding:8px 32px; font-size:15px; color:#185a99; cursor:pointer; background:none; border:none; outline:none; border-bottom:2.5px solid transparent; transition:.2s; }
    .layout-tab.active { color:#2176c7; font-weight:600; border-bottom:2.5px solid #2176c7; background:#f6f8fa; }
    .layout-content { margin-top:10px; }
    .layout-table { width:100%; border-collapse:collapse; background:#fff; font-size:15px; }
    .layout-table th, .layout-table td { border:1px solid #e5e6eb; padding:8px 12px; font-size:15px; }
    .layout-table th { background:#f6f8fa; color:#185a99; font-weight:500; font-size:15px; }
    .layout-width-input { width:80px; padding:4px 6px; font-size:15px; border:1px solid #bfc8d6; border-radius:3px; }
    
    .layout-detail-flexbox { display: flex; min-height: 360px; border: 1px solid #e5e6eb; border-radius: 6px; }
    .layout-detail-nav { width: 160px; background: #f6f8fa; border-right: 1px solid #e5e6eb; padding: 8px 0; }
    .layout-detail-nav-item { padding: 12px 20px; font-size: 15px; color: #185a99; cursor: pointer; border-left: 3px solid transparent; transition: .2s; }
    .layout-detail-nav-item.active { background: #fff; color: #2176c7; font-weight: 600; border-left-color: #2176c7; }
    .layout-detail-pane-container { flex: 1; padding: 20px; overflow-y: auto; }
    .layout-detail-pane { display: none; }
    .layout-detail-pane.active { display: block; }
    /* Modern input/button style for modal_detail_new.html */
    #tab-base .form-control, #tab-base input[type="text"], #tab-base select, #tab-base textarea {
      border: 1.5px solid #c0d3eb;
      border-radius: 7px;
      padding: 8px 14px;
      font-size: 15px;
      background: #fff !important;
      box-shadow: 0 1px 4px rgba(33,118,199,0.06);
      transition: border-color 0.2s, box-shadow 0.2s;
      outline: none;
    }
    #tab-base .form-control:focus, #tab-base input[type="text"]:focus, #tab-base select:focus, #tab-base textarea:focus {
      border-color: #2176c7;
      box-shadow: 0 0 0 2px rgba(33,118,199,0.13);
      background: #fff;
    }
    #tab-base .form-control:hover, #tab-base input[type="text"]:hover, #tab-base select:hover, #tab-base textarea:hover {
      border-color: #3ba1e3;
    }
    #tab-base .form-value {
      background: none;
      padding: 0;
      min-height: unset;
    }
    #tab-base .form-row {
      margin-bottom: 22px;
    }
    #tab-base .form-label {
      font-size: 15px;
      color: #185a99;
      font-weight: 500;
    }
    .modal-footer-fixed {
      position: absolute;
      left: 0; right: 0; bottom: 0;
      background: #fff;
      box-shadow: 0 -2px 12px rgba(33,118,199,0.06);
      padding: 18px 40px 18px 0;
      display: flex;
      justify-content: flex-end;
      z-index: 10;
      box-sizing: border-box;
      width: auto;
      max-width: none;
    }
    .btn-modern {
      background: #2176c7;
      color: #fff;
      border: none;
      border-radius: 6px;
      font-weight: 500;
      font-size: 15px;
      padding: 6px 22px;
      margin-left: 6px;
      cursor: pointer;
      transition: background 0.18s;
      box-shadow: 0 2px 8px rgba(33,118,199,0.08);
    }
    .btn-modern:hover {
      background: #185a99;
    }
    .btn-line-modern {
      background: #fff;
      color: #2176c7;
      border: 1.5px solid #2176c7;
      border-radius: 6px;
      font-size: 15px;
      padding: 6px 22px;
      margin-left: 6px;
      cursor: pointer;
      transition: background 0.18s, color 0.18s;
    }
    .btn-line-modern:hover {
      background: #f7faff;
      color: #185a99;
      border-color: #185a99;
    }
    #tab-base .form-2col {
      display: grid;
      grid-template-columns: 140px 240px 140px 240px;
      gap: 0 16px;
      row-gap: 28px;
      align-items: center;
      margin-top: 10px;
    }
    #tab-base .form-row {
      display: contents;
    }
    #tab-base .form-label {
      text-align: right;
      font-size: 16px;
      color: #185a99;
      font-weight: 600;
      padding-right: 16px;
    }
    #tab-base .form-value {
      width: 100%;
      min-width: 0;
      margin-right: 0;
      background: none;
      padding: 0;
      min-height: unset;
      display: flex;
      align-items: center;
    }
    #tab-base .form-row.desc-row {
      grid-column: 1 / 5;
      display: contents;
    }
    #tab-base .form-label.desc-label {
      grid-column: 1 / 2;
      align-self: start;
      margin-top: 8px;
    }
    #tab-base .form-value.desc-value {
      grid-column: 2 / 5;
      width: 100%;
      min-width: 0;
      margin-top: 0;
    }
    #tab-base .form-value.desc-value textarea.form-control {
      width: 100% !important;
      min-width: 0;
      max-width: 100%;
    }
    #tab-attr.modal-content {
      height: 100%;
      display: flex;
      padding: 0;
      box-sizing: border-box;
      overflow: hidden;
      padding-bottom: 110px !important;
      margin-top: 36px;
    }
    #tab-base .form-value .form-control,
    #tab-base .form-value input[type="text"],
    #tab-base .form-value select,
    #tab-base .form-value textarea {
      width: 240px !important;
      min-width: 0;
      max-width: 100%;
      box-sizing: border-box;
    }
    #tab-base textarea.form-control {
      width: 100% !important;
      min-width: 0;
      max-width: 100%;
    }
    #tab-base .form-label.required-label:after {
      content: '';
    }
    #tab-base.modal-content {
      max-height: 380px;
      overflow-y: auto;
    }
    .modal-content#tab-base {
      flex: 1 1 auto;
      min-height: 0;
      overflow-y: auto;
    }
    .table-link-delete {
      background: none;
      border: none;
      color: #e74c3c;
      font-size: 15px;
      cursor: pointer;
      padding: 0 8px;
      transition: color 0.18s;
    }
    .table-link-delete:hover {
      color: #b71c1c;
      text-decoration: underline;
    }
    .section-collapse-title,
    .section-collapse-title * {
      font-size: 12px !important;
      font-weight: 600 !important;
      color: #2176c7 !important;
    }
    .section-collapse-title {
      display: flex;
      align-items: center;
      cursor: pointer;
      user-select: none;
      margin-bottom: 8px;
      margin-top: 10px;
    }
    .section-collapse-title svg {
      margin-right: 8px;
      transition: transform 0.2s;
    }
    .section-collapse-title.collapsed svg {
      transform: rotate(-90deg);
    }
    .section-content {
      transition: max-height 0.2s, opacity 0.2s;
      overflow: hidden;
    }
    .section-content.collapsed {
      max-height: 0 !important;
      opacity: 0;
      padding: 0 !important;
      pointer-events: none;
    }
    #tab-rule.modal-content {
      padding-bottom: 110px !important;
    }
    #tab-code.modal-content {
      padding-bottom: 110px !important;
    }
    #tab-layout.modal-content {
      padding-bottom: 110px !important;
    }
    .modal-title, .modal-tab, .modal-content, .form-label, .form-value, .form-control, .attr-field-item, .attr-detail-title, .attr-detail-label, .attr-detail-value, .section-title, .rule-list, .layout-box, .table, th, td, .btn-modern, .btn-line-modern, .section-collapse-title, .tag, .rule-detail-title, .layout-detail-nav-item, .layout-detail-pane-container, .layout-detail-pane, .layout-tab, .layout-table th, .layout-table td, .code-rule-table th, .code-rule-table td, .modal-footer-fixed, .form-2col, .form-row, .form-label, .form-value, .form-control, .attr-detail-label, .attr-detail-value, .table-link-delete {
      font-size:12px !important;
    }
    .modal-window .modal-title, .modal-title {
      font-size: 14px !important;
      font-weight: 600;
      color: #185a99;
    }
    .attr-detail-title, .section-collapse-title, .section-collapse-title * {
      font-size: 12px !important;
    }
    .modal-steps, .modal-steps *, .modal-step, .modal-step .step-index {
      font-size: 17px !important;
    }
    .modal-step .step-index {
      display:inline-flex;align-items:center;justify-content:center;width:26px;height:26px;border-radius:50%;background:#e5e6eb;color:#888;font-size:15px;font-weight:600;margin-right:6px;transition:.18s;
    }
    .modal-step.active {
      color:#2176c7;font-weight:600;
    }
    .modal-step.active .step-index {
      background:#2176c7;color:#fff;
    }
    .modal-step.done {
      color:#4db6ac;
    }
    .modal-step.done .step-index {
      background:#4db6ac;color:#fff;
    }
    .modal-step:not(:last-child)::after {
      content: '';
      display: block;
      position: absolute;
      left: calc(100% + 36px); /* å‘å³ç§»åŠ¨36px */
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 2px;
      background: #2176c7;
      border-radius: 2px;
      z-index: 1;
      opacity: 0.85;
    }
    .modal-step.done:not(:last-child)::after {
      background: #4db6ac;
      opacity: 1;
    }
    .modal-step .step-index {
      position: relative;
      z-index: 2;             /* åœ†åœˆåœ¨æœ€ä¸Šå±‚ */
      background: #fff;       /* ç™½è‰²åº•ï¼Œé®ä½æ¨ªçº¿ */
    }
    
    /* ç¼–ç è§„åˆ™ç›¸å…³æ ·å¼ */
    .code-rule-switch input:checked + .code-rule-slider {
      background-color: #4db6ac;
    }
    .code-rule-switch input:focus + .code-rule-slider {
      box-shadow: 0 0 1px #4db6ac;
    }
    .code-rule-switch input:checked + .code-rule-slider:before {
      transform: translateX(22px);
    }
    .code-rule-switch .code-rule-slider:before {
      position: absolute;
      content: "";
      height: 18px;
      width: 18px;
      left: 2px;
      bottom: 2px;
      background-color: white;
      transition: .4s;
      border-radius: 50%;
    }
    .code-rule-switch .code-rule-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: #ccc;
      transition: .4s;
      border-radius: 22px;
    }
    .code-rule-switch {
      position: relative;
      display: inline-block;
      width: 44px;
      height: 22px;
    }
    .code-rule-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    
    /* ç¼–ç è§„åˆ™æŠ½å±‰åŠ¨ç”» */
    #codeRuleModalContent {
      transition: right 0.3s ease;
    }
    
    /* ç¼–ç è§„åˆ™è¡¨æ ¼æ ·å¼ */
    #tab-code table tr:hover td {
      background: #f0f6fd;
    }
    #tab-code table tr:last-child td {
      border-bottom: none;
    }
    
    /* ä¸šåŠ¡è§„åˆ™é“¾æ¥æ ·å¼ */
    #tab-rule a:hover {
      background: #185a99 !important;
      box-shadow: 0 4px 12px rgba(33,118,199,0.15) !important;
    }
    
    /* ç¼–ç è§„åˆ™é“¾æ¥æ ·å¼ */
    #tab-code a:hover {
      background: #185a99 !important;
      box-shadow: 0 4px 12px rgba(33,118,199,0.15) !important;
    }
    
    /* å‘å¸ƒé…ç½®é“¾æ¥æ ·å¼ */
    #tab-layout a:hover {
      background: #185a99 !important;
      box-shadow: 0 4px 12px rgba(33,118,199,0.15) !important;
    }
    
    /* å¤šè§†å›¾é¡µç­¾æ ·å¼ */
    .attr-view-tab {
      display: inline-block;
      padding: 10px 24px;
      font-size: 15px;
      color: #185a99;
      cursor: pointer;
      background: none;
      border: none;
      outline: none;
      border-bottom: 2.5px solid transparent;
      transition: .2s;
      font-weight: 500;
      margin-right: 2px;
      position: relative;
      z-index: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 120px;
      text-align: center;
    }
    .attr-view-tab:hover {
      color: #2176c7;
      background: #f6f8fa;
    }
    .attr-view-tab.active {
      color: #2176c7;
      font-weight: 600;
      border-bottom: 2.5px solid #2176c7;
      background: #f6f8fa;
      z-index: 2;
    }
    #attrViewTabs {
      width: 100%;
      display: flex;
      align-items: flex-end;
      border-bottom: 2px solid #e5e6eb;
      background: #fff;
      min-height: 44px;
      user-select: none;
      position: relative;
      z-index: 20;
      margin-bottom: 0;
      padding-left: 0;
      box-sizing: border-box;
    }
    #tab-base, #tab-base * {
      font-size: 16px !important;
    }
    .modal-step {
      /* ...åŸæœ‰æ ·å¼... */
      position: relative;
    }
    .modal-steps {
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: relative;
    }
    .modal-step {
      display: flex;
      align-items: center;
      position: relative;
      background: none;
      margin: 0 0;
      z-index: 2;
    }
    .modal-step .step-index {
      position: relative;
      z-index: 2;
      background: #fff;
      margin-right: 8px;
    }
    .modal-step:not(:last-child)::after {
      content: '';
      display: block;
      position: absolute;
      left: calc(100% + 36px); /* å‘å³ç§»åŠ¨36px */
      top: 50%;
      transform: translateY(-50%);
      width: 60px;
      height: 2px;
      background: #2176c7;
      border-radius: 2px;
      z-index: 1;
      opacity: 0.85;
    }
    .modal-step.done:not(:last-child)::after {
      background: #4db6ac;
      opacity: 1;
    }
  </style>
</head>
<body>
<div class="modal-mask">
  <div class="modal-window">
    <div class="modal-header">
      <span class="modal-title">æ¨¡å‹è¯¦æƒ…</span>
      <button class="modal-close" onclick="closeModal()">Ã—</button>
    </div>
    <div class="modal-steps" style="display:flex;align-items:center;justify-content:space-between;margin:26px 32px 0 32px;">
      <div class="modal-step" data-step="base"><span class="step-index">1</span> åŸºæœ¬é…ç½®</div>
      <div class="modal-step" data-step="attr"><span class="step-index">2</span> å±æ€§é…ç½®</div>
      <div class="modal-step" data-step="rule"><span class="step-index">3</span> ä¸šåŠ¡è§„åˆ™</div>
      <div class="modal-step" data-step="code"><span class="step-index">4</span> ç¼–ç è§„åˆ™</div>
      <div class="modal-step" data-step="layout"><span class="step-index">5</span> å¸ƒå±€é…ç½®</div>
    </div>
    <div class="modal-content" id="tab-base">
      <div class="section-collapse-title" id="baseInfoCollapseBtn">
        <svg width="16" height="16" viewBox="0 0 1024 1024"><path d="M384 192l256 320-256 320z" fill="#2176c7"/></svg>
        åŸºæœ¬ä¿¡æ¯
      </div>
      <div class="section-content" id="baseInfoSection">
        <div class="form-2col">
          <div class="form-row">
            <div class="form-label required-label"><span class='required'>*</span>æ¨¡å‹åˆ†ç±»ï¼š</div>
            <div class="form-value">
              <select class="form-control" name="category" id="modelCategorySelect" required>
                <option value="æ™®é€šæ¨¡å‹">æ™®é€šæ¨¡å‹</option>
                <option value="å¤šè§†å›¾æ¨¡å‹">å¤šè§†å›¾æ¨¡å‹</option>
                <option value="å¼•ç”¨åˆ†ç±»æ¨¡å‹">å¼•ç”¨åˆ†ç±»æ¨¡å‹</option>
                <option value="å¼•ç”¨åˆ†ç±»å¤šè§†å›¾">å¼•ç”¨åˆ†ç±»å¤šè§†å›¾</option>
              </select>
            </div>
            <div class="form-label required-label"><span class='required'>*</span>ä¸»æ•°æ®ç±»å‹ï¼š</div>
            <div class="form-value">
              <select class="form-control" name="type" id="mainDataTypeSelect" required>
                <option value="ç³»ç»Ÿå­—å…¸è¡¨">ç³»ç»Ÿå­—å…¸è¡¨</option>
                <option value="å­—å…¸è¡¨">å­—å…¸è¡¨</option>
                <option value="ä¸»æ•°æ®">ä¸»æ•°æ®</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label required-label"><span class='required'>*</span>æ¨¡å‹ç¼–ç ï¼š</div>
            <div class="form-value"><input type="text" class="form-control" name="code" value="mdm_sys_master_data_type" required></div>
            <div class="form-label required-label"><span class='required'>*</span>æ¨¡å‹åç§°ï¼š</div>
            <div class="form-value"><input type="text" class="form-control" name="name" value="æ¨¡å‹ç±»å‹" required></div>
          </div>
          <div class="form-row ref-row" style="display:none;">
            <div class="form-label required-label"><span class='required'>*</span>å¼•ç”¨ä¸»æ•°æ®ï¼š</div>
            <div class="form-value">
              <select class="form-control" id="refMasterSelect" required></select>
            </div>
            <div class="form-label required-label"><span class='required'>*</span>å¼•ç”¨å­—æ®µï¼š</div>
            <div class="form-value">
              <select class="form-control" id="refFieldSelect" required></select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-label">æ˜¯å¦æ ‘å½¢å±•ç¤ºï¼š</div>
            <div class="form-value"><select class="form-control" name="tree"><option value="å¦" selected>å¦</option><option value="æ˜¯">æ˜¯</option></select></div>
          </div>
          <div class="form-row desc-row">
            <div class="form-label desc-label">æ¨¡å‹æè¿°ï¼š</div>
            <div class="form-value desc-value">
              <textarea class="form-control" name="desc" rows="3" style="resize:vertical;min-height:60px;max-height:180px;"></textarea>
            </div>
          </div>
        </div>
      </div>
      <div class="section-collapse-title" id="viewInfoCollapseBtn">
        <svg width="16" height="16" viewBox="0 0 1024 1024"><path d="M384 192l256 320-256 320z" fill="#2176c7"/></svg>
        è§†å›¾ä¿¡æ¯
      </div>
      <div class="section-content" id="viewInfoSection">
        <div id="viewListBox"></div>
      </div>
    </div>
    <div class="modal-footer-fixed">
      <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
      <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
    </div>
    <div class="modal-content" id="tab-attr" style="display:none; padding-top:0;">
      <div class="attr-flexbox">
        <div class="attr-field-list" id="attrFieldListWrapper">
          <div id="attrViewTabs" style="width:100%;"></div>
          <div id="attrFieldList"></div>
        </div>
        <div class="attr-field-detail" id="attr-detail-box">
          <!-- è¯¦æƒ…å†…å®¹ç”±JSæ¸²æŸ“ -->
        </div>
      </div>
    </div>
    <!-- å­—æ®µåº“å¼¹çª— -->
    <div id="fieldLibModal" class="modal-mask" style="display:none;z-index:2001;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,0.18);width:700px;max-width:98vw;min-height:420px;position:relative;">
        <div style="background:#2176c7;color:#fff;font-size:18px;font-weight:500;padding:16px 28px 12px 28px;border-radius:10px 10px 0 0;">æ ‡å‡†åº“ <span style='position:absolute;right:28px;top:16px;cursor:pointer;font-size:22px;' id="closeFieldLibModal">Ã—</span></div>
        <div style="padding:18px 28px 18px 28px;">
          <div style="margin-bottom:12px;display:flex;align-items:center;gap:12px;">
            <input id="fieldLibSearch" type="text" class="form-control" placeholder="å¿«é€ŸæŸ¥è¯¢å­—æ®µå/æè¿°" style="width:220px;">
            <button class="btn-modern" id="fieldLibSearchBtn">æŸ¥è¯¢</button>
          </div>
          <div style="max-height:320px;overflow:auto;">
            <table style="width:100%;border-collapse:collapse;background:#fff;font-size:15px;">
              <thead>
                <tr style="background:#f6f8fa;">
                  <th style="width:40px;"><input type="checkbox" id="fieldLibCheckAll"></th>
                  <th style="width:120px;">å€¼</th>
                  <th>åç§°</th>
                </tr>
              </thead>
              <tbody id="fieldLibTableBody">
                <!-- å­—æ®µåº“æ•°æ®ç”±JSæ¸²æŸ“ -->
              </tbody>
            </table>
          </div>
          <div style="margin-top:18px;text-align:right;">
            <button class="btn-modern" id="fieldLibAddBtn">æ·»åŠ æ‰€é€‰å­—æ®µ</button>
            <button class="btn-line-modern" id="fieldLibCancelBtn">å–æ¶ˆ</button>
          </div>
        </div>
      </div>
    </div>
    <div class="modal-content" id="tab-rule" style="display:none;">
      <div style="text-align: center; padding: 60px 20px; color: #666;">
        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ“‹</div>
        <div style="font-size: 18px; margin-bottom: 12px; color: #185a99; font-weight: 600;">ä¸šåŠ¡è§„åˆ™ç®¡ç†</div>
        <div style="font-size: 15px; margin-bottom: 24px; color: #666; line-height: 1.6;">
          è¯¦ç»†åŠŸèƒ½è¯·å‚è€ƒä¸šåŠ¡è§„åˆ™ç®¡ç†é¡µé¢<br>
          æ‚¨å¯ä»¥åœ¨è¿™é‡Œé…ç½®å’Œç®¡ç†æ¨¡å‹çš„ä¸šåŠ¡è§„åˆ™
        </div>
        <a href="businessrule.html" target="_blank" style="display: inline-block; background: #2176c7; color: #fff; border: none; border-radius: 6px; font-weight: 500; font-size: 15px; padding: 12px 24px; text-decoration: none; transition: background 0.18s; box-shadow: 0 2px 8px rgba(33,118,199,0.08);">
          å‰å¾€ä¸šåŠ¡è§„åˆ™ç®¡ç†
        </a>
      </div>
    </div>
    <div class="modal-content" id="tab-code" style="display:none;">
      <div style="text-align: center; padding: 60px 20px; color: #666;">
        <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ”¢</div>
        <div style="font-size: 18px; margin-bottom: 12px; color: #185a99; font-weight: 600;">ç¼–ç è§„åˆ™ç®¡ç†</div>
        <div style="font-size: 15px; margin-bottom: 24px; color: #666; line-height: 1.6;">
          è¯¦ç»†åŠŸèƒ½è¯·å‚è€ƒç¼–ç è§„åˆ™ç®¡ç†é¡µé¢<br>
          æ‚¨å¯ä»¥åœ¨è¿™é‡Œé…ç½®å’Œç®¡ç†æ¨¡å‹çš„ç¼–ç è§„åˆ™
        </div>
        <a href="data_coderule.html" target="_blank" style="display: inline-block; background: #2176c7; color: #fff; border: none; border-radius: 6px; font-weight: 500; font-size: 15px; padding: 12px 24px; text-decoration: none; transition: background 0.18s; box-shadow: 0 2px 8px rgba(33,118,199,0.08);">
          å‰å¾€ç¼–ç è§„åˆ™ç®¡ç†
        </a>
      </div>
    </div>
    <div class="modal-content" id="tab-layout" style="display:none;">
      <div style="display: flex; justify-content: center; gap: 48px; align-items: stretch; padding: 60px 0;">
        <!-- åŸæœ‰å¸ƒå±€é…ç½®å¡ç‰‡ -->
        <div style="flex:1; min-width:320px; max-width:420px; background:#fff; border-radius:10px; box-shadow:0 2px 12px rgba(33,118,199,0.10); display:flex; flex-direction:column; align-items:center; padding:36px 24px;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸš€</div>
          <div style="font-size: 18px; margin-bottom: 12px; color: #185a99; font-weight: 600;">å¸ƒå±€é…ç½®ç®¡ç†</div>
          <div style="font-size: 15px; margin-bottom: 24px; color: #666; line-height: 1.6;">
            è¯¦ç»†åŠŸèƒ½è¯·å‚è€ƒå¸ƒå±€é…ç½®ç®¡ç†é¡µé¢<br>
            æ‚¨å¯ä»¥åœ¨è¿™é‡Œé…ç½®å’Œç®¡ç†æ¨¡å‹çš„å¸ƒå±€è®¾ç½®
          </div>
          <a href="javascript:void(0)" onclick="openPageSetup()" style="display: inline-block; background: #2176c7; color: #fff; border: none; border-radius: 6px; font-weight: 500; font-size: 15px; padding: 12px 24px; text-decoration: none; transition: background 0.18s; box-shadow: 0 2px 8px rgba(33,118,199,0.08);">
            å‰å¾€å¸ƒå±€é…ç½®ç®¡ç†
          </a>
        </div>
        <!-- æ–°å¢å¼•ç”¨åˆ†ç±»å¸ƒå±€é…ç½®å¡ç‰‡ -->
        <div style="flex:1; min-width:320px; max-width:420px; background:#fff; border-radius:10px; box-shadow:0 2px 12px rgba(33,118,199,0.10); display:flex; flex-direction:column; align-items:center; padding:36px 24px;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸŒ³</div>
          <div style="font-size: 18px; margin-bottom: 12px; color: #185a99; font-weight: 600;">å¼•ç”¨åˆ†ç±»å¸ƒå±€é…ç½®</div>
          <div style="font-size: 15px; margin-bottom: 24px; color: #666; line-height: 1.6;">
            é€‚ç”¨äºå¼•ç”¨åˆ†ç±»æ¨¡å‹çš„æ ‘å½¢é¡µé¢å¸ƒå±€<br>
            æ‚¨å¯ä»¥åœ¨è¿™é‡Œé…ç½®å’Œç®¡ç†å¼•ç”¨åˆ†ç±»æ¨¡å‹çš„é¡µé¢å¸ƒå±€
          </div>
          <a href="javascript:void(0)" onclick="window.open('page_setup_tree.html','_blank')" style="display: inline-block; background: #2176c7; color: #fff; border: none; border-radius: 6px; font-weight: 500; font-size: 15px; padding: 12px 24px; text-decoration: none; transition: background 0.18s; box-shadow: 0 2px 8px rgba(33,118,199,0.08);">
            å‰å¾€å¼•ç”¨åˆ†ç±»å¸ƒå±€é…ç½®
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- å‘å¸ƒå¹¶æäº¤å¼¹çª— -->
<div id="publishModal" class="modal-mask" style="display:none;z-index:2001;">
  <div style="background:#fff;border-radius:10px;box-shadow:0 4px 24px rgba(0,0,0,0.18);width:500px;max-width:98vw;min-height:320px;position:relative;">
    <div style="background:#2176c7;color:#fff;font-size:16px;font-weight:500;padding:16px 24px 12px 24px;border-radius:10px 10px 0 0;display:flex;justify-content:space-between;align-items:center;">
      <span>å‘å¸ƒå¹¶æäº¤</span>
      <span style='cursor:pointer;font-size:20px;' id="closePublishModal">Ã—</span>
    </div>
    <div style="padding:24px;">
      <div style="margin-bottom:20px;">
        <div style="font-size:15px;color:#185a99;font-weight:600;margin-bottom:12px;">è¯·é€‰æ‹©èœå•ä½ç½®ï¼š</div>
        <div id="menuTreeContainer" style="border:1px solid #c0d3eb;border-radius:6px;max-height:200px;overflow-y:auto;background:#fff;">
          <div class="menu-tree-item" data-value="main" style="padding:10px 12px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#333;">ä¸»èœå•</span>
          </div>
          <div class="menu-tree-item" data-value="sub1" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”œâ”€ æ•°æ®ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â”œâ”€ ä¸»æ•°æ®ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â”œâ”€ æ•°æ®å­—å…¸</span>
          </div>
          <div class="menu-tree-item" data-value="sub1-3" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â””â”€ æ•°æ®æ ‡å‡†</span>
          </div>
          <div class="menu-tree-item" data-value="sub2" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”œâ”€ ç³»ç»Ÿç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â”œâ”€ ç”¨æˆ·ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â”œâ”€ è§’è‰²ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub2-3" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â”‚  â””â”€ æƒé™ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub3" style="padding:10px 12px 10px 24px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">â””â”€ ä¸šåŠ¡ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub3-1" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">   â”œâ”€ æµç¨‹ç®¡ç†</span>
          </div>
          <div class="menu-tree-item" data-value="sub3-2" style="padding:10px 12px 10px 36px;cursor:pointer;border-bottom:1px solid #f0f0f0;font-size:14px;">
            <span style="color:#666;">   â””â”€ æŠ¥è¡¨ç®¡ç†</span>
          </div>
        </div>
        <div id="selectedMenuDisplay" style="margin-top:8px;padding:8px 12px;background:#f6f8fa;border-radius:4px;font-size:13px;color:#666;display:none;">
          å·²é€‰æ‹©ï¼š<span id="selectedMenuText"></span>
        </div>
      </div>
      
      <div style="display:flex;justify-content:flex-end;gap:12px;margin-top:24px;">
        <button class="btn-line-modern" id="cancelPublishBtn" style="margin:0;">å–æ¶ˆ</button>
        <button class="btn-modern" id="confirmPublishBtn" style="margin:0;">ç¡®è®¤å‘å¸ƒ</button>
      </div>
    </div>
  </div>
</div>

<script>
// ========== ç»Ÿä¸€æ­¥éª¤æ¡ä¸Tabåˆ‡æ¢é€»è¾‘ ========== //
(function(){
  // æ­¥éª¤é¡ºåº
  const stepOrder = ['base','attr','rule','code','layout'];
  const stepEls = document.querySelectorAll('.modal-step');
  const tabEls = stepOrder.map(s=>document.getElementById('tab-'+s));
  const footer = document.querySelector('.modal-footer-fixed');

  // æ­¥éª¤æ¡é«˜äº®ä¸å¯¹å‹¾
  function updateStepBar(activeStep) {
    stepEls.forEach((el,idx)=>{
      el.classList.remove('active','done');
      if(stepOrder.indexOf(activeStep)>idx) el.classList.add('done');
      else if(stepOrder.indexOf(activeStep)===idx) el.classList.add('active');
      // å¯¹å‹¾
      const idxSpan = el.querySelector('.step-index');
      if(el.classList.contains('done')) idxSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8" fill="#4db6ac"/><path d="M4 8l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>';
      else idxSpan.textContent = (idx+1);
    });
  }
  // æ˜¾ç¤ºæŒ‡å®šæ­¥éª¤å†…å®¹åŒº
  function showStep(idx) {
    tabEls.forEach((el,i)=>el.style.display = i===idx?'':'none');
    updateStepBar(stepOrder[idx]);
    renderFooter(stepOrder[idx]);
  }
  // æ¸²æŸ“footeræŒ‰é’®
  function renderFooter(step) {
    if(typeof step==='object' && step.dataset) step = step.dataset.tab || step.dataset.step;
    if(step === 'attr' || step === 'rule' || step === 'code') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
        <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
      `;
    } else if(step === 'layout') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
        <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
        <button type="button" class="btn-modern" id="modalFinishBtn">æäº¤</button>
        <button type="button" class="btn-modern" id="modalPublishBtn">å‘å¸ƒå¹¶æäº¤</button>
      `;
    } else {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
        <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
      `;
    }
    bindFooterEvents();
  }
  // ç»‘å®šfooteræŒ‰é’®äº‹ä»¶
  function bindFooterEvents() {
    document.getElementById('modalPrevBtn') && (document.getElementById('modalPrevBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx>0) showStep(idx-1);
    });
    document.getElementById('modalNextBtn') && (document.getElementById('modalNextBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx<stepOrder.length-1) showStep(idx+1);
    });
    document.getElementById('modalSaveBtn') && (document.getElementById('modalSaveBtn').onclick = function() { alert('ä¿å­˜æˆåŠŸï¼'); });
    document.getElementById('modalFinishBtn') && (document.getElementById('modalFinishBtn').onclick = function() { alert('æäº¤æˆåŠŸï¼'); });
    document.getElementById('modalPublishBtn') && (document.getElementById('modalPublishBtn').onclick = function() { 
      // æ˜¾ç¤ºå‘å¸ƒå¹¶æäº¤å¼¹çª—
      document.getElementById('publishModal').style.display = 'flex';
    });
  }
  // æ­¥éª¤æ¡ç‚¹å‡»åˆ‡æ¢
  stepEls.forEach((el,idx)=>{
    el.onclick = function(){ showStep(idx); };
  });
  // é¡µé¢åˆå§‹åŒ–æ—¶é«˜äº®ç¬¬ä¸€ä¸ªtabå’Œfooter
  showStep(0);

  // ========== å‘å¸ƒå¼¹çª—äº‹ä»¶ç»‘å®š ========== //
  // å…³é—­å‘å¸ƒå¼¹çª—
  document.getElementById('closePublishModal') && (document.getElementById('closePublishModal').onclick = function() {
    document.getElementById('publishModal').style.display = 'none';
  });
  document.getElementById('cancelPublishBtn') && (document.getElementById('cancelPublishBtn').onclick = function() {
    document.getElementById('publishModal').style.display = 'none';
  });
  
  // èœå•æ ‘é€‰æ‹©äº‹ä»¶
  document.addEventListener('click', function(e) {
    if(e.target.closest('.menu-tree-item')) {
      const menuItem = e.target.closest('.menu-tree-item');
      const value = menuItem.getAttribute('data-value');
      const text = menuItem.querySelector('span').textContent.trim();
      
      // ç§»é™¤å…¶ä»–é€‰ä¸­çŠ¶æ€
      document.querySelectorAll('.menu-tree-item').forEach(item => {
        item.style.background = '';
        item.style.color = '';
      });
      
      // é«˜äº®å½“å‰é€‰ä¸­é¡¹
      menuItem.style.background = '#eaf3ff';
      menuItem.style.color = '#2176c7';
      
      // æ˜¾ç¤ºé€‰æ‹©ç»“æœ
      document.getElementById('selectedMenuDisplay').style.display = 'block';
      document.getElementById('selectedMenuText').textContent = text;
      
      // ä¿å­˜é€‰æ‹©çš„å€¼
      window.selectedMenuValue = value;
      window.selectedMenuText = text;
    }
  });
  
  // ç¡®è®¤å‘å¸ƒ
  document.getElementById('confirmPublishBtn') && (document.getElementById('confirmPublishBtn').onclick = function() {
    if(!window.selectedMenuValue) {
      alert('è¯·å…ˆé€‰æ‹©èœå•ä½ç½®ï¼');
      return;
    }
    
    const menuPosition = window.selectedMenuValue;
    const menuText = window.selectedMenuText;
    
    // æ„å»ºå‘å¸ƒä¿¡æ¯
    let positionText = '';
    switch(menuPosition) {
      case 'main': positionText = 'ä¸»èœå•'; break;
      case 'sub1': positionText = 'æ•°æ®ç®¡ç†'; break;
      case 'sub1-1': positionText = 'æ•°æ®ç®¡ç† > ä¸»æ•°æ®ç®¡ç†'; break;
      case 'sub1-2': positionText = 'æ•°æ®ç®¡ç† > æ•°æ®å­—å…¸'; break;
      case 'sub1-3': positionText = 'æ•°æ®ç®¡ç† > æ•°æ®æ ‡å‡†'; break;
      case 'sub2': positionText = 'ç³»ç»Ÿç®¡ç†'; break;
      case 'sub2-1': positionText = 'ç³»ç»Ÿç®¡ç† > ç”¨æˆ·ç®¡ç†'; break;
      case 'sub2-2': positionText = 'ç³»ç»Ÿç®¡ç† > è§’è‰²ç®¡ç†'; break;
      case 'sub2-3': positionText = 'ç³»ç»Ÿç®¡ç† > æƒé™ç®¡ç†'; break;
      case 'sub3': positionText = 'ä¸šåŠ¡ç®¡ç†'; break;
      case 'sub3-1': positionText = 'ä¸šåŠ¡ç®¡ç† > æµç¨‹ç®¡ç†'; break;
      case 'sub3-2': positionText = 'ä¸šåŠ¡ç®¡ç† > æŠ¥è¡¨ç®¡ç†'; break;
      default: positionText = menuText;
    }
    
    const message = `å‘å¸ƒæˆåŠŸï¼\n\nèœå•ä½ç½®ï¼š${positionText}`;
    alert(message);
    
    // å…³é—­å¼¹çª—
    document.getElementById('publishModal').style.display = 'none';
  });

  // ========== æ¸…ç†æ‰€æœ‰é‡å¤/è€çš„tabåˆ‡æ¢ã€footeræ¸²æŸ“ã€æ­¥éª¤æ¡ç›¸å…³JS ========== //
  // 1. ç§»é™¤æ‰€æœ‰å¤šä½™çš„stepOrder/stepEls/updateStepBar/renderFooterç›¸å…³å…¨å±€å˜é‡å’Œå‡½æ•°
  // 2. ç§»é™¤æ‰€æœ‰å¤šä½™çš„DOMContentLoadedäº‹ä»¶ä¸­å…³äºtabåˆ‡æ¢ã€footeræ¸²æŸ“ã€æ­¥éª¤æ¡çš„ç»‘å®š
  // 3. ä¿è¯å…¨å±€åªæœ‰æœ¬å¥—é€»è¾‘

  // ========== closeModalå‡½æ•°è¡¥å…… ========== //
  window.closeModal = function() {
    // æ”¯æŒå…³é—­å¼¹çª—ï¼ˆå¯æ ¹æ®å®é™…æƒ…å†µéšè—modal-maskæˆ–window.closeï¼‰
    var mask = document.querySelector('.modal-mask');
    if(mask) mask.style.display = 'none';
    // æˆ– window.close();
  };
})();

// å­—æ®µåº“æ¨¡æ‹Ÿæ•°æ®
const FIELD_LIBRARY = [
  { value: 'desc31', name: 'å›½ç±' },
  { value: 'desc32', name: 'èº«ä»½è¯å·ç ' },
  { value: 'desc33', name: 'å‡ºç”Ÿæ—¥æœŸ' },
  { value: 'desc34', name: 'æ‰€å±ç»„ç»‡æœºæ„' },
  { value: 'desc35', name: 'ç°å·¥ä½œå•ä½ç»„ç»‡æœºæ„' },
  { value: 'desc36', name: 'å‚åŠ å·¥ä½œæ—¶é—´' },
  { value: 'desc37', name: 'åˆ°é¦–é’¢å·¥ä½œæ—¶é—´' },
  { value: 'desc38', name: 'èŒç§°ç­‰çº§' },
  // å¯æ‰©å±•æ›´å¤šå­—æ®µ
];

// å¤šè§†å›¾å­—æ®µç®¡ç†
let currentView = 'base'; // å½“å‰é€‰ä¸­çš„è§†å›¾
let attrFieldsByView = {
  // åŸºæœ¬å±æ€§å­—æ®µ
  base: [
    { value: 'desc31', name: 'å›½ç±', status: 'normal', enabled: true, detail: { code: 'code1', name: 'å›½ç±', type: 'å­—ç¬¦ä¸²', length: '32', required: 'æ˜¯', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc32', name: 'èº«ä»½è¯å·ç ', status: 'normal', enabled: true, detail: { code: 'code2', name: 'èº«ä»½è¯å·ç ', type: 'å­—ç¬¦ä¸²', length: '32', required: 'æ˜¯', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc33', name: 'å‡ºç”Ÿæ—¥æœŸ', status: 'normal', enabled: true, detail: { code: 'code3', name: 'å‡ºç”Ÿæ—¥æœŸ', type: 'æ—¥æœŸ', length: '', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc34', name: 'æ‰€å±ç»„ç»‡æœºæ„', status: 'normal', enabled: true, detail: { code: 'code4', name: 'æ‰€å±ç»„ç»‡æœºæ„', type: 'å­—ç¬¦ä¸²', length: '32', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc35', name: 'ç°å·¥ä½œå•ä½ç»„ç»‡æœºæ„', status: 'normal', enabled: true, detail: { code: 'code5', name: 'ç°å·¥ä½œå•ä½ç»„ç»‡æœºæ„', type: 'å­—ç¬¦ä¸²', length: '32', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc36', name: 'å‚åŠ å·¥ä½œæ—¶é—´', status: 'normal', enabled: true, detail: { code: 'code6', name: 'å‚åŠ å·¥ä½œæ—¶é—´', type: 'æ—¥æœŸ', length: '', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc37', name: 'åˆ°é¦–é’¢å·¥ä½œæ—¶é—´', status: 'normal', enabled: true, detail: { code: 'code7', name: 'åˆ°é¦–é’¢å·¥ä½œæ—¶é—´', type: 'æ—¥æœŸ', length: '', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
    { value: 'desc38', name: 'èŒç§°ç­‰çº§', status: 'normal', enabled: true, detail: { code: 'code8', name: 'èŒç§°ç­‰çº§', type: 'å­—ç¬¦ä¸²', length: '32', required: 'å¦', getType: 'è‡ªåŠ¨ç”Ÿæˆ' } },
  ]
};

// è·å–å½“å‰è§†å›¾çš„å­—æ®µåˆ—è¡¨
function getCurrentAttrFields() {
  return attrFieldsByView[currentView] || [];
}

// è®¾ç½®å½“å‰è§†å›¾çš„å­—æ®µåˆ—è¡¨
function setCurrentAttrFields(fields) {
  attrFieldsByView[currentView] = fields;
}

// å½“å‰å±æ€§å­—æ®µï¼ˆå…¼å®¹åŸæœ‰ä»£ç ï¼‰
let attrFields = getCurrentAttrFields();

// é€‰ä¸­å­—æ®µç´¢å¼•
let selectedAttrIdx = 0;
function renderAttrDetailBox() {
  const box = document.getElementById('attr-detail-box');
  const currentFields = getCurrentAttrFields();
  const f = currentFields[selectedAttrIdx];
  if (!f) { box.innerHTML = '<div style="color:#888;padding:32px;">æ— å±æ€§</div>'; return; }
  if (!f.enabled) {
    box.innerHTML = `<div style='color:#d33;font-size:16px;padding:48px 0 0 0;text-align:center;'>è¯¥å­—æ®µå·²è¢«ç¦ç”¨ï¼Œè¯·ç‚¹å‡»å·¦ä¾§å¯ç”¨</div>`;
    return;
  }
  // æŠ˜å çŠ¶æ€
  if(typeof window.attrPanelCollapse === 'undefined') window.attrPanelCollapse = { attr: false, validate: true };
  const collapse = window.attrPanelCollapse;
  if(typeof collapse.advanced === 'undefined') collapse.advanced = false;
  // åˆ¤æ–­æ˜¯å¦ä¸ºç¼–ç æˆ–åç§°
  const isCode = selectedAttrIdx === 0;
  const isName = selectedAttrIdx === 1;
  box.innerHTML = `
    <div style='font-size:15px;font-weight:600;color:#2176c7;margin-bottom:6px;display:flex;align-items:center;cursor:pointer;user-select:none;' id='attrInfoToggle'>
      <svg style='margin-right:6px;transition:.2s;transform:rotate(${collapse.attr?0:90}deg);' width='14' height='14' viewBox='0 0 1024 1024'><path d='M384 192l256 320-256 320z' fill='#2176c7'/></svg>å±æ€§ä¿¡æ¯
    </div>
    <div id='attrInfoPanel' style='display:${collapse.attr?'none':'block'};'>
      <form class='form-2col' style='padding-bottom:8px;'>
        <div class='form-row'><div class='form-label'>å­—æ®µåç§°</div><div class='form-value'><input class='form-control' value='${f.name}' ${isCode?'readonly':''}></div>
          <div class='form-label'>è¾“å…¥ç±»å‹</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ–‡æœ¬</option><option>ä¸‹æ‹‰</option><option>åªè¯»</option></select></div></div>
        <div class='form-row'><div class='form-label'>å…ƒå±æ€§ç¼–ç </div><div class='form-value'><input class='form-control' value='${f.detail?.code||''}' readonly></div>
          <div class='form-label'>æ˜¯å¦å¼•ç”¨å…ƒæ•°æ®æè¿°</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div></div>
        <div class='form-row'><div class='form-label'>å…ƒå±æ€§åç§°</div><div class='form-value'><input class='form-control' value='${f.detail?.name||''}' ${isCode?'readonly':''}></div>
          <div class='form-label'>å–å€¼æ–¹å¼</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>è‡ªåŠ¨ç”Ÿæˆ</option><option>æ‰‹åŠ¨è¾“å…¥</option></select></div></div>
        <div class='form-row'><div class='form-label'>å­—æ®µç±»å‹</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>å­—ç¬¦ä¸²</option><option>æ•°å­—</option><option>æ—¥æœŸ</option></select></div>
          <div class='form-label'>é•¿åº¦ (byte)</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>æ˜¯å¦å¿…å¡«</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div>
          <div class='form-label'>å°æ•°ä½é•¿åº¦</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>é»˜è®¤å€¼</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div>
          <div class='form-label'>å­—å…¸è¡¨å¼•ç”¨</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ— </option><option>å¼•ç”¨A</option></select></div></div>
        <div class='form-row'><div class='form-label'>å­—å…¸è¡¨å¼•ç”¨</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ— </option><option>å¼•ç”¨A</option></select></div>
          <div class='form-label'>å­—å…¸è¡¨å¼•ç”¨å­—æ®µ</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>å­—æ®µ1</option><option>å­—æ®µ2</option></select></div></div>
        <div class='form-row'><div class='form-label'>æ˜¯å¦æ˜¾ç¤ºå­—å…¸è¡¨ä»£ç </div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div>
          <div class='form-label'>å­—å…¸è¡¨ç­›é€‰å­—æ®µ</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>å­—æ®µA</option><option>å­—æ®µB</option></select></div></div>
        <div class='form-row'><div class='form-label'>å­—å…¸è¡¨ç­›é€‰æ¡ä»¶</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div>
          <div class='form-label'>æ˜¯å¦æ ‘èŠ‚ç‚¹</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div></div>
        <div class='form-row'><div class='form-label'>èŠ‚ç‚¹æè¿°</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æè¿°A</option><option>æè¿°B</option></select></div>
          <div class='form-label'>æ ¹èŠ‚ç‚¹</div><div class='form-value'><input class='form-control' ${isCode?'readonly':''}></div></div>
        <div class='form-row'><div class='form-label'>èŠ‚ç‚¹æè¿°å­—æ®µ</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>å­—æ®µA</option><option>å­—æ®µB</option></select></div>
          <div class='form-label'>æ˜¯å¦æ˜¾ç¤ºæ ‘åç§°</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div></div>
        <div class='form-row'><div class='form-label'>å…³è”ä¸»æ•°æ®</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>ä¸»æ•°æ®A</option><option>ä¸»æ•°æ®B</option></select></div>
          <div class='form-label'>å¤§å°å†™è½¬æ¢</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ— </option><option>å¤§å†™</option><option>å°å†™</option></select></div></div>
        <div class='form-row'><div class='form-label'>å…¨åŠè§’è½¬æ¢</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ— </option><option>å…¨è§’</option><option>åŠè§’</option></select></div>
          <div class='form-label'>æ˜¯å¦è¿‡æ»¤ç©ºæ ¼</div><div class='form-value'><select class='form-control' ${isCode?'disabled':''}><option>æ˜¯</option><option>å¦</option></select></div></div>
      </form>
    </div>
    <div style='font-size:15px;font-weight:600;color:#2176c7;margin-bottom:6px;margin-top:8px;display:flex;align-items:center;cursor:pointer;user-select:none;' id='validateInfoToggle'>
      <svg style='margin-right:6px;transition:.2s;transform:rotate(${collapse.validate?0:90}deg);' width='14' height='14' viewBox='0 0 1024 1024'><path d='M384 192l256 320-256 320z' fill='#2176c7'/></svg>æ ¡éªŒä¿¡æ¯
    </div>
    <div id='validateInfoPanel' style='display:${collapse.validate?'none':'block'};'>
      <form class='form-2col' style='padding-bottom:8px;'>
        <div class='form-row'><div class='form-label'>æ˜¯å¦å¯ç¼–è¾‘</div><div class='form-value'><select class='form-control'><option>æ˜¯</option><option>å¦</option></select></div>
          <div class='form-label'>æœ€å¤§é•¿åº¦</div><div class='form-value'><input class='form-control'></div></div>
        <div class='form-row'><div class='form-label'>æœ€å°é•¿åº¦</div><div class='form-value'><input class='form-control'></div>
          <div class='form-label'>æ˜¯å¦å¯ç”¨ä¸Šä¸‹é™</div><div class='form-value'><select class='form-control'><option>æ˜¯</option><option>å¦</option></select></div></div>
        <div class='form-row'><div class='form-label'>ä¸Šé™</div><div class='form-value'><input class='form-control'></div>
          <div class='form-label'>ä¸‹é™</div><div class='form-value'><input class='form-control'></div></div>
        <div class='form-row'><div class='form-label'>æ˜¯å¦å”¯ä¸€</div><div class='form-value'><select class='form-control'><option>æ˜¯</option><option>å¦</option></select></div>
          <div class='form-label'>æ ¡éªŒç±»å‹</div><div class='form-value'><select class='form-control'><option>æ— </option><option>ç±»å‹A</option></select></div></div>
        <div class='form-row'><div class='form-label'>æ£€éªŒæ­£åˆ™è¡¨è¾¾å¼</div><div class='form-value'><button type='button' class='btn-line-modern' style='padding:4px 12px;font-size:13px;'>é€‰æ‹©æ­£åˆ™</button></div></div>
      </form>
    </div>
  `;
  // æŠ˜å /å±•å¼€äº‹ä»¶
  setTimeout(()=>{
    document.getElementById('attrInfoToggle').onclick = function(){
      window.attrPanelCollapse.attr = !window.attrPanelCollapse.attr;
      renderAttrDetailBox();
    };
    document.getElementById('validateInfoToggle').onclick = function(){
      window.attrPanelCollapse.validate = !window.attrPanelCollapse.validate;
      renderAttrDetailBox();
    };
  },0);
}
function renderAttrFieldList() {
  const list = document.getElementById('attrFieldList');
  const currentFields = getCurrentAttrFields();
  // æ‰¹é‡åˆ é™¤æŒ‰é’®
  let deleteBtn = `<button class="btn-modern" id="batchDeleteBtn" style="display:flex;align-items:center;gap:3px;font-size:10px;padding:1px 7px;margin-left:6px;min-width:unset;height:20px;line-height:1;background:#e53935;"><svg width='13' height='13' viewBox='0 0 1024 1024'><path d='M256 256l512 512M768 256L256 768' stroke='#fff' stroke-width='48' stroke-linecap='round'/></svg></button>`;
  list.innerHTML = `
    <div style="display:flex;align-items:center;justify-content:space-between;padding:14px 12px 8px 12px;">
      <span style="font-size:15px;font-weight:600;color:#185a99;">å±æ€§åˆ—è¡¨</span>
      <div style="display:flex;align-items:center;gap:4px;">
        <button class="btn-modern" id="openFieldLibBtn" style="display:flex;align-items:center;gap:3px;font-size:10px;padding:1px 7px;margin:0;min-width:unset;height:20px;line-height:1;">
          <span style='display:inline-flex;width:11px;height:11px;border-radius:50%;background:transparent;align-items:center;justify-content:center;'><svg width="11" height="11" viewBox="0 0 13 13"><path d="M6.5 2v9M2 6.5h9" stroke="#fff" stroke-width="2" stroke-linecap="round"/></svg></span>
          <span style='color:#fff;font-weight:500;'>æ·»åŠ </span>
        </button>
        ${deleteBtn}
      </div>
    </div>
  ` +
    currentFields.map((f, idx) => {
      let main = idx === 0 ? 'ç¼–ç ' : (idx === 1 ? 'åç§°' : f.name);
      let sub = idx === 0 ? `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>code</div>` : (idx === 1 ? `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>name</div>` : `<div style='font-size:12px;color:#888;margin-top:2px;margin-left:2px;'>desc${idx+1}</div>`);
      let icon = '';
      if(idx > 0) {
        icon = f.enabled
          ? `<span class='field-enable-icon' title='ç‚¹å‡»ç¦ç”¨' data-idx='${idx}' style='margin-left:auto;cursor:pointer;display:inline-flex;align-items:center;'><svg width='28' height='18' viewBox='0 0 28 18'><rect x='1' y='1' width='26' height='16' rx='8' fill='#2176c7'/><circle cx='20' cy='9' r='6' fill='#fff' stroke='#2176c7' stroke-width='2'/></svg></span>`
          : `<span class='field-enable-icon' title='ç‚¹å‡»å¯ç”¨' data-idx='${idx}' style='margin-left:auto;cursor:pointer;display:inline-flex;align-items:center;'><svg width='28' height='18' viewBox='0 0 28 18'><rect x='1' y='1' width='26' height='16' rx='8' fill='#d6d8db'/><circle cx='8' cy='9' r='6' fill='#fff' stroke='#bfc8d6' stroke-width='2'/></svg></span>`;
      }
      // å¤šé€‰checkboxï¼ˆç¼–ç ã€åç§°ä¸å¯é€‰ï¼‰
      let checkbox = idx > 1 ? `<input type='checkbox' class='field-checkbox' data-idx='${idx}' style='margin-right:6px;' ${f.selected?'checked':''}>` : `<span style='display:inline-block;width:18px;'></span>`;
      return `
        <div class="attr-field-item${idx===selectedAttrIdx?' active':''}" data-field="${f.value}" data-idx="${idx}" style="display:flex;flex-direction:column;align-items:flex-start;gap:0;padding:10px 12px;position:relative;">
          <div style='display:flex;align-items:center;width:100%;'>
            ${checkbox}
            <span style="color:#2176c7;font-weight:500;">${main}</span>
            ${icon}
          </div>
          ${sub}
        </div>
      `;
    }).join('');
  // ç»‘å®šç‚¹å‡»é€‰ä¸­
  Array.from(list.querySelectorAll('.attr-field-item')).forEach(item => {
    item.onclick = function(e) {
      // ç¦ç”¨/å¯ç”¨/checkboxç‚¹å‡»ä¸åˆ‡æ¢é€‰ä¸­
      if(e.target.closest('.field-enable-icon') || e.target.classList.contains('field-checkbox')) return;
      selectedAttrIdx = parseInt(this.getAttribute('data-idx'));
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  });
  // ç»‘å®šå¯ç”¨/ç¦ç”¨åˆ‡æ¢
  Array.from(list.querySelectorAll('.field-enable-icon')).forEach(icon => {
    icon.onclick = function(e) {
      e.stopPropagation();
      const idx = parseInt(this.getAttribute('data-idx'));
      const currentFields = getCurrentAttrFields();
      currentFields[idx].enabled = !currentFields[idx].enabled;
      setCurrentAttrFields(currentFields);
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  });
  // ç»‘å®šcheckboxå¤šé€‰
  Array.from(list.querySelectorAll('.field-checkbox')).forEach(cb => {
    cb.onclick = function(e) {
      e.stopPropagation();
      const idx = parseInt(this.getAttribute('data-idx'));
      const currentFields = getCurrentAttrFields();
      currentFields[idx].selected = this.checked;
      setCurrentAttrFields(currentFields);
    }
  });
  // ç»‘å®šæ‰¹é‡åˆ é™¤
  const batchDeleteBtn = document.getElementById('batchDeleteBtn');
  if(batchDeleteBtn) {
    batchDeleteBtn.onclick = function(e) {
      e.stopPropagation();
      // åªåˆ é™¤å‹¾é€‰çš„ï¼Œä¸”idx>1
      const currentFields = getCurrentAttrFields();
      const newFields = currentFields.filter((f, idx) => idx<=1 || !f.selected);
      setCurrentAttrFields(newFields);
      // é‡ç½®é€‰ä¸­
      if(selectedAttrIdx >= newFields.length) selectedAttrIdx = newFields.length-1;
      renderAttrFieldList();
      renderAttrDetailBox();
    }
  }
  // æ¸²æŸ“å³ä¾§å±æ€§
  renderAttrDetailBox();
}
window.toggleFieldStatus = function(value) {
  const currentFields = getCurrentAttrFields();
  const newFields = currentFields.map(f => f.value===value ? { ...f, status: f.status==='normal'?'deleted':'normal' } : f);
  setCurrentAttrFields(newFields);
  renderAttrFieldList();
}
// å­—æ®µåº“å¼¹çª—é€»è¾‘
const fieldLibModal = document.getElementById('fieldLibModal');
document.body.addEventListener('click', function(e) {
  const btn = e.target.closest('#openFieldLibBtn');
  if (btn) {
    renderFieldLibTable();
    fieldLibModal.style.display = 'flex';
  }
  if(e.target && (e.target.id==='closeFieldLibModal'||e.target.id==='fieldLibCancelBtn')) {
    fieldLibModal.style.display = 'none';
  }
  if(e.target && e.target.id==='fieldLibAddBtn') {
    // æ·»åŠ æ‰€é€‰å­—æ®µ
    const checked = Array.from(document.querySelectorAll('.field-lib-checkbox:checked')).map(cb=>cb.value);
    const currentFields = getCurrentAttrFields();
    checked.forEach(val => {
      if(!currentFields.some(f=>f.value===val)) {
        const field = FIELD_LIBRARY.find(f=>f.value===val);
        if(field) currentFields.push({ ...field, status: 'normal' });
      } else {
        // å¦‚æœå·²å­˜åœ¨ä½†è¢«åˆ é™¤ï¼Œæ¢å¤ä¸ºæ­£å¸¸
        const newFields = currentFields.map(f=>f.value===val ? { ...f, status: 'normal' } : f);
        setCurrentAttrFields(newFields);
        return;
      }
    });
    setCurrentAttrFields(currentFields);
    renderAttrFieldList();
    fieldLibModal.style.display = 'none';
  }
  // tab-attr ä¸Šä¸€æ­¥ã€ä¸‹ä¸€æ­¥
  if(e.target && e.target.id==='modalPrevBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // åˆ‡æ¢åˆ°åŸºæœ¬é…ç½®
    document.querySelectorAll('.modal-step').forEach(t=>t.classList.remove('active'));
    document.querySelector('.modal-step[data-step="base"]').classList.add('active');
    document.querySelectorAll('.modal-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-base').style.display = '';
    updateStepBar('base');
  }
  if(e.target && e.target.id==='modalNextBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // åˆ‡æ¢åˆ°ä¸šåŠ¡è§„åˆ™
    document.querySelectorAll('.modal-step').forEach(t=>t.classList.remove('active'));
    document.querySelector('.modal-step[data-step="rule"]').classList.add('active');
    document.querySelectorAll('.modal-content').forEach(c=>c.style.display='none');
    document.getElementById('tab-rule').style.display = '';
    updateStepBar('rule');
  }
  // å±æ€§é…ç½®ä¿å­˜
  if(e.target && e.target.id==='modalSaveBtn' && document.querySelector('.modal-step.active').dataset.step==='attr') {
    // åªå…è®¸æ¨¡å‹åç§°å’Œæ¨¡å‹æè¿°å¯ç¼–è¾‘
    document.querySelector('input[name="name"]').removeAttribute('readonly');
    document.querySelector('textarea[name="desc"]').removeAttribute('readonly');
    // å…¶å®ƒè¾“å…¥æ¡†ç¦ç”¨
    document.querySelectorAll('#tab-base input, #tab-base select, #tab-base textarea').forEach(el => {
      if(el.name!=='name' && el.name!=='desc') el.setAttribute('readonly','readonly');
      if(el.tagName==='SELECT' && el.name!=='name' && el.name!=='desc') el.setAttribute('disabled','disabled');
    });
  }
  // åŸºæœ¬é…ç½®é¡µä¿å­˜
  if(e.target && e.target.id==='modalSaveBtn' && document.querySelector('.modal-step.active').dataset.step==='base') {
    // åˆ¤æ–­æ¨¡å‹åˆ†ç±»
    const cat = document.getElementById('modelCategorySelect').value;
    if(cat==='å¤šè§†å›¾æ¨¡å‹' || cat==='å¼•ç”¨åˆ†ç±»å¤šè§†å›¾') {
      // å¦‚æœè§†å›¾ä¿¡æ¯åŒºåŸŸæœªæ˜¾ç¤ºï¼Œåˆ™æ¸²æŸ“
      renderViewList();
      // å¦‚æœæ²¡æœ‰è§†å›¾ï¼Œè‡ªåŠ¨æ·»åŠ ä¸€è¡Œ
      if(!window.viewList || window.viewList.length===0) {
        window.viewList = [{name:'',desc:''}];
        renderViewList();
      }
      // æ»šåŠ¨åˆ°è§†å›¾ä¿¡æ¯åŒºåŸŸ
      const viewListBox = document.getElementById('viewListBox');
      if(viewListBox) viewListBox.scrollIntoView({behavior:'smooth',block:'center'});
    }
  }
});
function renderFieldLibTable() {
  const tbody = document.getElementById('fieldLibTableBody');
  const currentFields = getCurrentAttrFields();
  tbody.innerHTML = FIELD_LIBRARY.map(f => `
    <tr>
      <td><input type="checkbox" class="field-lib-checkbox" value="${f.value}" ${currentFields.some(a=>a.value===f.value&&a.status==='normal')?'checked disabled':''}></td>
      <td>${f.value}</td>
      <td>${f.name}</td>
    </tr>
  `).join('');
}
renderAttrFieldList();

// æ¨¡æ‹Ÿä¸»æ•°æ®æ¨¡å‹å’Œå±æ€§
const MASTER_MODELS = [
  { code: 'mdm1', name: 'ä¸»æ•°æ®æ¨¡å‹A', fields: [ { code: 'f1', name: 'å±æ€§A1' }, { code: 'f2', name: 'å±æ€§A2' } ] },
  { code: 'mdm2', name: 'ä¸»æ•°æ®æ¨¡å‹B', fields: [ { code: 'f3', name: 'å±æ€§B1' }, { code: 'f4', name: 'å±æ€§B2' } ] },
  { code: 'mdm3', name: 'ä¸»æ•°æ®æ¨¡å‹C', fields: [ { code: 'f5', name: 'å±æ€§C1' }, { code: 'f6', name: 'å±æ€§C2' } ] },
];
function updateRefMasterOptions() {
  const refMaster = document.getElementById('refMasterSelect');
  if (!refMaster) return;
  refMaster.innerHTML = MASTER_MODELS.map(m => `<option value="${m.code}">${m.name}</option>`).join('');
  updateRefFieldOptions();
}
function updateRefFieldOptions() {
  const refMaster = document.getElementById('refMasterSelect');
  const refField = document.getElementById('refFieldSelect');
  if (!refMaster || !refField) return;
  const model = MASTER_MODELS.find(m => m.code === refMaster.value) || MASTER_MODELS[0];
  refField.innerHTML = model.fields.map(f => `<option value="${f.code}">${f.name}</option>`).join('');
}
function updateRefRowVisibility() {
  const cat = document.getElementById('modelCategorySelect').value;
  const refRow = document.querySelector('.ref-row');
  if (cat === 'å¼•ç”¨åˆ†ç±»æ¨¡å‹' || cat === 'å¼•ç”¨åˆ†ç±»å¤šè§†å›¾') {
    refRow.style.display = '';
    document.getElementById('refMasterSelect').setAttribute('required', 'required');
    document.getElementById('refFieldSelect').setAttribute('required', 'required');
  } else {
    refRow.style.display = 'none';
    document.getElementById('refMasterSelect').removeAttribute('required');
    document.getElementById('refFieldSelect').removeAttribute('required');
  }
}
document.addEventListener('DOMContentLoaded', function() {
  updateRefMasterOptions();
  updateRefRowVisibility();
  document.getElementById('modelCategorySelect').addEventListener('change', function() {
    updateRefRowVisibility();
    renderViewList();
  });
  document.getElementById('refMasterSelect').addEventListener('change', function() {
    updateRefFieldOptions();
  });
});
// è§†å›¾ä¿¡æ¯åŠ¨æ€æ¸²æŸ“
function renderViewList() {
  const cat = document.getElementById('modelCategorySelect').value;
  let viewListBox = document.getElementById('viewListBox');
  let viewInfoBtn = document.getElementById('viewInfoCollapseBtn');
  let viewInfoSection = document.getElementById('viewInfoSection');
  if(!viewListBox || !viewInfoBtn || !viewInfoSection) return;
  if(cat==='å¤šè§†å›¾æ¨¡å‹'||cat==='å¼•ç”¨åˆ†ç±»å¤šè§†å›¾') {
    viewInfoBtn.style.display = '';
    viewInfoSection.style.display = '';
    viewListBox.style.display = '';
    if(!window.viewList) window.viewList = [];
    const viewOptions = ["äººäº‹è§†å›¾","è´¢åŠ¡è§†å›¾","ç”Ÿäº§è§†å›¾"];
    viewListBox.innerHTML = `
      <div style='margin-bottom:8px;display:flex;justify-content:flex-end;align-items:center;'>
        <button type='button' class='btn-modern' id='addViewRowBtn' style='margin-bottom:0;'>æ·»åŠ </button>
      </div>
      <table style='width:100%;margin-bottom:8px;'>
        <thead><tr><th style='width:120px;'>è§†å›¾åç§°</th><th style='width:40px;'>æ“ä½œ</th></tr></thead>
        <tbody id='viewListTbody'>
          ${window.viewList.map((v,i)=>`<tr><td><select class='view-name' data-idx='${i}' style='width:110px;'>${viewOptions.map(opt=>`<option value='${opt}'${v.name===opt?" selected":''}>${opt}</option>`).join('')}</select></td><td><button type='button' class='table-link-delete' onclick='deleteViewRow(${i})'>åˆ é™¤</button></td></tr>`).join('')}
        </tbody>
      </table>`;
    document.getElementById('addViewRowBtn').onclick = function() {
      window.viewList.push({name:viewOptions[0],desc:''});
      renderViewList();
      
      // ä¸ºæ–°è§†å›¾åˆå§‹åŒ–å­—æ®µæ•°æ®
      const newViewIndex = window.viewList.length - 1;
      const newViewKey = `view${newViewIndex}`;
      attrFieldsByView[newViewKey] = [];
    };
    // åˆ é™¤
    window.deleteViewRow = function(idx) { 
      window.viewList.splice(idx,1); 
      renderViewList(); 
      
      // æ¸…ç†å¯¹åº”çš„è§†å›¾å­—æ®µæ•°æ®
      const viewKey = `view${idx}`;
      if (attrFieldsByView[viewKey]) {
        delete attrFieldsByView[viewKey];
      }
      
      // å¦‚æœå½“å‰é€‰ä¸­çš„æ˜¯è¢«åˆ é™¤çš„è§†å›¾ï¼Œåˆ‡æ¢åˆ°åŸºæœ¬å±æ€§
      if (currentView === viewKey) {
        currentView = 'base';
      }
      
      // é‡æ–°æ¸²æŸ“é¡µç­¾
      renderAttrViewTabs();
    };
    // è¾“å…¥åŒæ­¥
    viewListBox.querySelectorAll('.view-name').forEach(select=>{
      select.onchange = function(){ window.viewList[this.dataset.idx].name = this.value; };
    });
    
    // æ›´æ–°å¤šè§†å›¾é¡µç­¾
    renderAttrViewTabs();
  } else {
    viewInfoBtn.style.display = 'none';
    viewInfoSection.style.display = 'none';
    viewListBox.style.display = 'none';
    viewListBox.innerHTML = '';
    
    // æ›´æ–°å¤šè§†å›¾é¡µç­¾
    renderAttrViewTabs();
  }
}
document.addEventListener('DOMContentLoaded', function() {
  // ...å·²æœ‰ä»£ç ...
  document.getElementById('modelCategorySelect').addEventListener('change', function() {
    updateRefRowVisibility();
    renderViewList();
  });
  renderViewList();
  // ...å·²æœ‰ä»£ç ...
});
// æŠ˜å /å±•å¼€é€»è¾‘
let isBaseInfoCollapsed = false;
let isViewInfoCollapsed = false;
function updateSectionCollapse() {
  const baseBtn = document.getElementById('baseInfoCollapseBtn');
  const baseSec = document.getElementById('baseInfoSection');
  const viewBtn = document.getElementById('viewInfoCollapseBtn');
  const viewSec = document.getElementById('viewInfoSection');
  if(isBaseInfoCollapsed) {
    baseBtn.classList.add('collapsed');
    baseSec.classList.add('collapsed');
  } else {
    baseBtn.classList.remove('collapsed');
    baseSec.classList.remove('collapsed');
  }
  if(isViewInfoCollapsed) {
    viewBtn.classList.add('collapsed');
    viewSec.classList.add('collapsed');
  } else {
    viewBtn.classList.remove('collapsed');
    viewSec.classList.remove('collapsed');
  }
}
document.addEventListener('DOMContentLoaded', function() {
  // ...å·²æœ‰ä»£ç ...
  document.getElementById('baseInfoCollapseBtn').onclick = function() {
    isBaseInfoCollapsed = !isBaseInfoCollapsed;
    updateSectionCollapse();
  };
  document.getElementById('viewInfoCollapseBtn').onclick = function() {
    isViewInfoCollapsed = !isViewInfoCollapsed;
    updateSectionCollapse();
  };
  updateSectionCollapse();
});
// æ­¥éª¤æ¡åº•éƒ¨æŒ‰é’®è·³è½¬é€»è¾‘
function renderFooter(tab) {
  const step = tab.dataset ? tab.dataset.tab || tab.dataset.step : tab;
  if(step === 'attr') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
      <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
    `;
  } else if(step === 'rule') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
      <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
    `;
  } else if(step === 'code') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
      <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
    `;
  } else if(step === 'layout') {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
      <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
      <button type="button" class="btn-modern" id="modalFinishBtn">æäº¤</button>
      <button type="button" class="btn-modern" id="modalPublishBtn">å‘å¸ƒå¹¶æäº¤</button>
    `;
  } else {
    footer.innerHTML = `
      <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
      <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
    `;
  }
}
// æ­¥éª¤æ¡æŒ‰é’®è·³è½¬
footer.onclick = function(e) {
  const activeStep = document.querySelector('.modal-step.active');
  const idx = stepOrder.indexOf(activeStep.dataset.step);
  if(e.target.id==='modalNextBtn' && idx < stepOrder.length-1) {
    stepOrder.forEach(s=>document.getElementById('tab-'+s).style.display='none');
    document.getElementById('tab-'+stepOrder[idx+1]).style.display='';
    updateStepBar(stepOrder[idx+1]);
    renderFooter({dataset:{tab:stepOrder[idx+1]}});
  }
  if(e.target.id==='modalPrevBtn' && idx > 0) {
    stepOrder.forEach(s=>document.getElementById('tab-'+s).style.display='none');
    document.getElementById('tab-'+stepOrder[idx-1]).style.display='';
    updateStepBar(stepOrder[idx-1]);
    renderFooter({dataset:{tab:stepOrder[idx-1]}});
  }
  // ä¿å­˜ã€æäº¤ã€å‘å¸ƒå¹¶æäº¤å¯è‡ªå®šä¹‰é€»è¾‘
  if(e.target.id==='modalSaveBtn') { alert('ä¿å­˜æˆåŠŸï¼'); }
  if(e.target.id==='modalFinishBtn') { alert('æäº¤æˆåŠŸï¼'); }
  if(e.target.id==='modalPublishBtn') { alert('å‘å¸ƒå¹¶æäº¤æˆåŠŸï¼'); }
}
// ========== æ­¥éª¤æ¡ä¸åº•éƒ¨æŒ‰é’®é€»è¾‘ ========== //
document.addEventListener('DOMContentLoaded', function() {
  const stepOrder = ['base','attr','rule','code','layout'];
  const stepEls = document.querySelectorAll('.modal-step');
  const footer = document.querySelector('.modal-footer-fixed');
  function updateStepBar(activeStep) {
    stepEls.forEach((el,idx)=>{
      el.classList.remove('active','done');
      if(stepOrder.indexOf(activeStep)>idx) el.classList.add('done');
      else if(stepOrder.indexOf(activeStep)===idx) el.classList.add('active');
      // å¯¹å‹¾
      const idxSpan = el.querySelector('.step-index');
      if(el.classList.contains('done')) idxSpan.innerHTML = '<svg width="16" height="16" viewBox="0 0 16 16"><circle cx="8" cy="8" r="8" fill="#4db6ac"/><path d="M4 8l3 3 5-5" stroke="#fff" stroke-width="2" fill="none"/></svg>';
      else idxSpan.textContent = (idx+1);
    });
  }
  function renderFooter(tab) {
    const step = tab.dataset ? tab.dataset.tab || tab.dataset.step : tab;
    if(step === 'attr' || step === 'rule' || step === 'code') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
        <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
      `;
    } else if(step === 'layout') {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalPrevBtn">ä¸Šä¸€æ­¥</button>
        <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
        <button type="button" class="btn-modern" id="modalFinishBtn">æäº¤</button>
        <button type="button" class="btn-modern" id="modalPublishBtn">å‘å¸ƒå¹¶æäº¤</button>
      `;
    } else {
      footer.innerHTML = `
        <button type="button" class="btn-line-modern" id="modalSaveBtn">ä¿å­˜</button>
        <button type="button" class="btn-modern" id="modalNextBtn">ä¸‹ä¸€æ­¥</button>
      `;
    }
    bindFooterEvents();
  }
  function showStep(idx) {
    stepOrder.forEach((s,i)=>{
      document.getElementById('tab-'+s).style.display = i===idx?'':'none';
    });
    updateStepBar(stepOrder[idx]);
    renderFooter({dataset:{tab:stepOrder[idx]}});
  }
  function bindFooterEvents() {
    document.getElementById('modalPrevBtn') && (document.getElementById('modalPrevBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx>0) showStep(idx-1);
    });
    document.getElementById('modalNextBtn') && (document.getElementById('modalNextBtn').onclick = function() {
      const idx = stepOrder.indexOf(document.querySelector('.modal-step.active').dataset.step);
      if(idx<stepOrder.length-1) showStep(idx+1);
    });
    document.getElementById('modalSaveBtn') && (document.getElementById('modalSaveBtn').onclick = function() { alert('ä¿å­˜æˆåŠŸï¼'); });
    document.getElementById('modalFinishBtn') && (document.getElementById('modalFinishBtn').onclick = function() { alert('æäº¤æˆåŠŸï¼'); });
    document.getElementById('modalPublishBtn') && (document.getElementById('modalPublishBtn').onclick = function() { alert('å‘å¸ƒå¹¶æäº¤æˆåŠŸï¼'); });
  }
  // æ­¥éª¤æ¡ç‚¹å‡»åˆ‡æ¢
  stepEls.forEach((el,idx)=>{
    el.onclick = function(){ showStep(idx); };
  });
  // é¡µé¢åˆå§‹åŒ–æ—¶é«˜äº®ç¬¬ä¸€ä¸ª
  showStep(0);
});

// ========== ç¼–ç è§„åˆ™åŠŸèƒ½ ========== //
// ç¼–ç è§„åˆ™æ•°æ®æ¨¡æ‹Ÿ
let codeRuleData = [
  { 
    code: 'RULE001', 
    name: 'ä¾›åº”å•†ç¼–ç è§„åˆ™', 
    type: 'è‡ªåŠ¨ç¼–ç ', 
    desc: 'ä¾›åº”å•†è‡ªåŠ¨ç¼–ç è§„åˆ™ï¼ŒåŒ…å«å›ºå®šå‰ç¼€+æ—¥æœŸ+æµæ°´å·', 
    field: 'supplier_code', 
    status: 'å¯ç”¨',
    segments: [
      { type: 'å›ºå®šç ', config: { value: 'SUP' }, separator: '-' },
      { type: 'æ—¥æœŸç ', config: { field: 'create_date', format: 'YYYYMMDD' }, separator: '-' },
      { type: 'æµæ°´ç ', config: { maxLength: 4, padZero: true, step: 1 }, separator: '' }
    ]
  },
  { 
    code: 'RULE002', 
    name: 'å‘˜å·¥ç¼–ç è§„åˆ™', 
    type: 'æ‰‹åŠ¨ç¼–ç ', 
    desc: 'å‘˜å·¥æ‰‹åŠ¨ç¼–ç è§„åˆ™', 
    field: 'employee_code', 
    status: 'å¯ç”¨',
    manualLength: 8
  },
  { 
    code: 'RULE003', 
    name: 'äº§å“ç¼–ç è§„åˆ™', 
    type: 'è‡ªåŠ¨ç¼–ç ', 
    desc: 'äº§å“ç¼–ç è§„åˆ™ï¼ŒåŒ…å«åˆ†ç±»ä»£ç +æµæ°´å·', 
    field: 'product_code', 
    status: 'ç¦ç”¨',
    segments: [
      { type: 'å­—æ®µç ', config: { field: 'category_code' }, separator: '-' },
      { type: 'æµæ°´ç ', config: { maxLength: 6, padZero: true, step: 1 }, separator: '' }
    ]
  }
];
let codeRuleEditIdx = -1;

function renderCodeRuleTable() {
  const tbody = document.getElementById('codeRuleTableBody');
  if (codeRuleData.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="7" style="text-align: center; padding: 60px 20px; color: #666;">
          <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.3;">ğŸ“‹</div>
          <div style="font-size: 15px; margin-bottom: 8px;">æš‚æ— ç¼–ç è§„åˆ™</div>
          <div style="font-size: 13px; opacity: 0.7;">ç‚¹å‡»"æ–°å¢ç¼–ç è§„åˆ™"å¼€å§‹åˆ›å»º</div>
        </td>
      </tr>
    `;
    return;
  }
  
  tbody.innerHTML = codeRuleData.map((item, idx) => `
    <tr>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left;">
        <input type="checkbox" class="codeRuleRowCheck" data-idx="${idx}">
      </td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left;">${item.code}</td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left;">${item.name}</td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left;">${item.type}</td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: left;">${item.field}</td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: center;">
        <label class="code-rule-switch" style="vertical-align: middle;">
          <input type="checkbox" class="codeRuleRowStatusSwitch" data-idx="${idx}" ${item.status === 'å¯ç”¨' ? 'checked' : ''}>
          <span class="code-rule-slider"></span>
        </label>
      </td>
      <td style="padding: 10px 12px; border-bottom: 1px solid #e3eaf3; text-align: center;">
        <button type="button" onclick="editCodeRuleRow(${idx})" style="background:none;border:none;color:#2176c7;cursor:pointer;font-size:14px;padding:0 8px;">ç¼–è¾‘</button>
        <button type="button" onclick="deleteCodeRuleRow(${idx})" style="background:none;border:none;color:#e74c3c;cursor:pointer;font-size:14px;padding:0 8px;">åˆ é™¤</button>
      </td>
    </tr>
  `).join('');
}

function showCodeRuleDrawer() {
  document.getElementById('codeRuleModalMask').style.display = 'block';
  setTimeout(() => {
    document.getElementById('codeRuleModalContent').style.right = '0';
  }, 10);
}

function hideCodeRuleDrawer() {
  document.getElementById('codeRuleModalContent').style.right = '-800px';
  setTimeout(() => {
    document.getElementById('codeRuleModalMask').style.display = 'none';
  }, 300);
}

function toggleCodeRuleConfig() {
  const codeType = document.getElementById('codeRuleEditType').value;
  const autoConfig = document.getElementById('codeRuleAutoConfig');
  const manualConfig = document.getElementById('codeRuleManualConfig');
  
  if (codeType === 'è‡ªåŠ¨ç¼–ç ') {
    autoConfig.style.display = 'block';
    manualConfig.style.display = 'none';
    // æ¸…ç©ºç¼–ç æ®µï¼Œå› ä¸ºç±»å‹æ”¹å˜äº†
    document.getElementById('codeRuleSegmentsContainer').innerHTML = '';
    document.getElementById('codeRulePreview').textContent = 'è¯·é…ç½®ç¼–ç è§„åˆ™';
  } else {
    autoConfig.style.display = 'none';
    manualConfig.style.display = 'block';
  }
}

function addCodeRuleSegment(event) {
  if (event) {
    event.stopPropagation();
  }
  const container = document.getElementById('codeRuleSegmentsContainer');
  const segmentId = Date.now();
  const codeType = document.getElementById('codeRuleEditType').value;

  let typeOptions = '';
  if (codeType === 'è‡ªåŠ¨ç¼–ç ') {
    typeOptions = `
      <option value="å›ºå®šç ">å›ºå®šç </option>
      <option value="æ—¥æœŸç ">æ—¥æœŸç </option>
      <option value="å­—æ®µç ">å­—æ®µç </option>
      <option value="æµæ°´ç ">æµæ°´ç </option>
      <option value="å¼•ç”¨ç ">å¼•ç”¨ç </option>
    `;
  } else {
    typeOptions = `<option value="æ‰‹å·¥ç ">æ‰‹å·¥ç </option>`;
  }

  const segmentHtml = `
    <div class="code-rule-segment-item" data-segment-id="${segmentId}" style="display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: #f8fafc; border: 1px solid #e0e6ed; border-radius: 6px; margin-bottom: 12px;">
      <div style="width: 120px; flex-shrink: 0;">
        <select class="code-rule-segment-type-select" onchange="updateCodeRuleSegmentConfig(${segmentId})" style="width: 100%; padding: 6px 8px; border: 1px solid #c0d3eb; border-radius: 4px; font-size: 13px;">
          ${typeOptions}
        </select>
      </div>
      <div class="code-rule-segment-config" id="code-rule-config-${segmentId}" style="flex: 1; display: flex; gap: 8px; align-items: center; min-height: 32px;"></div>
      <button type="button" onclick="removeCodeRuleSegment(${segmentId}, event)" style="padding: 4px 10px; font-size: 11px; border: none; border-radius: 3px; cursor: pointer; transition: background 0.2s; background: #e74c3c; color: #fff; height:32px; white-space:nowrap;">åˆ é™¤</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', segmentHtml);
  updateCodeRuleSegmentConfig(segmentId);
}

function updateCodeRuleSegmentConfig(segmentId) {
  const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
  const typeSelect = segment.querySelector('.code-rule-segment-type-select');
  const configDiv = segment.querySelector('.code-rule-segment-config');
  const type = typeSelect.value;
  const codeType = document.getElementById('codeRuleEditType').value;

  // å…ˆæ¸…ç©º
  configDiv.innerHTML = '';

  let configHtml = '';

  if (codeType === 'è‡ªåŠ¨ç¼–ç ') {
    switch(type) {
      case 'å›ºå®šç ':
        configHtml = `<input type="text" class="code-rule-fixed-value" placeholder="å›ºå®šå­—ç¬¦" style="width:120px;" oninput="updateCodeRulePreview()">`;
        configHtml += `<input type="text" class="code-rule-separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodeRulePreview()" style="width:64px;margin-left:8px;">`;
        break;
      case 'æ—¥æœŸç ':
        configHtml = `
          <select class="code-rule-date-field" style="width:120px;" onchange="updateCodeRulePreview()">
            <option value="create_date">åˆ›å»ºæ—¥æœŸ</option>
            <option value="update_date">æ›´æ–°æ—¥æœŸ</option>
          </select>
          <input type="text" class="code-rule-date-format" placeholder="æ—¥æœŸæ ¼å¼" value="YYYYMMDD" style="width:100px;" oninput="updateCodeRulePreview()">
          <input type="text" class="code-rule-separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodeRulePreview()" style="width:64px;margin-left:8px;">
        `;
        break;
      case 'å­—æ®µç ':
        configHtml = `
          <select class="code-rule-field-name" style="width:120px;" onchange="updateCodeRulePreview()">
            <option value="">æ¨¡å‹å±æ€§</option>
            <option value="attr1">å±æ€§1</option>
            <option value="attr2">å±æ€§2</option>
            <option value="attr3">å±æ€§3</option>
          </select>
          <select class="code-rule-ref-attr" style="width:120px;margin-left:8px;" onchange="updateCodeRulePreview()">
            <option value="">å¼•ç”¨å±æ€§</option>
            <option value="ref1">å¼•ç”¨1</option>
            <option value="ref2">å¼•ç”¨2</option>
            <option value="ref3">å¼•ç”¨3</option>
          </select>
          <input type="text" class="code-rule-separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodeRulePreview()" style="width:64px;margin-left:8px;">
        `;
        break;
      case 'æµæ°´ç ':
        configHtml = `
          <div style='display:flex;flex-direction:column;gap:4px;max-width:900px;'>
            <div style='display:flex;align-items:flex-end;gap:4px;flex-wrap:nowrap;'>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">æœ€å¤§é•¿åº¦</label>
                <input type="number" class="code-rule-serial-length" min="1" max="10" value="4" oninput="updateCodeRulePreview()" style="width:58px;">
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">è¡¥é›¶</label>
                <input type="checkbox" class="code-rule-serial-pad" checked onchange="updateCodeRulePreview()" style="width:13px;height:13px;">
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">æ­¥é•¿</label>
                <input type="number" class="code-rule-serial-step" value="1" min="1" oninput="updateCodeRulePreview()" style="width:35px;">
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">èµ·å§‹å€¼</label>
                <input type="number" class="code-rule-serial-start" value="1" min="0" oninput="updateCodeRulePreview()" style="width:40px;">
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">ç»ˆæ­¢å€¼</label>
                <input type="number" class="code-rule-serial-end" value="9999" min="0" oninput="updateCodeRulePreview()" style="width:58px;">
              </div>
              <div style="display:flex;flex-direction:column;align-items:flex-start;min-width:70px;">
                <label style="margin-bottom:2px;font-size:13px;color:#2176c7;">åˆ†éš”ç¬¦</label>
                <input type="text" class="code-rule-separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodeRulePreview()" style="width:40px;">
              </div>
            </div>
            <div style='display:flex;align-items:center;gap:8px;flex-wrap:nowrap;justify-content:flex-start;'>
              <label style='white-space:nowrap;'>é‡ç½®ç±»å‹</label>
              <select class="code-rule-serial-reset-type" style="width:90px;" onchange="updateCodeRuleSerialResetConfig(this, ${segmentId})">
                <option value="none">ä¸é‡ç½®</option>
                <option value="date">æŒ‰æ—¥æœŸé‡ç½®</option>
                <option value="field">æŒ‰å­—æ®µå€¼é‡ç½®</option>
              </select>
              <div style='display:flex;align-items:center;gap:4px;'><label style='margin-right:4px;'>å­—æ®µ</label><select class='code-rule-serial-reset-field' style='width:90px;'><option value='field1'>å­—æ®µ1</option><option value='field2'>å­—æ®µ2</option></select></div>
            </div>
          </div>
        `;
        break;
      case 'å¼•ç”¨ç ':
        configHtml = `<input type="text" class="code-rule-parent-field" placeholder="çˆ¶çº§å­—æ®µ" style="width:120px;" oninput="updateCodeRulePreview()">`;
        configHtml += `<input type="text" class="code-rule-separator-input" placeholder="åˆ†éš”ç¬¦" maxlength="3" oninput="updateCodeRulePreview()" style="width:64px;margin-left:8px;">`;
        break;
    }
  } else {
    // æ‰‹åŠ¨ç¼–ç æ¨¡å¼
    configHtml = `<input type="number" class="code-rule-manual-length" placeholder="æœ€å¤§é•¿åº¦" min="1" max="20" style="width:120px;" oninput="updateCodeRulePreview()">`;
  }

  configDiv.innerHTML = configHtml;
  updateCodeRulePreview();
}

function updateCodeRulePreview() {
  const segments = document.querySelectorAll('.code-rule-segment-item');
  let preview = '';
  
  segments.forEach((segment, index) => {
    const type = segment.querySelector('.code-rule-segment-type-select').value;
    const separator = segment.querySelector('.code-rule-separator-input') ? segment.querySelector('.code-rule-separator-input').value : '';
    
    let segmentValue = '';
    switch(type) {
      case 'å›ºå®šç ':
        segmentValue = segment.querySelector('.code-rule-fixed-value') ? segment.querySelector('.code-rule-fixed-value').value : 'FIX';
        break;
      case 'æ—¥æœŸç ':
        segmentValue = '20241201';
        break;
      case 'å­—æ®µç ':
        segmentValue = segment.querySelector('.code-rule-field-name') ? segment.querySelector('.code-rule-field-name').value : 'FIELD';
        break;
      case 'æµæ°´ç ':
        const length = segment.querySelector('.code-rule-serial-length') ? segment.querySelector('.code-rule-serial-length').value : 4;
        const start = segment.querySelector('.code-rule-serial-start') ? segment.querySelector('.code-rule-serial-start').value : 1;
        segmentValue = String(start).padStart(length, '0');
        break;
      case 'å¼•ç”¨ç ':
        segmentValue = segment.querySelector('.code-rule-parent-field') ? segment.querySelector('.code-rule-parent-field').value : 'REF';
        break;
    }
    
    preview += segmentValue;
    if (index < segments.length - 1 && separator) {
      preview += separator;
    }
  });
  
  document.getElementById('codeRulePreview').textContent = preview || 'è¯·é…ç½®ç¼–ç è§„åˆ™';
}

function removeCodeRuleSegment(segmentId, event) {
  if (event) {
    event.stopPropagation();
  }
  const segment = document.querySelector(`[data-segment-id="${segmentId}"]`);
  if (segment) {
    segment.remove();
    updateCodeRulePreview();
  }
}

function saveCodeRuleRow() {
  const formData = {
    code: document.getElementById('codeRuleEditCode').value,
    name: document.getElementById('codeRuleEditName').value,
    type: document.getElementById('codeRuleEditType').value,
    field: document.getElementById('codeRuleEditField').value,
    status: document.getElementById('codeRuleStatusSwitch').checked ? 'å¯ç”¨' : 'ç¦ç”¨'
  };

  if (formData.type === 'è‡ªåŠ¨ç¼–ç ') {
    const segments = [];
    document.querySelectorAll('.code-rule-segment-item').forEach(segment => {
      const type = segment.querySelector('.code-rule-segment-type-select').value;
      const separator = segment.querySelector('.code-rule-separator-input') ? segment.querySelector('.code-rule-separator-input').value : '';
      let config = {};
      
      if (type === 'å›ºå®šç ') {
        config.value = segment.querySelector('.code-rule-fixed-value') ? segment.querySelector('.code-rule-fixed-value').value : '';
      } else if (type === 'æ—¥æœŸç ') {
        config.field = segment.querySelector('.code-rule-date-field') ? segment.querySelector('.code-rule-date-field').value : '';
        config.format = segment.querySelector('.code-rule-date-format') ? segment.querySelector('.code-rule-date-format').value : '';
      } else if (type === 'å­—æ®µç ') {
        config.field = segment.querySelector('.code-rule-field-name') ? segment.querySelector('.code-rule-field-name').value : '';
        config.ref = segment.querySelector('.code-rule-ref-attr') ? segment.querySelector('.code-rule-ref-attr').value : '';
      } else if (type === 'æµæ°´ç ') {
        config.maxLength = parseInt(segment.querySelector('.code-rule-serial-length') ? segment.querySelector('.code-rule-serial-length').value : 4);
        config.padZero = segment.querySelector('.code-rule-serial-pad') ? segment.querySelector('.code-rule-serial-pad').checked : true;
        config.step = parseInt(segment.querySelector('.code-rule-serial-step') ? segment.querySelector('.code-rule-serial-step').value : 1);
        config.start = parseInt(segment.querySelector('.code-rule-serial-start') ? segment.querySelector('.code-rule-serial-start').value : 1);
        config.end = parseInt(segment.querySelector('.code-rule-serial-end') ? segment.querySelector('.code-rule-serial-end').value : 9999);
        config.resetType = segment.querySelector('.code-rule-serial-reset-type') ? segment.querySelector('.code-rule-serial-reset-type').value : 'none';
        if(config.resetType === 'date') {
          config.resetDate = segment.querySelector('.code-rule-serial-reset-date') ? segment.querySelector('.code-rule-serial-reset-date').value : '';
        } else if(config.resetType === 'field') {
          config.resetField = segment.querySelector('.code-rule-serial-reset-field') ? segment.querySelector('.code-rule-serial-reset-field').value : '';
        }
      } else if (type === 'å¼•ç”¨ç ') {
        config.field = segment.querySelector('.code-rule-parent-field') ? segment.querySelector('.code-rule-parent-field').value : '';
      }
      
      segments.push({ type, config, separator });
    });
    formData.segments = segments;
  } else if (formData.type === 'æ‰‹åŠ¨ç¼–ç ') {
    formData.manualLength = parseInt(document.getElementById('codeRuleManualLength').value);
  }

  if (codeRuleEditIdx === -1) {
    codeRuleData.push(formData);
  } else {
    codeRuleData[codeRuleEditIdx] = formData;
  }
  
  renderCodeRuleTable();
  hideCodeRuleDrawer();
}

// æ–°å¢ç¼–ç è§„åˆ™
function addCodeRuleRow() {
  codeRuleEditIdx = -1;
  document.getElementById('codeRuleDrawerTitle').textContent = 'æ–°å¢ç¼–ç è§„åˆ™';
  document.getElementById('codeRuleEditForm').reset();
  document.getElementById('codeRuleStatusSwitch').checked = true;
  document.getElementById('codeRuleSegmentsContainer').innerHTML = '';
  document.getElementById('codeRulePreview').textContent = 'è¯·é…ç½®ç¼–ç è§„åˆ™';
  toggleCodeRuleConfig();
  showCodeRuleDrawer();
}

// ç¼–è¾‘ç¼–ç è§„åˆ™
function editCodeRuleRow(idx) {
  codeRuleEditIdx = idx;
  const item = codeRuleData[idx];
  document.getElementById('codeRuleDrawerTitle').textContent = 'ç¼–è¾‘ç¼–ç è§„åˆ™';
  document.getElementById('codeRuleEditCode').value = item.code;
  document.getElementById('codeRuleEditName').value = item.name;
  document.getElementById('codeRuleEditType').value = item.type;
  document.getElementById('codeRuleEditField').value = item.field;
  document.getElementById('codeRuleStatusSwitch').checked = item.status === 'å¯ç”¨';
  
  if (item.type === 'è‡ªåŠ¨ç¼–ç ' && item.segments) {
    document.getElementById('codeRuleSegmentsContainer').innerHTML = '';
    item.segments.forEach(segment => {
      addCodeRuleSegment(null);
      const lastSegment = document.querySelector('.code-rule-segment-item:last-child');
      const typeSelect = lastSegment.querySelector('.code-rule-segment-type-select');
      typeSelect.value = segment.type;
      updateCodeRuleSegmentConfig(lastSegment.dataset.segmentId);
      
      // è®¾ç½®é…ç½®å€¼
      setTimeout(() => {
        const configDiv = lastSegment.querySelector('.code-rule-segment-config');
        const separatorInput = lastSegment.querySelector('.code-rule-separator-input');
        
        if (segment.type === 'å›ºå®šç ') {
          if(configDiv.querySelector('.code-rule-fixed-value')) configDiv.querySelector('.code-rule-fixed-value').value = segment.config.value;
        } else if (segment.type === 'æ—¥æœŸç ') {
          if(configDiv.querySelector('.code-rule-date-field')) configDiv.querySelector('.code-rule-date-field').value = segment.config.field;
          if(configDiv.querySelector('.code-rule-date-format')) configDiv.querySelector('.code-rule-date-format').value = segment.config.format;
        } else if (segment.type === 'å­—æ®µç ') {
          if(configDiv.querySelector('.code-rule-field-name')) configDiv.querySelector('.code-rule-field-name').value = segment.config.field;
          if(configDiv.querySelector('.code-rule-ref-attr')) configDiv.querySelector('.code-rule-ref-attr').value = segment.config.ref || '';
        } else if (segment.type === 'æµæ°´ç ') {
          if(configDiv.querySelector('.code-rule-serial-length')) configDiv.querySelector('.code-rule-serial-length').value = segment.config.maxLength;
          if(configDiv.querySelector('.code-rule-serial-pad')) configDiv.querySelector('.code-rule-serial-pad').checked = segment.config.padZero;
          if(configDiv.querySelector('.code-rule-serial-step')) configDiv.querySelector('.code-rule-serial-step').value = segment.config.step;
          if(configDiv.querySelector('.code-rule-serial-start')) configDiv.querySelector('.code-rule-serial-start').value = segment.config.start || 1;
          if(configDiv.querySelector('.code-rule-serial-end')) configDiv.querySelector('.code-rule-serial-end').value = segment.config.end || 9999;
          // å›æ˜¾é‡ç½®ç±»å‹
          const resetType = segment.config.resetType || 'none';
          const resetTypeSelect = configDiv.parentElement.querySelector('.code-rule-serial-reset-type');
          if(resetTypeSelect) {
            resetTypeSelect.value = resetType;
            updateCodeRuleSerialResetConfig(resetTypeSelect, segmentId);
            if(resetType === 'date' && configDiv.parentElement.querySelector('.code-rule-serial-reset-date')) {
              configDiv.parentElement.querySelector('.code-rule-serial-reset-date').value = segment.config.resetDate || 'year';
            } else if(resetType === 'field' && configDiv.parentElement.querySelector('.code-rule-serial-reset-field')) {
              configDiv.parentElement.querySelector('.code-rule-serial-reset-field').value = segment.config.resetField || 'field1';
            }
          }
        } else if (segment.type === 'å¼•ç”¨ç ') {
          if(configDiv.querySelector('.code-rule-parent-field')) configDiv.querySelector('.code-rule-parent-field').value = segment.config.field;
        }
        
        if(separatorInput) separatorInput.value = segment.separator;
      }, 100);
    });
    updateCodeRulePreview();
  } else if (item.type === 'æ‰‹åŠ¨ç¼–ç ') {
    document.getElementById('codeRuleManualLength').value = item.manualLength || '';
  }
  
  toggleCodeRuleConfig();
  showCodeRuleDrawer();
}

// åˆ é™¤ç¼–ç è§„åˆ™
function deleteCodeRuleRow(idx) {
  if (confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡ç¼–ç è§„åˆ™å—ï¼Ÿ')) {
    codeRuleData.splice(idx, 1);
    renderCodeRuleTable();
  }
}

// ç¼–ç è§„åˆ™ç›¸å…³äº‹ä»¶ç»‘å®š
document.addEventListener('DOMContentLoaded', function() {
  // åˆå§‹åŒ–ç¼–ç è§„åˆ™è¡¨æ ¼
  renderCodeRuleTable();
  
  // æ–°å¢ç¼–ç è§„åˆ™æŒ‰é’®
  document.getElementById('addCodeRuleBtn') && (document.getElementById('addCodeRuleBtn').onclick = addCodeRuleRow);
  
  // åˆ é™¤ç¼–ç è§„åˆ™æŒ‰é’®
  document.getElementById('deleteCodeRuleBtn') && (document.getElementById('deleteCodeRuleBtn').onclick = function() {
    const checkedBoxes = document.querySelectorAll('.codeRuleRowCheck:checked');
    if (checkedBoxes.length === 0) {
      alert('è¯·é€‰æ‹©è¦åˆ é™¤çš„è®°å½•');
      return;
    }
    
    if (confirm(`ç¡®å®šè¦åˆ é™¤é€‰ä¸­çš„ ${checkedBoxes.length} æ¡è®°å½•å—ï¼Ÿ`)) {
      const indices = Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.idx)).sort((a, b) => b - a);
      indices.forEach(idx => codeRuleData.splice(idx, 1));
      renderCodeRuleTable();
      document.getElementById('codeRuleCheckAll').checked = false;
    }
  });
  
  // ç¼–ç è§„åˆ™è¡¨å•æäº¤
  document.getElementById('codeRuleEditForm') && (document.getElementById('codeRuleEditForm').onsubmit = function(e) {
    e.preventDefault();
    saveCodeRuleRow();
  });
  
  // ç¼–ç è§„åˆ™æŠ½å±‰å…³é—­
  document.getElementById('codeRuleDrawerClose') && (document.getElementById('codeRuleDrawerClose').onclick = hideCodeRuleDrawer);
  document.getElementById('codeRuleDrawerCancel') && (document.getElementById('codeRuleDrawerCancel').onclick = hideCodeRuleDrawer);
  
  // ç¼–ç è§„åˆ™æŠ½å±‰é®ç½©ç‚¹å‡»å…³é—­
  document.getElementById('codeRuleModalMask') && (document.getElementById('codeRuleModalMask').onclick = function(e) {
    if (e.target === this) {
      hideCodeRuleDrawer();
    }
  });
  
  // ç¼–ç è§„åˆ™å…¨é€‰åŠŸèƒ½
  document.getElementById('codeRuleCheckAll') && (document.getElementById('codeRuleCheckAll').onchange = function() {
    const checkboxes = document.querySelectorAll('.codeRuleRowCheck');
    checkboxes.forEach(cb => cb.checked = this.checked);
  });
  
  // ç¼–ç è§„åˆ™é€‚ç”¨æ¡ä»¶æœç´¢æŒ‰é’®äº‹ä»¶
  document.getElementById('codeRuleConditionSearchBtn') && (document.getElementById('codeRuleConditionSearchBtn').onclick = function() {
    window.open('condition_new.html', '_blank');
  });
  
  // æ·»åŠ äº‹ä»¶ç›‘å¬å™¨ç”¨äºå®æ—¶æ›´æ–°é¢„è§ˆ
  document.addEventListener('input', function(e) {
    if (e.target.closest('#codeRuleAutoConfig')) {
      updateCodeRulePreview();
    }
  });
});

// ç¼–ç è§„åˆ™æµæ°´ç é‡ç½®é…ç½®
function updateCodeRuleSerialResetConfig(select, segmentId) {
  const val = select.value;
  const extraDiv = document.getElementById('code-rule-serial-reset-extra-' + segmentId);
  if(val === 'date') {
    if(extraDiv) {
      extraDiv.style.display = '';
      extraDiv.innerHTML = `<label>é‡ç½®å‘¨æœŸ</label><select class='code-rule-serial-reset-date' style='width:90px;'><option value='year'>å¹´</option><option value='quarter'>å­£åº¦</option><option value='month'>æœˆ</option></select>`;
    }
  } else if(val === 'field') {
    if(extraDiv) {
      extraDiv.style.display = '';
      extraDiv.innerHTML = `<div style='display:flex;align-items:center;gap:4px;'><label style='margin-right:4px;'>å­—æ®µ</label><select class='code-rule-serial-reset-field' style='width:90px;'><option value='field1'>å­—æ®µ1</option><option value='field2'>å­—æ®µ2</option></select></div>`;
    }
  } else {
    if(extraDiv) {
      extraDiv.style.display = 'none';
      extraDiv.innerHTML = '';
    }
  }
}

// å‘å¸ƒé…ç½®é¡µé¢è·³è½¬å‡½æ•°
function openPageSetup() {
  // è·å–å½“å‰é€‰æ‹©çš„æ¨¡å‹åˆ†ç±»
  const modelCategory = document.getElementById('modelCategorySelect').value;
  
  // æ ¹æ®æ¨¡å‹åˆ†ç±»å†³å®šæ‰“å¼€å“ªä¸ªé¡µé¢
  if (modelCategory === 'å¼•ç”¨åˆ†ç±»æ¨¡å‹' || modelCategory === 'å¼•ç”¨åˆ†ç±»å¤šè§†å›¾') {
    // æ‰“å¼€æ ‘å½¢é¡µé¢å¸ƒå±€é…ç½®
    window.open('page_setup_tree.html', '_blank');
  } else {
    // æ‰“å¼€æ™®é€šé¡µé¢å¸ƒå±€é…ç½®
    window.open('page_setup.html', '_blank');
  }
}

// å¤šè§†å›¾é¡µç­¾ç®¡ç†
function renderAttrViewTabs() {
  const modelCategory = document.getElementById('modelCategorySelect').value;
  const attrViewTabs = document.getElementById('attrViewTabs');
  
  if (modelCategory === 'å¤šè§†å›¾æ¨¡å‹' || modelCategory === 'å¼•ç”¨åˆ†ç±»å¤šè§†å›¾') {
    attrViewTabs.style.display = 'flex';
    
    // è·å–è§†å›¾åˆ—è¡¨
    const viewList = window.viewList || [];
    
    // æ¸²æŸ“é¡µç­¾
    let tabsHtml = '<div class="attr-view-tab active" data-view="base">åŸºæœ¬å±æ€§</div>';
    
    viewList.forEach((view, index) => {
      const viewKey = `view${index}`;
      const isActive = currentView === viewKey ? 'active' : '';
      
      tabsHtml += `<div class="attr-view-tab ${isActive}" data-view="${viewKey}">${view.name}</div>`;
      
      // åˆå§‹åŒ–è§†å›¾å­—æ®µï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
      if (!attrFieldsByView[viewKey]) {
        attrFieldsByView[viewKey] = [];
      }
    });
    
    attrViewTabs.innerHTML = tabsHtml;
    
    // ç»‘å®šé¡µç­¾ç‚¹å‡»äº‹ä»¶
    attrViewTabs.querySelectorAll('.attr-view-tab').forEach(tab => {
      tab.onclick = function() {
        const viewKey = this.getAttribute('data-view');
        switchAttrView(viewKey);
      };
    });
  } else {
    attrViewTabs.style.display = 'none';
    currentView = 'base';
  }
}

// åˆ‡æ¢è§†å›¾
function switchAttrView(viewKey) {
  // æ›´æ–°å½“å‰è§†å›¾
  currentView = viewKey;
  
  // æ›´æ–°é¡µç­¾çŠ¶æ€
  document.querySelectorAll('.attr-view-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  const activeTab = document.querySelector(`[data-view="${viewKey}"]`);
  if (activeTab) {
    activeTab.classList.add('active');
  }
  
  // é‡ç½®é€‰ä¸­ç´¢å¼•
  selectedAttrIdx = 0;
  
  // é‡æ–°æ¸²æŸ“å­—æ®µåˆ—è¡¨å’Œè¯¦æƒ…
  renderAttrFieldList();
  renderAttrDetailBox();
}

// ç›‘å¬æ¨¡å‹åˆ†ç±»å˜åŒ–ï¼Œæ›´æ–°é¡µç­¾
document.addEventListener('DOMContentLoaded', function() {
  // ç›‘å¬æ¨¡å‹åˆ†ç±»å˜åŒ–
  document.getElementById('modelCategorySelect').addEventListener('change', function() {
    renderAttrViewTabs();
  });
  
  // åˆå§‹åŒ–é¡µç­¾
  renderAttrViewTabs();
  
  // åˆå§‹åŒ–å­—æ®µåˆ—è¡¨
  renderAttrFieldList();
});
</script>
</body>
</html> 